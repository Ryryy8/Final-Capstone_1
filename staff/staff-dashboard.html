<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AssessPro - Staff Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // IMMEDIATE SESSION CHECK AND REDIRECT
        window.addEventListener('DOMContentLoaded', function() {
            // Check session immediately when page loads
            fetch('../backend/security/session_check.php', {
                method: 'POST',
                credentials: 'same-origin',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    // Force redirect immediately
                    window.location.href = '../index.html';
                    window.location.replace('../index.html');
                }
            })
            .catch(error => {
                // Any error means redirect
                window.location.href = '../index.html';
                window.location.replace('../index.html');
            });
        });
        
        // ALSO check immediately without waiting for DOM
        fetch('../backend/security/session_check.php', {
            method: 'POST',
            credentials: 'same-origin',
            cache: 'no-cache'
        })
        .then(response => response.json())
        .then(result => {
            if (!result.success) {
                window.location.replace('../index.html');
            }
        })
        .catch(() => {
            window.location.replace('../index.html');
        });
    </script>
    <style>
        /* Calendar scheduled inspection styling */
.calendar-table td.scheduled {
    background: var(--light-green) !important;
    border: 2px solid var(--primary-green) !important;
    color: var(--dark-green) !important;
    position: relative;
    font-weight: bold !important;
    border-radius: 4px;
}

.calendar-table td.scheduled:hover {
    background: var(--accent-green) !important;
    border-color: var(--dark-green) !important;
    border-radius: 4px;
}

.calendar-table td.clickable {
    cursor: pointer;
}

.calendar-table td.clickable:hover {
    transform: scale(1.02);
    transition: transform 0.2s ease;
}

.calendar-note {
    font-size: 1em;
    color: var(--dark-green);
    margin-top: 2px;
    font-weight: bold;
    line-height: 1.2;
}

.calendar-note.multiple-inspections {
    background: var(--primary-green);
    color: var(--white);
    padding: 2px 4px;
    border-radius: 3px;
    font-size: 0.8em;
    text-align: center;
}

.inspection-detail {
    font-size: 0.7em;
    color: var(--text-dark);
    margin-top: 1px;
    line-height: 1.1;
    opacity: 0.9;
}

.calendar-note-text {
    font-size: 0.65em;
    color: var(--text-dark);
    font-weight: normal;
    font-style: italic;
}

.scheduled-indicator {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 6px;
    height: 6px;
    background: var(--primary-green);
    border-radius: 50%;
}

/* Today + Scheduled combination */
.calendar-table td.today.scheduled {
    border: 3px solid var(--primary-green) !important;
    box-shadow: inset 0 0 0 2px var(--white), inset 0 0 0 3px var(--blue-500);
}
/* Custom color for schedule button in Inspection Request module */
.schedule-btn {
    background: #ff9800 !important; /* Orange for visibility */
    color: #fff !important;
    border: 1px solid #ff9800 !important;
    font-weight: 600;
    transition: background 0.2s, border 0.2s;
}
.schedule-btn:disabled {
    background: #ffe0b2 !important;
    color: #bdbdbd !important;
    border: 1px solid #ffe0b2 !important;
    cursor: not-allowed;
}
.schedule-btn:hover:not(:disabled) {
    background: #fb8c00 !important;
    border-color: #fb8c00 !important;
}
.pending-red {
    color: #f44336 !important;
    font-weight: bold;
}
/* Darker table header for view requests table */
.view-requests-table th {
    background: #1a202c;
    color: #fff;
}
/* Schedule Modal Styles */
.modal {
    display: none; /* Hidden by default */
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    overflow-y: auto;
    overflow-x: hidden;
    background: rgba(0,0,0,0.35);
    padding: 20px;
    box-sizing: border-box;
    transition: background 0.2s;
}

.modal-content {
    background: var(--white);
    margin: auto;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
    padding: 2rem 2rem 1.5rem 2rem;
    max-width: 540px;
    min-width: 320px;
    width: 95vw;
    position: relative;
    animation: modalFadeIn 0.25s;
}

@keyframes modalFadeIn {
    from { transform: translateY(40px) scale(0.98); opacity: 0; }
    to { transform: translateY(0) scale(1); opacity: 1; }
}

.modal-body {
    display: flex;
    gap: 2rem;
    align-items: flex-start;
}

.modal-calendar label,
.modal-note label {
    font-size: 1rem;
    color: var(--primary-green);
    margin-bottom: 0.25rem;
    display: block;
}

.modal-calendar input[type="date"] {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 1rem;
    margin-top: 0.5rem;
}

.modal-note textarea {
    width: 100%;
    min-height: 120px;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    padding: 0.5rem;
    font-size: 1rem;
    margin-top: 0.5rem;
    resize: vertical;
}

.modal-footer {
    margin-top: 1.5rem;
    text-align: right;
}

.close {
    position: absolute;
    top: 1rem;
    right: 1.5rem;
    font-size: 1.5rem;
    color: var(--text-light);
    cursor: pointer;
    transition: color 0.2s;
    z-index: 10;
}
.close:hover {
    color: var(--primary-green);
}

@media (max-width: 600px) {
    .modal-content {
        padding: 1rem 0.5rem 1rem 0.5rem;
        min-width: unset;
        max-width: 98vw;
    }
    .modal-body {
        flex-direction: column;
        gap: 1rem;
    }
}
/* Color Palette */
:root {
    --primary-green: #2d8659;
    --accent-green: #4ade80;
    --light-green: #f0f9f4;
    --dark-green: #1e5a3a;
    --text-dark: #1f2937;
    --text-light: #6b7280;
    --white: #ffffff;
    --border-light: #e5e7eb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-800: #1f2937;
    --blue-500: #3b82f6;
    --red-500: #ef4444;
    --yellow-500: #eab308;
    --purple-500: #8b5cf6;
}

/* Role badges */
.role-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.role-admin {
    background: #fee2e2;
    color: #dc2626;
}

.role-staff {
    background: #dbeafe;
    color: #2563eb;
}

.role-head {
    background: #f3e8ff;
    color: #7c3aed;
}

.role-system {
    background: #f3f4f6;
    color: #6b7280;
}

/* Enhanced status indicators */
.status {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-success {
    background: #dcfce7;
    color: #16a34a;
}

.status-failed {
    background: #fee2e2;
    color: #dc2626;
}

.status-neutral {
    background: #f1f5f9;
    color: #64748b;
}

.status-info {
    background: #dbeafe;
    color: #2563eb;
}

.status-warning {
    background: #fef3c7;
    color: #d97706;
}

/* Additional CSS variables */
:root {
    --sidebar-width: 280px;
    --header-height: 70px;
    --bg-light: #f8fafc;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* General Styles and Layout (adapted from admin-styles.css) */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg-light);
    color: var(--text-dark);
    line-height: 1.6;
}

.staff-layout {
    display: flex;
    min-height: 100vh;
}

.sidebar {
    width: var(--sidebar-width);
    background: var(--white);
    box-shadow: var(--shadow);
    position: fixed;
    height: 100vh;
    left: 0;
    top: 0;
    z-index: 1000;
    transition: transform 0.3s ease;
    overflow-y: auto;
}

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    display: none;
}

.sidebar.mobile-open {
    transform: translateX(0);
}

.sidebar-overlay.active {
    display: block;
}

.sidebar-header {
    background: #2d8659;
    padding: 3rem 0 2rem 0;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 140px;
}

.sidebar-logo {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.sidebar-logo img {
    width: 130px;
    height: 130px;
    object-fit: cover;
    border: none;
    background: transparent;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.sidebar-nav {
    padding: 1rem 0;
}

.nav-section {
    margin-bottom: 2rem;
}

.nav-section-title {
    padding: 0 1.5rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-light);
}

.nav-item {
    margin-bottom: 0.25rem;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 0.875rem 1.5rem;
    color: var(--text-dark);
    text-decoration: none;
    transition: all 0.2s ease;
    position: relative;
}

.nav-link:hover {
    background: var(--light-green);
    color: var(--primary-green);
}

.nav-link.active {
    background: var(--light-green);
    color: var(--primary-green);
    border-right: 3px solid var(--primary-green);
}

.nav-link i {
    width: 20px;
    margin-right: 0.875rem;
    font-size: 1.125rem;
}

/* Notification Badge */
.notification-badge {
    background: #dc3545;
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: auto;
    padding: 0 6px;
    opacity: 0;
    transform: scale(0);
    transition: all 0.2s ease;
}

.notification-badge.show {
    opacity: 1;
    transform: scale(1);
}

.notification-badge.pulse {
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

/* Announcements Styles */
.announcements-header {
    margin-bottom: 2rem;
}

.page-header {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    text-align: center;
}

.page-main-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
}

.page-description {
    font-size: 1.125rem;
    color: var(--text-light);
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
}

.announcements-viewer-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    overflow: hidden;
}

.viewer-header {
    background: linear-gradient(135deg, #f8fafc 0%, white 100%);
    padding: 2rem 1.5rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    position: relative;
}

.viewer-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary-green);
}

.viewer-title-section {
    flex: 1;
}

.viewer-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.viewer-title i {
    color: var(--primary-green);
}

.viewer-subtitle {
    font-size: 0.875rem;
    color: var(--text-light);
}

.viewer-actions {
    display: flex;
    gap: 0.75rem;
}

.action-btn {
    width: 42px;
    height: 42px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.action-btn:hover {
    background: #f8fafc;
    color: var(--primary-green);
    border-color: var(--primary-green);
    transform: translateY(-1px);
}

.viewer-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 1rem 1.5rem;
    background: white;
    border-bottom: 1px solid #e5e7eb;
}

.search-box {
    position: relative;
    flex: 1;
    max-width: 320px;
}

.search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
    font-size: 0.9rem;
    z-index: 1;
}

.search-input {
    width: 100%;
    padding: 0.625rem 1rem 0.625rem 2.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.9rem;
    background: white;
    transition: all 0.2s ease;
    color: var(--text-dark);
}

.search-input:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(45, 134, 89, 0.1);
}

.filter-controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-left: auto;
}

.filter-select {
    padding: 0.625rem 0.875rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.9rem;
    background: white;
    color: var(--text-dark);
    min-width: 140px;
    transition: all 0.2s ease;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(45, 134, 89, 0.1);
}

.announcement-stats {
    display: flex;
    gap: 2rem;
    padding: 1.5rem;
    background: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
    justify-content: center;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.stat-item.urgent .stat-value {
    color: #ef4444;
}

.stat-label {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-dark);
}

.announcements-timeline {
    padding: 2rem;
    min-height: 200px;
}

.announcement-item {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.2s ease;
    position: relative;
    cursor: pointer;
}

.announcement-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: #d1d5db;
    transform: translateY(-1px);
}

.announcement-item.unread {
    border-left: 4px solid var(--primary-green);
    background: linear-gradient(135deg, #f0fdf4 0%, white 100%);
}

.announcement-item.urgent {
    border-left: 4px solid #ef4444;
}

.announcement-item.high {
    border-left: 4px solid #f59e0b;
}

.announcement-header {
    margin-bottom: 1rem;
}

.announcement-title-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.announcement-item h4 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-dark);
    line-height: 1.4;
    flex: 1;
}

.announcement-badges {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-shrink: 0;
}

.priority-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.priority-badge.normal {
    background: #e5e7eb;
    color: #4b5563;
}

.priority-badge.high {
    background: #fef3c7;
    color: #d97706;
}

.priority-badge.urgent {
    background: #fee2e2;
    color: #dc2626;
}

.category-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 500;
    background: #f3f4f6;
    color: #6b7280;
}

.target-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 500;
}

.target-badge.staff-only {
    background: rgba(34, 197, 94, 0.1);
    color: #16a34a;
    border: 1px solid rgba(34, 197, 94, 0.2);
}

.target-badge.all-users {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
}

.announcement-content {
    margin-bottom: 1rem;
}

.announcement-message {
    font-size: 0.95rem;
    line-height: 1.6;
    color: var(--text-dark);
    word-wrap: break-word;
}

.announcement-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #f3f4f6;
}

.announcement-footer small {
    color: var(--text-light);
    font-size: 0.8rem;
}

.announcement-footer small i {
    margin-right: 0.25rem;
    color: #9ca3af;
}

.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-light);
}

.empty-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 1.5rem;
    color: var(--text-light);
}

.empty-state h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
}

.empty-state p {
    font-size: 0.95rem;
    color: var(--text-light);
    max-width: 400px;
    margin: 0 auto;
    line-height: 1.5;
}

/* Mobile responsiveness for announcements */
@media (max-width: 768px) {
    .viewer-controls {
        flex-direction: column;
        gap: 0.75rem;
        align-items: stretch;
    }
    
    .search-box {
        max-width: none;
    }
    
    .filter-controls {
        margin-left: 0;
        gap: 0.5rem;
    }
    
    .filter-select {
        min-width: 120px;
        font-size: 0.8rem;
    }
    
    .announcement-stats {
        gap: 1rem;
        padding: 1rem;
        flex-wrap: wrap;
    }
    
    .stat-item {
        min-width: 80px;
    }
    
    .announcement-title-row {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
    }
}

.main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    min-height: 100vh;
    transition: margin-left 0.3s ease;
}

.header {
    background: var(--white);
    height: var(--header-height);
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 2rem;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sidebar-toggle {
    display: none;
    background: none;
    border: none;
    font-size: 1.25rem;
    color: var(--text-dark);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.2s ease;
}

.page-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-dark);
}

.header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.search-box {
    position: relative;
}

.search-box input {
    padding: 0.5rem 1rem 0.5rem 2.5rem;
    border: 1px solid var(--border-light);
    border-radius: 20px;
    width: 300px;
    background: var(--bg-light);
    transition: all 0.2s ease;
}

.search-box i {
    position: absolute;
    left: 0.875rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.notification-btn {
    position: relative;
    background: none;
    border: none;
    font-size: 1.25rem;
    color: var(--text-light);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.2s ease;
}

.notification-btn.active,
.sidebar-nav .nav-link.active[data-section="notifications"] i,
.sidebar-nav .nav-link.active[data-section="notifications"] span {
    color: var(--primary-green) !important;
    background: var(--light-green);
}

.user-menu {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1rem;
    background: var(--white);
    border: 1px solid var(--border-light);
    border-radius: 50px;
    cursor: default;
    transition: none;
}



.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-green);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-weight: 600;
}

.user-info {
    display: flex;
    flex-direction: column;
}

.user-name {
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1;
}

.user-role {
    font-size: 0.75rem;
    color: var(--text-light);
    line-height: 1;
}

.content {
    padding: 2rem;
}

.content-section {
    display: none;
}

.content-section.active {
    display: block;
}

/* Card and Stat Cards */
.card {
    background: var(--white);
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 2rem;
    margin-bottom: 2rem;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.card-title {
    font-size: 1.25rem;
    font-weight: 600;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
}

.stat-card {
    background: var(--white);
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.stat-header {
    margin-bottom: 1rem;
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--white);
}

.stat-icon.blue { background: #3b82f6; }
.stat-icon.green { background: #10b981; }
.stat-icon.yellow { background: #f59e0b; }
.stat-icon.purple { background: #8b5cf6; }

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--primary-green);
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-light);
    font-weight: 500;
}

/* Table Styles for Inspection Requests */
.table-responsive {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th, .data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border-light);
}

.data-table th {
    background: var(--bg-light);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    color: var(--text-light);
}

/* Darker table header for view requests table (override) */
.view-requests-table th {
    color: #1a202c !important;
}
.data-table th.centered-col,
.data-table td.centered-col {
    text-align: center;
    vertical-align: middle;
}
.data-table th.centered-col,
.data-table td.centered-col {
    padding-left: 30px; /* Move header and numbers further to the left */
}
.data-table td strong {
    font-size: 1.12em;
    letter-spacing: 0.5px;
}

/* Form Styles for Update Records & Notifications */
.record-update-form, .notification-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
}

.form-group input, .form-group textarea {
    padding: 0.75rem;
    border: 1px solid var(--border-light);
    border-radius: 8px;
    font-family: 'Poppins', sans-serif;
    font-size: 1rem;
    transition: border-color 0.2s ease;
}

.form-group input:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--primary-green);
}

.form-help {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
    font-style: italic;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
}

/* Decline Modal Specific Styles */
#declineRequestModal .modal-content {
    animation: slideInDown 0.3s ease-out;
}

#declineRequestModal textarea {
    transition: border-color 0.2s ease;
}

#declineRequestModal textarea:focus {
    border-color: var(--primary-green) !important;
    box-shadow: 0 0 0 3px rgba(45, 110, 63, 0.1);
}

#declineRequestModal textarea.error {
    border-color: #dc3545 !important;
    animation: shake 0.3s ease-in-out;
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Buttons */
.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease, transform 0.2s ease;
    border: none;
}

.btn-primary {
    background: var(--primary-green);
    color: var(--white);
}

.btn-primary:hover {
    background: var(--dark-green);
    transform: translateY(-2px);
}

/* Calendar Styles */
#dashboard-calendar {
    max-width: 100%;
    margin: 0 auto;
    padding: 1rem 0;
    min-height: 400px; /* Adjust the height as needed */
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.calendar-table {
    width: 100%;
    border-collapse: collapse;
    text-align: center;
    font-size: 1rem;
    min-height: 320px;
}
.calendar-table th,
.calendar-table td {
    width: 48px;
    height: 48px;
    min-width: 48px;
    min-height: 48px;
    max-width: 48px;
    max-height: 48px;
    box-sizing: border-box;
    padding: 0;
    text-align: center;
    vertical-align: middle;
    border: 1px solid #e5e7eb;
    aspect-ratio: 1 / 1; /* Ensures perfect square even if resized */
}
.calendar-table th {
    color: var(--primary-green);
    font-weight: 600;
    background: var(--light-green);
}
.calendar-table td {
    border-radius: 0;
    transition: background 0.2s;
    cursor: pointer;
    font-size: 1rem;
}
/* Removed conflicting scheduled style - using the new green theme instead */
.calendar-table td.holiday {
    background: var(--red-500) !important;
    border: 2px solid var(--red-500) !important;
    color: var(--white) !important;
    font-weight: bold;
    border-radius: 4px;
}
.calendar-table td.today {
    border: 2px solid var(--primary-green);
}
.calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}
.calendar-nav button {
    background: var(--primary-green);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 0.25rem 0.75rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
}
.calendar-nav button:hover {
    background: var(--dark-green);
}
/* Remove or comment out the legend styles if you want to fully remove them visually
.calendar-legend {
    display: none;
}
*/
.calendar-legend {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    margin-top: 0.5rem;
    font-size: 0.95rem;
}
.calendar-legend span {
    display: inline-flex;
    align-items: center;
    gap: 0.4em;
}
.calendar-legend .legend-box {
    display: inline-block;
    width: 18px;
    height: 18px;
    border-radius: 4px;
    vertical-align: middle;
}
.calendar-legend .scheduled { background: var(--primary-green); }
.calendar-legend .holiday { background: var(--red-500); }
/* Google Calendar Inspired Styles */
.calendar-container {
    background: var(--white);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border-light);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    padding: 1.5rem 2rem 1rem 2rem;
    background: var(--white);
    border-bottom: 1px solid var(--border-light);
}

.calendar-view-toggle {
    display: flex;
    background: var(--gray-100);
    border-radius: 24px;
    padding: 4px;
    gap: 0;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.view-btn {
    padding: 8px 16px;
    border: none;
    background: transparent;
    color: var(--text-light);
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    min-width: 70px;
}

.view-btn:hover {
    background: var(--gray-200);
}

.view-btn.active {
    background: var(--primary-green);
    color: var(--white);
    font-weight: 600;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

.calendar-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    background: #ffffff;
    border-bottom: 1px solid #e0e0e0;
}

.calendar-nav {
    display: flex;
    align-items: center;
    gap: 12px;
}

.nav-btn {
    background: none;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    color: #5f6368;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.nav-btn:hover {
    background: #f1f3f4;
}

.today-btn {
    background: #ffffff;
    border: 1px solid #dadce0;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    color: #3c4043;
}

.today-btn:hover {
    background: rgba(16, 185, 129, 0.1);
    border-color: var(--primary-green);
    color: var(--primary-green);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.prev-btn, .next-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}

.calendar-title {
    font-size: 22px;
    font-weight: 400;
    color: #3c4043;
    margin: 0;
    margin-left: 8px;
}

/* Calendar toolbar styling */
.calendar-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.calendar-actions {
    display: flex;
    gap: 10px;
}

.block-date-btn {
    background: #e74c3c !important;
    color: white !important;
    border: none !important;
}

.block-date-btn:hover {
    background: #c0392b !important;
}

/* Block Date Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    max-width: 90%;
    max-height: 90%;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
}

.modal-header h3 {
    margin: 0;
    color: #333;
    font-size: 1.3rem;
}

.close {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #aaa;
}

.close:hover {
    color: #333;
}

.modal-body {
    padding: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
}

.form-group textarea {
    resize: vertical;
    font-family: inherit;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.btn-primary {
    background: #27ae60;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
}

.btn-primary:hover {
    background: #219a52;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
}

.btn-secondary:hover {
    background: #7f8c8d;
}



.calendar-view {
    padding: 0;
}

/* Month View Styles */
.calendar-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    table-layout: fixed;
    background: #ffffff;
}

.calendar-table th {
    background: #ffffff;
    color: #70757a;
    font-weight: 500;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    padding: 16px 8px 8px 8px;
    text-align: center;
    border-bottom: 1px solid #e8eaed;
}

.calendar-table td {
    height: 136px;
    padding: 0;
    border-right: 1px solid #e8eaed;
    border-bottom: 1px solid #e8eaed;
    vertical-align: top;
    position: relative;
    background: #ffffff;
    cursor: pointer;
    transition: background-color 0.1s ease;
}

.calendar-table td:hover {
    background: #f8f9fa;
}

.calendar-table td.holiday:hover {
    background: #f8f9fa;
}

.calendar-table td.holiday-national:hover {
    background: #f8f9fa;
}

.calendar-table td.holiday-religious:hover {
    background: #f8f9fa;
}

.calendar-table td.holiday-special:hover {
    background: #f8f9fa;
}

.calendar-table td:last-child {
    border-right: none;
}

.calendar-table tbody tr:last-child td {
    border-bottom: none;
}

.day-content {
    padding: 8px;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.day-number {
    font-size: 14px;
    font-weight: 400;
    color: var(--text-dark);
    margin-bottom: 4px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.calendar-table td.other-month {
    background: var(--gray-100);
}

.calendar-table td.other-month .day-number {
    color: var(--text-light);
}

.calendar-table td.other-month:hover {
    background: var(--gray-200);
}

.calendar-table td.today .day-number {
    background: var(--primary-green);
    color: var(--white);
    font-weight: 500;
}

.calendar-table td.today:hover .day-number {
    background: var(--dark-green);
}

.calendar-events {
    display: flex;
    flex-direction: column;
    gap: 2px;
    max-height: 84px;
    overflow: hidden;
    flex: 1;
}

.calendar-event {
    background: var(--primary-green);
    color: #ffffff;
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    line-height: 16px;
    cursor: pointer;
    transition: background-color 0.1s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    border-left: 3px solid var(--primary-green);
}

.calendar-event:hover {
    background: #059669;
    border-left-color: #059669;
}

.calendar-event.event-green {
    background: #137333;
    border-left-color: #137333;
}

.calendar-event.event-green:hover {
    background: #0f5132;
    border-left-color: #0f5132;
}

.calendar-event.event-red {
    background: var(--primary-green);
    border-left-color: var(--primary-green);
}

.calendar-event.event-red:hover {
    background: #059669;
    border-left-color: #059669;
}

.more-events {
    color: #5f6368;
    font-size: 11px;
    cursor: pointer;
    margin-top: 2px;
    padding: 1px 0;
}

/* Holiday Highlighting Styles */
.calendar-table td.holiday {
    background: #f39c9c !important;
    border: 2px solid #c0392b !important;
    color: #333333 !important;
    position: relative;
}

.calendar-table td.holiday-national {
    background: #f39c9c !important;
    border: 2px solid #c0392b !important;
    color: #333333 !important;
}

.calendar-table td.holiday-religious {
    background: #f39c9c !important;
    border: 2px solid #c0392b !important;
    color: #333333 !important;
}

.calendar-table td.holiday-special {
    background: #f39c9c !important;
    border: 2px solid #c0392b !important;
    color: #333333 !important;
}

.calendar-table td.holiday .day-number {
    color: #333333 !important;
    font-weight: normal;
}

.calendar-table td.holiday-national .day-number {
    color: #333333 !important;
    font-weight: normal;
}

.calendar-table td.holiday-religious .day-number {
    color: #333333 !important;
    font-weight: normal;
}

.calendar-table td.holiday-special .day-number {
    color: #333333 !important;
    font-weight: normal;
}

/* Blocked Date Styles - Exact same as holidays */
.calendar-table td.blocked {
    background: #f39c9c !important;
    border: 2px solid #c0392b !important;
    color: #333333 !important;
    position: relative;
}

.calendar-table td.blocked:hover {
    background: #f39c9c !important;
    border: 2px solid #c0392b !important;
    transform: none;
}

.calendar-table td.blocked .day-number {
    color: #333333 !important;
    font-weight: normal;
}

.blocked-note {
    font-size: 8px;
    font-weight: 600;
    color: white;
    text-align: center;
    line-height: 1.1;
    margin-top: 2px;
}

.blocked-reason {
    font-size: 7px;
    font-weight: normal;
    opacity: 0.9;
}

.blocked-indicator {
    position: absolute;
    top: 2px;
    right: 2px;
    font-size: 10px;
    z-index: 1;
}

.holiday-indicator {
    font-size: 9px;
    font-weight: 600;
    padding: 1px 2px;
    border-radius: 2px;
    margin: 2px 0 0 0;
    line-height: 1.1;
    text-align: center;
    border: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    display: block;
    font-style: normal;
    color: #8b0000 !important;
    background: rgba(139, 0, 0, 0.1);
}

.holiday-indicator.national {
    color: #8b0000 !important;
    background: rgba(139, 0, 0, 0.1);
}

.holiday-indicator.special {
    color: #8b0000 !important;
    background: rgba(139, 0, 0, 0.1);
}

.holiday-indicator.religious {
    color: #8b0000 !important;
    background: rgba(139, 0, 0, 0.1);
}

.inspection-note {
    font-size: 0.6rem;
    color: white;
    background: var(--primary-green);
    padding: 1px 3px;
    border-radius: 2px;
    margin-top: 2px;
    text-align: center;
    font-weight: 500;
}

/* Today + Holiday combination */
.calendar-table td.today.holiday .day-number {
    background: var(--primary-green);
    color: white;
    font-weight: 600;
}

/* Week View Styles */
.week-container {
    overflow-x: auto;
    border: 1px solid #dadce0;
    border-radius: 8px;
}

.week-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 700px;
}

.week-time-header {
    background: #fafbfc;
    padding: 0.75rem 0.5rem;
    text-align: center;
    font-weight: 600;
    color: #5f6368;
    font-size: 0.875rem;
    border-right: 1px solid #dadce0;
    border-bottom: 1px solid #dadce0;
    width: 80px;
    min-width: 80px;
}

.week-day-header {
    background: #fafbfc;
    padding: 0.75rem 0.5rem;
    text-align: center;
    font-weight: 500;
    color: #5f6368;
    border-right: 1px solid #dadce0;
    border-bottom: 1px solid #dadce0;
    width: calc((100% - 80px) / 7);
    min-width: 100px;
}

.week-day-header:last-child {
    border-right: none;
}

.week-day-header.today {
    background: #e8f5e8;
    color: var(--primary-green);
    font-weight: 600;
}

.week-day-name {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.week-day-number {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 0.25rem;
}

.week-time-slot {
    background: #fafbfc;
    padding: 0.75rem 0.5rem;
    font-size: 0.75rem;
    color: #5f6368;
    text-align: center;
    border-right: 1px solid #dadce0;
    border-bottom: 1px solid #dadce0;
    font-weight: 500;
    width: 80px;
    min-width: 80px;
}

.week-day-slot {
    background: white;
    height: 60px;
    padding: 0.25rem;
    border-right: 1px solid #dadce0;
    border-bottom: 1px solid #dadce0;
    vertical-align: top;
    position: relative;
}

.week-day-slot:last-child {
    border-right: none;
}

.week-event {
    background: var(--primary-green);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
    cursor: pointer;
    line-height: 1.2;
}

.week-event:hover {
    opacity: 0.8;
}

/* Agenda View Styles */
.agenda-view {
    max-height: 400px;
    overflow-y: auto;
}

.agenda-section {
    margin-bottom: 1.5rem;
}

.agenda-date {
    font-size: 1rem;
    font-weight: 600;
    color: #3c4043;
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--primary-green);
}

.agenda-events {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.agenda-event {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid var(--primary-green);
}

.agenda-event-content {
    flex: 1;
}

.agenda-event-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.agenda-event-time {
    font-size: 0.875rem;
    font-weight: 500;
    color: #5f6368;
    min-width: 80px;
}

.agenda-event-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: #3c4043;
    flex: 1;
}

.agenda-event-note {
    font-size: 0.8rem;
    color: #5f6368;
    margin-top: 0.25rem;
}

.agenda-event-status {
    font-size: 0.8rem;
    margin-top: 0.5rem;
}

.btn-complete {
    background: var(--primary-green);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.btn-complete:hover {
    background: #059669;
    transform: translateY(-1px);
}

.btn-reschedule {
    background-color: var(--warning-orange, #ff9800);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-reschedule:hover {
    background-color: #f57c00;
    transform: translateY(-1px);
}

.completed-badge {
    background: #10b981;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Inspection Details Modal Styles */
.inspection-details {
    padding: 1rem 0;
}

.detail-row {
    margin-bottom: 1rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e5e7eb;
}

.detail-row:last-child {
    border-bottom: none;
}

.action-buttons {
    border-top: 1px solid #e5e7eb;
    padding-top: 1rem;
}

.completed-info {
    border-top: 1px solid #e5e7eb;
    padding-top: 1rem;
}

.no-events {
    text-align: center;
    color: #9aa0a6;
    padding: 2rem;
    font-style: italic;
}

/* Responsive Styles */
@media (max-width: 1024px) {
    .staff-layout {
        flex-direction: column;
    }
    .sidebar {
        width: 100%;
        height: auto;
        position: relative;
    }
    .main-content {
        margin-left: 0;
    }
}
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        width: 280px;
        position: fixed;
        height: 100vh;
        z-index: 1001;
    }
    .sidebar.mobile-open {
        transform: translateX(0);
    }
    .main-content {
        margin-left: 0;
    }
    .sidebar-toggle {
        display: block;
    }
    .search-box input {
        width: 200px;
    }
    .header {
        padding: 0 1rem;
    }
    
    .header-actions {
        gap: 0.5rem;
    }
    
    .user-menu {
        padding: 0.4rem 0.8rem;
    }
    
    .user-info {
        display: flex;
        flex-direction: column;
    }
    
    .user-name {
        font-size: 0.75rem;
    }
    
    .user-role {
        font-size: 0.7rem;
        color: var(--text-light);
    }
    
    .user-avatar {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }

    /* Mobile Calendar Styles */
    .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }

    .calendar-view-toggle {
        order: -1;
        width: 100%;
        justify-content: center;
    }

    .view-btn {
        flex: 1;
        text-align: center;
    }

    .calendar-toolbar {
        padding: 12px 16px;
        flex-wrap: wrap;
        gap: 8px;
    }

    .calendar-nav {
        flex-wrap: wrap;
        gap: 8px;
    }

    .calendar-title {
        font-size: 18px;
        order: -1;
        width: 100%;
        margin: 0 0 8px 0;
    }

    .today-btn {
        padding: 6px 12px;
        font-size: 13px;
    }

    .prev-btn, .next-btn {
        width: 28px;
        height: 28px;
    }

    .calendar-table th {
        padding: 12px 4px 6px 4px;
        font-size: 10px;
    }

    .calendar-table td {
        height: 100px;
    }

    .day-content {
        padding: 4px;
    }

    .day-number {
        font-size: 12px;
        width: 24px;
        height: 24px;
    }

    .calendar-events {
        gap: 1px;
        max-height: 60px;
    }

    .calendar-event {
        font-size: 10px;
        padding: 1px 4px;
        line-height: 14px;
    }

    .calendar-table td.holiday .day-number {
        width: 24px;
        height: 24px;
        font-size: 12px;
        color: #dc2626 !important;
        font-weight: 600 !important;
    }
    
    .holiday-indicator {
        font-size: 7px !important;
        padding: 0.5px 2px !important;
        margin: 0.5px 0 0 0 !important;
    }
    
    .holiday-indicator.national {
        color: #6b7280 !important;
        background: transparent !important;
    }
    
    .holiday-indicator.special,
    .holiday-indicator.religious {
        color: #6b7280 !important;
        background: transparent !important;
    }

    .agenda-event {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .agenda-event-time {
        min-width: auto;
    }

    /* Week View Mobile Fixes */
    .week-table {
        min-width: 600px;
    }

    .week-time-header,
    .week-time-slot {
        width: 60px;
        min-width: 60px;
        padding: 0.5rem 0.25rem;
        font-size: 0.7rem;
    }

    .week-day-header {
        padding: 0.5rem 0.25rem;
        min-width: 80px;
    }

    .week-day-name {
        font-size: 0.65rem;
    }

    .week-day-number {
        font-size: 1rem;
    }

    .week-day-slot {
        height: 50px;
        padding: 0.1rem;
        min-width: 80px;
    }

    .week-event {
        font-size: 0.65rem;
        padding: 0.1rem 0.3rem;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }
}

/* Extra Small Mobile Devices - Week View Fix */
@media (max-width: 480px) {
    .user-menu {
        padding: 0.3rem 0.6rem;
        gap: 0.5rem;
    }
    
    .user-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
    }
    
    .user-info .user-name {
        font-size: 0.75rem;
    }
    
    .user-info .user-role {
        font-size: 0.65rem;
    }

    .week-table {
        min-width: 480px;
        font-size: 0.7rem;
    }

    .week-time-header,
    .week-time-slot {
        width: 45px;
        min-width: 45px;
        padding: 0.3rem 0.1rem;
        font-size: 0.6rem;
    }

    .week-day-header {
        padding: 0.3rem 0.1rem;
        min-width: 60px;
    }

    .week-day-name {
        font-size: 0.6rem;
    }

    .week-day-number {
        font-size: 0.9rem;
    }

    .week-day-slot {
        height: 40px;
        padding: 0.05rem;
        min-width: 60px;
    }

    .week-event {
        font-size: 0.55rem;
        padding: 0.05rem 0.2rem;
        margin-bottom: 0.1rem;
    }
}

/* View Requests Table Styles */
.view-requests-table {
    font-size: 0.85rem;
    width: 100%;
}

.view-requests-table th {
    background: var(--primary-green);
    color: white;
    font-weight: 600;
    text-align: center;
    padding: 0.75rem 0.5rem;
    border-bottom: 2px solid var(--primary-green);
    white-space: nowrap;
}

.view-requests-table td {
    padding: 0.75rem 0.5rem;
    text-align: center;
    vertical-align: middle;
    border-bottom: 1px solid #e0e0e0;
}

.purpose-cell {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.action-buttons {
    display: flex;
    gap: 0.3rem;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-sm {
    padding: 0.3rem 0.6rem;
    font-size: 0.75rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    transition: all 0.2s ease;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary-green);
    color: white;
}

.btn-primary:hover {
    background: #2d7c3e;
    transform: translateY(-1px);
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
    transform: translateY(-1px);
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.btn-info:hover {
    background: #138496;
    transform: translateY(-1px);
}

.btn-outline {
    background: transparent;
    color: var(--primary-green);
    border: 1px solid var(--primary-green);
}

.btn-outline:hover {
    background: var(--primary-green);
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

/* Status Badge Styles */
.status-badge {
    padding: 0.3rem 0.6rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-badge.pending {
    background: #ffeaa7;
    color: #d63031;
}

.status-badge.accepted {
    background: #00b894;
    color: white;
}

.status-badge.declined {
    background: #fd79a8;
    color: #e84393;
}

.status-badge.scheduled {
    background: #74b9ff;
    color: #0984e3;
}

.status-badge.completed {
    background: #00b894;
    color: white;
}

.status-badge.cancelled {
    background: #fd79a8;
    color: #e84393;
}

/* Category Badge Styles */
.category-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
    text-align: center;
    min-width: 70px;
}

.category-badge.land-property {
    background: #f8f9fa;
    color: #495057;
    border: 1px solid #dee2e6;
}

.category-badge.machinery {
    background: #e3f2fd;
    color: #1565c0;
    border: 1px solid #bbdefb;
}

.category-badge.building {
    background: #e8f5e8;
    color: #2e7d32;
    border: 1px solid #c8e6c9;
}

/* Card Actions */
.card-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

/* Details Grid */
.details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin: 1rem 0;
}

.details-grid > div {
    padding: 0.5rem;
    border-bottom: 1px solid #f0f0f0;
}

.details-grid strong {
    color: var(--primary-green);
    font-weight: 600;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .view-requests-table {
        font-size: 0.8rem;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 0.2rem;
    }
    
    .btn-sm {
        font-size: 0.7rem;
        padding: 0.25rem 0.4rem;
    }
}

@media (max-width: 768px) {
    .view-requests-table th,
    .view-requests-table td {
        padding: 0.5rem 0.3rem;
    }
    
    .details-grid {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .card-actions {
        flex-direction: column;
        gap: 0.5rem;
    }
}

/* Form Select Styling */
.form-select {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    font-size: 0.9rem;
    color: var(--primary-green);
    cursor: pointer;
    min-width: 200px;
}

.form-select:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 2px rgba(52, 168, 83, 0.2);
}

.form-select option {
    padding: 0.5rem;
    color: #333;
}

/* Workflow Enhancement Styles */
.ready-to-schedule {
    background-color: rgba(76, 175, 80, 0.1);
    border-left: 4px solid #4CAF50;
}

.highlight-count {
    font-weight: bold;
    color: #4CAF50;
    font-size: 1.1em;
}

.btn-success {
    background-color: #4CAF50;
    color: white;
    border: 1px solid #4CAF50;
    animation: pulse-success 2s infinite;
}

@keyframes pulse-success {
    0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
    100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
}

.btn-success:hover {
    background-color: #45a049;
    border-color: #45a049;
}

.btn-danger {
    background-color: #f44336;
    color: white;
    border: 1px solid #f44336;
}

.btn-danger:hover {
    background-color: #da190b;
    border-color: #da190b;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.action-buttons .btn {
    margin: 0.1rem;
}

/* Status badges for incoming requests */
.status-badge.incoming {
    background-color: #ff9800;
    color: white;
}

.status-badge.pending {
    background-color: #2196F3;
    color: white;
}

.status-badge.scheduled {
    background-color: #4CAF50;
    color: white;
}

.status-badge.completed {
    background-color: #9E9E9E;
    color: white;
}

/* Table enhancements */
.data-table th {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
}

.purpose-cell {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Mobile responsiveness for action buttons */
@media (max-width: 768px) {
    .action-buttons {
        flex-direction: column;
    }
    
    .action-buttons .btn {
        width: 100%;
        margin: 0.2rem 0;
    }
}

/* Enhanced Announcement Styles (matching admin design) */
.announcements-viewer-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    overflow: hidden;
}

.viewer-header {
    background: linear-gradient(135deg, #f8fafc 0%, white 100%);
    padding: 2rem 1.5rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    position: relative;
}

.viewer-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary-color);
}

.viewer-title-section {
    flex: 1;
}

.viewer-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.viewer-title i {
    color: var(--primary-color);
}

.viewer-subtitle {
    font-size: 0.875rem;
    color: #6b7280;
}

.viewer-actions {
    display: flex;
    gap: 0.75rem;
}

.action-btn {
    width: 42px;
    height: 42px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.action-btn:hover {
    background: #f8fafc;
    color: var(--primary-color);
    border-color: var(--primary-color);
    transform: translateY(-1px);
}

.viewer-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 1rem 1.5rem;
    background: white;
    border-bottom: 1px solid #e5e7eb;
}

.search-box {
    position: relative;
    flex: 1;
    max-width: 320px;
}

.search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    font-size: 0.9rem;
    z-index: 1;
}

.search-input {
    width: 100%;
    padding: 0.625rem 1rem 0.625rem 2.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.9rem;
    background: white;
    transition: all 0.2s ease;
    color: var(--text-color);
}

.search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(45, 134, 89, 0.1);
}

.filter-controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-left: auto;
}

.filter-select {
    padding: 0.625rem 0.875rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.9rem;
    background: white;
    color: var(--text-color);
    min-width: 140px;
    transition: all 0.2s ease;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(45, 134, 89, 0.1);
}

.announcement-stats {
    display: flex;
    gap: 2rem;
    padding: 1.5rem;
    background: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
    justify-content: center;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.stat-item.urgent .stat-value {
    color: #ef4444;
}

.stat-label {
    font-size: 0.8rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-color);
}

.announcements-timeline {
    padding: 2rem;
    min-height: 200px;
}

.announcement-item {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.2s ease;
    position: relative;
    cursor: pointer;
}

.announcement-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: #d1d5db;
    transform: translateY(-1px);
}

.announcement-item.unread {
    border-left: 4px solid var(--primary-color);
    background: linear-gradient(135deg, #f0fdf4 0%, white 100%);
}

.announcement-item.urgent {
    border-left: 4px solid #ef4444;
}

.announcement-item.high {
    border-left: 4px solid #f59e0b;
}

.announcement-header {
    margin-bottom: 1rem;
}

.announcement-title-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.announcement-item h4 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-color);
    line-height: 1.4;
    flex: 1;
}

.announcement-badges {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-shrink: 0;
}

.priority-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.priority-badge.normal {
    background: #e5e7eb;
    color: #4b5563;
}

.priority-badge.high {
    background: #fef3c7;
    color: #d97706;
}

.priority-badge.urgent {
    background: #fee2e2;
    color: #dc2626;
}

.category-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 500;
    background: #f3f4f6;
    color: #6b7280;
}

.target-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 500;
}

.target-badge.admin-only {
    background: rgba(34, 197, 94, 0.1);
    color: #16a34a;
    border: 1px solid rgba(34, 197, 94, 0.2);
}

.target-badge.all-users {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
}

.announcement-content {
    margin-bottom: 1rem;
}

.announcement-message {
    font-size: 0.95rem;
    line-height: 1.6;
    color: var(--text-color);
    word-wrap: break-word;
}

.announcement-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #f3f4f6;
}

.announcement-footer small {
    color: #6b7280;
    font-size: 0.8rem;
}

.announcement-footer small i {
    margin-right: 0.25rem;
    color: #9ca3af;
}

.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: #6b7280;
}

.empty-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 1.5rem;
    color: #6b7280;
}

.empty-state h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.5rem;
}

.empty-state p {
    font-size: 0.95rem;
    color: #6b7280;
    max-width: 400px;
    margin: 0 auto;
    line-height: 1.5;
}

/* Mobile responsiveness for announcements */
@media (max-width: 768px) {
    .viewer-controls {
        flex-direction: column;
        gap: 1rem;
    }
    
    .search-box {
        max-width: none;
    }
    
    .filter-controls {
        margin-left: 0;
        width: 100%;
        justify-content: space-between;
    }
    
    .announcement-stats {
        gap: 1rem;
    }
    
    .announcements-timeline {
        padding: 1rem;
    }
    
    .announcement-title-row {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .announcement-badges {
        align-self: flex-start;
    }
}
/* Responsive additions for small screens */
@media (max-width: 1024px) {
    /* Make header controls stack and shrink spacing */
    .viewer-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
    }
    .viewer-controls .search-box {
        max-width: 100%;
        width: 100%;
    }
    .viewer-controls .action-btn {
        width: 100%;
        justify-content: center;
    }

    /* Make table controls wrap nicely (targets inline styled flex container) */
    .table-container > div > div[style*="display: flex"][style*="justify-content: space-between"] {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
    }

    .table-container select,
    .table-container button {
        width: auto;
        min-width: 0;
    }

    .data-table th,
    .data-table td {
        padding: 0.75rem 0.5rem;
        font-size: 0.95rem;
    }

    img {
        max-width: 100%;
        height: auto;
    }
}

@media (max-width: 768px) {
    /* Mobile sidebar: off-canvas by default */
    .sidebar {
        position: fixed;
        left: -280px;
        top: 0;
        z-index: 1000;
        width: 280px;
        height: 100vh;
        transition: left 0.3s ease;
        background: white;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    /* Show sidebar when mobile-open class is added */
    .sidebar.mobile-open {
        left: 0;
    }

    /* Sidebar overlay for mobile */
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .sidebar-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    /* Ensure main content fills the screen and remove excess padding */
    .main-content {
        margin-left: 0 !important;
        padding: 0 !important;
    }

    .content {
        padding: 0.75rem !important;
    }

    .header {
        margin: 0 !important;
        padding: 0 1rem !important;
    }

    /* Make sure hamburger toggle is visible and functional */
    .sidebar-toggle {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        background: transparent !important;
        color: var(--text-dark) !important;
        border: none !important;
        padding: 0.6rem !important;
        border-radius: 8px !important;
        cursor: pointer !important;
        font-size: 1.4rem !important;
        min-width: 48px !important;
        min-height: 48px !important;
        transition: background 0.2s ease !important;
        width: auto !important;
        height: auto !important;
    }

    .sidebar-toggle:hover {
        background: var(--gray-100);
    }

    .sidebar-toggle:active {
        background: var(--gray-200);
    }

    /* Adjust header for mobile */
    .header {
        padding: 0 1rem;
    }

    .header-left {
        gap: 0.75rem;
    }

    .page-title {
        font-size: 1.25rem;
    }

    /* Make filter controls full width for easier tapping */
    #yearFilter, #monthFilter, #clearFiltersBtn, #refreshHistoryBtn {
        width: 100% !important;
        box-sizing: border-box;
    }

                /* Make action buttons and touch targets larger */
    .action-btn, .schedule-btn, button {
        padding: 0.75rem 1rem !important;
        font-size: 1rem !important;
    }

    /* Table responsiveness: allow horizontal scroll and optimize padding */
    .table-container > div + div {
        overflow-x: auto;
    }

    .data-table th, .data-table td {
        white-space: nowrap;
    }
}

@media (max-width: 420px) {
    /* Further reduce paddings and font-sizes for very small screens */
    .page-main-title { font-size: 1.25rem; }
    .page-description { font-size: 0.85rem; }
    .data-table th, .data-table td { font-size: 0.9rem; padding: 0.5rem 0.4rem; }
    .modal-content { padding: 0.75rem; }
    .sidebar-logo img { width: 90px; height: 90px; }
}
    </style>

        <script>
        // Utility to get initials from a name string
        function getInitials(name) {
            if (!name) return '';
            const words = name.trim().split(/\s+/).filter(Boolean);
            if (words.length === 1) {
                return words[0][0].toUpperCase();
            }
            return (words[0][0] + words[words.length - 1][0]).toUpperCase();
        }

        // Set initials in the avatar
        function setUserAvatarInitials(userName) {
            const avatar = document.querySelector('.user-avatar');
            if (avatar) {
                avatar.textContent = getInitials(userName);
            }
        }

        // Observe changes to the .user-name element and update avatar
        document.addEventListener('DOMContentLoaded', function() {
            const userNameElem = document.querySelector('.user-name');
            if (!userNameElem) return;

            // Initial set
            setUserAvatarInitials(userNameElem.textContent.trim());

            // Watch for changes
            const observer = new MutationObserver(function() {
                setUserAvatarInitials(userNameElem.textContent.trim());
            });
            observer.observe(userNameElem, { childList: true, characterData: true, subtree: true });
        });
        </script>

        <script>
        // Utility to get initials from a name string
        function getInitials(name) {
            if (!name) return '';
            // Split by space, filter out empty, take first char of first two words
            const words = name.trim().split(/\s+/).filter(Boolean);
            if (words.length === 1) {
                return words[0][0].toUpperCase();
            }
            return (words[0][0] + words[words.length - 1][0]).toUpperCase();
        }

        // Set initials in the avatar
        function setUserAvatarInitials(userName) {
            const avatar = document.querySelector('.user-avatar');
            if (avatar) {
                avatar.textContent = getInitials(userName);
            }
        }

        // Example: Set the user name here (replace with dynamic value as needed)
        document.addEventListener('DOMContentLoaded', function() {
            // You may fetch/set the user name dynamically here
            var userName = document.querySelector('.user-name')?.textContent?.trim();
            if (!userName) {
                // Fallback: set a default name for demo
                userName = 'Staff';
            }
            setUserAvatarInitials(userName);
        });
        </script>
</head>
<body>
    <div class="staff-layout">
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="../images/logo.png" alt="Logo" style="width: 130px; height: 130px; object-fit: contain; border: none; background: transparent;">
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <div class="nav-item">
                        <a href="#" class="nav-link active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Communications</div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-section="announcements">
                            <i class="fas fa-bullhorn"></i>
                            <span>Announcements</span>
                            <span class="notification-badge" id="announcementCount">0</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-section="notifications" id="sidebarNotificationsLink">
                            <i class="fas fa-bell"></i>
                            <span>Notifications</span>
                            <span class="notification-badge" id="notificationCount">0</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Inspections</div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-section="inspection-requests">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Inspection Requests</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-section="view-requests">
                            <i class="fas fa-eye"></i>
                            <span>View</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-section="inspection-history">
                            <i class="fas fa-history"></i>
                            <span>Inspection History</span>
                        </a>
                    </div>
                </div>



                <div class="nav-section logout-section" style="margin-top:auto;">
                    <div class="nav-item">
                        <a href="#" class="nav-link" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <main class="main-content" id="mainContent">
        <!-- Schedule Modal Popup -->
        <div id="scheduleModal" class="modal" style="display:none;">
            <div class="modal-content" style="width: 580px; max-width: 95%; margin: auto; background: #ffffff; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); overflow: hidden; max-height: 90vh; display: flex; flex-direction: column;">
                <!-- Header -->
                <div class="modal-header" style="background: #2d8659; color: white; padding: 18px 24px; position: relative; border-bottom: none; flex-shrink: 0;">
                    <h2 style="margin: 0; font-weight: 600; font-size: 18px; color: white;">Schedule Batch Inspection</h2>
                    <button class="close" id="closeScheduleModal" style="position: absolute; right: 18px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); border: none; color: white; font-size: 18px; cursor: pointer; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'"></button>
                </div>
                
                <!-- Body -->
                <div class="modal-body" style="flex: 1; padding: 24px; background: #fff; overflow-y: auto; min-height: 0;">

                    <!-- Form -->
                    <div style="display: block; width: 100%;">
                        
                        <!-- Date Selection Calendar -->
                        <div class="date-section" style="margin-bottom: 24px; width: 100%;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #333; margin-bottom: 8px;">Inspection Date</label>
                            
                            <!-- Hidden input for form submission -->
                            <input type="hidden" id="scheduleDate">
                            
                            <!-- Date Picker Button -->
                            <button type="button" id="datePickerBtn" 
                                    style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; background: white; transition: border-color 0.2s; box-sizing: border-box; font-family: inherit; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                                    onfocus="this.style.borderColor='#2d8659'" 
                                    onblur="this.style.borderColor='#ddd'">
                                <span id="datePickerText" style="color: #999;">Click to select date...</span>
                                <span style="color: #666;"></span>
                            </button>
                            
                            <!-- Calendar Widget (Initially Hidden) -->
                            <div id="calendarWidget" class="calendar-responsive" style="display: none; border: 1px solid #d1d5db; border-radius: 6px; background: white; overflow: hidden; margin-top: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; z-index: 10; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;">
                                
                                <!-- Calendar Header -->
                                <div style="background: linear-gradient(135deg, #2d8659 0%, #238a4f 100%); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
                                    <button type="button" id="prevMonth" style="background: rgba(255,255,255,0.15); border: none; color: white; cursor: pointer; font-size: 16px; padding: 6px 8px; border-radius: 4px; transition: all 0.2s; font-weight: 600;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'"></button>
                                    <span id="currentMonth" style="font-weight: 600; font-size: 14px; color: white; flex: 1; text-align: center; letter-spacing: 0.5px;"></span>
                                    <button type="button" id="nextMonth" style="background: rgba(255,255,255,0.15); border: none; color: white; cursor: pointer; font-size: 16px; padding: 6px 8px; border-radius: 4px; transition: all 0.2s; font-weight: 600;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'"></button>
                                </div>
                                
                                <!-- Days of Week Header -->
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                                    <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">S</div>
                                    <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">M</div>
                                    <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">T</div>
                                    <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">W</div>
                                    <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">T</div>
                                    <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">F</div>
                                    <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">S</div>
                                </div>
                                
                                <!-- Calendar Days Grid -->
                                <div id="calendarDays" style="display: grid; grid-template-columns: repeat(7, 1fr); background: #fff; gap: 0;">
                                    <!-- Days will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Selected date display -->
                            <div id="selectedDateDisplay" style="font-size: 10px; color: #666; margin-top: 4px; padding: 4px 6px; background: #f8f9fa; border-radius: 3px; text-align: center;">
                                Select an available date for batch inspection scheduling
                            </div>
                            
                            <!-- Enhanced Batch Scheduling Legend -->
                            <div style="margin-top: 12px; padding: 8px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 10px; font-weight: 600; color: #374151; margin-bottom: 6px; text-align: center;">Calendar Legend</div>
                                
                                <!-- Main Status Colors -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <div style="width: 12px; height: 12px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 3px;"></div>
                                        <span style="font-size: 8px; color: #374151;">Available</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <div style="width: 12px; height: 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 3px;"></div>
                                        <span style="font-size: 8px; color: #374151;">Unavailable</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <div style="width: 12px; height: 12px; background: #fffbeb; border: 1px solid #fed7aa; border-radius: 3px;"></div>
                                        <span style="font-size: 8px; color: #374151;">Holiday/Event</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <div style="width: 12px; height: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 3px;"></div>
                                        <span style="font-size: 8px; color: #374151;">Weekend/Past</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes Section -->
                        <div class="notes-section" style="width: 100%; margin-top: 24px;">
                            <label for="scheduleNote" style="display: block; font-size: 13px; font-weight: 600; color: #333; margin-bottom: 8px;">
                                Notes 
                            </label>
                            <textarea id="scheduleNote" rows="4" 
                                      style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 12px 16px; resize: none; font-size: 13px; line-height: 1.5; font-family: inherit; background: white; transition: border-color 0.2s; box-sizing: border-box;"
                                      onfocus="this.style.borderColor='#2d8659'" 
                                      onblur="this.style.borderColor='#ddd'"
                                      placeholder="Add specific instructions, requirements, or notes for the inspection team..."></textarea>
                            <div style="font-size: 11px; color: #666; margin-top: 6px;">Provide detailed instructions to help the inspection team prepare and understand specific requirements for this batch.</div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="modal-footer" style="padding: 16px 24px; background: #f8f9fa; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0;">

                    <button type="button" id="cancelScheduleBtn"
                                style="background: #fff; color: #6c757d; border: 1px solid #ccc; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;"
                                onmouseover="this.style.background='#f8f9fa'" 
                                onmouseout="this.style.background='#fff'">
                            Cancel
                        </button>
                    <button id="saveScheduleBtn" 
                            style="background: #2d8659; color: white; border: 1px solid #2d8659; padding: 8px 18px; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 13px; transition: background-color 0.2s;"
                            onmouseover="this.style.background='#236449'" 
                            onmouseout="this.style.background='#2d8659'">
                        Schedule Inspection
                    </button>
                </div>
            </div>
        </div>        <!-- Professional Success Modal -->
        <div id="successModal" class="modal" style="display:none;">
            <div class="modal-content" style="max-width: 600px; margin: 5% auto;">
                <div class="modal-header" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; padding: 25px 30px; border-radius: 8px 8px 0 0; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;"></div>
                    <h3 style="margin: 0; font-weight: 300; font-size: 26px;">Inspection Successfully Scheduled!</h3>
                </div>
                
                <div class="modal-body" style="padding: 30px;">
                    <div id="successDetails" style="background: #f1f8e9; padding: 20px; border-radius: 8px; border-left: 5px solid #4caf50;">
                        <!-- Success details will be populated here -->
                    </div>
                    
                    <div id="emailResults" style="margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px; border-left: 5px solid #2196f3;">
                        <h4 style="margin: 0 0 15px 0; color: #2d8659;"> Email Notifications</h4>
                        <div id="emailStatus">
                            <!-- Email status will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer" style="padding: 20px 30px; background: #f8f9fa; border-radius: 0 0 8px 8px; text-align: center; border-top: 1px solid #e0e0e0;">
                    <button onclick="document.getElementById('successModal').style.display='none'" 
                            style="background: #4caf50; color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 16px;">
                        Ok
                    </button>
                </div>
            </div>
        </div>

        <style>
            /* Enhanced form styling for scheduling modal */
            #scheduleDate:focus, #scheduleNote:focus {
                outline: none;
                border-color: #4caf50 !important;
                box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
                transform: translateY(-1px);
            }
            
            #scheduleDate:hover, #scheduleNote:hover {
                border-color: #81c784;
            }
            
            #scheduleNote {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            /* Full Width Form Sections */
            .modal-body .date-section,
            .modal-body .notes-section {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .modal-body > div:nth-child(1) {
                display: block !important;
                width: 100% !important;
            }
            
            .calendar-responsive {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Professional Modal Animation */
            #scheduleModal.show {
                animation: modalFadeIn 0.4s ease-out;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                box-sizing: border-box;
                pointer-events: auto;
            }
            
            #scheduleModal .modal-content {
                transform: none !important;
                top: auto !important;
                position: relative;
                margin: 0;
                animation: professionalSlideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
                overflow: visible;
            }
            
            @keyframes modalFadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            @keyframes professionalSlideIn {
                from {
                    opacity: 0;
                    transform: scale(0.9) translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }
            
            /* Responsive adjustments */
            /* Responsive Design for Mobile */
            @media (max-width: 768px) {
                #scheduleModal .modal-content {
                    width: 95%;
                    max-width: 95%;
                    margin: 10px auto;
                }
                
                #scheduleModal .modal-body {
                    padding: 24px;
                }
                
                #scheduleModal .modal-header {
                    padding: 20px 24px;
                }
                
                #scheduleModal .modal-header h2 {
                    font-size: 18px;
                }
                
                #scheduleModal .modal-footer {
                    padding: 20px 24px;
                    flex-direction: column;
                    gap: 12px;
                }
                
                #scheduleModal .modal-footer button {
                    width: 100%;
                    justify-content: center;
                }
            }
            
            @media (max-width: 480px) {
                #scheduleModal .modal-content {
                    width: 95%;
                    margin: 8px auto;
                }
                
                #scheduleModal .modal-body {
                    padding: 20px;
                }
                
                #scheduleModal .modal-header {
                    padding: 18px 20px;
                }
                
                #scheduleModal .modal-footer {
                    padding: 16px 20px;
                }
            }

/* Mobile Responsive Styles for Inspection Calendar */
@media (max-width: 768px) {
    .calendar-container {
        margin: 0 -1rem;
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    .card-header {
        padding: 1rem;
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .calendar-view-toggle {
        align-self: center;
    }
    
    .calendar-toolbar {
        padding: 0.75rem 1rem;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .calendar-nav {
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 0;
    }
    
    .calendar-title {
        font-size: 1.1rem;
        margin: 0 0.5rem;
    }
    
    .calendar-actions {
        justify-content: center;
    }
    
    .nav-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.85rem;
    }
    
    .today-btn {
        padding: 0.4rem 0.8rem;
    }
    
    /* Mobile Calendar Table */
    .calendar-table td {
        height: 80px !important;
        padding: 2px;
    }
    
    .day-content {
        padding: 4px;
    }
    
    .day-number {
        font-size: 12px;
        width: 24px;
        height: 24px;
        margin-bottom: 2px;
    }
    
    .inspection-note {
        font-size: 9px;
        padding: 1px 3px;
        margin: 1px 0;
        border-radius: 2px;
        line-height: 1.1;
    }
    
    .calendar-note {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
}

@media (max-width: 480px) {
    .card-header {
        padding: 0.75rem;
    }
    
    .calendar-title {
        font-size: 1rem;
    }
    
    .calendar-nav {
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .nav-btn {
        padding: 0.3rem 0.5rem;
        font-size: 0.8rem;
    }
    
    .today-btn {
        padding: 0.3rem 0.6rem;
    }
    
    /* Very Small Mobile Calendar */
    .calendar-table th {
        padding: 8px 2px 4px 2px !important;
        font-size: 9px;
    }
    
    .calendar-table td {
        height: 60px !important;
        padding: 1px;
    }
    
    .day-content {
        padding: 2px;
    }
    
    .day-number {
        font-size: 10px;
        width: 20px;
        height: 20px;
    }
    
    .inspection-note {
        font-size: 8px;
        padding: 1px 2px;
        margin: 0.5px 0;
    }
    
    /* Optimize space usage */
    .calendar-actions .nav-btn i {
        margin-right: 2px;
    }
    
    .calendar-actions .nav-btn {
        font-size: 0.75rem;
    }
    
    .block-date-btn {
        padding: 0.3rem 0.4rem;
    }
    
    .view-btn {
        padding: 6px 12px;
        font-size: 12px;
        min-width: 60px;
    }
}

/* Mobile Modal Fixes for Inspection Lists */
@media (max-width: 768px) {
    /* Fix inspection modal scrolling on mobile */
    #inspectionModal .modal-content {
        max-height: 85vh;
        margin: 5vh auto;
        display: flex;
        flex-direction: column;
    }
    
    #inspectionModal .modal-body {
        overflow-y: auto;
        max-height: calc(85vh - 100px);
        padding: 1rem;
        -webkit-overflow-scrolling: touch;
    }
    
    #inspectionModal .modal-header {
        flex-shrink: 0;
    }
    
    /* Style the inspection list items for mobile */
    #inspectionModal .inspection-item {
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: #f9fafb;
    }
    
    #inspectionModal .inspection-details {
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    #inspectionModal .inspection-buttons {
        margin-top: 0.5rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    #inspectionModal button {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        flex: 1;
        min-width: 80px;
    }
}

@media (max-width: 480px) {
    /* Even more compact for very small screens */
    #inspectionModal .modal-content {
        max-height: 90vh;
        margin: 2vh auto;
        width: 95%;
    }
    
    #inspectionModal .modal-body {
        max-height: calc(90vh - 80px);
        padding: 0.75rem;
    }
    
    #inspectionModal .inspection-item {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
    }
    
    #inspectionModal .inspection-details {
        font-size: 0.85rem;
    }
    
    #inspectionModal button {
        font-size: 0.8rem;
        padding: 0.35rem 0.6rem;
    }
    
    #inspectionModal .modal-header {
        padding: 0.75rem;
    }
    
    #inspectionModal .modal-title {
        font-size: 1rem;
    }
}
            
            /* Professional notification styling */
            .professional-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                max-width: 400px;
                z-index: 10000;
                animation: slideInRight 0.4s ease-out;
            }
            
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            .validation-error {
                background: linear-gradient(135deg, #ffebee, #ffcdd2);
                border: 1px solid #f44336;
                color: #c62828;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
            }
            
            .validation-error .error-title {
                font-weight: 600;
                margin-bottom: 5px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .validation-error .error-message {
                font-size: 14px;
                color: #666;
                line-height: 1.4;
            }
        </style>

        <script>
            function validateScheduleDate() {
                const dateInput = document.getElementById('scheduleDate');
                const selectedDate = new Date(dateInput.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (selectedDate <= today) {
                    dateInput.style.borderColor = '#f44336';
                    dateInput.title = 'Please select a future date';
                    return false;
                } else {
                    dateInput.style.borderColor = '#4caf50';
                    dateInput.title = 'Valid date selected';
                    return true;
                }
            }

            function showProfessionalSuccess(details) {
                const modal = document.getElementById('successModal');
                const successDetails = document.getElementById('successDetails');
                const emailResults = document.getElementById('emailResults');
                
                // Populate success details
                successDetails.innerHTML = `
                    <h4 style="margin: 0 0 15px 0; color: #2e7d32;"> Inspection Details</h4>
                    <div style="margin: 8px 0;"><strong>Barangay:</strong> ${details.barangay}</div>
                    <div style="margin: 8px 0;"><strong>Date:</strong> ${new Date(details.date).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</div>
                    <div style="margin: 8px 0;"><strong>Properties:</strong> ${details.requestCount} inspections scheduled</div>
                    <div style="margin: 8px 0;"><strong>Note:</strong> ${details.note}</div>
                `;
                
                // Populate email results
                let emailHtml = '';
                if (details.emails_sent !== undefined) {
                    const success = details.emails_sent;
                    const total = details.total_clients || details.requestCount;
                    
                    if (success > 0) {
                        emailHtml += `<div style="color: #2e7d32; margin: 8px 0;"> <strong>${success}/${total}</strong> clients notified successfully</div>`;
                        emailHtml += `<div style="color: #666; font-size: 14px;">All affected property owners have been informed about the scheduled inspection.</div>`;
                    }
                    
                    if (success < total) {
                        const failed = total - success;
                        emailHtml += `<div style="color: #f57c00; margin: 8px 0;"> <strong>${failed}</strong> email(s) could not be delivered</div>`;
                        emailHtml += `<div style="color: #666; font-size: 14px;">Some clients may need to be contacted manually.</div>`;
                    }
                } else {
                    emailHtml = '<div style="color: #666;">Email notification status not available</div>';
                }
                
                document.getElementById('emailStatus').innerHTML = emailHtml;
                
                modal.style.display = 'block';
            }

            // Enhanced modal population when opening schedule modal
            function populateScheduleModal(barangay, requestCount) {
                // Note: Batch info section was removed, so we don't set those elements anymore
                
                // Clear previous values
                document.getElementById('scheduleDate').value = '';
                document.getElementById('scheduleNote').value = '';
                
                // Reset date picker button text
                const datePickerText = document.getElementById('datePickerText');
                if (datePickerText) {
                    datePickerText.textContent = 'Click to select date...';
                    datePickerText.style.color = '#999';
                }
                
                // Set minimum date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('scheduleDate').min = tomorrow.toISOString().split('T')[0];
                
                // Add placeholder text with context
                const noteTextarea = document.getElementById('scheduleNote');
                noteTextarea.placeholder = `Enter inspection details for ${barangay}...\n\nExample:\n Focus on property boundaries\n Check structural integrity\n Verify property documents\n ${requestCount} properties to be inspected`;
            }
        </script>

        <!-- Calendar Widget JavaScript -->
        <script>
            // Calendar state variables
            let currentCalendarDate = new Date();
            let selectedDate = null;
            let calendarData = null;

            // Initialize calendar when modal opens
            function initializeCalendar() {
                currentCalendarDate = new Date();
                selectedDate = null;
                document.getElementById('scheduleDate').value = '';
                
                // Reset date picker button
                const datePickerText = document.getElementById('datePickerText');
                datePickerText.textContent = 'Click to select date...';
                datePickerText.style.color = '#999';
                
                // Hide calendar initially and setup button click handler
                const calendar = document.getElementById('calendarWidget');
                const dateBtn = document.getElementById('datePickerBtn');
                
                calendar.style.display = 'none';
                
                // Add click event to show calendar
                dateBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (calendar.style.display === 'none' || calendar.style.display === '') {
                        calendar.style.display = 'block';
                        loadCalendarData();
                    } else {
                        calendar.style.display = 'none';
                    }
                });
                
                // Hide calendar when clicking outside the date picker area only
                document.addEventListener('click', function(event) {
                    const dateSection = dateBtn.closest('div'); // The date selection div
                    if (!calendar.contains(event.target) && 
                        !dateBtn.contains(event.target) && 
                        dateSection && 
                        !dateSection.contains(event.target)) {
                        calendar.style.display = 'none';
                    }
                });
                
                // Setup navigation event listeners
                document.getElementById('prevMonth').addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                    loadCalendarData();
                });
                
                document.getElementById('nextMonth').addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                    loadCalendarData();
                });
            }

            // Load calendar availability data from backend (for batch scheduling)
            async function loadCalendarData() {
                try {
                    const month = currentCalendarDate.getMonth() + 1;
                    const year = currentCalendarDate.getFullYear();
                    
                    const response = await fetch(`../backend/get_batch_calendar_availability.php?month=${month}&year=${year}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        calendarData = data;
                        renderCalendar();
                    } else {
                        console.error('Failed to load calendar data:', data.error);
                        showCalendarError('Failed to load calendar data');
                    }
                } catch (error) {
                    console.error('Calendar fetch error:', error);
                    showCalendarError('Failed to connect to server');
                }
            }

            // Render the calendar
            function renderCalendar() {
                if (!calendarData) return;
                
                // Update month header
                document.getElementById('currentMonth').textContent = 
                    `${calendarData.monthName} ${calendarData.year}`;
                
                const calendarDays = document.getElementById('calendarDays');
                calendarDays.innerHTML = '';
                
                // Calculate first day of month (Sunday = 0, Monday = 1, etc. - standard JS)
                const firstDay = new Date(calendarData.year, currentCalendarDate.getMonth(), 1);
                const startDay = firstDay.getDay(); // Use default: Sunday = 0
                
                // Add empty cells for days before first day of month
                for (let i = 0; i < startDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.style.cssText = 'height: 32px; width: 100%; box-sizing: border-box; margin: 1px;';
                    calendarDays.appendChild(emptyCell);
                }
                
                // Add calendar days
                calendarData.availability.forEach(dayData => {
                    const dayCell = createDayCell(dayData);
                    calendarDays.appendChild(dayCell);
                });
            }

            // Create individual day cell with disabled state handling
            function createDayCell(dayData) {
                const cell = document.createElement('div');
                cell.style.cssText = `
                    height: 32px;
                    width: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    position: relative;
                    transition: all 0.15s ease;
                    box-sizing: border-box;
                    border: 1px solid transparent;
                    margin: 1px;
                    border-radius: 4px;
                    font-weight: 500;
                `;
                
                // Check if this date is blocked
                const isBlocked = window.staffDashboard && window.staffDashboard.isDateBlocked && 
                                 window.staffDashboard.isDateBlocked(dayData.date);
                
                // Determine styling based on batch scheduling status
                let backgroundColor, textColor, cursor, isDisabled, tooltipText = '';
                
                // Check for blocked dates first (highest priority)
                if (isBlocked) {
                    backgroundColor = '#fffbeb';
                    textColor = '#d97706';
                    cursor = 'not-allowed';
                    isDisabled = true;
                    cell.style.border = '1px solid #fed7aa';
                    const blockInfo = window.staffDashboard.getBlockedDateInfo(dayData.date);
                    tooltipText = `Blocked - ${blockInfo ? blockInfo.reason : 'Not available'}`;
                } else {
                    switch (dayData.status) {
                        case 'available':
                            // Green - Available for batching (with or without individual inspections)
                            backgroundColor = '#f0fdf4';
                            textColor = '#15803d';
                            cursor = 'pointer';
                            isDisabled = false;
                            cell.style.border = '1px solid #bbf7d0';
                            if (dayData.individualCount > 0) {
                                const inspectionText = dayData.totalInspections > 0 
                                    ? ` (${dayData.totalInspections} total scheduled)`
                                    : '';
                                tooltipText = `Available: ${dayData.individualCount} individual inspections${inspectionText} (${dayData.barangays || 'Various locations'})`;
                            } else if (dayData.hasBatchScheduled && dayData.totalInspections === 1) {
                                tooltipText = `Available: 1 batch scheduled, can schedule 1 more inspection`;
                            } else {
                                const inspectionText = dayData.totalInspections > 0 
                                    ? ` (${dayData.totalInspections} already scheduled)`
                                    : '';
                                tooltipText = `Available for scheduling batch inspection${inspectionText}`;
                            }
                            break;
                        case 'unavailable':
                            // Red - Not available (batch scheduled, no individuals, etc.)
                            backgroundColor = '#fef2f2';
                            textColor = '#b91c1c';
                            cell.style.border = '1px solid #fecaca';
                            if (dayData.hasReachedLimit) {
                                tooltipText = `Unavailable: Maximum 2 inspections per day (${dayData.totalInspections} scheduled)`;
                            } else if (dayData.hasBatchScheduled) {
                                tooltipText = 'Batch inspection already scheduled for this date';
                            } else {
                                tooltipText = dayData.reason || 'Not available';
                            }
                            cursor = 'not-allowed';
                            isDisabled = true;
                            break;
                        case 'holiday':
                            backgroundColor = '#fffbeb';
                            textColor = '#d97706';
                            cursor = 'not-allowed';
                            isDisabled = true;
                            cell.style.border = '1px solid #fed7aa';
                            tooltipText = `Holiday: ${dayData.holidayName || 'Not available'}`;
                            break;
                        case 'weekend':
                        case 'past':
                        default:
                            backgroundColor = '#f9fafb';
                            textColor = '#9ca3af';
                            cursor = 'not-allowed';
                            isDisabled = true;
                            cell.style.border = '1px solid #e5e7eb';
                            tooltipText = dayData.reason || 'Not available';
                            break;
                    }
                }
                
                // Apply styling
                cell.style.backgroundColor = backgroundColor;
                cell.style.color = textColor;
                cell.style.cursor = cursor;
                
                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.textContent = dayData.day;
                dayNumber.style.cssText = 'font-size: 12px; font-weight: 600; line-height: 1; font-family: inherit;';
                cell.appendChild(dayNumber);
                
                // Add status indicator for batch scheduling availability
                if (dayData.totalInspections > 0) {
                    const indicator = document.createElement('div');
                    
                    if (dayData.hasReachedLimit) {
                        // Show full indicator for dates at limit
                        indicator.textContent = '2';
                        indicator.style.cssText = `
                            width: 16px; height: 16px; 
                            background: #b91c1c; 
                            color: white;
                            border-radius: 50%; 
                            font-size: 9px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            position: absolute;
                            top: 1px;
                            right: 1px;
                            font-weight: 700;
                            border: 2px solid white;
                        `;
                    } else if (dayData.status === 'available') {
                        // Show count for available dates with some inspections
                        indicator.textContent = dayData.totalInspections;
                        indicator.style.cssText = `
                            width: 14px; height: 14px; 
                            background: #15803d; 
                            color: white;
                            border-radius: 50%; 
                            font-size: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            position: absolute;
                            top: 2px;
                            right: 2px;
                            font-weight: 600;
                        `;
                    } else {
                        // Show checkmark for unavailable dates with inspections
                        indicator.textContent = '';
                        indicator.style.cssText = `
                            width: 12px; height: 12px; 
                            background: #b91c1c; 
                            color: white;
                            border-radius: 50%; 
                            font-size: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            position: absolute;
                            top: 2px;
                            right: 2px;
                            font-weight: 600;
                        `;
                    }
                    
                    cell.appendChild(indicator);
                }
                
                // Add tooltip
                if (tooltipText) {
                    cell.title = tooltipText;
                }
                
                // Add click handler only for available dates
                if (!isDisabled) {
                    cell.addEventListener('mouseenter', () => {
                        cell.style.backgroundColor = '#dcfce7';
                        cell.style.borderColor = '#16a34a';
                        cell.style.transform = 'scale(1.05)';
                        cell.style.zIndex = '2';
                    });
                    
                    cell.addEventListener('mouseleave', () => {
                        if (selectedDate !== dayData.date) {
                            cell.style.backgroundColor = backgroundColor;
                            cell.style.borderColor = '#bbf7d0';
                            cell.style.transform = 'scale(1)';
                            cell.style.zIndex = '1';
                        }
                    });
                    
                    cell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectDate(dayData.date, cell);
                    });
                } else {
                    // Add tooltip for disabled dates
                    if (!tooltipText) {
                        if (dayData.status === 'holiday') {
                            tooltipText = `Holiday: ${dayData.holidayName || 'Public Holiday'}`;
                        } else if (dayData.status === 'booked' || dayData.hasScheduledInspections) {
                            tooltipText = `Unavailable`;
                        } else if (dayData.status === 'weekend') {
                            tooltipText = 'Weekend - Not available';
                        } else if (dayData.status === 'past') {
                            tooltipText = 'Past date - Cannot schedule';
                        }
                    }
                    
                    if (tooltipText) {
                        cell.title = tooltipText;
                    }
                    
                    // Visual indicator for disabled state
                    cell.style.opacity = '0.6';
                }
                
                return cell;
            }

            // Select a date (only available dates can be selected)
            function selectDate(date, cellElement) {
                // Clear previous selection styling
                document.querySelectorAll('#calendarDays > div').forEach(cell => {
                    const isAvailable = cell.style.cursor === 'pointer';
                    if (isAvailable) {
                        cell.style.backgroundColor = '#f0fdf4';
                        cell.style.borderColor = '#bbf7d0';
                        cell.style.transform = 'scale(1)';
                        cell.style.zIndex = '1';
                    }
                });
                
                // Highlight selected cell
                cellElement.style.backgroundColor = '#166534';
                cellElement.style.borderColor = '#166534';
                cellElement.style.color = 'white';
                cellElement.style.transform = 'scale(1.05)';
                cellElement.style.zIndex = '3';
                
                // Update selected date
                selectedDate = date;
                document.getElementById('scheduleDate').value = date;
                
                // Update display
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                document.getElementById('selectedDateDisplay').innerHTML = 
                    `<strong>Selected:</strong> ${formattedDate}`;
                document.getElementById('selectedDateDisplay').style.color = '#2d8659';
                
                // Update button text
                const datePickerText = document.getElementById('datePickerText');
                datePickerText.textContent = formattedDate;
                datePickerText.style.color = '#2d8659';
                
                // Hide calendar after selection
                document.getElementById('calendarWidget').style.display = 'none';
                
                // Validate the selection
                validateScheduleDate();
            }

            // Updated validation function for calendar
            function validateScheduleDate() {
                const dateInput = document.getElementById('scheduleDate');
                const selectedDateDisplay = document.getElementById('selectedDateDisplay');
                
                if (!dateInput.value) {
                    selectedDateDisplay.innerHTML = 'Please select an available date from the calendar';
                    selectedDateDisplay.style.color = '#dc3545';
                    return false;
                }
                
                selectedDateDisplay.style.color = '#2d8659';
                return true;
            }

            // Show calendar error
            function showCalendarError(message) {
                document.getElementById('calendarDays').innerHTML = 
                    `<div style="grid-column: span 7; text-align: center; padding: 20px; color: #dc3545;">
                        Error: ${message}
                    </div>`;
            }
        </script>

            <header class="header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">AssessPro</h1>
                </div>
                
                <div class="header-right">
                    <div class="header-actions">
                        <div class="user-menu">
                            <div class="user-avatar">S</div>
                            <div class="user-info">
                                <div class="user-name"></div>
                                <div class="user-role">Assessor</div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content">
                <div class="content-section active" id="dashboard">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon blue">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="pending-inspections">-</div>
                            <div class="stat-label">Pending Request</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon green">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="scheduled-inspections">-</div>
                            <div class="stat-label">Scheduled This Week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon purple">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="completed-inspections">-</div>
                            <div class="stat-label">Completed</div>
                        </div>
                    </div>
                    <!-- Calendar Card -->
                    <div class="card" style="margin-top:2rem;">
                        <div class="card-header">
                            <h2 class="card-title">Inspection Calendar</h2>
                            <div class="calendar-view-toggle">
                                <button class="view-btn active" data-view="month">Month</button>
                                <button class="view-btn" data-view="agenda">Agenda</button>
                            </div>
                        </div>
                        <div class="calendar-container">
                            <div class="calendar-toolbar">
                                <div class="calendar-nav">
                                    <button class="nav-btn today-btn" id="todayBtn">Today</button>
                                    <button class="nav-btn prev-btn" id="prevBtn">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="nav-btn next-btn" id="nextBtn">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                    <h2 class="calendar-title" id="calendarTitle"></h2>
                                </div>
                                <div class="calendar-actions">
                                    <button class="nav-btn block-date-btn" id="blockDateBtn">
                                        <i class="fas fa-ban"></i> Block Date
                                    </button>
                                </div>
                            </div>
                            <div id="calendarView"></div>
                        </div>
                    </div>
                </div>

                <!-- Block Date Modal -->
                <div id="blockDateModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>Block Date for Urgent Event</h3>
                            <span class="close" id="closeBlockDateModal">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="blockDateForm">
                                <div class="form-group">
                                    <label for="blockDate">Select Date to Block:</label>
                                    <input type="date" id="blockDate" name="blockDate" required>
                                    <small class="form-help">This date will be unavailable for all inspection requests</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="blockReason">Reason for Blocking:</label>
                                    <textarea id="blockReason" name="blockReason" rows="4" required 
                                              placeholder="e.g., Emergency department meeting, Staff training, Equipment maintenance, Holiday"></textarea>
                                </div>
                                
                                <div class="modal-actions">
                                    <button type="button" class="btn-secondary" id="cancelBlockDate">Cancel</button>
                                    <button type="submit" class="btn-primary">Block Date</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Recent System Activities Section -->
                    <div class="card" id="activitiesSection" style="margin-top: 2rem; display: none;">
                        <div class="card-header">
                            <h2 class="card-title">Recent System Activities</h2>
                            <button class="btn btn-secondary" id="refreshActivitiesBtn">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Role</th>
                                        <th>Action</th>
                                        <th>Timestamp</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="staff-activities-table">
                                    <tr>
                                        <td colspan="5" class="text-center">Click refresh to load activities...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="content-section" id="inspection-requests">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Inspection Requests</h2>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Barangay</th>
                                        <th class="centered-col">Land Property</th>
                                        <th class="centered-col">Machinery</th>
                                        <th class="centered-col">Building</th>
                                        <th class="centered-col">Total Pending</th>
                                        <th class="centered-col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inspection-requests-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Notifications Section -->
                <div class="content-section" id="notifications">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Incoming Requests - Review</h2>
                            <div class="card-actions">
                                <button class="btn btn-secondary" id="refreshNotificationsBtn">
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Request ID</th>
                                        <th>Client Name</th>
                                        <th>Email</th>
                                        <th>Category</th>
                                        <th>Property Class</th>
                                        <th>Barangay</th>
                                        <th>Purpose</th>
                                        <th>Date Submitted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="incoming-requests-table-body">
                                    <!-- Incoming requests will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- View Requests Section -->
                <div class="content-section" id="view-requests">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">View Inspection Requests</h2>
                            <div class="card-actions" style="display: flex; gap: 1rem; align-items: center;">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="viewRequestsSearch" placeholder="Search by name, ID, contact, landmark, or purpose...">
                                </div>
                                <select id="barangayFilter" class="form-select">
                                    <option value="all">All Barangays</option>
                                    <option value="Poblacion">Barangay Poblacion</option>
                                    <option value="Anilao Proper">Barangay Anilao Proper</option>
                                    <option value="Anilao East">Barangay Anilao East</option>
                                    <option value="Bagalangit">Barangay Bagalangit</option>
                                    <option value="Bulacan">Barangay Bulacan</option>
                                    <option value="Calamias">Barangay Calamias</option>
                                    <option value="Estrella">Barangay Estrella</option>
                                    <option value="Gasang">Barangay Gasang</option>
                                    <option value="Laurel">Barangay Laurel</option>
                                    <option value="Ligaya">Barangay Ligaya</option>
                                    <option value="Mainaga">Barangay Mainaga</option>
                                    <option value="Mainit">Barangay Mainit</option>
                                    <option value="Majuben">Barangay Majuben</option>
                                    <option value="Malimatoc-1">Barangay Malimatoc-1</option>
                                    <option value="Malimatoc-2">Barangay Malimatoc-2</option>
                                    <option value="Nag-Iba">Barangay Nag-Iba</option>
                                    <option value="Pilahan">Barangay Pilahan</option>
                                    <option value="P. Anahao">Barangay P. Anahao</option>
                                    <option value="P. Balibaguhan">Barangay P. Balibaguhan</option>
                                    <option value="P. Lupa">Barangay P. Lupa</option>
                                    <option value="P. Niogan">Barangay P. Niogan</option>
                                    <option value="Saguing">Barangay Saguing</option>
                                    <option value="Sampaguita">Barangay Sampaguita</option>
                                    <option value="San Francisco">Barangay San Francisco</option>
                                    <option value="San Jose">Barangay San Jose</option>
                                    <option value="San Juan">Barangay San Juan</option>
                                    <option value="San Teodoro">Barangay San Teodoro</option>
                                    <option value="Solo">Barangay Solo</option>
                                    <option value="Sta. Ana">Barangay Sta. Ana</option>
                                    <option value="Sta. Mesa">Barangay Sta. Mesa</option>
                                    <option value="Sto. Nio">Barangay Sto. Nio</option>
                                    <option value="Sto. Tomas">Barangay Sto. Tomas</option>
                                    <option value="Talaga Proper">Barangay Talaga Proper</option>
                                    <option value="Talaga East">Barangay Talaga East</option>
                                </select>
                                <button class="btn btn-secondary" id="refreshViewBtn">
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table view-requests-table">
                                <thead>
                                    <tr>
                                        <th>Request ID</th>
                                        <th>Client Name</th>
                                        <th>Client Email</th>
                                        <th>Contact Number</th>
                                        <th>Category</th>
                                        <th>Location/Barangay</th>
                                        <th>Landmark</th>
                                        <th>Land Reference</th>
                                        <th>Contact Person</th>
                                        <th>Purpose and Preferred Date</th>
                                        <th>Valid ID</th>
                                        <th>Date Submitted</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="view-requests-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Announcements Section -->
                <div class="content-section" id="announcements">
                    <div class="announcements-header">
                        <div class="page-header">
                            <h1 class="page-main-title">System Announcements</h1>
                            <p class="page-description">View important announcements from the Head Assessor</p>
                        </div>
                    </div>

                    <div class="announcements-viewer-card">
                        <div class="viewer-header">
                            <div class="viewer-title-section">
                                <h2 class="viewer-title">
                                    <i class="fas fa-bullhorn"></i>
                                    Recent Announcements
                                </h2>
                                <p class="viewer-subtitle">Stay updated with system notifications and important messages</p>
                            </div>
                            <div class="viewer-actions">
                                <button class="action-btn" id="refreshAnnouncements" title="Refresh">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="action-btn" id="markAllRead" title="Mark All as Read">
                                    <i class="fas fa-check-double"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="viewer-controls">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="announcementSearch" placeholder="Search announcements..." class="search-input">
                            </div>
                            <div class="filter-controls">
                                <select id="priorityFilter" class="filter-select">
                                    <option value="all">All Priorities</option>
                                    <option value="urgent">Urgent</option>
                                    <option value="high">High Priority</option>
                                    <option value="normal">Normal</option>
                                </select>
                                <select id="categoryFilter" class="filter-select">
                                    <option value="all">All Categories</option>
                                    <option value="general">General</option>
                                    <option value="system">System</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="policy">Policy</option>
                                    <option value="emergency">Emergency</option>
                                    <option value="training">Training</option>
                                </select>
                            </div>
                        </div>

                        <div class="announcement-stats">
                            <div class="stat-item">
                                <span class="stat-label">Total</span>
                                <span class="stat-value" id="totalStaffAnnouncements">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Unread</span>
                                <span class="stat-value" id="unreadStaffAnnouncements">0</span>
                            </div>
                            <div class="stat-item urgent">
                                <span class="stat-label">Urgent</span>
                                <span class="stat-value" id="urgentStaffAnnouncements">0</span>
                            </div>
                        </div>
                        
                        <div id="staffAnnouncementsList" class="announcements-timeline">
                            <!-- Announcements will be dynamically added here -->
                            <div class="empty-state" id="no-staff-announcements">
                                <div class="empty-icon">
                                    <i class="fas fa-bullhorn"></i>
                                </div>
                                <h3>No announcements available</h3>
                                <p>There are currently no announcements for staff members</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inspection History Section -->
                <div class="content-section" id="inspection-history">
                    <div class="page-header">
                        <h1 class="page-main-title">Inspection History</h1>
                        <p class="page-description">View your completed inspections and their details</p>
                        <div style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 0.75rem 1rem; margin-top: 1rem; display: inline-block;">
                            <i class="fas fa-info-circle" style="color: #1976d2; margin-right: 0.5rem;"></i>
                            <span style="color: #1976d2; font-size: 0.9rem; font-weight: 500;">
                                This section shows completed inspections from both individual assessment requests and scheduled barangay inspections.
                            </span>
                        </div>
                    </div>
                    <!-- Inspection History Table -->
                    <div class="table-container" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                        <div style="padding: 1.5rem 1.5rem 1rem 1.5rem; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="margin: 0 0 0.5rem 0; color: #333;">Completed Inspections</h3>
                                    <p style="margin: 0; color: #666; font-size: 0.9rem;">Your inspection history</p>
                                </div>
                                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                    <!-- Year Filter -->
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <label for="yearFilter" style="font-size: 0.9rem; color: #555; font-weight: 500;">Year:</label>
                                        <select id="yearFilter" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white; cursor: pointer; min-width: 100px;">
                                            <option value="">All Years</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Month Filter -->
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <label for="monthFilter" style="font-size: 0.9rem; color: #555; font-weight: 500;">Month:</label>
                                        <select id="monthFilter" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white; cursor: pointer; min-width: 120px;">
                                            <option value="">All Months</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Clear Filter Button -->
                                    <button id="clearFiltersBtn" style="padding: 0.5rem 0.75rem; background: #6b7280; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;" title="Clear All Filters">
                                        <i class="fas fa-times"></i>
                                        Clear
                                    </button>
                                    
                                    <!-- Refresh Button -->
                                    <button id="refreshHistoryBtn" style="padding: 0.5rem 1rem; background: #2d8659; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;" title="Refresh Data">
                                        <i class="fas fa-sync-alt"></i>
                                        Refresh
                                    </button>
                                    
                                    <!-- Archive Button -->
                                    <button id="viewArchiveBtn" style="padding: 0.5rem 1rem; background: #6b7280; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;" title="View Archived Records">
                                        <i class="fas fa-archive"></i>
                                        Archive
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table class="data-table" style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #555; border-bottom: 1px solid #eee;">Date</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #555; border-bottom: 1px solid #eee;">Address</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #555; border-bottom: 1px solid #eee;">Category</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #555; border-bottom: 1px solid #eee;">Status</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #555; border-bottom: 1px solid #eee;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inspection-history-table-body">
                                    <tr>
                                        <td colspan="5" style="padding: 2rem; text-align: center; color: #666;">
                                            <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                                            <br>Loading inspection history...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div class="empty-state" id="no-inspection-history" style="display: none; text-align: center; padding: 3rem; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="empty-icon" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;">
                            <i class="fas fa-history"></i>
                        </div>
                        <h3 style="color: #666; margin-bottom: 0.5rem;">No inspection history found</h3>
                        <p style="color: #999; text-align: center;">You haven't completed any inspections yet, or no inspections match your current filters.</p>
                    </div>

                    <!-- Archived Inspections Table -->
                    <div class="table-container" id="archive-container" style="display: none; margin-top: 2rem; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                        <div style="padding: 1.5rem 1.5rem 1rem 1.5rem; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="margin: 0 0 0.5rem 0; color: #333; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-archive" style="color: #6b7280;"></i>
                                        Archived Inspection Records
                                    </h3>
                                    <p style="margin: 0; color: #666; font-size: 0.9rem;">Deleted inspection records that have been moved to archive</p>
                                </div>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <button id="refreshArchiveBtn" style="padding: 0.5rem 1rem; background: #2d8659; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;" title="Refresh Archive">
                                        <i class="fas fa-sync-alt"></i>
                                        Refresh
                                    </button>
                                    <button id="hideArchiveBtn" style="padding: 0.5rem 1rem; background: #6b7280; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;" title="Hide Archive">
                                        <i class="fas fa-times"></i>
                                        Hide
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table class="data-table" style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #555; border-bottom: 1px solid #eee;">Date</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #555; border-bottom: 1px solid #eee;">Address</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #555; border-bottom: 1px solid #eee;">Category</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #555; border-bottom: 1px solid #eee;">Status</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #555; border-bottom: 1px solid #eee;">Archived Date</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #555; border-bottom: 1px solid #eee;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="archived-inspections-table-body">
                                    <tr>
                                        <td colspan="6" style="padding: 2rem; text-align: center; color: #666;">
                                            <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                                            <br>Loading archived records...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty Archive State -->
                    <div class="empty-state" id="no-archived-inspections" style="display: none; text-align: center; padding: 3rem; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 2rem;">
                        <div class="empty-icon" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;">
                            <i class="fas fa-archive"></i>
                        </div>
                        <h3 style="color: #666; margin-bottom: 0.5rem;">No archived records found</h3>
                        <p style="color: #999; margin: 0;">No inspection records have been deleted yet.</p>
                    </div>
                </div>
                
                <!-- Delete Inspection Confirmation Modal -->
                <div id="deleteInspectionModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
                    <div class="modal-content" style="background: white; padding: 0; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); max-width: 500px; width: 90%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="padding: 1.5rem 2rem 1rem 2rem; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: white; border-radius: 12px 12px 0 0; z-index: 10;">
                            <h3 style="margin: 0; color: #374151; font-size: 1.25rem; font-weight: 600;">Delete Inspection Record</h3>
                        </div>
                        <div class="modal-body" style="padding: 1.5rem 2rem;">
                            <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="color: #ef4444; font-size: 2rem; flex-shrink: 0;">
                                    <i class="fas fa-trash-alt"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: #374151; font-size: 1.1rem; font-weight: 600;">Are you sure you want to delete this record?</h4>
                                    <p style="margin: 0 0 0.75rem 0; color: #6b7280; line-height: 1.5;">This action will move the inspection record to the archived section. The record will no longer appear in your active inspection history but can be viewed in the Archive section.</p>
                                    <div style="background: #fef3cd; border: 1px solid #f6e05e; border-radius: 6px; padding: 0.75rem; margin-top: 1rem;">
                                        <p style="margin: 0; color: #92400e; font-size: 0.9rem;"><strong><i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>Note:</strong> Deleted records can be restored from the Archive section if needed.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="padding: 1rem 2rem 1.5rem 2rem; border-top: 1px solid #e5e7eb; display: flex; gap: 1rem; justify-content: flex-end; background: #f9fafb; border-radius: 0 0 12px 12px;">
                            <button id="cancelDeleteInspection" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 500;" onmouseover="this.style.backgroundColor='#4b5563'" onmouseout="this.style.backgroundColor='#6b7280'">Cancel</button>
                            <button id="confirmDeleteInspection" class="btn btn-danger" style="padding: 0.75rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 500;" onmouseover="this.style.backgroundColor='#b91c1c'" onmouseout="this.style.backgroundColor='#dc2626'">
                                <i class="fas fa-trash" style="margin-right: 0.5rem;"></i>Delete Record
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recovery Confirmation Modal -->
                <div id="recoverInspectionModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
                    <div class="modal-content" style="background: white; padding: 0; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); max-width: 500px; width: 90%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="padding: 1.5rem 2rem 1rem 2rem; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: white; border-radius: 12px 12px 0 0; z-index: 10;">
                            <h3 style="margin: 0; color: #374151; font-size: 1.25rem; font-weight: 600;">Recover Inspection Record</h3>
                        </div>
                        <div class="modal-body" style="padding: 1.5rem 2rem;">
                            <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="color: #10b981; font-size: 2rem; flex-shrink: 0;">
                                    <i class="fas fa-undo"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: #374151; font-size: 1.1rem; font-weight: 600;">Are you sure you want to recover this record?</h4>
                                    <p style="margin: 0 0 0.75rem 0; color: #6b7280; line-height: 1.5;">This action will restore the inspection record back to your active inspection history. It will be removed from the archive and appear in the main inspection table.</p>
                                    <div style="background: #ecfdf5; border: 1px solid #10b981; border-radius: 6px; padding: 0.75rem; margin-top: 1rem;">
                                        <p style="margin: 0; color: #047857; font-size: 0.9rem;"><strong><i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>Safe Action:</strong> No data will be lost during this operation.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="padding: 1rem 2rem 1.5rem 2rem; border-top: 1px solid #e5e7eb; display: flex; gap: 1rem; justify-content: flex-end; background: #f9fafb; border-radius: 0 0 12px 12px;">
                            <button id="cancelRecoverInspection" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 500;" onmouseover="this.style.backgroundColor='#4b5563'" onmouseout="this.style.backgroundColor='#6b7280'">Cancel</button>
                            <button id="confirmRecoverInspection" class="btn btn-success" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 500;" onmouseover="this.style.backgroundColor='#059669'" onmouseout="this.style.backgroundColor='#10b981'">
                                <i class="fas fa-undo" style="margin-right: 0.5rem;"></i>Recover Record
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Permanent Delete Confirmation Modal -->
                <div id="permanentDeleteModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; margin: auto; padding: 0; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); max-width: 550px; width: 90%; position: relative;">
                        <div class="modal-header" style="padding: 1.5rem 2rem 1rem 2rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; background: #fef2f2;">
                            <h3 style="margin: 0; color: #dc2626; font-size: 1.25rem; font-weight: 600;"> Permanent Deletion Warning</h3>
                            <button id="closePermanentDeleteModal" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.2s;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 1.5rem 2rem;">
                            <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="color: #dc2626; font-size: 2.5rem;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div>
                                    <h4 style="margin: 0 0 0.75rem 0; color: #dc2626; font-weight: 600;">Permanent Deletion</h4>
                                    <p style="margin: 0 0 0.75rem 0; color: #374151; line-height: 1.5; font-weight: 500;">This action will <strong>permanently delete</strong> this inspection record from the system.</p>
                                    <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                        <ul style="margin: 0; color: #dc2626; font-size: 0.9rem; line-height: 1.6;">
                                            <li> <strong>Cannot be undone</strong></li>
                                            <li> <strong>All data will be lost forever</strong></li>
                                            <li> <strong>No recovery will be possible</strong></li>
                                            <li> <strong>Record will be completely removed from database</strong></li>
                                        </ul>
                                    </div>
                                    <p style="margin: 0; color: #6b7280; line-height: 1.5; font-size: 0.9rem;"><strong>Recommendation:</strong> Consider keeping the record in archive instead of permanent deletion unless absolutely necessary.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <button id="cancelPermanentDelete" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                                <button id="confirmPermanentDelete" class="btn" style="padding: 0.75rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;"> Delete Permanently</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

   <script>
    // IMMEDIATE SESSION CHECK - Run before anything else loads
    (async function() {
        try {
            const response = await fetch('../backend/security/session_check.php', {
                method: 'POST',
                credentials: 'same-origin'
            });
            const result = await response.json();
            if (!result.success) {
                window.location.href = '../index.html';
                return;
            }
        } catch (error) {
            window.location.href = '../index.html';
            return;
        }
    })();
    
    // SESSION SECURITY VALIDATION
    class SessionValidator {
        constructor() {
            this.checkInterval = 5 * 60 * 1000; // Check every 5 minutes
            this.warningTime = 25 * 60 * 1000; // Warn at 25 minutes (5 min before 30 min timeout)
            this.init();
        }
        
        init() {
            // Validate session immediately on page load
            this.validateSession();
            
            // Set up periodic session checks
            setInterval(() => {
                this.validateSession();
            }, this.checkInterval);
            
            // Track user activity to extend session
            this.setupActivityTracking();
            
            // Prevent page access via direct URL without proper authentication
            this.validatePageAccess();
        }
        
        async validateSession() {
            try {
                const response = await fetch('../backend/security/session_check.php', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    this.redirectToLogin(result.message || 'Session invalid');
                    return;
                }
                
                // Check for session warning (close to expiry)
                if (result.warning) {
                    this.showSessionWarning(result.remaining_time);
                }
                
            } catch (error) {
                console.error('Session validation error:', error);
                // Don't redirect on network errors, but log them
            }
        }
        
        async validatePageAccess() {
            try {
                const response = await fetch('../backend/security/validate_access.php', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        required_role: 'staff',
                        page: 'staff-dashboard'
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    this.redirectToLogin(result.message || 'Access denied');
                }
                
            } catch (error) {
                console.error('Access validation error:', error);
                this.redirectToLogin('Unable to validate access');
            }
        }
        
        setupActivityTracking() {
            // Events that indicate user activity
            const activityEvents = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];
            
            let lastActivity = Date.now();
            
            const updateActivity = () => {
                const now = Date.now();
                // Only send activity update if it's been more than 1 minute since last update
                if (now - lastActivity > 60000) {
                    this.updateActivityTimestamp();
                    lastActivity = now;
                }
            };
            
            activityEvents.forEach(event => {
                document.addEventListener(event, updateActivity, true);
            });
        }
        
        async updateActivityTimestamp() {
            try {
                await fetch('../backend/security/update_activity.php', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
            } catch (error) {
                console.error('Activity update error:', error);
            }
        }
        
        showSessionWarning(remainingMinutes) {
            // Create warning modal if it doesn't exist
            if (!document.getElementById('sessionWarningModal')) {
                const modal = document.createElement('div');
                modal.id = 'sessionWarningModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center; max-width: 400px;">
                        <h3 style="color: #d32f2f; margin-bottom: 1rem;"> Session Expiring Soon</h3>
                        <p>Your session will expire in <span id="sessionCountdown">${remainingMinutes}</span> minutes due to inactivity.</p>
                        <p>Click continue to extend your session.</p>
                        <button onclick="sessionValidator.extendSession()" style="background: #2d8659; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                            Continue Working
                        </button>
                        <button onclick="sessionValidator.logoutNow()" style="background: #d32f2f; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">
                            Logout
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } else {
                document.getElementById('sessionCountdown').textContent = remainingMinutes;
                document.getElementById('sessionWarningModal').style.display = 'flex';
            }
        }
        
        async extendSession() {
            try {
                const response = await fetch('../backend/security/extend_session.php', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const modal = document.getElementById('sessionWarningModal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                } else {
                    this.redirectToLogin('Unable to extend session');
                }
                
            } catch (error) {
                console.error('Session extension error:', error);
                this.redirectToLogin('Session extension failed');
            }
        }
        
        logoutNow() {
            window.location.href = '../backend/api/logout.php';
        }
        
        redirectToLogin(message = 'Session expired') {
            console.log('Redirecting to login:', message);
            
            // Clear any local storage or cached data
            localStorage.clear();
            sessionStorage.clear();
            
            // Redirect to main page
            window.location.href = '../index.html';
        }
    }
    
    // Initialize session validator immediately
    const sessionValidator = new SessionValidator();
    
    // DOM Elements
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebarOverlay = document.getElementById('sidebarOverlay');
const navLinks = document.querySelectorAll('.nav-link');
const pageTitle = document.getElementById('pageTitle');
const contentSections = document.querySelectorAll('.content-section');
const userIdDisplay = document.querySelector('.user-name');

// Staff Announcement Manager Class
class StaffAnnouncementManager {
    constructor() {
        console.log(' Initializing StaffAnnouncementManager...');
        this.apiUrl = '../backend/announcements.php';
        this.announcements = [];
        // Removed localStorage - now using backend isRead field
        this.currentFilter = {
            category: '',
            priority: '',
            search: ''
        };
        this.pollingInterval = null;
        console.log(' StaffAnnouncementManager initialized');
        
        // Set user display
        // Fetch and display user's actual name
        if (userIdDisplay) {
            fetch('../backend/security/session_check.php', {
                method: 'POST',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success && result.user) {
                    const displayName = result.user.full_name && result.user.full_name.trim() 
                        ? result.user.full_name.trim()
                        : result.user.username;
                    userIdDisplay.textContent = displayName;
                    const userRoleElement = document.querySelector('.user-role');
                    if (userRoleElement) {
                        userRoleElement.textContent = "Assessor's Staff";
                    }
                } else {
                    userIdDisplay.textContent = 'User';
                    const userRoleElement = document.querySelector('.user-role');
                    if (userRoleElement) {
                        userRoleElement.textContent = "Assessor's Staff";
                    }
                }
            })
            .catch(() => {
                userIdDisplay.textContent = 'Staff User';
            });
        }
        
        this.init();
    }

    init() {
        console.log(' Initializing StaffAnnouncementManager components...');
        
        // Clear old localStorage data that might interfere
        localStorage.removeItem('readAnnouncements');
        console.log(' Cleared old localStorage data');
        
        this.bindEvents();
        this.loadAnnouncements();
        this.startPolling();
        console.log(' StaffAnnouncementManager init complete');
    }

    bindEvents() {
        // Search functionality
        const searchInput = document.getElementById('announcementSearch');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.currentFilter.search = e.target.value;
                this.filterAnnouncements();
            });
        }

        // Category filter
        const categoryFilter = document.getElementById('categoryFilter');
        if (categoryFilter) {
            categoryFilter.addEventListener('change', (e) => {
                this.currentFilter.category = e.target.value;
                this.filterAnnouncements();
            });
        }

        // Priority filter
        const priorityFilter = document.getElementById('priorityFilter');
        if (priorityFilter) {
            priorityFilter.addEventListener('change', (e) => {
                this.currentFilter.priority = e.target.value;
                this.filterAnnouncements();
            });
        }

        // Refresh button
        const refreshBtn = document.getElementById('refreshAnnouncements');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                this.loadAnnouncements();
                this.showToast('Announcements refreshed', 'success');
            });
        }

        // Mark all as read button
        const markAllReadBtn = document.getElementById('markAllRead');
        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', () => {
                this.markAllAsRead();
            });
        }


    }

    async loadAnnouncements() {
        try {
            console.log(' Loading staff announcements...');
            const loadingEl = document.getElementById('loadingAnnouncements');
            if (loadingEl) loadingEl.style.display = 'block';

            const response = await fetch(`${this.apiUrl}?path=staff`);
            const result = await response.json();
            
            console.log(' API Response:', result);
            
            if (result.success) {
                console.log(` Loaded ${result.data.length} announcements:`, result.data);
                
                // Debug: Check each announcement's read status
                result.data.forEach(ann => {
                    const readStatus = ann.isRead ? ' READ' : ' UNREAD';
                    console.log(` ID: ${ann.id}, "${ann.subject}" - ${readStatus}`);
                    if (ann.isRead) {
                        console.log(`    Read at: ${ann.readAt}`);
                    }
                });
                
                // Count read/unread for verification
                const readCount = result.data.filter(a => a.isRead).length;
                const unreadCount = result.data.length - readCount;
                console.log(` Summary: ${readCount} read, ${unreadCount} unread`);
                
                this.announcements = result.data;
                this.updateStats();
                this.updateAnnouncementBadge();
                this.renderAnnouncements();
            } else {
                console.error(' API Error:', result.error);
                this.showToast('Failed to load announcements', 'error');
            }
        } catch (error) {
            console.error('Error loading staff announcements:', error);
            this.showToast('Error loading announcements', 'error');
        } finally {
            const loadingEl = document.getElementById('loadingAnnouncements');
            if (loadingEl) loadingEl.style.display = 'none';
        }
    }

    renderAnnouncements() {
        console.log(' Rendering announcements...');
        const container = document.getElementById('staffAnnouncementsList');
        const emptyState = document.getElementById('no-staff-announcements');
        
        if (!container) {
            console.error(' Container not found: staffAnnouncementsList');
            return;
        }

        const filteredAnnouncements = this.getFilteredAnnouncements();
        console.log(` Filtered announcements: ${filteredAnnouncements.length}`, filteredAnnouncements);
        
        if (filteredAnnouncements.length === 0) {
            console.log(' No announcements to show, displaying empty state');
            container.innerHTML = '';
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        console.log(' Rendering announcements to container');
        if (emptyState) emptyState.style.display = 'none';
        
        container.innerHTML = filteredAnnouncements
            .map(announcement => this.createAnnouncementHTML(announcement))
            .join('');
        
        // Add click handlers for read tracking
        container.querySelectorAll('.announcement-item').forEach(card => {
            const id = card.dataset.id;
            console.log(` Adding click handler for announcement ID: ${id}`);
            card.addEventListener('click', (event) => {
                console.log(` Announcement ${id} clicked!`);
                event.preventDefault();
                this.markAsRead(id);
            });
        });
    }

    createAnnouncementHTML(announcement) {
        // Use the backend's isRead field instead of local storage
        const isRead = announcement.isRead || false;
        const timeAgo = this.getTimeAgo(new Date(announcement.createdAt || announcement.created_at));
        
        const categoryIcons = {
            general: 'fas fa-info-circle',
            system: 'fas fa-cog',
            maintenance: 'fas fa-tools',
            policy: 'fas fa-file-alt',
            emergency: 'fas fa-exclamation-triangle',
            training: 'fas fa-graduation-cap'
        };

        const priorityClass = {
            normal: 'priority-normal',
            high: 'priority-high', 
            urgent: 'priority-urgent'
        };

        return `
            <div class="announcement-item ${isRead ? 'read' : 'unread'} ${announcement.priority}" data-id="${announcement.id}">
                <div class="announcement-header">
                    <div class="announcement-title-row">
                        <h4>${announcement.subject}</h4>
                        <div class="announcement-badges">
                            <span class="priority-badge ${announcement.priority}">
                                <i class="fas fa-${announcement.priority === 'urgent' ? 'exclamation-triangle' : announcement.priority === 'high' ? 'exclamation' : 'info-circle'}"></i>
                                ${announcement.priority}
                            </span>
                            <span class="category-badge">
                                <i class="${categoryIcons[announcement.category] || 'fas fa-info-circle'}"></i>
                                ${announcement.category}
                            </span>
                            ${!isRead ? '<span class="target-badge all-users">NEW</span>' : ''}
                        </div>
                    </div>
                </div>
                
                <div class="announcement-content">
                    <p class="announcement-message">${this.formatAnnouncementText(announcement.message)}</p>
                </div>
                
                <div class="announcement-footer">
                    <small>
                        <i class="fas fa-user"></i> ${announcement.authorName || announcement.author_name || 'Head Assessor'}  
                        <i class="fas fa-clock"></i> ${timeAgo}
                    </small>
                    ${isRead ? '<i class="fas fa-check-circle" style="color: #10b981;"></i>' : ''}
                </div>
            </div>
        `;
    }

    formatAnnouncementText(text) {
        return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **bold**
            .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *italic*
            .replace(/\n/g, '<br>')                            // Line breaks
            .replace(/ /g, '<br> ');                         // Bullet points
    }

    getFilteredAnnouncements() {
        return this.announcements.filter(announcement => {
            const matchesSearch = !this.currentFilter.search || 
                announcement.subject.toLowerCase().includes(this.currentFilter.search.toLowerCase()) ||
                announcement.message.toLowerCase().includes(this.currentFilter.search.toLowerCase());
            
            const matchesCategory = !this.currentFilter.category || 
                announcement.category === this.currentFilter.category;
            
            const matchesPriority = !this.currentFilter.priority || 
                announcement.priority === this.currentFilter.priority;
            
            return matchesSearch && matchesCategory && matchesPriority;
        });
    }

    async markAsRead(announcementId) {
        const id = announcementId.toString();
        console.log(` markAsRead called for ID: ${id}`);
        
        // Find the announcement in our current list
        const announcement = this.announcements.find(a => a.id.toString() === id);
        
        if (!announcement) {
            console.warn(` Announcement ${id} not found`);
            return;
        }
        
        if (announcement.isRead) {
            console.log(` Announcement ${id} already marked as read`);
            return;
        }
        
        console.log(` Marking announcement ${id} as read...`);
        try {
            // Call API to mark as read in database
            console.log(` Calling API: ${this.apiUrl}?path=mark-read/${id}`);
            const response = await fetch(`${this.apiUrl}?path=mark-read/${id}`);
            const result = await response.json();
            
            console.log(` API Response:`, result);
            
            if (result.success) {
                console.log(` Marked announcement ${id} as read in database`);
                
                // Update the local announcement object
                announcement.isRead = true;
                announcement.readAt = new Date().toISOString();
                
                // Update the UI components
                this.updateStats();
                this.updateAnnouncementBadge(); // Update badge immediately
                this.renderAnnouncements();
                
                // Show success feedback
                this.showToast('Announcement marked as read', 'success');
            } else {
                console.warn(` Failed to mark announcement ${id} as read:`, result.error);
                this.showToast('Failed to mark as read', 'error');
            }
        } catch (error) {
            console.error(` Error marking announcement ${id} as read:`, error);
            this.showToast('Error marking as read', 'error');
        }
    }

    async markAllAsRead() {
        const unreadAnnouncements = this.announcements.filter(a => 
            !a.isRead
        );
        
        if (unreadAnnouncements.length === 0) {
            this.showToast('No unread announcements', 'info');
            return;
        }

        // Call API for each unread announcement
        const apiCalls = unreadAnnouncements.map(async (announcement) => {
            try {
                const response = await fetch(`${this.apiUrl}?path=mark-read/${announcement.id}`);
                const result = await response.json();
                if (result.success) {
                    console.log(` Marked announcement ${announcement.id} as read in database`);
                } else {
                    console.warn(` Failed to mark announcement ${announcement.id} as read:`, result.error);
                }
            } catch (error) {
                console.error(` Error marking announcement ${announcement.id} as read:`, error);
            }
        });

        // Wait for all API calls to complete
        await Promise.all(apiCalls);

        // Update the local announcements to reflect read status
        unreadAnnouncements.forEach(announcement => {
            announcement.isRead = true;
            announcement.readAt = new Date().toISOString();
        });
        
        this.updateStats();
        this.updateAnnouncementBadge();
        this.renderAnnouncements();
        this.showToast(`Marked ${unreadAnnouncements.length} announcements as read`, 'success');
    }

    clearFilters() {
        this.currentFilter = { category: '', priority: '', search: '' };
        
        const searchInput = document.getElementById('searchAnnouncements');
        const categoryFilter = document.getElementById('categoryFilter');
        const priorityFilter = document.getElementById('priorityFilter');
        
        if (searchInput) searchInput.value = '';
        if (categoryFilter) categoryFilter.value = '';
        if (priorityFilter) priorityFilter.value = '';
        
        this.filterAnnouncements();
        this.showToast('Filters cleared', 'info');
    }

    filterAnnouncements() {
        this.renderAnnouncements();
        this.updateFilteredStats();
    }

    updateStats() {
        const totalEl = document.getElementById('totalStaffAnnouncements');
        const unreadEl = document.getElementById('unreadStaffAnnouncements');
        const urgentEl = document.getElementById('urgentStaffAnnouncements');
        
        if (totalEl) totalEl.textContent = this.announcements.length;
        
        const unreadCount = this.announcements.filter(a => 
            !a.isRead
        ).length;
        if (unreadEl) unreadEl.textContent = unreadCount;
        
        const urgentCount = this.announcements.filter(a => a.priority === 'urgent').length;
        if (urgentEl) urgentEl.textContent = urgentCount;

        // Update mark all read button state
        const markAllReadBtn = document.getElementById('markAllRead');
        if (markAllReadBtn) {
            markAllReadBtn.disabled = unreadCount === 0;
        }
    }

    updateFilteredStats() {
        const filtered = this.getFilteredAnnouncements();
        const resultCount = document.getElementById('filteredCount');
        if (resultCount) {
            resultCount.textContent = `Showing ${filtered.length} of ${this.announcements.length} announcements`;
        }
    }

    updateAnnouncementBadge() {
        const badge = document.getElementById('announcementCount');
        if (badge) {
            const unreadCount = this.announcements.filter(a => 
                !a.isRead
            ).length;
            
            console.log(` Updating announcement badge: ${unreadCount} unread announcements`);
            console.log(` Announcements data:`, this.announcements.map(a => ({id: a.id, subject: a.subject, isRead: a.isRead})));
            
            badge.textContent = unreadCount;
            
            if (unreadCount > 0) {
                badge.style.display = 'inline-flex';
                badge.classList.add('show', 'pulse');
                console.log(` Badge shown with count: ${unreadCount}`);
            } else {
                badge.style.display = 'none';
                badge.classList.remove('show', 'pulse');
                console.log(` Badge hidden - no unread announcements`);
            }
        } else {
            console.error(' Badge element not found: announcementCount');
        }
    }

    getTimeAgo(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return `${days}d ago`;
        if (hours > 0) return `${hours}h ago`;
        if (minutes > 0) return `${minutes}m ago`;
        return 'Just now';
    }

    showToast(message, type = 'info') {
        // Create toast notification
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        `;

        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
        }, 100);

        setTimeout(() => {
            toast.style.transform = 'translateX(400px)';
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }

    startPolling() {
        // Poll every 30 seconds
        this.pollingInterval = setInterval(() => {
            this.loadAnnouncements();
        }, 30000);
    }

    stopPolling() {
        if (this.pollingInterval) {
            clearInterval(this.pollingInterval);
            this.pollingInterval = null;
        }
    }
}

// Staff Dashboard Modules
class StaffApp {
    // Show notification when pending requests reach 10
    showPendingNotification(barangayName, count) {
        // You can replace this with a custom toast/notification UI
        alert(`Barangay ${barangayName} has reached ${count} pending requests and is ready to schedule!`);
    }
    constructor() {
        this.scheduledInspections = [];
        this.holidays = this.getHolidays();
        this.incomingRequests = this.loadIncomingRequests();
        this.pendingRequests = this.loadPendingRequests();
        this.blockedDates = []; // Initialize empty, will load async
        this.init();
    }

    async init() {
        // Load scheduled inspections from database
        this.scheduledInspections = await this.loadScheduledInspections();
        console.log('Loaded scheduled inspections in init:', this.scheduledInspections);
        
        // Load blocked dates from backend
        this.blockedDates = await this.loadBlockedDates();
        console.log(' Loaded blocked dates:', this.blockedDates);
        
        // Debug blocked dates
        if (this.blockedDates && this.blockedDates.length > 0) {
            console.log(' Blocked dates ready for calendar:', this.blockedDates.map(d => d.date));
        } else {
            console.log(' No blocked dates loaded');
        }
        
        this.bindEvents();
        this.handleResize();
        this.loadInitialData();
        this.initNotificationModuleUI();
        this.initGoogleCalendar(); // Initialize Google Calendar-inspired calendar
        this.initBlockDateModal(); // Initialize block date functionality
        
        // Render calendar after data is loaded
        setTimeout(() => {
            this.renderCurrentView();
        }, 500);
    }

    // Initialize Block Date Modal functionality
    initBlockDateModal() {
        const blockDateBtn = document.getElementById('blockDateBtn');
        const blockDateModal = document.getElementById('blockDateModal');
        const closeModal = document.getElementById('closeBlockDateModal');
        const cancelBtn = document.getElementById('cancelBlockDate');
        const blockDateForm = document.getElementById('blockDateForm');

        // Open modal
        if (blockDateBtn) {
            blockDateBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                blockDateModal.style.display = 'flex';
                // Set minimum date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('blockDate').min = today;
            });
        }

        // Close modal events
        [closeModal, cancelBtn].forEach(btn => {
            if (btn) {
                btn.addEventListener('click', () => {
                    blockDateModal.style.display = 'none';
                    blockDateForm.reset();
                });
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === blockDateModal) {
                blockDateModal.style.display = 'none';
                blockDateForm.reset();
            }
        });

        // Handle form submission
        if (blockDateForm) {
            blockDateForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleBlockDate(blockDateForm);
            });
        }
    }

    // Handle blocking a date
    async handleBlockDate(form) {
        const formData = new FormData(form);
        const blockData = {
            date: formData.get('blockDate'),
            reason: formData.get('blockReason'),
            created_by: 'Staff' // In real app, get from session
        };

        try {
            // Save to backend database
            const result = await this.saveBlockedDate(blockData);
            
            // Show professional success message (updated)
            this.showSuccessNotification(' Date Blocked Successfully', `Date <strong>${blockData.date}</strong> has been blocked for all inspections.<br><strong>Reason:</strong> ${blockData.reason}`);
            
            // Close modal and refresh calendar
            document.getElementById('blockDateModal').style.display = 'none';
            form.reset();
            
            // Reload blocked dates and refresh calendar
            this.blockedDates = await this.loadBlockedDates();
            this.renderCurrentView();
            
            // Also refresh reschedule calendar if it's open
            if (typeof refreshRescheduleCalendar === 'function') {
                refreshRescheduleCalendar();
            }
            
        } catch (error) {
            console.error('Error blocking date:', error);
            this.showErrorNotification('Error Blocking Date', error.message);
        }
    }

    // Professional success notification
    showSuccessNotification(title, message) {
        this.showNotification(title, message, 'success');
    }

    // Professional error notification  
    showErrorNotification(title, message) {
        this.showNotification(title, message, 'error');
    }

    // Create and show professional notification
    showNotification(title, message, type = 'success') {
        // Remove any existing notifications
        const existing = document.querySelector('.professional-notification');
        if (existing) {
            existing.remove();
        }

        // Create notification element
        const notification = document.createElement('div');
        notification.className = `professional-notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <div class="notification-icon">
                    ${type === 'success' ? '' : ''}
                </div>
                <div class="notification-text">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.parentElement.style.opacity='0'; this.parentElement.parentElement.style.transform='translateX(100%)'; this.parentElement.parentElement.style.transition='all 0.3s ease-out'; setTimeout(() => this.parentElement.parentElement.remove(), 300);">&times;</button>
            </div>
        `;

        // Add styles if not already added
        if (!document.querySelector('#notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                .professional-notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 99999;
                    min-width: 350px;
                    max-width: 500px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    animation: slideInRight 0.3s ease-out;
                    pointer-events: auto;
                }
                .professional-notification.success {
                    background: #f0f9ff;
                    border-left: 4px solid #10b981;
                }
                .professional-notification.error {
                    background: #fef2f2;
                    border-left: 4px solid #ef4444;
                }
                .notification-content {
                    display: flex;
                    align-items: flex-start;
                    padding: 16px;
                    gap: 12px;
                }
                .notification-icon {
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    color: white;
                    font-size: 14px;
                }
                .professional-notification.success .notification-icon {
                    background: #10b981;
                }
                .professional-notification.error .notification-icon {
                    background: #ef4444;
                }
                .notification-text {
                    flex: 1;
                }
                .notification-title {
                    font-weight: 600;
                    font-size: 14px;
                    margin-bottom: 4px;
                    color: #1f2937;
                }
                .notification-message {
                    font-size: 13px;
                    color: #6b7280;
                    line-height: 1.4;
                }
                .notification-close {
                    background: none;
                    border: none;
                    font-size: 18px;
                    color: #9ca3af;
                    cursor: pointer;
                    padding: 0;
                    width: 20px;
                    height: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                .notification-close:hover {
                    color: #4b5563;
                }
                @keyframes slideInRight {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOutRight {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // Add to page
        document.body.appendChild(notification);

        // Auto-remove after 2 seconds
        setTimeout(() => {
            if (notification && notification.parentElement) {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                notification.style.transition = 'all 0.3s ease-out';
                setTimeout(() => {
                    if (notification && notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 2000);
    }

    // Load blocked dates from backend API
    async loadBlockedDates() {
        try {
            console.log(' Attempting to load blocked dates from DASHBOARD...');
            const apiUrl = '../backend/blocked_dates.php?action=list';
            console.log(' API URL:', apiUrl);
            const response = await fetch(apiUrl);
            console.log(' API response status:', response.status);
            
            const result = await response.json();
            console.log(' Raw API result for DASHBOARD:', result);
            
            if (result.success) {
                console.log(' Successfully loaded blocked dates:', result.data);
                return result.data || [];
            } else {
                console.error(' API returned error:', result.error);
                return [];
            }
        } catch (error) {
            console.error(' Exception loading blocked dates:', error);
            return [];
        }
    }

    // Save blocked date to backend API
    async saveBlockedDate(blockData) {
        try {
            console.log('Sending block data:', blockData);
            const response = await fetch('../backend/blocked_dates.php?action=add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(blockData)
            });
            
            // Get the response text first to see what we're getting
            const responseText = await response.text();
            console.log('Raw response:', responseText);
            console.log('Response status:', response.status);
            
            // Check if response is ok
            if (!response.ok) {
                console.error('Server error response:', responseText);
                throw new Error(`HTTP error! status: ${response.status}. Server response: ${responseText}`);
            }
            
            // Try to parse as JSON
            let result;
            try {
                result = JSON.parse(responseText);
            } catch (jsonError) {
                console.error('JSON parse error:', jsonError);
                console.error('Response text:', responseText);
                throw new Error('Invalid JSON response from server: ' + responseText.substring(0, 100));
            }
            
            if (result.success) {
                // Add to local array for immediate UI update
                this.blockedDates.push({
                    ...blockData,
                    id: result.blocked_id
                });
                return result;
            } else {
                throw new Error(result.error || 'Failed to save blocked date');
            }
        } catch (error) {
            console.error('Error saving blocked date:', error);
            throw error;
        }
    }

    // Check if a date is blocked
    isDateBlocked(dateStr) {
        return this.blockedDates.some(blocked => blocked.date === dateStr);
    }

    // Get blocked date info
    getBlockedDateInfo(dateStr) {
        if (!this.blockedDates || this.blockedDates.length === 0) {
            return null;
        }
        
        const blocked = this.blockedDates.find(blocked => blocked.date === dateStr);
        if (blocked) {
            console.log(` Date ${dateStr} is blocked:`, blocked);
        }
        return blocked;
    }

    bindEvents() {
        // Sidebar Toggle
        sidebarToggle.addEventListener('click', () => {
            this.toggleSidebar();
        });

        // Close sidebar when clicking overlay
        sidebarOverlay.addEventListener('click', () => {
            this.closeSidebar();
        });

        // Handle navigation clicks
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                this.handleNavClick(link);
            });
        });

        // Remove record update form event binding
        // const recordUpdateForm = document.querySelector('.record-update-form');
        // if (recordUpdateForm) {
        //     recordUpdateForm.addEventListener('submit', (e) => {
        //         e.preventDefault();
        //         this.handleRecordUpdate(e.target);
        //     });
        // }

        // Handle logout button click
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.handleLogout();
            });
        }

        // Handle schedule modal events
        const closeScheduleModal = document.getElementById('closeScheduleModal');
        const cancelScheduleBtn = document.getElementById('cancelScheduleBtn');
        const saveScheduleBtn = document.getElementById('saveScheduleBtn');
        const scheduleModal = document.getElementById('scheduleModal');

        if (closeScheduleModal) {
            closeScheduleModal.addEventListener('click', () => {
                scheduleModal.classList.remove('show');
                scheduleModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        }

        if (cancelScheduleBtn) {
            cancelScheduleBtn.addEventListener('click', () => {
                scheduleModal.classList.remove('show');
                scheduleModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        }

        if (saveScheduleBtn) {
            saveScheduleBtn.addEventListener('click', () => {
                this.saveSchedule();
            });
        }

        // Close modal when clicking outside
        if (scheduleModal) {
            scheduleModal.addEventListener('click', (e) => {
                if (e.target === scheduleModal) {
                    scheduleModal.classList.remove('show');
                    scheduleModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            this.handleResize();
        });
    }
    
    handleLogout() {
        // Clear session storage
        sessionStorage.clear();
        
        // Call server logout API to destroy session
        fetch('../backend/api/logout.php', {
            method: 'POST',
            credentials: 'same-origin'
        })
        .then(() => {
            // Redirect after logout
            window.location.href = '../index.html';
        })
        .catch(() => {
            // Redirect even if logout fails
            window.location.href = '../index.html';
        });
    }

    toggleSidebar() {
        sidebar.classList.toggle('mobile-open');
        sidebarOverlay.classList.toggle('active');
    }

    closeSidebar() {
        sidebar.classList.remove('mobile-open');
        sidebarOverlay.classList.remove('active');
    }

    handleResize() {
        if (window.innerWidth > 768) {
            this.closeSidebar();
        }
    }

    handleNavClick(clickedLink) {
        navLinks.forEach(link => link.classList.remove('active'));
        clickedLink.classList.add('active');

        const targetSection = clickedLink.getAttribute('data-section');
        this.switchSection(targetSection);
        pageTitle.textContent = 'AssessPro';

        if (window.innerWidth <= 768) {
            this.closeSidebar();
        }
    }

    switchSection(targetSectionId) {
        contentSections.forEach(section => {
            section.classList.remove('active');
        });
        const targetElement = document.getElementById(targetSectionId);
        if (targetElement) {
            targetElement.classList.add('active');
            
            // Refresh calendar when switching to dashboard
            if (targetSectionId === 'dashboard') {
                setTimeout(() => {
                    this.renderCurrentView();
                }, 100);
            }
            
            // Load data when switching to view-requests section
            if (targetSectionId === 'view-requests') {
                setTimeout(() => {
                    this.loadViewRequestsTable();
                }, 100);
            }
            
            // Load data when switching to notifications section
            if (targetSectionId === 'notifications') {
                setTimeout(() => {
                    this.loadIncomingRequestsTable();
                }, 100);
            }
            
            // Load data when switching to inspection-requests section
            if (targetSectionId === 'inspection-requests') {
                setTimeout(() => {
                    this.loadInspectionRequests();
                }, 100);
            }
            
            // Load data when switching to inspection-history section
            if (targetSectionId === 'inspection-history') {
                setTimeout(() => {
                    // Ensure month filter is populated first
                    if (inspectionHistoryManager) {
                        inspectionHistoryManager.populateMonthFilter();
                    }
                    this.loadInspectionHistory();
                }, 100);
            }
            

        }
    }

    async loadInitialData() {
        // Update dashboard stats based on real data
        await this.updateDashboardStats();
        // Removed auto-loading of system activities - only load when refresh button is clicked
        this.loadInspectionRequests();
        this.loadIncomingRequestsTable();
        this.loadViewRequestsTable();
        this.renderCurrentView(); // Ensure calendar is rendered with initial data
    }

    async updateDashboardStats() {
        try {
            // Update Pending Inspections - should count ACCEPTED requests (ready for inspection)
            const response = await fetch('../backend/api/get_requests.php');
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.data) {
                    // Pending Inspections = Accepted requests that are ready for inspection
                    const acceptedRequests = data.data.filter(request => request.status === 'accepted');
                    document.getElementById('pending-inspections').textContent = acceptedRequests.length;
                    console.log(`Updated pending inspections count: ${acceptedRequests.length} (accepted requests ready for inspection)`);
                    
                    // Update Notification Badge - count PENDING requests (new incoming requests)
                    const pendingRequests = data.data.filter(request => !request.status || request.status === 'pending');
                    this.updateNotificationBadge(pendingRequests.length);
                    console.log(`Updated notification badge count: ${pendingRequests.length} (pending requests for review)`);
                } else {
                    document.getElementById('pending-inspections').textContent = '0';
                    this.updateNotificationBadge(0);
                }
            } else {
                document.getElementById('pending-inspections').textContent = '0';
            }
        } catch (error) {
            console.error('Error updating pending inspections stats:', error);
            document.getElementById('pending-inspections').textContent = '0';
        }
        
        try {
            // Update Scheduled This Week - should only count inspections scheduled for current week
            const scheduledResponse = await fetch('../backend/api/get_scheduled_inspections.php');
            if (scheduledResponse.ok) {
                const scheduledData = await scheduledResponse.json();
                if (scheduledData.success && scheduledData.data) {
                    // Get current week boundaries (Monday to Sunday)
                    const today = new Date();
                    
                    // Create a copy of today for calculations
                    const currentWeekStart = new Date(today);
                    
                    // Get Monday of current week (ISO week standard)
                    const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
                    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // If Sunday, go back 6 days to Monday
                    currentWeekStart.setDate(today.getDate() + daysToMonday);
                    currentWeekStart.setHours(0, 0, 0, 0);
                    
                    // Get Sunday of current week  
                    const currentWeekEnd = new Date(currentWeekStart);
                    currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
                    currentWeekEnd.setHours(23, 59, 59, 999);
                    
                    console.log(`=== WEEKLY CALCULATION DEBUG ===`);
                    console.log(`Today: ${today.toDateString()} (Day of week: ${dayOfWeek})`);
                    console.log(`Current week: ${currentWeekStart.toDateString()} to ${currentWeekEnd.toDateString()}`);
                    console.log(`Total inspections from API: ${scheduledData.data.length}`);
                    
                    // Log all inspections for debugging
                    scheduledData.data.forEach(inspection => {
                        const inspectionDate = new Date(inspection.date);
                        console.log(`Inspection: ${inspection.date} (${inspectionDate.toDateString()}) - ${inspection.barangay} - Status: ${inspection.status}`);
                    });
                    
                    // Filter inspections scheduled for this week only AND still pending (not completed)
                    const thisWeekInspections = scheduledData.data.filter(inspection => {
                        const inspectionDate = new Date(inspection.date);
                        const isThisWeek = inspectionDate >= currentWeekStart && inspectionDate <= currentWeekEnd;
                        const isActive = inspection.status !== 'completed' && inspection.status !== 'cancelled';
                        
                        if (isThisWeek) {
                            console.log(`   This week inspection: ${inspection.date} - ${inspection.barangay} (${inspection.status}) - Active: ${isActive}`);
                        }
                        
                        return isThisWeek && isActive;
                    });
                    
                    document.getElementById('scheduled-inspections').textContent = thisWeekInspections.length;
                    console.log(`=== FINAL COUNT ===`);
                    console.log(`Scheduled This Week (Active): ${thisWeekInspections.length}`);
                    console.log(`=== END DEBUG ===`);
                    
                    // Log completed/cancelled inspections for this week (for debugging)
                    const thisWeekCompleted = scheduledData.data.filter(inspection => {
                        const inspectionDate = new Date(inspection.date);
                        const isThisWeek = inspectionDate >= currentWeekStart && inspectionDate <= currentWeekEnd;
                        const isCompleted = inspection.status === 'completed' || inspection.status === 'cancelled';
                        return isThisWeek && isCompleted;
                    });
                    
                    if (thisWeekCompleted.length > 0) {
                        console.log(`This week completed/cancelled inspections (not counted): ${thisWeekCompleted.length}`);
                        thisWeekCompleted.forEach(inspection => {
                            console.log(`  Completed: ${inspection.date} - ${inspection.barangay} (${inspection.status})`);
                        });
                    }
                } else {
                    document.getElementById('scheduled-inspections').textContent = '0';
                }
            } else {
                document.getElementById('scheduled-inspections').textContent = '0';
            }
        } catch (error) {
            console.error('Error updating scheduled inspections stats:', error);
            document.getElementById('scheduled-inspections').textContent = '0';
        }
        
        try {
            // Update Completed Inspections - count all inspections with status 'completed'
            console.log('Fetching completed inspections data...');
            const completedResponse = await fetch('../backend/api/get_scheduled_inspections.php');
            if (completedResponse.ok) {
                const completedData = await completedResponse.json();
                console.log('Completed inspections API response:', completedData);
                if (completedData.success && completedData.data) {
                    // Filter inspections with completed status
                    const completedInspections = completedData.data.filter(inspection => inspection.status === 'completed');
                    const completedCount = completedInspections.length;
                    document.getElementById('completed-inspections').textContent = completedCount;
                    console.log(`Updated completed inspections count: ${completedCount}`);
                    
                    // Log completed inspections for debugging
                    if (completedCount > 0) {
                        console.log('Found completed inspections:');
                        completedInspections.forEach(inspection => {
                            console.log(`- ID: ${inspection.id}, Date: ${inspection.date}, Barangay: ${inspection.barangay}, Status: ${inspection.status}`);
                        });
                    } else {
                        console.log('No completed inspections found');
                    }
                } else {
                    console.warn('No data received for completed inspections');
                    document.getElementById('completed-inspections').textContent = '0';
                }
            } else {
                console.error('Failed to fetch completed inspections:', completedResponse.status);
                document.getElementById('completed-inspections').textContent = '0';
            }
        } catch (error) {
            console.error('Error updating completed inspections stats:', error);
            document.getElementById('completed-inspections').textContent = '0';
        }
    }

    async loadSystemActivities() {
        try {
            const response = await fetch('../backend/api/staff.php?action=recent_activities');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            this.displayActivities(data.data || []);
        } catch (error) {
            console.error('Failed to load system activities:', error);
            const tbody = document.getElementById('staff-activities-table');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Failed to load activities</td></tr>';
            }
        }
    }

    displayActivities(activities) {
        const tbody = document.getElementById('staff-activities-table');
        if (!tbody) return;

        if (activities.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No recent activities</td></tr>';
            return;
        }

        // Filter and enhance activities for internal staff only
        const filteredActivities = activities.filter((activity, index) => {
            // Skip automatic logout entries that happen with role access denials
            if (activity.action === 'logout') {
                const sameTimestamp = activities.find(other => 
                    other.created_at === activity.created_at && 
                    other.action === 'login_failed' &&
                    other.old_values && 
                    other.old_values.includes('Role access denied')
                );
                if (sameTimestamp) return false;
            }
            return true;
        });

        tbody.innerHTML = filteredActivities.map(activity => {
            const userName = activity.first_name && activity.last_name 
                ? `${activity.first_name} ${activity.last_name}` 
                : (activity.username || 'System User');
            
            const userRole = activity.role ? activity.role.toUpperCase() : 'SYSTEM';
            const actionText = this.formatAction(activity.action);
            const timestamp = new Date(activity.created_at).toLocaleString();
            
            // Enhanced status determination
            let status, statusClass;
            if (activity.action === 'login_failed' || activity.action.includes('fail') || activity.action.includes('denied')) {
                status = 'Failed';
                statusClass = 'status-failed';
            } else if (activity.action === 'login_success' || activity.action === 'login') {
                status = 'Success';
                statusClass = 'status-success';
            } else if (activity.action === 'logout') {
                status = 'Logout';
                statusClass = 'status-neutral';
            } else if (activity.action.includes('create') || activity.action.includes('add')) {
                status = 'Created';
                statusClass = 'status-success';
            } else if (activity.action.includes('update') || activity.action.includes('edit')) {
                status = 'Updated';
                statusClass = 'status-info';
            } else if (activity.action.includes('delete') || activity.action.includes('remove')) {
                status = 'Deleted';
                statusClass = 'status-warning';
            } else {
                status = 'Completed';
                statusClass = 'status-success';
            }

            return `
                <tr>
                    <td>${userName}</td>
                    <td><span class="role-badge role-${activity.role || 'system'}">${userRole}</span></td>
                    <td>${actionText}</td>
                    <td>${timestamp}</td>
                    <td><span class="status ${statusClass}">${status}</span></td>
                </tr>
            `;
        }).join('');
    }

    formatAction(action) {
        const actionMap = {
            // Authentication actions
            'login': 'User Login',
            'login_success': 'User Login',
            'login_failed': 'Failed Login Attempt',
            'logout': 'User Logout',
            
            // User management actions
            'create_user': 'Created User Account',
            'edit_user': 'Updated User Profile',
            'delete_user': 'Deleted User Account',
            'suspend_user': 'Suspended User Account',
            'activate_user': 'Activated User Account',
            'change_user_role': 'Changed User Role',
            'reset_password': 'Reset User Password',
            
            // Assessment management
            'create_appointment': 'Created Assessment Appointment',
            'update_appointment': 'Updated Assessment Appointment',
            'cancel_appointment': 'Cancelled Assessment Appointment',
            'update_assessment_request': 'Updated Assessment Request',
            'assign_assessor': 'Assigned Assessor',
            'approve_request': 'Approved Assessment Request',
            'reject_request': 'Rejected Assessment Request',
            
            // System administration
            'update_system_settings': 'Updated System Settings',
            'backup_database': 'Created Database Backup',
            'system_maintenance': 'Performed System Maintenance',
            'update_permissions': 'Updated User Permissions',
            
            // Staff workflow actions
            'review_request': 'Reviewed Assessment Request',
            'schedule_inspection': 'Scheduled Property Inspection',
            'complete_inspection': 'Completed Property Inspection',
            'generate_report': 'Generated Assessment Report',
            'send_notification': 'Sent System Notification'
        };
        
        return actionMap[action] || action.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    updateNotificationBadge(count) {
        const badge = document.getElementById('notificationCount');
        if (!badge) return;
        
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count.toString();
            badge.classList.add('show');
            
            // Add pulse animation for new notifications
            if (!badge.classList.contains('pulse')) {
                badge.classList.add('pulse');
                setTimeout(() => {
                    badge.classList.remove('pulse');
                }, 3000);
            }
        } else {
            badge.classList.remove('show', 'pulse');
            badge.textContent = '0';
        }
    }

    async loadViewRequestsTable() {
        const tableBody = document.getElementById('view-requests-table-body');
        if (!tableBody) return;

        try {
            // Show loading state
            tableBody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 2rem;">Loading requests...</td></tr>';

            // Fetch assessment requests from database
            const response = await fetch('../backend/api/get_requests.php');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Fetched view requests:', data);

            tableBody.innerHTML = '';

            if (!data.success || !data.data || data.data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 2rem; color: #666;">No requests found.</td></tr>';
                return;
            }

            // Filter only accepted requests for view module
            const acceptedRequests = data.data.filter(request => request.status === 'accepted');
            
            if (acceptedRequests.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 2rem; color: #666;">No accepted requests found.</td></tr>';
                return;
            }

            // Populate table with accepted requests from database
            acceptedRequests.forEach(request => {
                const row = document.createElement('tr');
                row.setAttribute('data-barangay', request.location || '');
                const formattedDate = new Date(request.created_at).toLocaleDateString();
                
                row.innerHTML = `
                    <td>#${request.id}</td>
                    <td>${request.name || 'N/A'}</td>
                    <td>${request.email || 'N/A'}</td>
                    <td>${request.contact_number || 'N/A'}</td>
                    <td><span class="category-badge ${(request.inspection_category || '').toLowerCase().replace(' ', '-')}">${request.inspection_category || 'N/A'}</span></td>
                    <td>${request.location || 'N/A'}</td>
                    <td>${request.landmark || 'N/A'}</td>
                    <td>${request.land_reference || 'N/A'}</td>
                    <td>${request.contact_person || 'N/A'}</td>
                    <td class="purpose-cell">${(request.purpose || 'N/A').length > 30 ? (request.purpose || 'N/A').substring(0, 30) + '...' : (request.purpose || 'N/A')}</td>
                    <td>${request.valid_id_name ? `<a href="../backend/api/view_valid_id.php?id=${request.id}" target="_blank" style="color: #007bff; text-decoration: none; font-weight: 500;">View</a>` : 'N/A'}</td>
                    <td>${formattedDate}</td>
                    <td><span class="status-badge accepted">Accepted</span></td>
                `;
                tableBody.appendChild(row);
            });

            console.log(`Loaded ${acceptedRequests.length} accepted requests in view module`);

        } catch (error) {
            console.error('Error loading view requests:', error);
            tableBody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 2rem; color: #dc3545;">Error loading requests. Please try again.</td></tr>';
        }
    }

    // Load and save workflow data
    loadIncomingRequests() {
        return [];
    }

    saveIncomingRequests() {
    // No-op: localStorage removed for backend integration
    }

    loadPendingRequests() {
        return {};
    }

    savePendingRequests() {
    // No-op: localStorage removed for backend integration
    }

    getSampleIncomingRequests() {
        return [];
    }

    async loadIncomingRequestsTable() {
        const tableBody = document.getElementById('incoming-requests-table-body');
        if (!tableBody) return;

        try {
            // Show loading state
            tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem;">Loading requests...</td></tr>';

            // Fetch assessment requests from database
            const response = await fetch('../backend/api/get_requests.php');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Fetched assessment requests:', data);

            tableBody.innerHTML = '';

            if (!data.success || !data.data || data.data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #666;">No pending requests found.</td></tr>';
                return;
            }

            // Filter only pending requests for notifications table
            const pendingRequests = data.data.filter(request => !request.status || request.status === 'pending');

            if (pendingRequests.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: #666;">No pending requests found.</td></tr>';
                return;
            }

            // Populate table with real data from database
            pendingRequests.forEach(request => {
                const row = document.createElement('tr');
                const formattedDate = new Date(request.created_at).toLocaleDateString();
                
                row.innerHTML = `
                    <td>#${request.id}</td>
                    <td>${request.name || 'N/A'}</td>
                    <td>${request.email || 'N/A'}</td>
                    <td>
                        <span class="badge" style="background: ${
                            request.inspection_category === 'Land Property' ? '#6c757d' : 
                            request.inspection_category === 'Machinery' ? '#007bff' : '#28a745'
                        }; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">
                            ${request.inspection_category || 'N/A'}
                        </span>
                    </td>
                    <td>${request.property_classification || 'N/A'}</td>
                    <td>${request.location || 'N/A'}</td>
                    <td class="purpose-cell">${(request.purpose || 'N/A').length > 30 ? (request.purpose || 'N/A').substring(0, 30) + '...' : (request.purpose || 'N/A')}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-success" onclick="acceptRequest('${request.id}')">
                                <i class="fas fa-check"></i>
                                Accept
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="declineRequest('${request.id}')">
                                <i class="fas fa-times"></i>
                                Decline
                            </button>
                            <button class="btn btn-sm btn-info" onclick="viewRequestDetails('${request.id}')">
                                <i class="fas fa-eye"></i>
                                Details
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            console.log(`Loaded ${pendingRequests.length} pending assessment requests`);
            
            // Update notification badge with current pending count
            this.updateNotificationBadge(pendingRequests.length);

        } catch (error) {
            console.error('Error loading assessment requests:', error);
            tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: #dc3545;">Error loading requests. Please try again.</td></tr>';
            // Set badge to 0 on error
            this.updateNotificationBadge(0);
        }
    }

    async acceptRequest(requestId) {
        // Show professional confirmation modal instead of browser confirm
        showAcceptRequestModal(requestId);
    }

    async processAcceptRequest(requestId) {
        try {
            console.log(`Processing accept request for ID: ${requestId}`);
            
            // Get the request details for acceptance processing
            const requestResponse = await fetch(`../backend/api/get_requests.php?id=${requestId}`);
            const requestResult = await requestResponse.json();
            
            if (!requestResult.success) {
                throw new Error('Failed to fetch request details');
            }
            
            const request = requestResult.data;
            
            // Update request status in database
            const response = await fetch('../backend/api/update_request_status.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    request_id: requestId,
                    status: 'accepted'
                })
            });
            
            const result = await response.json();
            console.log('Accept request response:', result);
            
            if (result.success) {
                // All categories now use batch scheduling - no immediate emails or auto-scheduling
                // Requests will be held in Inspection Requests module until batch of 5 is reached
                console.log(`Request accepted for batch scheduling: ${request.inspection_category} inspection in ${request.location}`);
                
                // Show success modal - all requests now go to batch scheduling
                showAcceptSuccessModal(requestId, request.location || 'Unknown');
                
                // Refresh all tables and stats
                await this.loadIncomingRequestsTable();
                await this.loadViewRequestsTable();
                await this.loadInspectionRequests();
                await this.updateDashboardStats();
                
                // Refresh calendar data to show new scheduled inspections
                if (this.scheduledInspections !== undefined) {
                    this.scheduledInspections = await this.loadScheduledInspections();
                    console.log('Refreshed scheduled inspections after accept:', this.scheduledInspections);
                    
                    // Re-render calendar if we're on calendar module
                    const calendarGrid = document.getElementById('calendar-grid');
                    if (calendarGrid) {
                        // Ensure we have current month/year set
                        if (this.currentMonth === undefined || this.currentYear === undefined) {
                            const now = new Date();
                            this.currentMonth = now.getMonth() + 1;
                            this.currentYear = now.getFullYear();
                        }
                        this.renderCalendar(this.currentMonth, this.currentYear);
                        console.log('Re-rendered calendar after accept');
                    }
                    
                    // Also refresh agenda view if it's currently active
                    const agendaViewBtn = document.querySelector('.view-btn[data-view="agenda"]');
                    if (agendaViewBtn && agendaViewBtn.classList.contains('active')) {
                        const calendarTitle = document.querySelector('.card-title');
                        const calendarView = document.getElementById('calendarView');
                        
                        if (calendarTitle && calendarView) {
                            this.renderAgendaView(calendarTitle, calendarView);
                            console.log('Refreshed agenda view after accept');
                        }
                    }
                }
                
            } else {
                console.error('Failed to accept request:', result.error);
                showAcceptErrorModal(result.error || 'Unknown error occurred');
            }
            
        } catch (error) {
            console.error('Error accepting request:', error);
            showAcceptErrorModal('Network error occurred. Please check your connection and try again.');
        }
    }

    async declineRequest(requestId) {
        // Show the decline modal instead of using prompt
        showDeclineRequestModal(requestId);
    }

    async processDeclineRequest(requestId, reason) {
        try {
            if (!reason || reason.trim() === '') {
                // This shouldn't happen as validation is done in the modal
                return;
            }

            // First, fetch the request details directly from the API
            const requestResponse = await fetch(`../backend/api/get_requests.php?id=${requestId}`);
            const requestResult = await requestResponse.json();
            
            if (!requestResult.success || !requestResult.data) {
                console.error('Request data not found for ID:', requestId);
                showDeclineErrorModal('Unable to find request details. Please refresh and try again.');
                return;
            }
            
            const requestData = requestResult.data;

            // Update request status in database
            const response = await fetch('../backend/api/update_request_status.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    request_id: requestId,
                    status: 'declined',
                    decline_reason: reason.trim()
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Send decline email notification
                await this.sendDeclineNotification(requestData, reason.trim());
                
                // Close loading modal
                const loadingModal = document.getElementById('declineLoadingModal');
                if (loadingModal) {
                    loadingModal.remove();
                }
                
                // Close the decline modal
                closeDeclineRequestModal();
                
                // Show professional success notification
                showDeclineSuccessModal(requestId, reason);
                
                // Refresh tables and stats
                await this.loadIncomingRequestsTable();
                await this.updateDashboardStats();
                
            } else {
                // Close loading modal
                const loadingModal = document.getElementById('declineLoadingModal');
                if (loadingModal) {
                    loadingModal.remove();
                }
                
                // Show professional error notification
                showDeclineErrorModal(result.error || 'Unknown error');
            }
            
        } catch (error) {
            console.error('Error declining request:', error);
            
            // Close loading modal
            const loadingModal = document.getElementById('declineLoadingModal');
            if (loadingModal) {
                loadingModal.remove();
            }
            
            showDeclineErrorModal('Error declining request. Please try again.');
        }
    }

    async sendDeclineNotification(requestData, declineReason) {
        try {
            console.log('Sending decline notification to:', requestData.email);
            console.log('Request data received:', requestData);

            // Prepare client data using correct database field names
            const clientData = {
                name: requestData.name,
                email: requestData.email
            };

            // Prepare form data using correct database field names
            const formData = {
                request_id: requestData.id,
                category: requestData.inspection_category || 'Land Property Assessment',
                property_address: requestData.location || 'N/A',
                submission_date: requestData.created_at ? new Date(requestData.created_at).toLocaleDateString() : new Date().toLocaleDateString()
            };

            console.log('Prepared email data:', { clientData, formData, declineReason });

            // Send decline notification
            const emailResponse = await fetch('../backend/api/email_notifications.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'send_decline',
                    client_data: clientData,
                    form_data: formData,
                    decline_reason: declineReason
                })
            });

            const emailResult = await emailResponse.json();
            
            if (emailResult.success) {
                console.log('Decline notification email sent successfully');
            } else {
                console.warn('Failed to send decline notification email:', emailResult.message);
                // Don't throw error - declining should still work even if email fails
            }

        } catch (error) {
            console.error('Error sending decline notification:', error);
            // Don't throw error - declining should still work even if email fails
        }
    }

    getTotalPendingCount() {
        let total = 0;
        Object.values(this.pendingRequests).forEach(barangayRequests => {
            total += barangayRequests.length;
        });
        return total;
    }


    // Show notification when pending requests reach 10
    showPendingNotification(barangayName, count) {
        // You can replace this with a custom toast/notification UI
        alert(`Barangay ${barangayName} has reached ${count} pending requests and is ready to schedule!`);
    }
    // --- Calendar Logic ---

    renderCalendar() {
        console.log(' renderCalendar() function called in DASHBOARD MODULE!');
        console.log(' DASHBOARD blocked dates available:', this.blockedDates);
        
        // Ensure we're in the dashboard section
        const dashboardSection = document.getElementById('dashboard');
        const isDashboardActive = dashboardSection && dashboardSection.classList.contains('active');
        console.log(' Is dashboard section active?', isDashboardActive);
        
        const calendarContainer = document.getElementById('calendarView');
        if (!calendarContainer) {
            console.error(' Calendar container not found!');
            return;
        }
        
        console.log(' Calendar container found in dashboard:', calendarContainer);
        
        try {
            console.log('=== CALENDAR RENDER START ===');
            console.log('Rendering calendar with scheduled inspections:', this.scheduledInspections);
            
            // Debug: Show status breakdown
            if (this.scheduledInspections && this.scheduledInspections.length > 0) {
                const statusCounts = {};
                this.scheduledInspections.forEach(item => {
                    statusCounts[item.status || 'undefined'] = (statusCounts[item.status || 'undefined'] || 0) + 1;
                });
                console.log('Inspection status breakdown:', statusCounts);
                
                // Show all completed inspections for debugging
                const completedInspections = this.scheduledInspections.filter(item => item.status === 'completed');
                console.log('All completed inspections in calendar data:', completedInspections.map(item => 
                    `ID: ${item.id}, Date: ${item.date}, Barangay: ${item.barangay}, Status: ${item.status}`
                ));
            }
        } catch (error) {
            console.error('Error in renderCalendar function:', error);
            return;
        }

        // Always get fresh current date to ensure accuracy on refresh
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time to midnight for accurate date comparison
        
        // Use the same date system as the Google Calendar navigation
        let currentMonth, currentYear;
        if (this.currentDate) {
            currentMonth = this.currentDate.getMonth();
            currentYear = this.currentDate.getFullYear();
        } else {
            // Fallback to current date if not initialized
            this.currentDate = new Date();
            currentMonth = this.currentDate.getMonth();
            currentYear = this.currentDate.getFullYear();
        }

        // Get first day of the month
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const startDay = firstDay.getDay(); // 0 (Sun) - 6 (Sat)
        const daysInMonth = lastDay.getDate();

        // Calendar header
        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        let html = `
            <div class="calendar-nav">
                <button id="calendarPrevBtn">&lt;</button>
                <span><strong>${monthNames[currentMonth]} ${currentYear}</strong></span>
                <button id="calendarNextBtn">&gt;</button>
            </div>
            <table class="calendar-table">
                <thead>
                    <tr>
                        <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th>
                        <th>Thu</th><th>Fri</th><th>Sat</th>
                    </tr>
                </thead>
                <tbody>
        `;

        let day = 1;
        for (let i = 0; i < 6; i++) { // 6 weeks
            html += "<tr>";
            for (let j = 0; j < 7; j++) {
                if ((i === 0 && j < startDay) || day > daysInMonth) {
                    html += "<td></td>";
                } else {
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    let tdClass = "";
                    let tdTitle = "";
                    let noteHtml = '';
                    let indicatorHtml = '';
                    
                    // Check for blocked dates (DASHBOARD MODULE ONLY)
                    const blockedInfo = this.getBlockedDateInfo(dateStr);
                    if (blockedInfo) {
                        console.log(` DASHBOARD: Found blocked date ${dateStr}:`, blockedInfo);
                        tdClass += " blocked";
                        tdTitle = ` BLOCKED - ${blockedInfo.reason}`;
                        noteHtml = `<div class='blocked-note'>${blockedInfo.reason}</div>`;
                        indicatorHtml = `<div class='blocked-indicator'></div>`;
                    }
                    
                    // Check for holidays
                    const holidayName = this.isHoliday(dateStr);
                    if (holidayName) {
                        tdClass += " holiday";
                        if (!tdTitle) tdTitle = holidayName;
                    }
                    
                    // Check for scheduled inspections (only show non-completed ones)
                    const scheduledList = this.scheduledInspections.filter(item => 
                        item.date === dateStr && 
                        item.status !== 'completed' && 
                        item.status !== 'cancelled'
                    );
                    if (scheduledList.length > 0 && !blockedInfo) { // Don't show scheduled if date is blocked
                        console.log(` Found ${scheduledList.length} active scheduled inspection(s) for ${dateStr}:`, scheduledList);
                        tdClass += " scheduled clickable";
                        
                        if (scheduledList.length === 1) {
                            tdTitle = `Scheduled Inspection - ${scheduledList[0].barangay}: ${scheduledList[0].note} (Click for details)`;
                            noteHtml = `<div class='calendar-note'>${scheduledList[0].barangay}</div>`;
                        } else {
                            tdTitle = `${scheduledList.length} Scheduled Inspections (Click for details)`;
                            noteHtml = `<div class='calendar-note multiple-inspections'>${scheduledList.length} Inspections</div>`;
                        }
                        indicatorHtml = `<div class='scheduled-indicator'></div>`;
                    } else {
                        // Debug: Check if there are completed inspections for this date
                        const completedInspections = this.scheduledInspections.filter(item => 
                            item.date === dateStr && 
                            (item.status === 'completed' || item.status === 'cancelled')
                        );
                        if (completedInspections.length > 0) {
                            console.log(` Found ${completedInspections.length} completed inspection(s) for ${dateStr} (not showing):`, completedInspections);
                        }
                    }
                    
                    // Check if today
                    if (
                        day === today.getDate() &&
                        currentMonth === today.getMonth() &&
                        currentYear === today.getFullYear()
                    ) tdClass += " today";
                    
                    // If not a holiday or scheduled, show inspection note if any
                    if (!tdTitle) {
                        const inspectionNote = this.getInspectionNote(dateStr);
                        if (inspectionNote) {
                            console.log(` getInspectionNote for ${dateStr} returned:`, inspectionNote);
                        }
                        tdTitle = inspectionNote || '';
                    }
                    
                    // Debug: Log what's being added to this calendar cell
                    if (noteHtml || tdTitle || tdClass.includes('scheduled')) {
                        console.log(` Calendar cell ${dateStr}: class="${tdClass}", title="${tdTitle}", noteHtml="${noteHtml}"`);
                    }
                    
                    html += `<td class="${tdClass.trim()}" title="${tdTitle}" 
                             ${scheduled ? `onclick="staffApp.showInspectionDetails('${dateStr}')"` : ''}>${day}${noteHtml}${indicatorHtml}</td>`;
                    day++;
                }
            }
            html += "</tr>";
            if (day > daysInMonth) break;
        }
        html += `
                </tbody>
            </table>
        `;

        calendarContainer.innerHTML = html;
        console.log(' Calendar DOM updated successfully!');

        // Calendar navigation - sync with main navigation system
        document.getElementById('calendarPrevBtn').onclick = () => {
            if (!this.currentDate) this.currentDate = new Date();
            this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            this.renderCurrentView();
        };
        document.getElementById('calendarNextBtn').onclick = () => {
            if (!this.currentDate) this.currentDate = new Date();
            this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            this.renderCurrentView();
        };
    }

    isScheduled(dateStr) {
        return this.scheduledInspections.some(item => 
            item.date === dateStr && 
            item.status !== 'completed' && 
            item.status !== 'cancelled'
        );
    }

    getInspectionNote(dateStr) {
        const found = this.scheduledInspections.find(item => 
            item.date === dateStr && 
            item.status !== 'completed' && 
            item.status !== 'cancelled'
        );
        return found ? `${found.barangay}: ${found.note}` : '';
    }

    isHoliday(dateStr) {
        // Map of recurring holidays (fixed dates) for all years, all months
        const recurringHolidays = {
            '01-01': "New Year's Day",
            '02-25': "EDSA Revolution Anniversary",
            '04-09': "Araw ng Kagitingan",
            '05-01': "Labor Day",
            '06-12': "Independence Day",
            '08-21': "Ninoy Aquino Day",
            '11-01': "All Saints' Day",
            '11-30': "Bonifacio Day",
            '12-08': "Immaculate Conception",
            '12-25': "Christmas Day",
            '12-30': "Rizal Day"
        };

        // Moveable holidays for 2025 (add more years as needed)
        const moveableHolidays = {
            '2025-04-17': "Maundy Thursday",
            '2025-04-18': "Good Friday",
            '2025-08-25': "National Heroes Day"
            // Add more moveable holidays for other years as needed
        };

        const year = dateStr.slice(0, 4);
        const monthDay = dateStr.slice(5);

        if (recurringHolidays[monthDay]) return recurringHolidays[monthDay];
        if (moveableHolidays[dateStr]) return moveableHolidays[dateStr];
        return false;
    }

    getHolidays() {
        // Not used anymore, but kept for compatibility
        return [];
    }

    // Save scheduled inspections to localStorage (simulate backend)
    saveScheduledInspections() {
    // No-op: localStorage removed for backend integration
    }

    async loadScheduledInspections() {
        try {
            console.log('=== LOADING SCHEDULED INSPECTIONS ===');
            // Add cache-busting parameter to ensure fresh data
            const response = await fetch(`../backend/api/get_scheduled_inspections.php?_=${Date.now()}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Raw API response for scheduled inspections:', data);
            
            if (data.success) {
                const inspections = data.data || [];
                console.log('Parsed scheduled inspections:', inspections);
                console.log('Inspection count by status:', 
                    inspections.reduce((acc, item) => {
                        acc[item.status || 'undefined'] = (acc[item.status || 'undefined'] || 0) + 1;
                        return acc;
                    }, {})
                );
                return inspections;
            } else {
                console.error('Error loading scheduled inspections:', data.message);
                return [];
            }
        } catch (error) {
            console.error('Error fetching scheduled inspections:', error);
            return [];
        }
    }

    async loadInspectionRequests() {
        const tableBody = document.getElementById('inspection-requests-table-body');
        if (!tableBody) return;

        try {
            // Show loading state
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">Loading inspection requests...</td></tr>';

            // Fetch assessment requests from database
            const response = await fetch('../backend/api/get_requests.php');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Fetched requests for inspection scheduling:', data);

            tableBody.innerHTML = '';

            if (!data.success || !data.data) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #dc3545;">Error loading requests.</td></tr>';
                return;
            }

            // Get only accepted requests for scheduling (minimum 5 per barangay)
            const acceptedRequests = data.data.filter(request => request.status === 'accepted');
            
            // Group accepted requests by barangay
            const barangayGroups = {};
            acceptedRequests.forEach(request => {
                const barangay = request.location || 'Unknown';
                if (!barangayGroups[barangay]) {
                    barangayGroups[barangay] = [];
                }
                barangayGroups[barangay].push(request);
            });

            // List of all barangays to show (even with 0 requests)
            const allBarangays = [
                'Poblacion', 'Anilao Proper', 'Anilao East', 'Bagalangit', 'Bulacan',
                'Calamias', 'Estrella', 'Gasang', 'Laurel', 'Ligaya',
                'Mainaga', 'Mainit', 'Majuben', 'Malimatoc-1', 'Malimatoc-2',
                'Nag-Iba', 'Pilahan', 'P. Anahao', 'P. Balibaguhan', 'P. Lupa',
                'P. Niogan', 'Saguing', 'Sampaguita', 'San Francisco', 'San Jose',
                'San Juan', 'San Teodoro', 'Solo', 'Sta. Ana', 'Sta. Mesa',
                'Sto. Nio', 'Sto. Tomas', 'Talaga Proper', 'Talaga East'
            ];

            // Add barangays that have requests but aren't in the predefined list
            Object.keys(barangayGroups).forEach(barangay => {
                if (!allBarangays.includes(barangay)) {
                    allBarangays.push(barangay);
                }
            });

            // Sort hierarchy: highest to lowest number of requests, then alphabetically
            allBarangays.sort((a, b) => {
                const requestsA = barangayGroups[a] || [];
                const requestsB = barangayGroups[b] || [];
                const countA = requestsA.length;
                const countB = requestsB.length;
                
                // Priority 1: Sort by request count (descending - highest to lowest)
                if (countA !== countB) {
                    return countB - countA; // Higher count first
                }
                
                // Priority 2: If same count, sort alphabetically
                return a.localeCompare(b);
            });

            // Create table rows for each barangay
            allBarangays.forEach(barangayName => {
                const requestsInBarangay = barangayGroups[barangayName] || [];
                
                // Count by category
                const landPropertyCount = requestsInBarangay.filter(req => req.inspection_category === 'Land Property').length;
                const machineryCount = requestsInBarangay.filter(req => req.inspection_category === 'Machinery').length;
                const buildingCount = requestsInBarangay.filter(req => req.inspection_category === 'Building').length;
                const totalCount = requestsInBarangay.length;
                
                const canSchedule = totalCount >= 5;
                const isReady = totalCount > 0 && totalCount < 5;

                const row = document.createElement('tr');
                
                // Add visual indicators based on count
                if (canSchedule) {
                    row.classList.add('ready-to-schedule');
                }

                row.innerHTML = `
                    <td><strong>${barangayName}</strong></td>
                    <td class="centered-col">${landPropertyCount}</td>
                    <td class="centered-col">${machineryCount}</td>
                    <td class="centered-col">${buildingCount}</td>
                    <td class="centered-col ${canSchedule ? 'highlight-count' : ''} ${isReady ? 'pending-red' : ''}">${totalCount}</td>
                    <td class="centered-col">
                        <button class="btn ${canSchedule ? 'btn-success schedule-btn' : 'btn-secondary'} btn-sm" 
                                data-barangay="${barangayName}" 
                                data-count="${totalCount}"
                                ${!canSchedule ? 'disabled' : ''}
                                onclick="staffApp.openScheduleModal('${barangayName}', ${totalCount})">
                            ${canSchedule ? '<i class="fas fa-calendar-check"></i> Schedule Now' : `<i class="fas fa-calendar-plus"></i> Schedule (${totalCount}/5)`}
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            console.log(`Loaded inspection requests grouped by barangay. ${acceptedRequests.length} total accepted requests.`);

        } catch (error) {
            console.error('Error loading inspection requests:', error);
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #dc3545;">Error loading requests. Please try again.</td></tr>';
        }
    }

    openScheduleModal(barangayName, requestCount) {
        try {
            // Verify the barangay has enough requests to schedule
            if (requestCount < 5) {
                this.showValidationError(
                    'Insufficient Requests for Batch Scheduling',
                    `Barangay ${barangayName} has only ${requestCount} request(s). You need at least 5 requests to schedule a batch inspection.`
                );
                return;
            }

            // Show schedule modal
            const scheduleModal = document.getElementById('scheduleModal');
            
            if (scheduleModal) {
                // Store current barangay data for saving
                scheduleModal.dataset.barangay = barangayName;
                scheduleModal.dataset.requestCount = requestCount;
                
                // Populate modal with context-aware data
                populateScheduleModal(barangayName, requestCount);
                
                // Show the modal
                scheduleModal.style.display = 'flex';
                scheduleModal.classList.add('show');
                
                // Prevent body scroll when modal is open
                document.body.style.overflow = 'hidden';
                
                // Initialize calendar widget
                setTimeout(() => {
                    initializeCalendar();
                }, 100);
                
                console.log(` Opened scheduling modal for ${barangayName} (${requestCount} properties)`);
            } else {
                this.showErrorModal('Interface Error', 'Scheduling interface not available. Please refresh the page and try again.');
            }
        } catch (error) {
            console.error(' Error opening schedule modal:', error);
            this.showErrorModal('System Error', 'Failed to open scheduling interface. Please try again or contact support.');
        }
    }

    async saveSchedule() {
        try {
            const scheduleModal = document.getElementById('scheduleModal');
            const scheduleDate = document.getElementById('scheduleDate');
            const scheduleNote = document.getElementById('scheduleNote');

            const barangayName = scheduleModal.dataset.barangay;
            const requestCount = scheduleModal.dataset.requestCount;
            const selectedDate = scheduleDate.value;
            const note = scheduleNote.value.trim();

            // Enhanced validation with professional error messages
            if (!selectedDate) {
                scheduleDate.style.borderColor = '#f44336';
                scheduleDate.focus();
                this.showValidationError('Please select a date for the inspection', 'Date is required for scheduling the batch inspection');
                return;
            }

            if (!validateScheduleDate()) {
                scheduleDate.focus();
                this.showValidationError('Please select a future date', 'The inspection date must be at least one day in the future');
                return;
            }

            if (!note) {
                scheduleNote.style.borderColor = '#f44336';
                scheduleNote.focus();
                this.showValidationError('Please add inspection notes', 'Notes help the inspection team prepare and understand requirements');
                return;
            }

            if (note.length < 10) {
                scheduleNote.style.borderColor = '#f44336';
                scheduleNote.focus();
                this.showValidationError('Please provide more detailed notes', 'Notes should be at least 10 characters to provide adequate information');
                return;
            }

            // Reset form styling
            scheduleDate.style.borderColor = '#e0e0e0';
            scheduleNote.style.borderColor = '#e0e0e0';

            // Professional confirmation modal
            const confirmResult = await this.showConfirmationModal({
                title: ' Confirm Batch Inspection Scheduling',
                message: 'You are about to schedule a batch inspection with the following details:',
                details: {
                    barangay: barangayName,
                    date: new Date(selectedDate).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }),
                    properties: `${requestCount} properties`,
                    note: note
                }
            });

            if (!confirmResult) return;

            // Show loading state
            const saveBtn = document.getElementById('saveScheduleBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = ' Scheduling...';
            saveBtn.disabled = true;

            try {
                console.log(' Sending schedule request:', {
                    barangay: barangayName,
                    inspection_date: selectedDate,
                    request_count: parseInt(requestCount),
                    notes: note
                });

                // Save to database
                const response = await fetch('../backend/api/save_schedule.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        barangay: barangayName,
                        inspection_date: selectedDate,
                        request_count: parseInt(requestCount),
                        notes: note
                    })
                });

                const data = await response.json();
                console.log(' Schedule response:', data);

                if (!response.ok || !data.success) {
                    throw new Error(data.message || `Server error: ${response.status}`);
                }

                // Add to local array for immediate calendar update
                const newInspection = {
                    id: data.data.id,
                    date: selectedDate,
                    barangay: barangayName,
                    requestCount: requestCount,
                    note: note,
                    status: 'scheduled'
                };

                this.scheduledInspections.push(newInspection);

                // Close modal
                scheduleModal.classList.remove('show');
                scheduleModal.style.display = 'none';
                document.body.style.overflow = 'auto';

                // Show professional success modal
                showProfessionalSuccess({
                    barangay: barangayName,
                    date: selectedDate,
                    requestCount: requestCount,
                    note: note,
                    emails_sent: data.emails_sent,
                    total_clients: data.total_clients,
                    email_errors: data.email_errors
                });

                // Refresh displays
                await this.loadInspectionRequests();
                this.renderCurrentView();
                await this.updateDashboardStats();
                
                // Refresh batch scheduling calendar to show updated availability
                if (typeof loadCalendarData === 'function') {
                    await loadCalendarData();
                }

            } finally {
                // Restore button state
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }

        } catch (error) {
            console.error(' Error saving schedule:', error);
            this.showErrorModal('Failed to Schedule Inspection', error.message);
        }
    }

    showValidationError(title, message) {
        // Create a professional validation error notification
        const errorDiv = document.createElement('div');
        errorDiv.className = 'professional-notification';
        errorDiv.innerHTML = `
            <div class="validation-error">
                <div class="error-title">
                    <span></span>
                    <span>${title}</span>
                </div>
                <div class="error-message">${message}</div>
            </div>
        `;
        
        document.body.appendChild(errorDiv);
        
        // Auto-remove with fade out animation
        setTimeout(() => {
            errorDiv.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 300);
        }, 4000);
    }

    showErrorModal(title, message) {
        // Create error modal
        const errorModal = document.createElement('div');
        errorModal.className = 'modal';
        errorModal.style.display = 'block';
        errorModal.innerHTML = `
            <div class="modal-content" style="max-width: 500px; margin: 5% auto;">
                <div class="modal-header" style="background: #f44336; color: white; padding: 20px 30px; border-radius: 8px 8px 0 0; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;"></div>
                    <h3 style="margin: 0; font-weight: 300; font-size: 22px;">${title}</h3>
                </div>
                <div class="modal-body" style="padding: 30px; text-align: center;">
                    <p style="color: #666; font-size: 16px; line-height: 1.5;">${message}</p>
                    <p style="color: #999; font-size: 14px; margin-top: 20px;">Please try again or contact technical support if the problem persists.</p>
                </div>
                <div class="modal-footer" style="padding: 20px 30px; background: #f8f9fa; border-radius: 0 0 8px 8px; text-align: center; border-top: 1px solid #e0e0e0;">
                    <button onclick="this.closest('.modal').remove()" 
                            style="background: #f44336; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(errorModal);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (errorModal.parentNode) {
                errorModal.remove();
            }
        }, 10000);
    }

    showConfirmationModal(options) {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.6);
                backdrop-filter: blur(2px);
            `;
            
            modal.innerHTML = `
                <div style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 450px;
                    max-width: 90vw;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
                    overflow: hidden;
                ">
                    <!-- Header -->
                    <div style="
                        background: linear-gradient(135deg, #2d8659 0%, #1e6b44 100%);
                        color: white;
                        padding: 24px 30px;
                        text-align: center;
                    ">
                        <h2 style="
                            margin: 0;
                            font-size: 20px;
                            font-weight: 600;
                            letter-spacing: 0.3px;
                        ">Confirmation Required</h2>
                        <p style="
                            margin: 6px 0 0 0;
                            font-size: 14px;
                            opacity: 0.9;
                        ">Batch Inspection Scheduling</p>
                    </div>

                    <!-- Content -->
                    <div style="padding: 30px;">
                        <p style="
                            margin: 0 0 24px 0;
                            color: #4a5568;
                            font-size: 15px;
                            line-height: 1.5;
                            text-align: center;
                        ">Please confirm the inspection details below:</p>

                        <!-- Details Card -->
                        <div style="
                            background: #f7fafc;
                            border: 1px solid #e2e8f0;
                            border-radius: 8px;
                            overflow: hidden;
                            margin-bottom: 20px;
                        ">
                            <div style="
                                display: grid;
                                grid-template-columns: 140px 1fr;
                                align-items: center;
                                padding: 16px 20px;
                                border-bottom: 1px solid #e2e8f0;
                            ">
                                <span style="
                                    font-weight: 600;
                                    color: #2d3748;
                                    font-size: 14px;
                                ">Barangay</span>
                                <span style="
                                    color: #4a5568;
                                    font-size: 14px;
                                ">${options.details.barangay}</span>
                            </div>

                            <div style="
                                display: grid;
                                grid-template-columns: 140px 1fr;
                                align-items: center;
                                padding: 16px 20px;
                                border-bottom: 1px solid #e2e8f0;
                            ">
                                <span style="
                                    font-weight: 600;
                                    color: #2d3748;
                                    font-size: 14px;
                                ">Inspection Date</span>
                                <span style="
                                    color: #4a5568;
                                    font-size: 14px;
                                ">${options.details.date}</span>
                            </div>

                            <div style="
                                display: grid;
                                grid-template-columns: 140px 1fr;
                                align-items: center;
                                padding: 16px 20px;
                                ${options.details.note ? 'border-bottom: 1px solid #e2e8f0;' : ''}
                            ">
                                <span style="
                                    font-weight: 600;
                                    color: #2d3748;
                                    font-size: 14px;
                                ">Total Properties</span>
                                <span style="
                                    color: #4a5568;
                                    font-size: 14px;
                                ">${options.details.properties}</span>
                            </div>

                            ${options.details.note ? `
                            <div style="
                                display: grid;
                                grid-template-columns: 140px 1fr;
                                align-items: flex-start;
                                padding: 16px 20px;
                            ">
                                <span style="
                                    font-weight: 600;
                                    color: #2d3748;
                                    font-size: 14px;
                                    padding-top: 2px;
                                ">Notes</span>
                                <span style="
                                    color: #4a5568;
                                    font-size: 14px;
                                    line-height: 1.5;
                                ">${options.details.note}</span>
                            </div>
                            ` : ''}
                        </div>

                        <!-- Notice -->
                        <div style="
                            background: #fef5e7;
                            border: 1px solid #f6d55c;
                            border-radius: 6px;
                            padding: 14px 16px;
                            display: flex;
                            align-items: center;
                            margin-bottom: 8px;
                        ">
                            <div style="
                                width: 20px;
                                height: 20px;
                                background: #f59e0b;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin-right: 12px;
                                flex-shrink: 0;
                            ">
                                <span style="
                                    color: white;
                                    font-size: 12px;
                                    font-weight: bold;
                                ">!</span>
                            </div>
                            <span style="
                                color: #92400e;
                                font-size: 13px;
                                font-weight: 500;
                            ">Email notifications will be sent to all property owners</span>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="
                        background: #f7fafc;
                        border-top: 1px solid #e2e8f0;
                        padding: 20px 30px;
                        display: flex;
                        justify-content: flex-end;
                        gap: 12px;
                    ">
                        <button id="cancelBtn" style="
                            background: white;
                            color: #4a5568;
                            border: 1px solid #cbd5e0;
                            padding: 10px 20px;
                            border-radius: 6px;
                            font-size: 14px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " 
                        onmouseover="this.style.background='#f7fafc'; this.style.borderColor='#a0aec0';" 
                        onmouseout="this.style.background='white'; this.style.borderColor='#cbd5e0';">
                            Cancel
                        </button>
                        <button id="confirmBtn" style="
                            background: linear-gradient(135deg, #2d8659 0%, #1e6b44 100%);
                            color: white;
                            border: none;
                            padding: 10px 24px;
                            border-radius: 6px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        "
                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(45, 134, 89, 0.4)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            Confirm Schedule
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('#cancelBtn').onclick = () => {
                modal.remove();
                resolve(false);
            };
            
            modal.querySelector('#confirmBtn').onclick = () => {
                modal.remove();
                resolve(true);
            };
            
            // Close on background click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                    resolve(false);
                }
            };
        });
    }

    showBarangayRequests(barangay) {
        const requests = this.pendingRequests[barangay] || [];
        
        if (requests.length === 0) {
            alert(`No pending requests for ${barangay}.`);
            return;
        }

        let requestsList = `Pending Requests for ${barangay}:\n\n`;
        requests.forEach((req, index) => {
            requestsList += `${index + 1}. ${req.clientName} (${req.email})\n   Purpose: ${req.purpose}\n\n`;
        });

        alert(requestsList);
    }

    sendBatchNotifications(scheduledInspection) {
        const { barangay, date, note, requests } = scheduledInspection;
        
        console.log(`Sending batch notifications for ${barangay} inspection on ${date}`);
        
        requests.forEach(request => {
            this.sendInspectionNotification(request, date, note);
        });

        // Simulate API call for batch email sending
        // In real implementation, this would call your backend API
        console.log(`Batch notification sent to ${requests.length} clients for ${barangay} inspection`);
    }

    sendInspectionNotification(request, date, note) {
        // Simulate sending email notification to client
        const emailData = {
            to: request.email,
            subject: `Inspection Scheduled - ${request.propertyClass} Property Assessment`,
            body: `
                Dear ${request.clientName},

                Your property assessment request (ID: ${request.id}) has been scheduled.

                Inspection Details:
                - Date: ${date}
                - Location: ${request.location}
                - Property: ${request.propertyClass}
                - Reference: ${request.landRef}
                - Notes: ${note}

                Please ensure that you or your contact person (${request.contactPerson}) is available on the scheduled date.

                Best regards,
                Assessor's Office
            `
        };

        console.log(`Email notification prepared for ${request.email}:`, emailData);
        // In real implementation: fetch('/api/send-email', { method: 'POST', body: JSON.stringify(emailData) })
    }

    // Add this method at the end of the class
    initNotificationModuleUI() {
        document.addEventListener('DOMContentLoaded', () => {
            const notificationBtn = document.querySelector('.notification-btn');
            const sidebarNotificationsLink = document.getElementById('sidebarNotificationsLink');
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            const pageTitle = document.getElementById('pageTitle');

            function showNotificationsSection() {
                navLinks.forEach(link => link.classList.remove('active'));
                if (sidebarNotificationsLink) sidebarNotificationsLink.classList.add('active');
                contentSections.forEach(section => section.classList.remove('active'));
                document.getElementById('notifications').classList.add('active');
                pageTitle.textContent = 'AssessPro';
                // Highlight the notification icon at the top
                if (notificationBtn) notificationBtn.classList.add('active');
            }

            function removeNotificationHighlight() {
                if (notificationBtn) notificationBtn.classList.remove('active');
            }

            // Remove highlight when navigating away from notifications
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    if (link.getAttribute('data-section') !== 'notifications') {
                        removeNotificationHighlight();
                    }
                });
            });

            if (notificationBtn && sidebarNotificationsLink) {
                notificationBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showNotificationsSection();
                });
                sidebarNotificationsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    showNotificationsSection();
                });
            }
        });
    }
    initGoogleCalendar() {
        this.currentView = 'month';
        // Always start with the current date
        this.currentDate = new Date();
        this.events = []; // Empty events array - ready for future scheduling
        this.holidays = this.getPhilippineHolidays();

        this.bindCalendarEvents();
        
        // Set initial navigation visibility (month view shows all buttons)
        this.toggleNavigationVisibility('month');
        
        this.renderCurrentView();
    }

    getPhilippineHolidays() {
        const year = this.currentDate.getFullYear();
        const holidays = [];
        
        // Fixed National Holidays
        holidays.push({ date: new Date(year, 0, 1), name: "New Year", type: 'national' });
        holidays.push({ date: new Date(year, 3, 9), name: "Araw ng Kagitingan", type: 'national' });
        holidays.push({ date: new Date(year, 4, 1), name: "Labor Day", type: 'national' });
        holidays.push({ date: new Date(year, 5, 12), name: "Independence", type: 'national' });
        holidays.push({ date: new Date(year, 10, 30), name: "Bonifacio Day", type: 'national' });
        holidays.push({ date: new Date(year, 11, 25), name: "Christmas", type: 'national' });
        holidays.push({ date: new Date(year, 11, 30), name: "Rizal Day", type: 'national' });
        
        // Movable National Holidays (last Monday)
        holidays.push({ date: this.getLastMonday(year, 7), name: "Heroes Day", type: 'national' });
        
        // Special Non-working Holidays
        holidays.push({ date: new Date(year, 1, 25), name: "EDSA Revolution", type: 'special' });
        holidays.push({ date: new Date(year, 7, 21), name: "Ninoy Aquino", type: 'special' });
        holidays.push({ date: new Date(year, 10, 1), name: "All Saints", type: 'special' });
        holidays.push({ date: new Date(year, 10, 2), name: "All Souls", type: 'special' });
        holidays.push({ date: new Date(year, 11, 8), name: "Immaculate Conception", type: 'special' });
        holidays.push({ date: new Date(year, 11, 31), name: "New Year's Eve", type: 'special' });
        
        // Religious Holidays (Easter-based - approximate)
        const easter = this.getEasterDate(year);
        const palmSunday = new Date(easter.getTime() - 7 * 24 * 60 * 60 * 1000);
        const maundyThursday = new Date(easter.getTime() - 3 * 24 * 60 * 60 * 1000);
        const goodFriday = new Date(easter.getTime() - 2 * 24 * 60 * 60 * 1000);
        const blackSaturday = new Date(easter.getTime() - 1 * 24 * 60 * 60 * 1000);
        
        holidays.push({ date: palmSunday, name: "Palm Sunday", type: 'religious' });
        holidays.push({ date: maundyThursday, name: "Maundy Thursday", type: 'religious' });
        holidays.push({ date: goodFriday, name: "Good Friday", type: 'religious' });
        holidays.push({ date: blackSaturday, name: "Black Saturday", type: 'religious' });
        holidays.push({ date: easter, name: "Easter Sunday", type: 'religious' });
        
        // Chinese New Year (approximate - varies by year)
        holidays.push({ date: this.getChineseNewYear(year), name: "Chinese New Year", type: 'special' });
        
        // Eid al-Fitr and Eid al-Adha (approximate - varies by year)
        const eidDates = this.getEidDates(year);
        holidays.push(...eidDates);
        
        return holidays;
    }
    
    getLastMonday(year, month) {
        const lastDay = new Date(year, month + 1, 0);
        const day = lastDay.getDay();
        const mondayOffset = day === 0 ? 6 : day - 1;
        return new Date(year, month, lastDay.getDate() - mondayOffset);
    }
    
    getEasterDate(year) {
        // Easter calculation using Anonymous Gregorian algorithm
        const a = year % 19;
        const b = Math.floor(year / 100);
        const c = year % 100;
        const d = Math.floor(b / 4);
        const e = b % 4;
        const f = Math.floor((b + 8) / 25);
        const g = Math.floor((b - f + 1) / 3);
        const h = (19 * a + b - d - g + 15) % 30;
        const i = Math.floor(c / 4);
        const k = c % 4;
        const l = (32 + 2 * e + 2 * i - h - k) % 7;
        const m = Math.floor((a + 11 * h + 22 * l) / 451);
        const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
        const day = ((h + l - 7 * m + 114) % 31) + 1;
        return new Date(year, month, day);
    }
    
    getChineseNewYear(year) {
        // Extended Chinese New Year dates for more years
        const chineseNewYearDates = {
            2020: new Date(2020, 0, 25),
            2021: new Date(2021, 1, 12),
            2022: new Date(2022, 1, 1),
            2023: new Date(2023, 0, 22),
            2024: new Date(2024, 1, 10),
            2025: new Date(2025, 0, 29),
            2026: new Date(2026, 1, 17),
            2027: new Date(2027, 1, 6),
            2028: new Date(2028, 0, 26),
            2029: new Date(2029, 1, 13),
            2030: new Date(2030, 1, 3),
            2031: new Date(2031, 0, 23),
            2032: new Date(2032, 1, 11),
            2033: new Date(2033, 0, 31),
            2034: new Date(2034, 1, 19),
            2035: new Date(2035, 1, 8)
        };
        // Default to late January if year not found
        return chineseNewYearDates[year] || new Date(year, 0, 28);
    }
    
    getEidDates(year) {
        // Extended Eid dates for more years
        const eidDates = [];
        const eidAlFitrDates = {
            2020: new Date(2020, 4, 24),
            2021: new Date(2021, 4, 13),
            2022: new Date(2022, 4, 2),
            2023: new Date(2023, 3, 21),
            2024: new Date(2024, 3, 10),
            2025: new Date(2025, 2, 30),
            2026: new Date(2026, 2, 20),
            2027: new Date(2027, 2, 9),
            2028: new Date(2028, 1, 26),
            2029: new Date(2029, 1, 14),
            2030: new Date(2030, 1, 4),
            2031: new Date(2031, 0, 24),
            2032: new Date(2032, 0, 13),
            2033: new Date(2033, 11, 2),
            2034: new Date(2034, 10, 21),
            2035: new Date(2035, 10, 10)
        };
        
        const eidAlAdhaDates = {
            2020: new Date(2020, 6, 31),
            2021: new Date(2021, 6, 20),
            2022: new Date(2022, 6, 9),
            2023: new Date(2023, 5, 28),
            2024: new Date(2024, 5, 17),
            2025: new Date(2025, 5, 6),
            2026: new Date(2026, 4, 26),
            2027: new Date(2027, 4, 16),
            2028: new Date(2028, 4, 5),
            2029: new Date(2029, 3, 24),
            2030: new Date(2030, 3, 13),
            2031: new Date(2031, 3, 2),
            2032: new Date(2032, 1, 19),
            2033: new Date(2033, 1, 8),
            2034: new Date(2034, 0, 28),
            2035: new Date(2035, 0, 16)
        };
        
        // Add Eid dates if available, otherwise skip them
        if (eidAlFitrDates[year]) {
            eidDates.push({ date: eidAlFitrDates[year], name: "Eid al-Fitr", type: 'religious' });
        }
        if (eidAlAdhaDates[year]) {
            eidDates.push({ date: eidAlAdhaDates[year], name: "Eid al-Adha", type: 'religious' });
        }
        
        return eidDates;
    }

    bindCalendarEvents() {
        // View toggle buttons
        const viewBtns = document.querySelectorAll('.view-btn');
        viewBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                viewBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.currentView = btn.dataset.view;
                
                // Show/Hide navigation elements based on view
                this.toggleNavigationVisibility(btn.dataset.view);
                
                this.renderCurrentView();
            });
        });

        // Navigation buttons
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const todayBtn = document.getElementById('todayBtn');
        
        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                this.navigateCalendar(-1);
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                this.navigateCalendar(1);
            });
        }
        
        if (todayBtn) {
            todayBtn.addEventListener('click', () => {
                this.goToToday();
            });
        }
    }

    navigateCalendar(direction) {
        if (this.currentView === 'month') {
            this.currentDate.setMonth(this.currentDate.getMonth() + direction);
        }
        this.renderCurrentView();
    }

    goToToday() {
        this.currentDate = new Date();
        this.renderCurrentView();
    }

    toggleNavigationVisibility(view) {
        // Get navigation elements
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const todayBtn = document.getElementById('todayBtn');
        const blockDateBtn = document.getElementById('blockDateBtn');
        
        if (view === 'agenda') {
            // Hide navigation buttons in agenda view
            if (prevBtn) prevBtn.style.display = 'none';
            if (nextBtn) nextBtn.style.display = 'none';
            if (todayBtn) todayBtn.style.display = 'none';
            if (blockDateBtn) blockDateBtn.style.display = 'none';
        } else {
            // Show navigation buttons in month view
            if (prevBtn) prevBtn.style.display = 'block';
            if (nextBtn) nextBtn.style.display = 'block';
            if (todayBtn) todayBtn.style.display = 'block';
            if (blockDateBtn) blockDateBtn.style.display = 'block';
        }
    }

    renderCurrentView() {
        const calendarTitle = document.getElementById('calendarTitle');
        const calendarView = document.getElementById('calendarView');
        
        if (!calendarTitle || !calendarView) return;

        // Refresh holidays for current year being viewed
        this.holidays = this.getPhilippineHolidays();

        switch (this.currentView) {
            case 'month':
                this.renderMonthView(calendarTitle, calendarView);
                break;
            case 'agenda':
                this.renderAgendaView(calendarTitle, calendarView);
                break;
        }
    }

    renderMonthView(titleElement, viewElement) {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        
        titleElement.textContent = new Date(year, month).toLocaleDateString('en-US', { 
            month: 'long', 
            year: 'numeric' 
        });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        // Always get fresh current date to ensure accuracy on refresh
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time to midnight for accurate date comparison

        let html = `
            <div class="calendar-view">
                <table class="calendar-table">
                    <thead>
                        <tr>
                            <th>Sun</th>
                            <th>Mon</th>
                            <th>Tue</th>
                            <th>Wed</th>
                            <th>Thu</th>
                            <th>Fri</th>
                            <th>Sat</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        let date = 1;
        for (let week = 0; week < 6; week++) {
            html += '<tr>';
            for (let day = 0; day < 7; day++) {
                if (week === 0 && day < firstDay) {
                    const prevMonthDate = new Date(year, month, 0).getDate() - (firstDay - day - 1);
                    html += `<td class="other-month"><div class="day-number">${prevMonthDate}</div></td>`;
                } else if (date > daysInMonth) {
                    const nextMonthDate = date - daysInMonth;
                    html += `<td class="other-month"><div class="day-number">${nextMonthDate}</div></td>`;
                    date++;
                } else {
                    const currentDate = new Date(year, month, date);
                    const isToday = today.getDate() === date && 
                                   today.getMonth() === month && 
                                   today.getFullYear() === year;
                    
                    const dayEvents = this.getEventsForDate(currentDate);
                    const holiday = this.getHolidayForDate(currentDate);
                    
                    // Check for scheduled inspections (only show non-completed ones)
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                    const scheduledInspections = this.scheduledInspections.filter(inspection => 
                        inspection.date === dateString &&
                        inspection.status !== 'completed' &&
                        inspection.status !== 'cancelled'
                    );

                    // Check for blocked dates (Dashboard month view)
                    const blockedInfo = this.getBlockedDateInfo(dateString);
                    if (blockedInfo) {
                        console.log(` MonthView DASHBOARD: date ${dateString} is blocked:`, blockedInfo);
                    }
                    
                    // Debug: Check for completed inspections on this date
                    const completedInspections = this.scheduledInspections.filter(inspection => 
                        inspection.date === dateString &&
                        (inspection.status === 'completed' || inspection.status === 'cancelled')
                    );
                    if (completedInspections.length > 0) {
                        console.log(` MonthView: Found ${completedInspections.length} completed inspection(s) for ${dateString} (filtering out):`, completedInspections);
                    }
                    if (scheduledInspections.length > 0) {
                        console.log(` MonthView: Showing ${scheduledInspections.length} active inspection(s) for ${dateString}:`, scheduledInspections);
                    }
                    
                    let cellClasses = '';
                    if (isToday) cellClasses += 'today ';
                    // If blocked, show blocked style (use same visual as holiday)
                    if (blockedInfo) {
                        cellClasses += 'blocked ';
                    }
                    if (holiday) cellClasses += `holiday holiday-${holiday.type} `;
                    if (scheduledInspections.length > 0 && !blockedInfo) cellClasses += 'scheduled ';
                    
                    let titleText = '';
                    if (blockedInfo) {
                        titleText = `Blocked - ${blockedInfo.reason}`;
                    } else if (holiday) {
                        titleText = holiday.name;
                    }
                    if (!blockedInfo && scheduledInspections.length > 0) {
                        if (scheduledInspections.length === 1) {
                            titleText = scheduledInspections[0].note;
                        } else {
                            titleText = `${scheduledInspections.length} inspections scheduled - Click for details`;
                        }
                    }
                    
                    // Only make cell clickable when there are scheduled inspections and the date is not blocked
                    const onclickAttr = (scheduledInspections.length > 0 && !blockedInfo) ? `onclick="staffApp.showInspectionDetails('${dateString}')" style="cursor: pointer;"` : '';
                    html += `<td class="${cellClasses.trim()}" ${titleText ? `title="${titleText}"` : ''} ${onclickAttr}>
                        <div class="day-content">
                            <div class="day-number">${date}</div>`;
                    
                    if (holiday) {
                        // Show shortened holiday name
                        let shortName = holiday.name;
                        if (shortName.length > 12) {
                            shortName = shortName.substring(0, 10) + '...';
                        }
                        html += `<div class="holiday-indicator ${holiday.type}">${shortName}</div>`;
                    }
                    // If date is blocked, add a blocked indicator with reason (uses holiday indicator styles)
                    if (blockedInfo) {
                        let shortReason = blockedInfo.reason;
                        if (shortReason.length > 12) {
                            shortReason = shortReason.substring(0, 10) + '...';
                        }
                        html += `<div class="holiday-indicator blocked">${shortReason}</div>`;
                    }
                    
                    if (scheduledInspections.length > 0) {
                        if (scheduledInspections.length === 1) {
                            // Show single inspection with barangay name
                            html += `<div class="inspection-note calendar-note">${scheduledInspections[0].barangay}</div>`;
                        } else {
                            // Show count indicator for multiple inspections
                            html += `<div class="inspection-note calendar-note multiple-inspections">${scheduledInspections.length} Inspections</div>`;
                            
                            // Show first few barangays if space allows
                            const barangays = scheduledInspections.map(insp => insp.barangay);
                            const uniqueBarangays = [...new Set(barangays)];
                            if (uniqueBarangays.length <= 2) {
                                html += `<div class="inspection-detail">${uniqueBarangays.join(', ')}</div>`;
                            } else {
                                html += `<div class="inspection-detail">${uniqueBarangays.slice(0, 2).join(', ')}...</div>`;
                            }
                        }
                    }
                    
                    html += '<div class="calendar-events">';
                    dayEvents.forEach(event => {
                        html += `<div class="calendar-event">${event.title}</div>`;
                    });
                    
                    html += '</div></div></td>';
                    date++;
                }
            }
            html += '</tr>';
            if (date > daysInMonth) break;
        }

        html += '</tbody></table></div>';
        viewElement.innerHTML = html;
    }

    renderWeekView(titleElement, viewElement) {
        const startOfWeek = new Date(this.currentDate);
        startOfWeek.setDate(this.currentDate.getDate() - this.currentDate.getDay());
        
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        titleElement.textContent = `${startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

        let html = `
            <div class="calendar-view">
                <div class="week-container">
                    <table class="week-table">
                        <thead>
                            <tr>
                                <th class="week-time-header">Time</th>
        `;

        // Week day headers
        for (let i = 0; i < 7; i++) {
            const day = new Date(startOfWeek);
            day.setDate(startOfWeek.getDate() + i);
            const isToday = this.isToday(day);
            const dayName = day.toLocaleDateString('en-US', { weekday: 'short' });
            const dayNumber = day.getDate();
            
            html += `<th class="week-day-header ${isToday ? 'today' : ''}">
                <div class="week-day-name">${dayName}</div>
                <div class="week-day-number">${dayNumber}</div>
            </th>`;
        }

        html += `
                            </tr>
                        </thead>
                        <tbody>
        `;

        // Time slots (8 AM to 6 PM)
        for (let hour = 8; hour < 18; hour++) {
            const timeStr = hour < 12 ? `${hour}:00 AM` : hour === 12 ? '12:00 PM' : `${hour - 12}:00 PM`;
            html += `<tr>
                <td class="week-time-slot">${timeStr}</td>`;
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dayEvents = this.getEventsForDate(day);
                
                html += `<td class="week-day-slot">`;
                dayEvents.forEach(event => {
                    const eventHour = parseInt(event.time.split(':')[0]);
                    if (eventHour === hour) {
                        html += `<div class="week-event">${event.title}</div>`;
                    }
                });
                html += '</td>';
            }
            html += '</tr>';
        }

        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        viewElement.innerHTML = html;
    }

    renderAgendaView(titleElement, viewElement) {
        // Add null checks for safety
        if (!titleElement || !viewElement) {
            console.error('renderAgendaView called with null elements:', { titleElement, viewElement });
            return;
        }
        
        titleElement.textContent = 'Scheduled Inspections';
        // Use scheduledInspections for agenda
        const upcomingInspections = this.scheduledInspections
            .map(item => ({
                id: item.id,
                date: new Date(item.date),
                barangay: item.barangay,
                note: item.note || '',
                status: item.status || 'scheduled'
            }))
            .filter(item => {
                // Show only non-completed inspections from the last 7 days to current date + future inspections
                const today = new Date();
                const weekAgo = new Date(today);
                weekAgo.setDate(today.getDate() - 7);
                
                // Exclude completed and cancelled inspections from agenda view
                const isNotCompleted = item.status !== 'completed' && item.status !== 'cancelled';
                const isInDateRange = item.date >= weekAgo;
                
                return isNotCompleted && isInDateRange;
            })
            .sort((a, b) => a.date - b.date);

        let html = '<div class="calendar-view"><div class="agenda-view">';
        if (upcomingInspections.length === 0) {
            html += '<div class="no-events">No scheduled inspections</div>';
        } else {
            let currentDateStr = '';
            upcomingInspections.forEach(item => {
                const eventDateStr = item.date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                if (eventDateStr !== currentDateStr) {
                    if (currentDateStr !== '') {
                        html += '</div></div>';
                    }
                    html += `
                        <div class="agenda-section">
                            <div class="agenda-date">${eventDateStr}</div>
                            <div class="agenda-events">
                    `;
                    currentDateStr = eventDateStr;
                }
                html += `
                    <div class="agenda-event">
                        <div class="agenda-event-content">
                            <div class="agenda-event-title"><strong>${item.barangay}</strong></div>
                            <div class="agenda-event-note">${item.note}</div>
                            <div class="agenda-event-status">Status: <span class="status-badge ${item.status}">${item.status}</span></div>
                        </div>
                        <div class="agenda-event-actions">
                            ${item.status !== 'completed' ? `
                                <button class="btn-complete" onclick="staffApp.completeInspection(${item.id}, '${item.barangay}')">
                                    <i class="fas fa-check-circle"></i> Mark as Completed
                                </button>
                            ` : `
                                <span class="completed-badge">
                                    <i class="fas fa-check-circle"></i> Completed
                                </span>
                            `}
                        </div>
                    </div>
                `;
            });
            if (upcomingInspections.length > 0) {
                html += '</div></div>';
            }
        }
        html += '</div></div>';
        viewElement.innerHTML = html;
    }

    getEventsForDate(date) {
        return this.events.filter(event => 
            event.date.toDateString() === date.toDateString()
        );
    }

    getHolidayForDate(date) {
        return this.holidays.find(holiday => 
            holiday.date.toDateString() === date.toDateString()
        );
    }

    isToday(date) {
        const today = new Date();
        return date.toDateString() === today.toDateString();
    }

    async completeInspection(inspectionId, barangayName) {
        // Show professional confirmation modal instead of browser confirm
        showCompleteInspectionModal(inspectionId, barangayName);
    }

    async processCompleteInspection(inspectionId, barangayName) {
        try {
            console.log(`Attempting to complete inspection ID: ${inspectionId} for ${barangayName}`);
            
            const requestData = {
                inspection_id: inspectionId,
                status: 'completed'
            };
            console.log('Request data:', requestData);
            
            const response = await fetch('../backend/api/update_inspection_status.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Complete inspection response:', data);

            if (data.success) {
                console.log('=== Starting completion success flow ===');
                // Show professional success modal
                showCompleteSuccessModal(inspectionId, barangayName);

                console.log('=== About to reload scheduled inspections ===');
                // Refresh the data and update the dashboard
                this.scheduledInspections = await this.loadScheduledInspections();
                console.log('Reloaded scheduled inspections after completion:', this.scheduledInspections);
                
                // Debug: Check if the completed inspection status is updated in the data
                const updatedInspection = this.scheduledInspections.find(item => item.id == inspectionId);
                if (updatedInspection) {
                    console.log(`Updated inspection status for ID ${inspectionId}:`, updatedInspection.status);
                } else {
                    console.log(`Inspection ID ${inspectionId} not found in updated data`);
                }
                
                await this.updateDashboardStats();
                
                console.log('=== About to refresh calendar ===');
                // Re-render the calendar to reflect changes
                try {
                    console.log('Calendar container exists:', !!document.getElementById('dashboard-calendar'));
                    console.log('CalendarView exists:', !!document.getElementById('calendarView'));
                    console.log('Current view button active:', document.querySelector('.view-btn.active')?.dataset?.view);
                    
                    // Use the proper calendar refresh method
                    this.renderCurrentView();
                    
                    console.log('=== Calendar refresh completed ===');
                } catch (error) {
                    console.error('Error during calendar refresh:', error);
                }
                
                // If we're in agenda view, refresh it
                const agendaViewBtn = document.querySelector('.view-btn[data-view="agenda"]');
                if (agendaViewBtn && agendaViewBtn.classList.contains('active')) {
                    const calendarTitle = document.querySelector('.card-title');
                    const calendarView = document.getElementById('calendarView');
                    
                    // Add null checks before calling renderAgendaView
                    if (calendarTitle && calendarView) {
                        this.renderAgendaView(calendarTitle, calendarView);
                    } else {
                        console.warn('Could not find calendar elements for agenda refresh. Title:', calendarTitle, 'View:', calendarView);
                    }
                }
                
                console.log(`Successfully completed inspection for ${barangayName}`);
            } else {
                console.error('Failed to complete inspection:', data.message);
                showCompleteErrorModal(data.message || 'Unknown error occurred');
            }
        } catch (error) {
            console.error('Error completing inspection:', error);
            console.error('Error details:', error.message);
            showCompleteErrorModal(`Network error occurred: ${error.message}. Please check your connection and try again.`);
        }
    }

    showInspectionDetails(dateStr) {
        // Only show non-completed inspections
        const inspections = this.scheduledInspections.filter(item => 
            item.date === dateStr && 
            item.status !== 'completed' && 
            item.status !== 'cancelled'
        );
        
        if (!inspections || inspections.length === 0) {
            console.error('No active inspections found for date:', dateStr);
            return;
        }

        const inspectionDate = new Date(dateStr).toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });

        let modalContent = `
            <div class="inspection-details" style="max-width: 400px;">
                <div style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-light);">
                    <strong style="color: var(--primary-green); font-size: 1em;">${inspectionDate}</strong><br>
                    <small style="color: var(--text-light);">${inspections.length} pending inspection(s)</small>
                </div>
        `;

        // Show each active inspection in compact format
        inspections.forEach((inspection, index) => {
            // Determine category from available fields
            let category = inspection.inspection_category || inspection.category;
            
            // If category is still not available, try to infer from other fields
            if (!category || category === 'Not specified') {
                if (inspection.note && inspection.note.toLowerCase().includes('machinery')) {
                    category = 'Machinery';
                } else if (inspection.note && inspection.note.toLowerCase().includes('building')) {
                    category = 'Building';
                } else if (inspection.note && (inspection.note.toLowerCase().includes('batch') || inspection.note.toLowerCase().includes('property'))) {
                    category = 'Property';
                } else if (inspection.requestCount && inspection.requestCount >= 10) {
                    // Batch inspections (10+ requests) are Property category
                    category = 'Property';
                } else if (inspection.note && (inspection.note.toLowerCase().includes('individual') || inspection.note.toLowerCase().includes('request'))) {
                    // Individual requests are likely Machinery/Building
                    category = 'Machinery';
                } else {
                    // For unknown cases, try to infer from scheduling pattern
                    category = 'Machinery'; // Most individual scheduled inspections
                }
            }
            
            const categoryColor = category === 'Property' ? '#6c757d' : 
                                 category === 'Machinery' ? '#007bff' : '#28a745';
            
            modalContent += `
                <div style="margin-bottom: 0.75rem; padding: 0.6rem; background: var(--gray-100); border-radius: 4px; border-left: 3px solid ${categoryColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">
                        <div>
                            <strong style="color: var(--text-dark); font-size: 0.9em;">${inspection.barangay}</strong>
                            <span style="background: ${categoryColor}; color: white; padding: 1px 5px; border-radius: 2px; font-size: 0.7em; margin-left: 0.4rem;">${category}</span>
                        </div>
                    </div>
                    
                    ${inspection.note ? `<div style="font-size: 0.75em; color: var(--text-light); margin-bottom: 0.4rem;">${inspection.note}</div>` : ''}
                    
                    <div style="text-align: right; display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button onclick="openRescheduleModal(${inspection.id}, '${inspection.barangay}', '${inspection.date}', ''); document.getElementById('inspectionModal').style.display = 'none';" 
                                style="background: var(--warning-orange, #ff9800); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 3px; font-size: 0.75em; cursor: pointer; transition: background 0.2s;"
                                onmouseover="this.style.background='#f57c00'" onmouseout="this.style.background='var(--warning-orange, #ff9800)'">
                            <i class="fas fa-calendar-alt"></i> Reschedule
                        </button>
                        <button onclick="staffApp.completeInspection(${inspection.id}, '${inspection.barangay}'); document.getElementById('inspectionModal').style.display = 'none';" 
                                style="background: var(--primary-green); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 3px; font-size: 0.75em; cursor: pointer; transition: background 0.2s;"
                                onmouseover="this.style.background='var(--dark-green)'" onmouseout="this.style.background='var(--primary-green)'">
                            <i class="fas fa-check"></i> Complete
                        </button>
                    </div>
                </div>
            `;
        });

        modalContent += `</div>`;

        this.showCustomModal('Pending Inspections', modalContent);
    }

    showCustomModal(title, content) {
        // Create modal if it doesn't exist
        let modal = document.getElementById('inspectionModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'inspectionModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px; width: 90%; margin: 5% auto; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden;">
                    <div class="modal-header" style="padding: 1rem 1.2rem; background: var(--light-green); border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center;">
                        <span class="modal-title" style="font-weight: 600; color: var(--primary-green); font-size: 1.1em;"></span>
                        <span class="close-btn" style="cursor: pointer; font-size: 1.5em; color: var(--text-light); font-weight: bold; line-height: 1; padding: 0 0.2em;" onmouseover="this.style.color='var(--primary-green)'" onmouseout="this.style.color='var(--text-light)'">&times;</span>
                    </div>
                    <div class="modal-body" style="padding: 1.2rem;"></div>
                </div>
            `;
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 9999;';
            document.body.appendChild(modal);
            
            // Add close functionality
            modal.querySelector('.close-btn').onclick = () => {
                modal.style.display = 'none';
            };
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }

        // Set content and show
        modal.querySelector('.modal-title').textContent = title;
        modal.querySelector('.modal-body').innerHTML = content;
        modal.style.display = 'block';
    }
}

// Initialize the application
const staffApp = new StaffApp();
const staffAnnouncementManager = new StaffAnnouncementManager();

// Make staffApp globally accessible for calendar widgets
window.staffDashboard = staffApp;

// Add event listener for refresh activities button
document.addEventListener('DOMContentLoaded', () => {
    const refreshActivitiesBtn = document.getElementById('refreshActivitiesBtn');
    const activitiesSection = document.getElementById('activitiesSection');
    if (refreshActivitiesBtn) {
        refreshActivitiesBtn.addEventListener('click', () => {
            if (activitiesSection) {
                activitiesSection.style.display = 'block';
            }
            staffApp.loadSystemActivities();
        });
    }
});

// Global functions for table interactions
function viewDocument(documentId) {
    alert(`Viewing document: ${documentId}`);
    // TODO: Implement actual document viewing functionality
}

function scheduleInspection(requestId) {
    const modal = document.getElementById('scheduleModal');
    if (modal) {
        modal.style.display = 'block';
        modal.setAttribute('data-request-id', requestId);
    }
}

function scheduleInspection(barangayName, requestCount) {
    if (staffApp) {
        staffApp.openScheduleModal(barangayName, requestCount);
    } else {
        console.error('StaffApp not initialized');
        alert('Application not ready. Please refresh the page.');
    }
}

function viewSchedule(requestId) {
    alert(`Viewing schedule for request: ${requestId}`);
    // TODO: Implement actual schedule viewing functionality
}

function viewDetails(requestId) {
    const request = getRequestById(requestId);
    if (request) {
        showDetailsModal(request);
    }
}

function getRequestById(requestId) {
    return allRequests.find(request => request.id === requestId);
}

function viewStatus(requestId) {
    alert(`Viewing status for request: ${requestId}`);
    // TODO: Implement actual status viewing functionality
}

// New global functions for the workflow
function acceptRequest(requestId) {
    if (staffApp) {
        staffApp.acceptRequest(requestId);
    } else {
        console.error('StaffApp not initialized');
        alert('Application not ready. Please refresh the page.');
    }
}

function declineRequest(requestId) {
    if (staffApp) {
        staffApp.declineRequest(requestId);
    } else {
        console.error('StaffApp not initialized');
        alert('Application not ready. Please refresh the page.');
    }
}

async function viewRequestDetails(requestId) {
    try {
        // Show loading
        const loadingModal = `
            <div id="requestDetailsModal" class="modal" style="display: block;">
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="closeRequestDetailsModal()">&times;</span>
                    <h2>Loading Request Details...</h2>
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-green);"></i>
                    </div>
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById('requestDetailsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        document.body.insertAdjacentHTML('beforeend', loadingModal);

        // Fetch request details from database
        const response = await fetch(`../backend/api/get_requests.php?id=${requestId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (!data.success || !data.data) {
            throw new Error(data.message || 'Request not found');
        }

        // Assuming the API returns a single request when ID is specified
        const request = Array.isArray(data.data) ? data.data[0] : data.data;
        
        if (!request) {
            throw new Error('Request not found');
        }

        showRequestDetailsModal(request);
        
    } catch (error) {
        console.error('Error fetching request details:', error);
        closeRequestDetailsModal();
        alert('Error loading request details: ' + error.message);
    }
}

function showRequestDetailsModal(request) {
    const formattedDate = new Date(request.created_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    const modalHtml = `
        <div id="requestDetailsModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="closeRequestDetailsModal()">&times;</span>
                <h2>Incoming Request Details</h2>
                <div class="details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                    <div><strong>Request ID:</strong> #${request.id || 'N/A'}</div>
                    <div><strong>Status:</strong> <span class="status-badge ${request.status || 'pending'}">${(request.status || 'pending').toUpperCase()}</span></div>
                    <div><strong>Client Name:</strong> ${request.name || 'N/A'}</div>
                    <div><strong>Email:</strong> ${request.email || 'N/A'}</div>
                    <div><strong>Inspection Category:</strong> 
                        <span class="category-badge" style="background-color: ${
                            request.inspection_category === 'Land Property' ? '#6c757d' : 
                            request.inspection_category === 'Machinery' ? '#007bff' : '#28a745'
                        }; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">
                            ${request.inspection_category || 'N/A'}
                        </span>
                    </div>
                    ${request.inspection_category === 'Land Property' ? `
                    <div><strong>Property Classification:</strong> ${request.property_classification || 'N/A'}</div>
                    ` : ''}
                    <!-- No requested date section - clients use view-only calendar -->
                    <div><strong>Location:</strong> ${request.location || 'N/A'}</div>
                    <div><strong>Landmark:</strong> ${request.landmark || 'N/A'}</div>
                    <div><strong>Land Reference:</strong> ${request.land_reference || 'N/A'}</div>
                    <div><strong>Contact Person:</strong> ${request.contact_person || 'N/A'}</div>
                    <div><strong>Contact Number:</strong> ${request.contact_number || 'N/A'}</div>
                    <div><strong>Date Submitted:</strong> ${formattedDate}</div>
                    <div><strong>Valid ID:</strong> ${request.valid_id_name ? `<a href="../backend/api/view_valid_id.php?id=${request.id}" target="_blank" style="color: #007bff; text-decoration: none; font-weight: 500;">View</a>` : 'Not provided'}</div>
                </div>
                <div style="margin: 1rem 0;">
                    <strong>Purpose and Preferred Date:</strong>
                    <p style="margin: 0.5rem 0; padding: 1rem; background: #f5f5f5; border-radius: 4px;">${request.purpose || 'N/A'}</p>
                </div>
                <div style="margin: 1rem 0; padding: 1rem; background: #e8f5e8; border-radius: 4px; border-left: 4px solid #28a745;">
                    <div style="color: #155724; display: flex; align-items: center; margin-bottom: 0.5rem;">
                        <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                        <strong>Scheduling Information</strong>
                    </div>
                    <p style="margin: 0; color: #155724;">
                        Client has viewed the available dates calendar and mentioned preferred dates in the purpose field.
                    </p>
                </div>
                ${request.decline_reason ? `
                <div style="margin: 1rem 0;">
                    <strong>Decline Reason:</strong>
                    <p style="margin: 0.5rem 0; padding: 1rem; background: #fee; border-radius: 4px; border-left: 4px solid #dc3545;">${request.decline_reason}</p>
                </div>
                ` : ''}
                <div class="modal-footer" style="text-align: right; margin-top: 1.5rem;">
                    ${request.status === 'pending' ? `
                    <button class="btn btn-success" onclick="acceptRequest('${request.id}'); closeRequestDetailsModal();">
                        <i class="fas fa-check"></i> Accept Request
                    </button>
                    <button class="btn btn-danger" onclick="declineRequest('${request.id}'); closeRequestDetailsModal();">
                        <i class="fas fa-times"></i> Decline Request
                    </button>
                    ` : ''}
                    <button class="btn btn-secondary" onclick="closeRequestDetailsModal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('requestDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeRequestDetailsModal() {
    const modal = document.getElementById('requestDetailsModal');
    if (modal) {
        modal.remove();
    }
}

function showDeclineRequestModal(requestId) {
    const modalHtml = `
        <div id="declineRequestModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 500px;">
                <span class="close" onclick="closeDeclineRequestModal()">&times;</span>
                <h2 style="color: #dc3545; margin-bottom: 1.5rem;">
                    <i class="fas fa-times-circle" style="margin-right: 0.5rem;"></i>
                    Decline Request #${requestId}
                </h2>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 1rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: flex-start;">
                        <i class="fas fa-exclamation-triangle" style="color: #856404; margin-right: 0.5rem; margin-top: 0.1rem;"></i>
                        <div style="color: #856404;">
                            <strong>Important:</strong> Please provide a clear and professional reason for declining this request. 
                            The client will receive this explanation along with the decline notification.
                        </div>
                    </div>
                </div>

                <form id="declineForm" style="margin-bottom: 1.5rem;">
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="declineReason" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">
                            Reason for Declining <span style="color: #dc3545;">*</span>
                        </label>
                        <textarea 
                            id="declineReason" 
                            name="declineReason"
                            placeholder="Please provide a detailed explanation for why this request is being declined..."
                            style="width: 100%; min-height: 120px; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"
                            required
                        ></textarea>
                        <small style="color: #666; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                            Examples: Missing required documents, property outside service area, incomplete information, etc.
                        </small>
                    </div>
                </form>

                <div class="modal-footer" style="text-align: right; border-top: 1px solid #eee; padding-top: 1rem;">
                    <button 
                        class="btn btn-secondary" 
                        onclick="closeDeclineRequestModal()" 
                        style="margin-right: 0.5rem;"
                    >
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button 
                        class="btn btn-danger" 
                        onclick="confirmDeclineRequest(${requestId})"
                        id="confirmDeclineBtn"
                    >
                        <i class="fas fa-ban"></i> Decline Request
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('declineRequestModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Focus on the textarea
    setTimeout(() => {
        const textarea = document.getElementById('declineReason');
        if (textarea) {
            textarea.focus();
        }
    }, 100);
}

function closeDeclineRequestModal() {
    const modal = document.getElementById('declineRequestModal');
    if (modal) {
        modal.remove();
    }
}

function confirmDeclineRequest(requestId) {
    const reasonTextarea = document.getElementById('declineReason');
    const reason = reasonTextarea ? reasonTextarea.value.trim() : '';
    
    if (!reason) {
        // Add error class and shake animation
        if (reasonTextarea) {
            reasonTextarea.classList.add('error');
            reasonTextarea.focus();
            
            // Remove error class after animation
            setTimeout(() => {
                reasonTextarea.classList.remove('error');
            }, 300);
        }
        
        // Show error message in a more user-friendly way
        const errorMsg = document.createElement('div');
        errorMsg.style.cssText = `
            color: #dc3545; 
            font-size: 0.875rem; 
            margin-top: 0.5rem; 
            padding: 0.5rem; 
            background: #f8d7da; 
            border: 1px solid #f5c6cb; 
            border-radius: 4px;
            animation: fadeIn 0.3s ease;
        `;
        errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please provide a reason for declining this request.';
        
        // Remove existing error message if any
        const existingError = reasonTextarea.parentNode.querySelector('.error-message');
        if (existingError) {
            existingError.remove();
        }
        
        errorMsg.className = 'error-message';
        reasonTextarea.parentNode.appendChild(errorMsg);
        
        // Remove error message after 5 seconds
        setTimeout(() => {
            if (errorMsg.parentNode) {
                errorMsg.remove();
            }
        }, 5000);
        
        return;
    }
    
    // Remove any existing error messages
    const existingError = reasonTextarea.parentNode.querySelector('.error-message');
    if (existingError) {
        existingError.remove();
    }
    
    // Reset styles
    if (reasonTextarea) {
        reasonTextarea.classList.remove('error');
    }
    
    // Show professional confirmation dialog
    const confirmModal = `
        <div id="confirmationModal" class="modal" style="display: block; z-index: 10001;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <h3 style="color: #dc3545; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                    Confirm Decline
                </h3>
                <p style="margin-bottom: 1.5rem; line-height: 1.5;">
                    Are you sure you want to decline request <strong>#${requestId}</strong>?
                    <br><br>
                    <strong>This action cannot be undone.</strong>
                </p>
                <div style="border-top: 1px solid #eee; padding-top: 1rem;">
                    <button class="btn btn-secondary" onclick="closeConfirmationModal()" style="margin-right: 0.5rem;">
                        Cancel
                    </button>
                    <button class="btn btn-danger" onclick="proceedWithDecline(${requestId}, '${reason.replace(/'/g, "\\'")}')">
                        <i class="fas fa-ban"></i> Yes, Decline Request
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', confirmModal);
}

function closeConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    if (modal) {
        modal.remove();
    }
}

function proceedWithDecline(requestId, reason) {
    closeConfirmationModal();
    
    // Show loading modal immediately
    showDeclineLoadingModal(requestId);
    
    // Call the staffApp method to process the decline
    if (staffApp) {
        staffApp.processDeclineRequest(requestId, reason);
    } else {
        showDeclineErrorModal('Application not ready. Please refresh the page.');
    }
}

function showDeclineLoadingModal(requestId) {
    const modalHtml = `
        <div id="declineLoadingModal" class="modal" style="display: block; z-index: 10003;">
            <div class="modal-content" style="max-width: 400px; text-align: center; padding: 2rem;">
                <div style="color: #dc3545; font-size: 3rem; margin-bottom: 1rem;">
                    <i class="fas fa-spinner fa-pulse"></i>
                </div>
                <h2 style="color: #dc3545; margin-bottom: 1rem;">Processing Decline Request</h2>
                <p style="color: #6c757d; margin-bottom: 1.5rem; font-size: 1rem;">Declining request #${requestId}...</p>
                <p style="color: #666; font-size: 0.9rem;">Sending notification...</p>
            </div>
        </div>
        
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function showDeclineSuccessModal(requestId, reason) {
    const modalHtml = `
        <div id="declineSuccessModal" class="modal" style="display: block; z-index: 10002;">
            <div class="modal-content" style="max-width: 500px; text-align: center;">
                <div style="color: #28a745; font-size: 3rem; margin-bottom: 1rem;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 style="color: #28a745; margin-bottom: 1rem;">Request Declined Successfully</h2>
                
                <div style="text-align: left; background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #495057;">Request ID:</strong> 
                        <span style="color: #6c757d;">#${requestId}</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #495057;">Status:</strong> 
                        <span class="status-badge declined" style="background: #dc3545; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">DECLINED</span>
                    </div>
                    <div>
                        <strong style="color: #495057;">Decline Reason:</strong>
                        <div style="margin-top: 0.5rem; padding: 0.75rem; background: white; border-left: 4px solid #dc3545; border-radius: 4px;">
                            ${reason}
                        </div>
                    </div>
                </div>
                
                <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 1rem; margin: 1.5rem 0;">
                    <div style="color: #0c5460; display: flex; align-items: center;">
                        <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                        <span><strong>Client Notification:</strong> The client will be automatically notified about this decision via email.</span>
                    </div>
                </div>
                
                <div class="modal-footer" style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="closeDeclineSuccessModal()" style="min-width: 120px;">
                        <i class="fas fa-check"></i> OK
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('declineSuccessModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Auto-close after 8 seconds
    setTimeout(() => {
        closeDeclineSuccessModal();
    }, 8000);
}

function closeDeclineSuccessModal() {
    const modal = document.getElementById('declineSuccessModal');
    if (modal) {
        modal.remove();
    }
}

function showDeclineErrorModal(errorMessage) {
    const modalHtml = `
        <div id="declineErrorModal" class="modal" style="display: block; z-index: 10002;">
            <div class="modal-content" style="max-width: 450px; text-align: center;">
                <div style="color: #dc3545; font-size: 3rem; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2 style="color: #dc3545; margin-bottom: 1rem;">Error Declining Request</h2>
                
                <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 1rem; margin: 1.5rem 0; text-align: left;">
                    <div style="color: #721c24;">
                        <strong>Error Details:</strong><br>
                        ${errorMessage}
                    </div>
                </div>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 1rem; margin: 1.5rem 0;">
                    <div style="color: #856404; display: flex; align-items: flex-start;">
                        <i class="fas fa-lightbulb" style="margin-right: 0.5rem; margin-top: 0.1rem;"></i>
                        <div>
                            <strong>What to do:</strong><br>
                             Check your internet connection<br>
                             Try refreshing the page<br>
                             Contact technical support if the problem persists
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer" style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="closeDeclineErrorModal()" style="margin-right: 0.5rem;">
                        Close
                    </button>
                    <button class="btn btn-primary" onclick="closeDeclineErrorModal(); location.reload();">
                        <i class="fas fa-sync-alt"></i> Refresh Page
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('declineErrorModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeDeclineErrorModal() {
    const modal = document.getElementById('declineErrorModal');
    if (modal) {
        modal.remove();
    }
}

// Professional Accept Request Modal Functions
async function showAcceptRequestModal(requestId) {
    try {
        // Show loading first
        const loadingModal = `
            <div id="acceptRequestModal" class="modal" style="display: block;">
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="closeAcceptRequestModal()">&times;</span>
                    <h2 style="color: #28a745; margin-bottom: 1.5rem;">
                        <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                        Accept Request #${requestId}
                    </h2>
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #28a745;"></i>
                        <p style="margin-top: 1rem;">Loading request details...</p>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', loadingModal);
        
        // Fetch request details
        const response = await fetch(`../backend/api/get_requests.php?id=${requestId}`);
        const data = await response.json();
        
        if (!data.success || !data.data) {
            throw new Error('Failed to load request details');
        }
        
        const request = data.data;
        
        const modalHtml = `
            <div id="acceptRequestModal" class="modal" style="display: block;">
                <div class="modal-content" style="max-width: 550px;">
                    <span class="close" onclick="closeAcceptRequestModal()">&times;</span>
                    <h2 style="color: #28a745; margin-bottom: 1.5rem;">
                        <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                        Accept Request #${requestId}
                    </h2>
                    
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; align-items: center;">
                            <strong>Client:</strong> <span>${request.name}</span>
                            <strong>Category:</strong> 
                            <span>
                                <span class="category-badge" style="background-color: ${
                                    request.inspection_category === 'Land Property' ? '#6c757d' : 
                                    request.inspection_category === 'Machinery' ? '#007bff' : '#28a745'
                                }; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">
                                    ${request.inspection_category}
                                </span>
                            </span>
                            <strong>Location:</strong> <span>${request.location}</span>
                        </div>
                    </div>
                    
                    ${isAppointmentRequest ? `
                    <div style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 4px; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: flex-start;">
                            <i class="fas fa-calendar-check" style="color: #1976d2; margin-right: 0.5rem; margin-top: 0.1rem;"></i>
                            <div style="color: #1976d2;">
                                <strong>Automatic Scheduling:</strong> This ${request.inspection_category.toLowerCase()} inspection 
                                will be automatically scheduled for the client's preferred date when you accept this request.
                            </div>
                        </div>
                    </div>
                    ` : `
                    <div style="background: #f3e5f5; border: 1px solid #e1bee7; border-radius: 4px; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: flex-start;">
                            <i class="fas fa-calendar-alt" style="color: #7b1fa2; margin-right: 0.5rem; margin-top: 0.1rem;"></i>
                            <div style="color: #7b1fa2;">
                                <strong>Manual Scheduling:</strong> This request will be moved to the View module and grouped 
                                by barangay for manual scheduling when the barangay reaches 5+ pending requests.
                            </div>
                        </div>
                    </div>
                    `}

                    <div style="text-align: center; margin: 1.5rem 0;">
                        <p style="font-size: 1.1rem; color: #495057;">
                            Are you sure you want to accept this inspection request?
                        </p>
                    </div>

                    <div class="modal-footer" style="text-align: right; border-top: 1px solid #eee; padding-top: 1rem;">
                        <button 
                            class="btn btn-secondary" 
                            onclick="closeAcceptRequestModal()" 
                            style="margin-right: 0.5rem;"
                        >
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button 
                            class="btn btn-success" 
                            onclick="confirmAcceptRequest(${requestId})"
                            id="confirmAcceptBtn"
                        >
                            <i class="fas fa-check"></i> Accept ${isAppointmentRequest ? '& Schedule' : 'Request'}
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Replace loading modal with detailed modal
        const existingModal = document.getElementById('acceptRequestModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        console.error('Error loading request details:', error);
        closeAcceptRequestModal();
        
        // Show simple fallback modal
        const fallbackModal = `
            <div id="acceptRequestModal" class="modal" style="display: block;">
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="closeAcceptRequestModal()">&times;</span>
                    <h2 style="color: #28a745; margin-bottom: 1.5rem;">
                        <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                        Accept Request #${requestId}
                    </h2>
                    
                    <div style="text-align: center; margin: 2rem 0;">
                        <p style="font-size: 1.1rem; color: #495057; margin-bottom: 1.5rem;">
                            Are you sure you want to accept this inspection request?
                        </p>
                    </div>

                    <div class="modal-footer" style="text-align: right; border-top: 1px solid #eee; padding-top: 1rem;">
                        <button 
                            class="btn btn-secondary" 
                            onclick="closeAcceptRequestModal()" 
                            style="margin-right: 0.5rem;"
                        >
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button 
                            class="btn btn-success" 
                            onclick="confirmAcceptRequest(${requestId})"
                            id="confirmAcceptBtn"
                        >
                            <i class="fas fa-check"></i> Accept Request
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', fallbackModal);
    }
}

function closeAcceptRequestModal() {
    const modal = document.getElementById('acceptRequestModal');
    if (modal) {
        modal.remove();
    }
}

function confirmAcceptRequest(requestId) {
    // Close the confirmation modal
    closeAcceptRequestModal();
    
    // Show loading state and process the request
    showAcceptLoadingModal(requestId);
    
    // Process the actual acceptance
    staffApp.processAcceptRequest(requestId);
}

function showAcceptLoadingModal(requestId) {
    const modalHtml = `
        <div id="acceptLoadingModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <div style="padding: 2rem 1rem;">
                    <div style="color: #28a745; font-size: 3rem; margin-bottom: 1rem;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <h2 style="color: #28a745; margin-bottom: 1rem;">Accepting Request</h2>
                    <p style="color: #6c757d; margin-bottom: 0;">
                        Please wait while we accept the request #${requestId}...
                    </p>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('acceptLoadingModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function showAcceptSuccessModal(requestId, barangayName) {
    // Close loading modal
    const loadingModal = document.getElementById('acceptLoadingModal');
    if (loadingModal) {
        loadingModal.remove();
    }
    
    const modalHtml = `
        <div id="acceptSuccessModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 550px; text-align: center;">
                <div style="color: #28a745; font-size: 3rem; margin-bottom: 1rem;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 style="color: #28a745; margin-bottom: 1rem;">Request Accepted Successfully!</h2>
                
                <div style="text-align: left; background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #495057;">Request ID:</strong> 
                        <span style="color: #6c757d;">#${requestId}</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #495057;">Status:</strong> 
                        <span class="status-badge accepted" style="background: #28a745; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">ACCEPTED</span>
                    </div>
                    <div>
                        <strong style="color: #495057;">Barangay:</strong>
                        <span style="color: #6c757d;">${barangayName}</span>
                    </div>
                </div>
                
                <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 1rem; margin: 1.5rem 0;">
                    <div style="color: #0c5460; display: flex; align-items: flex-start;">
                        <i class="fas fa-info-circle" style="margin-right: 0.5rem; margin-top: 0.1rem;"></i>
                        <div>
                            <strong>Next Steps:</strong>
                            <ul style="margin: 0.5rem 0 0 0; padding-left: 1rem; text-align: left;">
                                <li>Request is now available in the <strong>View module</strong></li>
                                <li>Grouped by barangay in <strong>Inspection Requests</strong></li>
                                <li>Will be schedulable when ${barangayName} reaches 5+ pending requests</li>
                                <li>Client will be notified via email</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer" style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="closeAcceptSuccessModal()" style="min-width: 120px;">
                        <i class="fas fa-check"></i> OK
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('acceptSuccessModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Auto-close after 10 seconds
    setTimeout(() => {
        closeAcceptSuccessModal();
    }, 10000);
}

function closeAcceptSuccessModal() {
    const modal = document.getElementById('acceptSuccessModal');
    if (modal) {
        modal.remove();
    }
}

function showAcceptWithScheduleSuccessModal(requestId, barangayName, scheduledDate, inspectionCategory) {
    // Close loading modal
    const loadingModal = document.getElementById('acceptLoadingModal');
    if (loadingModal) {
        loadingModal.remove();
    }
    
    const formattedDate = new Date(scheduledDate).toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    const modalHtml = `
        <div id="acceptSuccessModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 600px; text-align: center;">
                <div style="color: #28a745; font-size: 3rem; margin-bottom: 1rem;">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <h2 style="color: #28a745; margin-bottom: 1rem;">Request Accepted & Scheduled!</h2>
                
                <div style="text-align: left; background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #495057;">Request ID:</strong> 
                        <span style="color: #6c757d;">#${requestId}</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #495057;">Status:</strong> 
                        <span class="status-badge scheduled" style="background: #17a2b8; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">SCHEDULED</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #495057;">Category:</strong>
                        <span style="color: #6c757d;">${inspectionCategory}</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #495057;">Scheduled Date:</strong>
                        <span style="color: #007bff; font-weight: 600;">${formattedDate}</span>
                    </div>
                    <div>
                        <strong style="color: #495057;">Location:</strong>
                        <span style="color: #6c757d;">${barangayName}</span>
                    </div>
                </div>
                
                <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 1rem; margin: 1.5rem 0;">
                    <div style="color: #0c5460; display: flex; align-items: flex-start;">
                        <i class="fas fa-calendar-alt" style="margin-right: 0.5rem; margin-top: 0.1rem;"></i>
                        <div>
                            <strong>Automatic Scheduling:</strong>
                            <ul style="margin: 0.5rem 0 0 0; padding-left: 1rem; text-align: left;">
                                <li>Inspection automatically added to calendar</li>
                                <li>Client's preferred date has been confirmed</li>
                                <li>Visible in Calendar and Inspection Requests modules</li>
                                <li>Client will receive confirmation notification</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer" style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="closeAcceptSuccessModal()" style="min-width: 120px;">
                        <i class="fas fa-check"></i> OK
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('acceptSuccessModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Auto-close after 15 seconds (longer for scheduling info)
    setTimeout(() => {
        closeAcceptSuccessModal();
    }, 15000);
}

function showAcceptErrorModal(errorMessage) {
    // Close loading modal if open
    const loadingModal = document.getElementById('acceptLoadingModal');
    if (loadingModal) {
        loadingModal.remove();
    }
    
    const modalHtml = `
        <div id="acceptErrorModal" class="modal" style="display: block; z-index: 10002;">
            <div class="modal-content" style="max-width: 450px; text-align: center;">
                <div style="color: #dc3545; font-size: 3rem; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2 style="color: #dc3545; margin-bottom: 1rem;">Accept Request Failed</h2>
                
                <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 1rem; margin: 1.5rem 0; text-align: left;">
                    <strong style="color: #721c24;">Error Details:</strong>
                    <div style="color: #721c24; margin-top: 0.5rem; font-family: monospace; font-size: 0.9rem;">
                        ${errorMessage}
                    </div>
                </div>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 1rem; margin: 1.5rem 0;">
                    <div style="color: #856404; display: flex; align-items: center;">
                        <i class="fas fa-lightbulb" style="margin-right: 0.5rem;"></i>
                        <span><strong>Suggestion:</strong> Please try again. If the problem persists, contact the system administrator.</span>
                    </div>
                </div>
                
                <div class="modal-footer" style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="closeAcceptErrorModal()" style="margin-right: 0.5rem;">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button class="btn btn-primary" onclick="closeAcceptErrorModal(); location.reload();">
                        <i class="fas fa-sync-alt"></i> Refresh Page
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('acceptErrorModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeAcceptErrorModal() {
    const modal = document.getElementById('acceptErrorModal');
    if (modal) {
        modal.remove();
    }
}

// Professional Complete Inspection Modal Functions
function showCompleteInspectionModal(inspectionId, barangayName) {
    const modalHtml = `
        <div id="completeInspectionModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 500px;">
                <span class="close" onclick="closeCompleteInspectionModal()">&times;</span>
                <h2 style="color: #28a745; margin-bottom: 1.5rem;">
                    <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                    Complete Inspection
                </h2>
                
                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; padding: 1rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: flex-start;">
                        <i class="fas fa-info-circle" style="color: #155724; margin-right: 0.5rem; margin-top: 0.1rem;"></i>
                        <div style="color: #155724;">
                            <strong>Confirmation Required:</strong> This will mark the inspection for <strong>${barangayName}</strong> 
                            as completed and update all related statistics. This action cannot be easily undone.
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin: 2rem 0;">
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="font-size: 1.1rem; color: #495057; margin-bottom: 0.5rem;">
                            <strong>Inspection Details:</strong>
                        </div>
                        <div style="color: #6c757d;">
                            <strong>ID:</strong> #${inspectionId}<br>
                            <strong>Barangay:</strong> ${barangayName}
                        </div>
                    </div>
                    <p style="font-size: 1.1rem; color: #495057;">
                        Are you sure this inspection has been completed?
                    </p>
                </div>

                <div class="modal-footer" style="text-align: right; border-top: 1px solid #eee; padding-top: 1rem;">
                    <button 
                        class="btn btn-secondary" 
                        onclick="closeCompleteInspectionModal()" 
                        style="margin-right: 0.5rem;"
                    >
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button 
                        class="btn btn-success" 
                        onclick="confirmCompleteInspection(${inspectionId}, '${barangayName}')"
                        id="confirmCompleteBtn"
                    >
                        <i class="fas fa-check"></i> Mark as Completed
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('completeInspectionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeCompleteInspectionModal() {
    const modal = document.getElementById('completeInspectionModal');
    if (modal) {
        modal.remove();
    }
}

function confirmCompleteInspection(inspectionId, barangayName) {
    // Close the confirmation modal
    closeCompleteInspectionModal();
    
    // Show loading state and process the completion
    showCompleteLoadingModal(inspectionId, barangayName);
    
    // Process the actual completion
    staffApp.processCompleteInspection(inspectionId, barangayName);
}

function showCompleteLoadingModal(inspectionId, barangayName) {
    const modalHtml = `
        <div id="completeLoadingModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <div style="padding: 2rem 1rem;">
                    <div style="color: #28a745; font-size: 3rem; margin-bottom: 1rem;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <h2 style="color: #28a745; margin-bottom: 1rem;">Completing Inspection</h2>
                    <p style="color: #6c757d; margin-bottom: 0;">
                        Please wait while we mark the inspection for <strong>${barangayName}</strong> as completed...
                    </p>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('completeLoadingModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function showCompleteSuccessModal(inspectionId, barangayName) {
    // Close loading modal
    const loadingModal = document.getElementById('completeLoadingModal');
    if (loadingModal) {
        loadingModal.remove();
    }
    
    const currentDate = new Date().toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    const modalHtml = `
        <div id="completeSuccessModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 550px; text-align: center;">
                <div style="color: #28a745; font-size: 3rem; margin-bottom: 1rem;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 style="color: #28a745; margin-bottom: 1rem;">Inspection Completed Successfully!</h2>
                
                <div style="text-align: left; background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #495057;">Inspection ID:</strong> 
                        <span style="color: #6c757d;">#${inspectionId}</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #495057;">Barangay:</strong>
                        <span style="color: #6c757d;">${barangayName}</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #495057;">Status:</strong> 
                        <span class="status-badge completed" style="background: #28a745; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">COMPLETED</span>
                    </div>
                    <div>
                        <strong style="color: #495057;">Completed On:</strong>
                        <span style="color: #6c757d;">${currentDate}</span>
                    </div>
                </div>
                
                <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 1rem; margin: 1.5rem 0;">
                    <div style="color: #0c5460; display: flex; align-items: flex-start;">
                        <i class="fas fa-info-circle" style="margin-right: 0.5rem; margin-top: 0.1rem;"></i>
                        <div>
                            <strong>Updated Statistics:</strong>
                            <ul style="margin: 0.5rem 0 0 0; padding-left: 1rem; text-align: left;">
                                <li><strong>Completed</strong> count increased</li>
                                <li><strong>Scheduled This Week</strong> count updated</li>
                                <li>Calendar and agenda views refreshed</li>
                                <li>Dashboard statistics updated</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer" style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="closeCompleteSuccessModal()" style="min-width: 120px;">
                        <i class="fas fa-check"></i> OK
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('completeSuccessModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Auto-close after 8 seconds
    setTimeout(() => {
        closeCompleteSuccessModal();
    }, 8000);
}

function closeCompleteSuccessModal() {
    const modal = document.getElementById('completeSuccessModal');
    if (modal) {
        modal.remove();
    }
}

function showCompleteErrorModal(errorMessage) {
    // Close loading modal if open
    const loadingModal = document.getElementById('completeLoadingModal');
    if (loadingModal) {
        loadingModal.remove();
    }
    
    const modalHtml = `
        <div id="completeErrorModal" class="modal" style="display: block; z-index: 10002;">
            <div class="modal-content" style="max-width: 450px; text-align: center;">
                <div style="color: #dc3545; font-size: 3rem; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2 style="color: #dc3545; margin-bottom: 1rem;">Complete Inspection Failed</h2>
                
                <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 1rem; margin: 1.5rem 0; text-align: left;">
                    <strong style="color: #721c24;">Error Details:</strong>
                    <div style="color: #721c24; margin-top: 0.5rem; font-family: monospace; font-size: 0.9rem;">
                        ${errorMessage}
                    </div>
                </div>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 1rem; margin: 1.5rem 0;">
                    <div style="color: #856404; display: flex; align-items: center;">
                        <i class="fas fa-lightbulb" style="margin-right: 0.5rem;"></i>
                        <span><strong>Suggestion:</strong> Please verify the inspection exists and try again. Contact administrator if issue persists.</span>
                    </div>
                </div>
                
                <div class="modal-footer" style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="closeCompleteErrorModal()" style="margin-right: 0.5rem;">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button class="btn btn-primary" onclick="closeCompleteErrorModal(); location.reload();">
                        <i class="fas fa-sync-alt"></i> Refresh Page
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('completeErrorModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeCompleteErrorModal() {
    const modal = document.getElementById('completeErrorModal');
    if (modal) {
        modal.remove();
    }
}

// Reschedule Modal Functions
// Global variable for current reschedule inspection - ensure it's properly declared
window.currentRescheduleInspection = null;

function openRescheduleModal(inspectionId, barangay, currentDate, currentTime) {
    // Set the global variable with inspection data
    window.currentRescheduleInspection = { 
        id: inspectionId, 
        barangay: barangay,
        currentDate: currentDate
    };
    
    console.log('Setting currentRescheduleInspection to:', window.currentRescheduleInspection);
    
    const modalHtml = `
        <div id="rescheduleModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 500px;">
                <span class="close" onclick="closeRescheduleModal()">&times;</span>
                <h2 style="margin-bottom: 1rem; color: var(--primary-blue);"> Reschedule Inspection</h2>
                
                <div style="margin-bottom: 1rem; padding: 1rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                    <p style="margin: 0; color: #856404;"><strong>Current Schedule:</strong></p>
                    <p style="margin: 0.5rem 0 0 0; color: #856404;" id="currentScheduleInfo">${barangay} - ${formatDate(currentDate)}</p>
                </div>
                
                <form id="rescheduleForm">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">New Date:</label>
                        
                        <!-- Date Picker Button -->
                        <button type="button" id="reschedulePickerBtn" 
                                style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; background: white; transition: border-color 0.2s; box-sizing: border-box; font-family: inherit; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                                onfocus="this.style.borderColor='#2d8659'" 
                                onblur="this.style.borderColor='#ddd'">
                            <span id="reschedulePickerText" style="color: #999;">Click to select date...</span>
                            <span style="color: #666;"></span>
                        </button>
                        
                        <!-- Calendar Widget (Initially Hidden) -->
                        <div id="rescheduleCalendarWidget" class="calendar-responsive" style="display: none; border: 1px solid #d1d5db; border-radius: 6px; background: white; overflow: hidden; margin-top: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; z-index: 10; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;">
                            
                            <!-- Calendar Header -->
                            <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
                                <button type="button" id="reschedulePrevMonth" style="background: rgba(255,255,255,0.15); border: none; color: white; cursor: pointer; font-size: 16px; padding: 6px 8px; border-radius: 4px; transition: all 0.2s; font-weight: 600;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'"></button>
                                <span id="rescheduleCurrentMonth" style="font-weight: 600; font-size: 14px; color: white; flex: 1; text-align: center; letter-spacing: 0.5px;"></span>
                                <button type="button" id="rescheduleNextMonth" style="background: rgba(255,255,255,0.15); border: none; color: white; cursor: pointer; font-size: 16px; padding: 6px 8px; border-radius: 4px; transition: all 0.2s; font-weight: 600;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'"></button>
                            </div>
                            
                            <!-- Days of Week Header -->
                            <div style="display: grid; grid-template-columns: repeat(7, 1fr); background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                                <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">S</div>
                                <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">M</div>
                                <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">T</div>
                                <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">W</div>
                                <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">T</div>
                                <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">F</div>
                                <div style="padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; letter-spacing: 0.025em;">S</div>
                            </div>
                            
                            <!-- Calendar Days Container -->
                            <div id="rescheduleCalendarDays" style="display: grid; grid-template-columns: repeat(7, 1fr); background: white; max-height: 280px; overflow-y: auto;">
                                <!-- Calendar days will be populated by JavaScript -->
                            </div>
                            
            <!-- Selected date display -->
            <div id="rescheduleSelectedDisplay" style="font-size: 10px; color: #666; margin-top: 4px; padding: 4px 6px; background: #f8f9fa; border-radius: 3px; text-align: center;">
                Select an available date for rescheduling
            </div>
            
            <!-- Calendar Legend -->
            <div style="margin-top: 12px; padding: 8px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                <div style="font-size: 10px; font-weight: 600; color: #374151; margin-bottom: 6px; text-align: center;">Calendar Legend</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div style="width: 12px; height: 12px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 3px;"></div>
                        <span style="font-size: 8px; color: #374151;">Available</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div style="width: 12px; height: 12px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 3px;"></div>
                        <span style="font-size: 8px; color: #374151;">Unavailable</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div style="width: 12px; height: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 3px;"></div>
                        <span style="font-size: 8px; color: #374151;">Holiday/Blocked</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div style="width: 12px; height: 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 3px;"></div>
                        <span style="font-size: 8px; color: #374151;">Past/Weekend</span>
                    </div>
                </div>
            </div>
        </div>                        <input type="hidden" id="newInspectionDate" required>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Reason for Rescheduling:</label>
                        <textarea id="rescheduleReason" rows="3" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" placeholder="Please provide a reason for rescheduling..."></textarea>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem;">
                        <button type="button" onclick="closeRescheduleModal()" 
                                style="background: #6c757d; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                            Cancel
                        </button>
                        <button type="submit" 
                                style="background: var(--warning-orange, #ff9800); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-calendar-alt"></i> Reschedule & Notify
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('rescheduleModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Initialize reschedule calendar and store reference
    window.rescheduleCalendar = initializeRescheduleCalendar();
    
    // Add form submit handler
    document.getElementById('rescheduleForm').addEventListener('submit', handleRescheduleSubmit);
}

function closeRescheduleModal() {
    const modal = document.getElementById('rescheduleModal');
    if (modal) {
        modal.remove();
    }
    // Don't reset currentRescheduleInspection here - keep it until form is submitted
}

function showRescheduleSuccessModal(newDate, newTime, barangay, emailSent, emailStats) {
    let emailStatus = '';
    
    if (emailStats && emailStats.total_owners > 0) {
        if (emailStats.emails_sent_count > 0) {
            emailStatus = ` ${emailStats.emails_sent_count} of ${emailStats.total_owners} property owner(s) notified`;
            if (emailStats.emails_failed_count > 0) {
                emailStatus += ` (${emailStats.emails_failed_count} failed)`;
            }
        } else {
            emailStatus = ' Property owners should be notified manually';
        }
    } else if (emailSent) {
        emailStatus = ' Email notification sent to property owner';
    } else {
        emailStatus = ' Property owner should be notified manually';
    }
    
    const modalHtml = `
        <div id="rescheduleSuccessModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 450px; text-align: center;">
                <div style="padding: 1.5rem;">
                    <div style="color: var(--success-green, #28a745); font-size: 3rem; margin-bottom: 1rem;">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <h2 style="color: var(--success-green, #28a745); margin-bottom: 1rem;">Inspection Rescheduled!</h2>
                    <p style="color: var(--text-dark); margin-bottom: 1.5rem; line-height: 1.5;">The inspection has been successfully rescheduled${emailStats && emailStats.emails_sent_count > 0 ? ' and email notifications have been sent' : ''}.</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; text-align: left;">
                        <strong>New Schedule:</strong><br>
                         ${barangay}<br>
                         ${formatDate(newDate)}<br>
                        ${emailStatus}
                    </div>
                    <button class="btn btn-primary" onclick="closeRescheduleSuccessModal()" style="min-width: 120px;">
                        <i class="fas fa-check"></i> OK
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('rescheduleSuccessModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeRescheduleSuccessModal() {
    const modal = document.getElementById('rescheduleSuccessModal');
    if (modal) {
        modal.remove();
    }
    // Refresh the calendar to show updated schedule
    if (typeof loadInspectionCalendar === 'function') {
        loadInspectionCalendar();
    }
}

// Helper functions
function convertTo12Hour(time24) {
    const [hours, minutes] = time24.split(':');
    const hour12 = ((parseInt(hours) + 11) % 12) + 1;
    const ampm = parseInt(hours) >= 12 ? 'PM' : 'AM';
    return `${hour12}:${minutes} ${ampm}`;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

// Initialize reschedule calendar
function initializeRescheduleCalendar() {
    let currentDate = new Date();
    let selectedDate = null;
    let availabilityData = {};
    
    // Set to next month initially to show future dates
    currentDate.setMonth(currentDate.getMonth() + 1);
    
    // Fetch availability data AND blocked dates for reschedule calendar
    async function fetchAvailabilityData() {
        try {
            const month = currentDate.getMonth() + 1; // JS months are 0-based
            const year = currentDate.getFullYear();
            console.log('Fetching batch calendar availability + blocked dates for reschedule:', month, year);

            // Fetch both batch availability and blocked dates
            const [batchResponse, blockedResponse] = await Promise.all([
                fetch(`../backend/get_batch_calendar_availability.php?month=${month}&year=${year}`),
                fetch(`../backend/blocked_dates.php?action=list`)
            ]);

            const batchData = await batchResponse.json();
            const blockedData = await blockedResponse.json();

            console.log('Batch availability response:', batchData);
            console.log('Blocked dates response:', blockedData);

            // Clear previous data
            availabilityData = {};

            // First, process batch availability data
            if (batchData.success && Array.isArray(batchData.availability)) {
                batchData.availability.forEach(dayData => {
                    availabilityData[dayData.date] = {
                        status: dayData.status,
                        count: dayData.totalInspections || 0,
                        isSelectable: dayData.status === 'available',
                        holidayName: dayData.holidayName || null,
                        reason: dayData.reason || null,
                        hasBatchScheduled: dayData.hasBatchScheduled || false,
                        hasReachedLimit: dayData.hasReachedLimit || false,
                        individualCount: dayData.individualCount || 0,
                        barangays: dayData.barangays || null
                    };
                });
            }

            // Then, override with blocked dates (blocked dates take priority)
            if (blockedData.success && Array.isArray(blockedData.data)) {
                blockedData.data.forEach(blockedDate => {
                    const dateStr = blockedDate.date;
                    if (dateStr) {
                        availabilityData[dateStr] = {
                            status: 'blocked',
                            count: 0,
                            isSelectable: false,
                            reason: blockedDate.reason || 'Date blocked by staff',
                            blockedBy: blockedDate.created_by || 'Staff',
                            holidayName: null
                        };
                    }
                });
            }
            
            console.log('Final merged availability data for reschedule:', availabilityData);
            renderCalendar();
        } catch (error) {
            console.error('Error fetching reschedule availability data:', error);
            availabilityData = {};
            renderCalendar(); // Render without availability data
        }
    }
    
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // Update month display - exact same as batch calendar
        const monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"];
        document.getElementById('rescheduleCurrentMonth').textContent = `${monthNames[month]} ${year}`;
        
        // Clear calendar days
        const calendarDays = document.getElementById('rescheduleCalendarDays');
        calendarDays.innerHTML = '';
        
        // Calendar logic exact copy from batch inspection calendar
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        const today = new Date();
        const todayStr = today.getFullYear() + '-' + 
                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(today.getDate()).padStart(2, '0');
        
        console.log('Rendering reschedule calendar - today:', todayStr);
        console.log('Availability data for reschedule:', availabilityData);
        
        // Add empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.style.cssText = 'padding: 10px; min-height: 40px;';
            calendarDays.appendChild(emptyDay);
        }
        
        // Add days of the month - using exact batch calendar logic
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = year + '-' + 
                           String(month + 1).padStart(2, '0') + '-' + 
                           String(day).padStart(2, '0');
            
            const dayData = availabilityData[dateStr];
            const isToday = dateStr === todayStr;
            
            // Check if selected for reschedule
            const isSelected = selectedDate && 
                selectedDate.getDate() === day && 
                selectedDate.getMonth() === month && 
                selectedDate.getFullYear() === year;
            
            const dayCell = createDayCell(day, dateStr, dayData, isToday, isSelected);
            calendarDays.appendChild(dayCell);
        }
        
        console.log('Reschedule calendar rendered for', monthNames[month], year);
    }
    
    // Create day cell - exact same logic as batch inspection calendar
    function createDayCell(day, dateStr, dayData, isToday, isSelected) {
        const dayElement = document.createElement('div');
        
        // Determine day of week for tooltip
        const dayDate = new Date(dateStr + 'T00:00:00');
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const dayName = dayNames[dayDate.getDay()];
        
        let className = '';
        let title = '';
        let clickable = false;
        
        // Status determination - blocked dates have highest priority
        if (dayData) {
            switch(dayData.status) {
                case 'blocked':
                    className = 'blocked';
                    title = `${dayName} - Blocked: ${dayData.reason || 'Date blocked by staff'}`;
                    clickable = false;
                    break;
                    
                case 'available':
                    className = 'available';
                    if (dayData.count > 0) {
                        title = `${dayName} - Available (${dayData.count} inspection${dayData.count > 1 ? 's' : ''} scheduled)`;
                    } else {
                        title = `${dayName} - Available for scheduling`;
                    }
                    clickable = true;
                    break;
                    
                case 'unavailable':
                    className = 'unavailable';
                    if (dayData.reason) {
                        title = `${dayName} - Unavailable: ${dayData.reason}`;
                    } else {
                        title = `${dayName} - Unavailable for scheduling`;
                    }
                    clickable = false;
                    break;
                    
                case 'holiday':
                    className = 'holiday';
                    title = `${dayName} - Holiday: ${dayData.holidayName || 'Public Holiday'}`;
                    clickable = false;
                    break;
                    
                case 'weekend':
                case 'past':
                default:
                    className = 'past';
                    title = `${dayName} - Not available`;
                    clickable = false;
                    break;
            }
        } else {
            // No data - treat as unavailable
            className = 'past';
            title = `${dayName} - Not available`;
            clickable = false;
        }
        
        // Apply selection styling
        if (isSelected) {
            className += ' selected';
            title = `${dayName} - Selected for rescheduling`;
        }
        
        if (isToday) {
            className += ' today';
        }
        
        dayElement.textContent = day;
        dayElement.title = title;
        dayElement.className = className;
        dayElement.style.cssText = `
            padding: 10px;
            text-align: center;
            cursor: ${clickable ? 'pointer' : 'not-allowed'};
            border-radius: 4px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: ${isSelected ? '600' : 'normal'};
            transition: all 0.2s;
        `;
        
        // Apply colors based on status - blocked dates same color as holidays
        switch(className.split(' ')[0]) {
            case 'available':
                dayElement.style.backgroundColor = isSelected ? '#ff9800' : '#d4edda';
                dayElement.style.color = isSelected ? 'white' : '#155724';
                dayElement.style.border = `1px solid ${isSelected ? '#ff9800' : '#c3e6cb'}`;
                break;
            case 'blocked':
                dayElement.style.backgroundColor = '#fff3cd';
                dayElement.style.color = '#856404';
                dayElement.style.border = '1px solid #ffeaa7';
                break;
            case 'unavailable':
                dayElement.style.backgroundColor = '#f8d7da';
                dayElement.style.color = '#721c24';
                dayElement.style.border = '1px solid #f5c6cb';
                break;
            case 'holiday':
                dayElement.style.backgroundColor = '#fff3cd';
                dayElement.style.color = '#856404';
                dayElement.style.border = '1px solid #ffeaa7';
                break;
            default:
                dayElement.style.backgroundColor = '#f8f9fa';
                dayElement.style.color = '#6c757d';
                dayElement.style.border = '1px solid #dee2e6';
                break;
        }
        
        // Add click handler for available days
        if (clickable) {
            dayElement.addEventListener('click', function() {
                // Set selected date
                selectedDate = new Date(dateStr + 'T00:00:00');
                
                // Update form input
                document.getElementById('newInspectionDate').value = dateStr;
                
                // Update display
                const formattedDate = selectedDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('reschedulePickerText').textContent = formattedDate;
                document.getElementById('reschedulePickerText').style.color = '#333';
                document.getElementById('rescheduleSelectedDisplay').textContent = `Selected: ${formattedDate}`;
                
                // Hide calendar
                document.getElementById('rescheduleCalendarWidget').style.display = 'none';
                
                // Re-render to show selection
                renderCalendar();
            });
            
            // Add hover effects
            dayElement.addEventListener('mouseenter', function() {
                if (!isSelected) {
                    this.style.backgroundColor = '#fff3e0';
                    this.style.borderColor = '#ff9800';
                }
            });
            
            dayElement.addEventListener('mouseleave', function() {
                if (!isSelected) {
                    this.style.backgroundColor = '#d4edda';
                    this.style.borderColor = '#c3e6cb';
                }
            });
        }
        
        return dayElement;
    }
    
    // Event listeners for calendar navigation
    document.getElementById('reschedulePrevMonth').addEventListener('click', function() {
        // Clear selection when changing months
        selectedDate = null;
        document.getElementById('newInspectionDate').value = '';
        document.getElementById('reschedulePickerText').textContent = 'Click to select date...';
        document.getElementById('reschedulePickerText').style.color = '#999';
        document.getElementById('rescheduleSelectedDisplay').textContent = 'Select an available date for rescheduling';
        
        // Navigate to previous month
        currentDate.setMonth(currentDate.getMonth() - 1);
        // Clear old data and fetch new data for the new month
        availabilityData = {};
        fetchAvailabilityData();
    });
    
    document.getElementById('rescheduleNextMonth').addEventListener('click', function() {
        // Clear selection when changing months
        selectedDate = null;
        document.getElementById('newInspectionDate').value = '';
        document.getElementById('reschedulePickerText').textContent = 'Click to select date...';
        document.getElementById('reschedulePickerText').style.color = '#999';
        document.getElementById('rescheduleSelectedDisplay').textContent = 'Select an available date for rescheduling';
        
        // Navigate to next month
        currentDate.setMonth(currentDate.getMonth() + 1);
        // Clear old data and fetch new data for the new month
        availabilityData = {};
        fetchAvailabilityData();
    });
    
    // Toggle calendar visibility
    document.getElementById('reschedulePickerBtn').addEventListener('click', function() {
        const calendar = document.getElementById('rescheduleCalendarWidget');
        calendar.style.display = calendar.style.display === 'none' ? 'block' : 'none';
    });
    
    // Hide calendar when clicking outside
    document.addEventListener('click', function(event) {
        const calendar = document.getElementById('rescheduleCalendarWidget');
        const picker = document.getElementById('reschedulePickerBtn');
        
        if (calendar && picker && !calendar.contains(event.target) && !picker.contains(event.target)) {
            calendar.style.display = 'none';
        }
    });
    
    // Initial load - fetch availability data and render
    fetchAvailabilityData();
    
    // Return refresh function for external use
    return {
        refresh: fetchAvailabilityData,
        refreshMonth: function() {
            availabilityData = {};
            fetchAvailabilityData();
        }
    };
}

// Global function to refresh reschedule calendar when blocked dates change
function refreshRescheduleCalendar() {
    if (window.rescheduleCalendar && typeof window.rescheduleCalendar.refresh === 'function') {
        window.rescheduleCalendar.refresh();
    }
}

// Handle reschedule form submission
async function handleRescheduleSubmit(e) {
    e.preventDefault();
    
    // Check if reschedule data is available
    if (!window.currentRescheduleInspection) {
        alert('Error: Reschedule data not found. Please close the modal and try again.');
        console.error('currentRescheduleInspection is null');
        return;
    }
    
    console.log('Current reschedule inspection:', window.currentRescheduleInspection);
    
    const newDate = document.getElementById('newInspectionDate').value;
    const reason = document.getElementById('rescheduleReason').value;
    
    if (!newDate || !reason.trim()) {
        alert('Please fill in all required fields.');
        return;
    }
    
    const newTime = '09:00'; // Default time
    
    // Disable submit button to prevent double submission
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rescheduling...';
    
    try {
        const response = await fetch('../backend/reschedule_inspection.php?v=' + Date.now(), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache'
            },
            body: JSON.stringify({
                inspection_id: window.currentRescheduleInspection.id,
                new_date: newDate,
                reason: reason,
                barangay: window.currentRescheduleInspection.barangay
            })
        });
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers.get('content-type'));
        
        const responseText = await response.text();
        console.log('Raw response:', responseText);
        
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (parseError) {
            console.error('JSON parse error:', parseError);
            console.error('Response was:', responseText);
            throw new Error('Server returned invalid JSON. Check console for details.');
        }
        
        console.log('Reschedule response:', result);
        
        if (result.success) {
            closeRescheduleModal();
            const emailStats = {
                emails_sent_count: result.emails_sent_count || 0,
                emails_failed_count: result.emails_failed_count || 0,
                total_owners: result.total_owners || 0
            };
            showRescheduleSuccessModal(newDate, null, window.currentRescheduleInspection.barangay, result.email_sent, emailStats);
            // Reset the variable after successful reschedule
            window.currentRescheduleInspection = null;
        } else {
            console.error('Reschedule failed:', result);
            alert('Error rescheduling inspection: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Reschedule error:', error);
        alert('Error rescheduling inspection: ' + error.message);
    } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

function showDetailsModal(request) {
    const modalHtml = `
        <div id="detailsModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="closeDetailsModal()">&times;</span>
                <h2>Inspection Request Details</h2>
                <div class="details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                    <div><strong>Request ID:</strong> #${request.id}</div>
                    <div><strong>Status:</strong> <span class="status-badge ${request.status}">${request.status}</span></div>
                    <div><strong>Client Name:</strong> ${request.clientName}</div>
                    <div><strong>Email:</strong> ${request.email}</div>
                    <div><strong>Property Class:</strong> ${request.propertyClass}</div>
                    <div><strong>Location:</strong> ${request.location}</div>
                    <div><strong>Landmark:</strong> ${request.landmark}</div>
                    <div><strong>Land Reference:</strong> ${request.landRef}</div>
                    <div><strong>Contact Person:</strong> ${request.contactPerson}</div>
                    <div><strong>Date Submitted:</strong> ${request.dateSubmitted}</div>
                </div>
                <div style="margin: 1rem 0;">
                    <strong>Purpose and Preferred Date:</strong>
                    <p style="margin: 0.5rem 0; padding: 1rem; background: #f5f5f5; border-radius: 4px;">${request.purpose}</p>
                    <small style="color: #6c757d; font-style: italic;">Client viewed calendar and mentioned preferred dates above</small>
                </div>
                <div class="modal-footer" style="text-align: right; margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="scheduleInspection('${request.id}'); closeDetailsModal();">
                        <i class="fas fa-calendar-plus"></i> Schedule Inspection
                    </button>
                    <button class="btn btn-secondary" onclick="closeDetailsModal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('detailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeDetailsModal() {
    const modal = document.getElementById('detailsModal');
    if (modal) {
        modal.remove();
    }
}

// Add refresh functionality and barangay filtering
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refreshViewBtn');
    const barangayFilter = document.getElementById('barangayFilter');
    const refreshNotificationsBtn = document.getElementById('refreshNotificationsBtn');
    const searchInput = document.getElementById('viewRequestsSearch');

    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            refreshViewRequests();
        });
    }

    if (barangayFilter) {
        barangayFilter.addEventListener('change', function() {
            filterByBarangay(this.value);
        });
    }

    if (refreshNotificationsBtn) {
        refreshNotificationsBtn.addEventListener('click', function() {
            staffApp.loadIncomingRequestsTable();
        });
    }

    // Search functionality for View Requests table
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const keyword = this.value.trim().toLowerCase();
            const tableRows = document.querySelectorAll('#view-requests-table-body tr');
            let visibleCount = 0;
            
            tableRows.forEach(row => {
                // Get specific searchable content from the row
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const searchableContent = [
                        cells[0]?.textContent || '', // Request ID
                        cells[1]?.textContent || '', // Client Name
                        cells[2]?.textContent || '', // Client Email
                        cells[4]?.textContent || '', // Location/Barangay
                        cells[5]?.textContent || '', // Landmark
                        cells[7]?.textContent || '', // Contact Person
                        cells[8]?.textContent || ''  // Purpose
                    ].join(' ').toLowerCase();

                    if (keyword === '' || searchableContent.includes(keyword)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
            
            // Show search results count
            console.log(`Search results: ${visibleCount} requests found for "${keyword}"`);
            
            // Apply barangay filter if active
            const currentBarangayFilter = document.getElementById('barangayFilter').value;
            if (currentBarangayFilter !== 'all') {
                filterByBarangay(currentBarangayFilter);
            }
        });
    }

    // Initialize the table with all requests when the page loads
    setTimeout(() => {
        loadAllRequests();
    }, 500);
});

// Sample requests data with diverse barangays
const allRequests = [];

function refreshViewRequests() {
    if (staffApp) {
        staffApp.loadViewRequestsTable();
        // Reset filter
        const filter = document.getElementById('barangayFilter');
        if (filter) {
            filter.value = 'all';
        }
    } else {
        console.error('StaffApp not initialized');
        alert('Application not ready. Please refresh the page.');
    }
}

function loadAllRequests() {
    const tableBody = document.getElementById('view-requests-table-body');
    if (tableBody) {
        tableBody.innerHTML = allRequests.map(request => createRequestRow(request)).join('');
    }
}

function createRequestRow(request) {
    return `
        <tr data-barangay="${request.location}">
            <td>#${request.id}</td>
            <td>${request.clientName}</td>
            <td>${request.email}</td>
            <td>${request.propertyClass}</td>
            <td>${request.location}</td>
            <td>${request.landmark}</td>
            <td>${request.landRef}</td>
            <td>${request.contactPerson}</td>
            <td class="purpose-cell">${request.purpose.length > 30 ? request.purpose.substring(0, 30) + '...' : request.purpose}</td>
            <td>
                <button class="btn btn-sm btn-outline" onclick="viewDocument('${request.validId}')">
                    <i class="fas fa-file-image"></i>
                    View ID
                </button>
            </td>
            <td>${request.dateSubmitted}</td>
            <td><span class="status-badge ${request.status}">${request.status.charAt(0).toUpperCase() + request.status.slice(1)}</span></td>
        </tr>
    `;
}

function filterByBarangay(selectedBarangay) {
    const tableRows = document.querySelectorAll('#view-requests-table-body tr');
    
    tableRows.forEach(row => {
        const barangay = row.getAttribute('data-barangay');
        if (selectedBarangay === 'all' || barangay === selectedBarangay) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update visible count
    const visibleRows = document.querySelectorAll('#view-requests-table-body tr[style=""], #view-requests-table-body tr:not([style])').length;
    console.log(`Showing ${visibleRows} requests for ${selectedBarangay === 'all' ? 'all barangays' : selectedBarangay}`);
}

// Inspection History Management
class InspectionHistoryManager {
    constructor() {
        this.apiUrl = '../backend/api/staff.php';
        this.inspections = [];
        this.filteredInspections = [];
        this.archivedInspections = [];
        this.initializeEventListeners();
    }

    initializeEventListeners() {
        // Initialize immediately when class is created
        setTimeout(() => {
            this.populateYearFilter();
            this.populateMonthFilter();
            
            const yearFilter = document.getElementById('yearFilter');
            const monthFilter = document.getElementById('monthFilter');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const refreshBtn = document.getElementById('refreshHistoryBtn');
            
            if (yearFilter) {
                yearFilter.addEventListener('change', () => {
                    this.filterInspections();
                });
            }
            
            if (monthFilter) {
                monthFilter.addEventListener('change', () => {
                    this.filterInspections();
                });
            }
            
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    this.clearFilters();
                });
            }
            
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    this.loadInspectionHistory();
                });
            }
            
            // Archive view controls
            const viewArchiveBtn = document.getElementById('viewArchiveBtn');
            const hideArchiveBtn = document.getElementById('hideArchiveBtn');
            const refreshArchiveBtn = document.getElementById('refreshArchiveBtn');
            
            if (viewArchiveBtn) {
                viewArchiveBtn.addEventListener('click', () => {
                    this.showArchive();
                });
            }
            
            if (hideArchiveBtn) {
                hideArchiveBtn.addEventListener('click', () => {
                    this.hideArchive();
                });
            }
            
            if (refreshArchiveBtn) {
                refreshArchiveBtn.addEventListener('click', () => {
                    this.loadArchivedInspections();
                });
            }
        }, 100);
    }

    populateYearFilter() {
        const yearFilter = document.getElementById('yearFilter');
        if (!yearFilter) return;

        const currentYear = new Date().getFullYear();
        const startYear = 2024; // Start from 2024
        const endYear = currentYear + 5; // Include next 5 years

        // Clear existing options except "All Years"
        const allYearsOption = yearFilter.querySelector('option[value=""]');
        yearFilter.innerHTML = '';
        yearFilter.appendChild(allYearsOption);

        // Add year options (newest first)
        for (let year = endYear; year >= startYear; year--) {
            const option = document.createElement('option');
            option.value = year.toString();
            option.textContent = year.toString();
            yearFilter.appendChild(option);
        }
    }

    populateMonthFilter() {
        const monthFilter = document.getElementById('monthFilter');
        if (!monthFilter) return;

        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];

        // Clear existing options except "All Months"
        const allMonthsOption = monthFilter.querySelector('option[value=""]');
        monthFilter.innerHTML = '';
        monthFilter.appendChild(allMonthsOption);

        // Add month options
        monthNames.forEach((monthName, index) => {
            const option = document.createElement('option');
            option.value = String(index + 1).padStart(2, '0'); // 01, 02, 03, etc.
            option.textContent = monthName;
            monthFilter.appendChild(option);
        });
    }

    async loadInspectionHistory() {
        const tableBody = document.getElementById('inspection-history-table-body');
        const emptyState = document.getElementById('no-inspection-history');
        
        // Show loading state
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="padding: 2rem; text-align: center; color: #666;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                    <br>Loading inspection history...
                </td>
            </tr>
        `;

        try {
            const response = await fetch(`${this.apiUrl}?action=inspection_history`, {
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();

            if (data.success) {
                console.log('=== INSPECTION HISTORY DEBUG ===');
                console.log('API returned inspections:', data.data.length);
                console.log('Source breakdown:', data.source_breakdown);
                console.log('Debug info:', data.debug_info);
                console.log('First few inspections:', data.data.slice(0, 3));
                console.log('Last few inspections:', data.data.slice(-3));
                console.log('=== END DEBUG ===');
                
                this.inspections = data.data;
                this.filteredInspections = [...this.inspections]; // Initialize filtered list
                this.populateMonthFilter(); // Ensure filter is populated
                this.renderInspectionHistory();
            } else {
                this.showError('Failed to load inspection history: ' + data.message);
            }

        } catch (error) {
            console.error('Error loading inspection history:', error);
            this.showError('Error loading inspection history. Please try again.');
        }
    }

    filterInspections() {
        const yearFilter = document.getElementById('yearFilter');
        const monthFilter = document.getElementById('monthFilter');
        
        const selectedYear = yearFilter ? yearFilter.value : '';
        const selectedMonth = monthFilter ? monthFilter.value : '';
        
        if (!selectedYear && !selectedMonth) {
            // Show all inspections
            this.filteredInspections = [...this.inspections];
        } else {
            // Filter by selected year and/or month
            this.filteredInspections = this.inspections.filter(inspection => {
                const inspectionDate = inspection.date || inspection.inspection_date;
                if (!inspectionDate) return false;
                
                const dateParts = inspectionDate.split('-'); // [YYYY, MM, DD]
                const inspectionYear = dateParts[0];
                const inspectionMonth = dateParts[1];
                
                let yearMatch = true;
                let monthMatch = true;
                
                if (selectedYear) {
                    yearMatch = inspectionYear === selectedYear;
                }
                
                if (selectedMonth) {
                    monthMatch = inspectionMonth === selectedMonth;
                }
                
                return yearMatch && monthMatch;
            });
        }
        
        this.renderInspectionHistory();
    }

    clearFilters() {
        const yearFilter = document.getElementById('yearFilter');
        const monthFilter = document.getElementById('monthFilter');
        
        if (yearFilter) yearFilter.value = '';
        if (monthFilter) monthFilter.value = '';
        
        this.filterInspections();
    }

    showNotification(message, type = 'info') {
        // Create or get existing notification container
        let notification = document.getElementById('inspection-notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'inspection-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 99999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            document.body.appendChild(notification);
        }
        
        // Set message and color based on type
        notification.textContent = message;
        notification.style.background = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
        
        // Show notification
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);
        
        // Hide notification after 2 seconds
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            // Completely remove after animation completes
            setTimeout(() => {
                if (notification && notification.parentElement) {
                    notification.remove();
                }
            }, 300);
        }, 2000);
    }

    showArchive() {
        const archiveContainer = document.getElementById('archive-container');
        const viewArchiveBtn = document.getElementById('viewArchiveBtn');
        
        if (archiveContainer) {
            archiveContainer.style.display = 'block';
            this.loadArchivedInspections();
        }
        
        if (viewArchiveBtn) {
            viewArchiveBtn.style.background = '#374151';
            viewArchiveBtn.innerHTML = '<i class="fas fa-archive"></i> Archive (Viewing)';
        }
    }

    hideArchive() {
        const archiveContainer = document.getElementById('archive-container');
        const noArchivedState = document.getElementById('no-archived-inspections');
        const viewArchiveBtn = document.getElementById('viewArchiveBtn');
        
        if (archiveContainer) {
            archiveContainer.style.display = 'none';
        }
        
        if (noArchivedState) {
            noArchivedState.style.display = 'none';
        }
        
        if (viewArchiveBtn) {
            viewArchiveBtn.style.background = '#6b7280';
            viewArchiveBtn.innerHTML = '<i class="fas fa-archive"></i> Archive';
        }
    }

    async loadArchivedInspections() {
        try {
            const response = await fetch(`${this.apiUrl}?action=get_archived_inspections`, {
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();
            
            if (data.success) {
                this.archivedInspections = data.data || [];
                this.renderArchivedInspections();
            } else {
                console.error('Failed to load archived inspections:', data.message);
                this.showEmptyArchive();
            }
        } catch (error) {
            console.error('Error loading archived inspections:', error);
            this.showEmptyArchive();
        }
    }

    renderArchivedInspections() {
        const tableBody = document.getElementById('archived-inspections-table-body');
        const archiveContainer = document.getElementById('archive-container');
        const emptyArchiveState = document.getElementById('no-archived-inspections');
        
        if (!this.archivedInspections || this.archivedInspections.length === 0) {
            this.showEmptyArchive();
            return;
        }

        if (emptyArchiveState) {
            emptyArchiveState.style.display = 'none';
        }

        const renderedRows = this.archivedInspections.map(inspection => {
            const inspectionDate = new Date(inspection.inspection_date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short', 
                day: 'numeric'
            });

            const archivedDate = new Date(inspection.archived_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short', 
                day: 'numeric'
            });

            const statusClass = inspection.status === 'completed' ? 'completed' : 'cancelled';
            const statusIcon = inspection.status === 'completed' ? 'fa-check-circle' : 'fa-times-circle';
            
            const sourceIcon = inspection.source === 'scheduled_inspection' ? 
                '<i class="fas fa-calendar-alt" style="color: #007bff; margin-right: 0.25rem;" title="Scheduled Barangay Inspection"></i>' :
                '<i class="fas fa-file-alt" style="color: #28a745; margin-right: 0.25rem;" title="Individual Assessment Request"></i>';

            return `
                <tr data-inspection-id="${inspection.id}" style="background: #f9fafb;">
                    <td style="padding: 1rem; border-bottom: 1px solid #eee;">${inspectionDate}</td>
                    <td style="padding: 1rem; border-bottom: 1px solid #eee;">${sourceIcon}${inspection.property_address}</td>
                    <td style="padding: 1rem; border-bottom: 1px solid #eee;">${inspection.assessment_type}</td>
                    <td style="padding: 1rem; border-bottom: 1px solid #eee;">
                        <span class="status-badge ${statusClass}" style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; opacity: 0.7;">
                            <i class="fas ${statusIcon}"></i>
                            ${inspection.status.charAt(0).toUpperCase() + inspection.status.slice(1)}
                        </span>
                    </td>
                    <td style="padding: 1rem; border-bottom: 1px solid #eee; color: #dc2626; font-weight: 500;">${archivedDate}</td>
                    <td style="padding: 1rem; border-bottom: 1px solid #eee;">
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary" onclick="inspectionHistoryManager.viewInspectionDetails('${inspection.id}')" 
                                    style="padding: 0.5rem 1rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="inspectionHistoryManager.recoverInspection('${inspection.archive_id}')" 
                                    style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;" title="Recover Inspection">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="inspectionHistoryManager.permanentDeleteInspection('${inspection.archive_id}')" 
                                    style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;" title="Delete Permanently">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = renderedRows.join('');
    }

    showEmptyArchive() {
        const tableBody = document.getElementById('archived-inspections-table-body');
        const emptyArchiveState = document.getElementById('no-archived-inspections');
        
        // Hide the table and show the empty state div instead
        if (tableBody) {
            tableBody.innerHTML = '';
        }
        
        if (emptyArchiveState) {
            emptyArchiveState.style.display = 'block';
        }
    }

    renderInspectionHistory() {
        console.log('=== RENDER DEBUG ===');
        console.log('About to render inspections:', this.filteredInspections.length, 'of', this.inspections.length, 'total');
        console.log('=== END RENDER DEBUG ===');
        
        const tableBody = document.getElementById('inspection-history-table-body');
        const emptyState = document.getElementById('no-inspection-history');
        
        if (this.filteredInspections.length === 0) {
            tableBody.innerHTML = '';
            emptyState.style.display = 'block';
            // Update empty state message based on filter
            const monthFilter = document.getElementById('monthFilter');
            const selectedMonth = monthFilter ? monthFilter.value : '';
            const emptyMsg = emptyState.querySelector('p');
            if (emptyMsg) {
                if (selectedMonth) {
                    const monthName = monthFilter.options[monthFilter.selectedIndex].text;
                    emptyMsg.textContent = `No inspections found for ${monthName}. Try selecting a different month or clear the filter.`;
                } else {
                    emptyMsg.textContent = 'You haven\'t completed any inspections yet, or no inspections match your current filters.';
                }
            }
            return;
        }

        emptyState.style.display = 'none';
        
        console.log('=== RENDER DETAILS ===');
        let renderCount = 0;
        
        const renderedRows = this.filteredInspections.map((inspection, index) => {
            try {
                const date = new Date(inspection.inspection_date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short', 
                    day: 'numeric'
                });

                const statusClass = inspection.status === 'completed' ? 'completed' : 'cancelled';
                const statusIcon = inspection.status === 'completed' ? 'fa-check-circle' : 'fa-times-circle';
                
                // Add source indicator
                const sourceIcon = inspection.source === 'scheduled_inspection' ? 
                    '<i class="fas fa-calendar-alt" style="color: #007bff; margin-right: 0.25rem;" title="Scheduled Barangay Inspection"></i>' :
                    '<i class="fas fa-file-alt" style="color: #28a745; margin-right: 0.25rem;" title="Individual Assessment Request"></i>';

                const row = `
                    <tr data-inspection-id="${inspection.id}">
                        <td style="padding: 1rem; border-bottom: 1px solid #eee;">${date}</td>
                        <td style="padding: 1rem; border-bottom: 1px solid #eee;">${sourceIcon}${inspection.property_address}</td>
                        <td style="padding: 1rem; border-bottom: 1px solid #eee;">
                            <span style="color: ${
                                ((inspection.inspection_category || inspection.assessment_type) === 'Land Property' || 
                                 (inspection.inspection_category || inspection.assessment_type) === 'Property') ? '#6c757d' : 
                                (inspection.inspection_category || inspection.assessment_type) === 'Machinery' ? '#007bff' : '#28a745'
                            }; font-weight: 500;">
                                ${(inspection.inspection_category || inspection.assessment_type) === 'Property' ? 'Land Property' : (inspection.inspection_category || inspection.assessment_type || 'N/A')}
                            </span>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid #eee;">
                            <span class="status-badge ${statusClass}" style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500;">
                                <i class="fas ${statusIcon}"></i>
                                ${inspection.status.charAt(0).toUpperCase() + inspection.status.slice(1)}
                            </span>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid #eee;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-sm btn-primary" onclick="inspectionHistoryManager.viewInspectionDetails('${inspection.id}')" 
                                        style="padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                    <i class="fas fa-eye" style="margin-right: 0.5rem;"></i>
                                    View Details
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="inspectionHistoryManager.deleteInspection('${inspection.id}')" 
                                        style="padding: 0.5rem 1rem; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                    <i class="fas fa-trash" style="margin-right: 0.5rem;"></i>
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                
                renderCount++;
                return row;
                
            } catch (error) {
                console.error(`Error rendering inspection ${index}:`, error);
                console.log('Problematic inspection data:', inspection);
                return ''; // Return empty string for failed renders
            }
        });
        
        console.log(`Successfully rendered ${renderCount} out of ${this.inspections.length} inspections`);
        console.log('=== END RENDER DETAILS ===');
        
        tableBody.innerHTML = renderedRows.join('');
        
        // Final verification - count actual rows in DOM
        setTimeout(() => {
            const actualRows = tableBody.querySelectorAll('tr').length;
            console.log(`=== FINAL VERIFICATION ===`);
            console.log(`Rows actually in DOM: ${actualRows}`);
            console.log(`Expected rows: ${this.inspections.length}`);
            if (actualRows !== this.inspections.length) {
                console.warn(`MISMATCH: Expected ${this.inspections.length} rows but DOM has ${actualRows}`);
            }
            console.log('=== END VERIFICATION ===');
        }, 100);
    }

    deleteInspection(inspectionId) {
        // Show professional confirmation modal
        const modal = document.getElementById('deleteInspectionModal');
        const confirmBtn = document.getElementById('confirmDeleteInspection');
        const cancelBtn = document.getElementById('cancelDeleteInspection');
        
        // Show modal
        modal.style.display = 'block';
        
        // Handle modal actions
        const handleConfirm = async () => {
            modal.style.display = 'none';
            try {
                const response = await fetch(`${this.apiUrl}?action=archive_inspection`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ inspectionId: inspectionId })
                });
                
                const data = await response.json();
                if (data.success) {
                    // Remove from local array
                    this.inspections = this.inspections.filter(inspection => inspection.id !== inspectionId);
                    this.filterInspections();
                    
                    // Show professional success message
                    this.showNotification('Inspection record archived successfully. You can view or restore it from the Archive section.', 'success');
                } else {
                    this.showNotification('Archive operation failed. ' + (data.message || 'Please try again or contact support.'), 'error');
                }
            } catch (error) {
                console.error('Error archiving inspection:', error);
                this.showNotification('Archive operation could not be completed. Please check your connection and try again.', 'error');
            }
            cleanup();
        };
        
        const handleCancel = () => {
            modal.style.display = 'none';
            cleanup();
        };
        
        const cleanup = () => {
            confirmBtn.removeEventListener('click', handleConfirm);
            cancelBtn.removeEventListener('click', handleCancel);
        };
        
        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);
    }

    recoverInspection(archiveId) {
        // Show professional recovery confirmation modal
        const modal = document.getElementById('recoverInspectionModal');
        const confirmBtn = document.getElementById('confirmRecoverInspection');
        const cancelBtn = document.getElementById('cancelRecoverInspection');
        
        // Show modal
        modal.style.display = 'block';
        
        // Handle modal actions
        const handleConfirm = async () => {
            modal.style.display = 'none';
            this.performRecovery(archiveId);
            cleanup();
        };
        
        const handleCancel = () => {
            modal.style.display = 'none';
            cleanup();
        };
        
        const cleanup = () => {
            confirmBtn.removeEventListener('click', handleConfirm);
            cancelBtn.removeEventListener('click', handleCancel);
        };
        
        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);
    }

    async performRecovery(archiveId) {
        try {
            const response = await fetch(`${this.apiUrl}?action=recover_inspection`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ archiveId: archiveId })
            });
            
            const data = await response.json();
            if (data.success) {
                // Remove from archived array and refresh archive display
                this.archivedInspections = this.archivedInspections.filter(inspection => inspection.archive_id != archiveId);
                this.renderArchivedInspections();
                
                // Refresh main inspection history to show recovered item
                this.loadInspectionHistory();
                
                this.showNotification('Inspection record restored successfully. It now appears in your active inspection history.', 'success');
            } else {
                this.showNotification('Recovery operation failed. ' + (data.message || 'Please try again or contact support.'), 'error');
            }
        } catch (error) {
            console.error('Error recovering inspection:', error);
            this.showNotification('Recovery operation could not be completed. Please check your connection and try again.', 'error');
        }
    }

    permanentDeleteInspection(archiveId) {
        // Show professional permanent deletion warning modal
        const modal = document.getElementById('permanentDeleteModal');
        const confirmBtn = document.getElementById('confirmPermanentDelete');
        const cancelBtn = document.getElementById('cancelPermanentDelete');
        const closeBtn = document.getElementById('closePermanentDeleteModal');
        
        modal.style.display = 'flex';
        
        // Handle modal actions
        const handleConfirm = async () => {
            modal.style.display = 'none';
            this.performPermanentDeletion(archiveId);
            cleanup();
        };
        
        const handleCancel = () => {
            modal.style.display = 'none';
            cleanup();
        };
        
        const cleanup = () => {
            confirmBtn.removeEventListener('click', handleConfirm);
            cancelBtn.removeEventListener('click', handleCancel);
            closeBtn.removeEventListener('click', handleCancel);
        };
        
        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);
        closeBtn.addEventListener('click', handleCancel);
    }

    async performPermanentDeletion(archiveId) {
        try {
            const response = await fetch(`${this.apiUrl}?action=permanent_delete`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ archiveId: archiveId })
            });
            
            const data = await response.json();
            if (data.success) {
                // Remove from archived array
                this.archivedInspections = this.archivedInspections.filter(inspection => inspection.archive_id != archiveId);
                this.renderArchivedInspections();
                
                this.showNotification('Inspection record permanently removed from the system.', 'success');
            } else {
                this.showNotification('Permanent deletion failed. ' + (data.message || 'Please try again or contact support.'), 'error');
            }
        } catch (error) {
            console.error('Error permanently deleting inspection:', error);
            this.showNotification('Deletion operation could not be completed. Please check your connection and try again.', 'error');
        }
    }

    async viewInspectionDetails(inspectionId) {
        try {
            console.log('=== VIEW INSPECTION DETAILS DEBUG ===');
            console.log('Requested inspection ID:', inspectionId);
            console.log('API URL:', `${this.apiUrl}?action=inspection_details&id=${inspectionId}`);
            
            const response = await fetch(`${this.apiUrl}?action=inspection_details&id=${inspectionId}`, {
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();
            console.log('Inspection details response:', data);
            console.log('Response success:', data.success);
            console.log('Response message:', data.message);

            if (data.success) {
                console.log('Inspection data:', data.data);
                console.log('Clients array:', data.data.clients);
                this.showInspectionModal(data.data);
            } else {
                console.log('Failed to load inspection details. Message:', data.message);
                this.showError('Failed to load inspection details: ' + data.message);
            }

        } catch (error) {
            console.error('Error loading inspection details:', error);
            this.showError('Error loading inspection details. Please try again.');
        }
    }

    showInspectionModal(inspection) {
        console.log('=== MODAL DEBUG START ===');
        console.log('showInspectionModal called with:', inspection);
        console.log('Is scheduled inspection:', inspection.source === 'scheduled_inspection');
        console.log('Clients data exists:', !!inspection.clients);
        console.log('Clients is array:', Array.isArray(inspection.clients));
        console.log('Clients length:', inspection.clients ? inspection.clients.length : 'N/A');
        console.log('Raw clients data:', inspection.clients);
        console.log('=== MODAL DEBUG END ===');
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.cssText = `
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.2s ease;
        `;

        const date = new Date(inspection.inspection_date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long', 
            day: 'numeric'
        });

        const statusBadge = inspection.status === 'completed' ? 
            '<span style="background: #d4edda; color: #155724; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.85rem; font-weight: 500; border: 1px solid #c3e6cb;">COMPLETED</span>' :
            inspection.status === 'cancelled' ? 
            '<span style="background: #f8d7da; color: #721c24; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.85rem; font-weight: 500; border: 1px solid #f5c6cb;">CANCELLED</span>' :
            '<span style="background: #fff3cd; color: #856404; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.85rem; font-weight: 500; border: 1px solid #ffeaa7;">PENDING</span>';

        // Check if this is a scheduled inspection or individual assessment
        const isScheduledInspection = inspection.source === 'scheduled_inspection';
        const inspectionTypeIcon = isScheduledInspection ? 
            '<i class="fas fa-calendar-alt" style="color: #007bff; margin-right: 0.5rem;"></i>' :
            '<i class="fas fa-file-alt" style="color: #28a745; margin-right: 0.5rem;"></i>';
        const inspectionTypeLabel = isScheduledInspection ? 
            'Scheduled Barangay Inspection' : 
            'Individual Assessment Request';

        modal.innerHTML = `
            <div class="modal-content" style="
                background: white;
                margin: 3% auto;
                padding: 0;
                width: 90%;
                max-width: 800px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                max-height: 85vh;
                overflow-y: auto;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            ">
                <!-- Header -->
                <div style="
                    padding: 1.5rem 2rem;
                    border-bottom: 2px solid #f1f3f4;
                    background: #fafbfc;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="margin: 0; color: #1a1a1a; font-size: 1.5rem; font-weight: 600;">
                                ${inspectionTypeIcon}${inspectionTypeLabel}
                            </h2>
                            <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">
                                Reference ID: <strong>#${inspection.id}</strong> | ${statusBadge}
                            </p>
                        </div>
                        <button class="close-btn" style="
                            background: none;
                            border: 1px solid #ddd;
                            color: #666;
                            width: 32px;
                            height: 32px;
                            border-radius: 4px;
                            font-size: 1.2rem;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='none'">&times;</button>
                    </div>
                </div>

                <!-- Content -->
                <div style="padding: 0;">
                    
                    ${isScheduledInspection ? `
                        <!-- Scheduled Inspection Information -->
                        <div style="padding: 1.5rem 2rem; border-bottom: 1px solid #f1f3f4;">
                            <h3 style="margin: 0 0 1rem 0; color: #333; font-size: 1.1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-left: 3px solid #007bff; padding-left: 0.75rem;">
                                Scheduled Inspection Details
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Barangay</label>
                                    <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.property_address}</p>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Inspection Date</label>
                                    <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${date}</p>
                                </div>
                                ${inspection.request_count ? `
                                    <div>
                                        <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Assessment Requests</label>
                                        <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.request_count} requests processed</p>
                                    </div>
                                ` : ''}
                                <div>
                                    <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Inspection Type</label>
                                    <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.assessment_type}</p>
                                </div>
                            </div>
                            ${inspection.notes ? `
                                <div style="margin-top: 1rem;">
                                    <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Inspection Notes</label>
                                    <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500; line-height: 1.5; background: #f8f9fa; padding: 0.75rem; border-radius: 4px; border-left: 3px solid #6c757d;">${inspection.notes}</p>
                                </div>
                            ` : ''}
                        </div>

                        ${inspection.clients && inspection.clients.length > 0 ? `
                            <!-- DEBUG: About to render clients section -->
                            <!-- Client count: ${inspection.clients.length} -->
                            <!-- Client Details Section -->
                            <div style="padding: 1.5rem 2rem; border-bottom: 1px solid #f1f3f4; background: #f8f9fa;">
                                <h3 style="margin: 0 0 1rem 0; color: #333; font-size: 1.1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-left: 3px solid #28a745; padding-left: 0.75rem;">
                                    Clients Served (${inspection.clients.length})
                                </h3>
                                <div style="max-height: 400px; overflow-y: auto; padding-right: 0.5rem;">
                                    ${inspection.clients.map(client => `
                                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                            <div style="border-bottom: 1px solid #eee; padding-bottom: 0.75rem; margin-bottom: 0.75rem;">
                                                <h4 style="margin: 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">
                                                     ${client.name}
                                                </h4>
                                                <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.85rem;">
                                                     ${client.email} |  ${client.assessment_type}
                                                </p>
                                            </div>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem;">
                                                <div>
                                                    <strong style="font-size: 0.8rem; color: #666;">Property:</strong>
                                                    <p style="margin: 0; font-size: 0.9rem; color: #333;">${client.location}</p>
                                                </div>
                                                ${client.contact_person ? `
                                                    <div>
                                                        <strong style="font-size: 0.8rem; color: #666;">Contact:</strong>
                                                        <p style="margin: 0; font-size: 0.9rem; color: #333;">${client.contact_person}</p>
                                                    </div>
                                                ` : ''}
                                                ${client.contact_number ? `
                                                    <div>
                                                        <strong style="font-size: 0.8rem; color: #666;">Phone:</strong>
                                                        <p style="margin: 0; font-size: 0.9rem; color: #333;">${client.contact_number}</p>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            ${client.purpose ? `
                                                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #eee;">
                                                    <strong style="font-size: 0.8rem; color: #666;">Purpose:</strong>
                                                    <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #333; line-height: 1.4;">${client.purpose}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : '<!-- DEBUG: No clients to display -->'}
                    ` : `
                        <!-- Individual Assessment Information -->
                        <div style="padding: 1.5rem 2rem; border-bottom: 1px solid #f1f3f4;">
                            <h3 style="margin: 0 0 1rem 0; color: #333; font-size: 1.1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-left: 3px solid #007bff; padding-left: 0.75rem;">
                                Client Information
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Full Name</label>
                                    <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.client_name}</p>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Email Address</label>
                                    <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.email}</p>
                                </div>
                                ${inspection.contact_person ? `
                                    <div>
                                        <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Contact Person</label>
                                        <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.contact_person}</p>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Contact Number</label>
                                        <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.contact_number || 'Not provided'}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Property Details -->
                        <div style="padding: 1.5rem 2rem; border-bottom: 1px solid #f1f3f4;">
                            <h3 style="margin: 0 0 1rem 0; color: #333; font-size: 1.1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-left: 3px solid #28a745; padding-left: 0.75rem;">
                                Property Information
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div style="grid-column: span 2;">
                                    <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Property Address</label>
                                    <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500; line-height: 1.4;">${inspection.property_address}</p>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Property Classification</label>
                                    <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.property_classification || 'Not specified'}</p>
                                </div>
                                ${inspection.landmark ? `
                                    <div>
                                        <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Landmark</label>
                                        <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.landmark}</p>
                                    </div>
                                ` : ''}
                                ${inspection.land_reference_arp ? `
                                    <div>
                                        <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Land Reference (ARP)</label>
                                        <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.land_reference_arp}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Assessment Details -->
                        <div style="padding: 1.5rem 2rem; border-bottom: 1px solid #f1f3f4;">
                            <h3 style="margin: 0 0 1rem 0; color: #333; font-size: 1.1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-left: 3px solid #ffc107; padding-left: 0.75rem;">
                                Assessment Information
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Assessment Type</label>
                                    <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.assessment_type}</p>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Current Status</label>
                                    <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.status.charAt(0).toUpperCase() + inspection.status.slice(1)}</p>
                                </div>
                                ${inspection.valid_id_name ? `
                                    <div>
                                        <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Valid ID Submitted</label>
                                        <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500;">${inspection.valid_id_name}</p>
                                    </div>
                                ` : ''}
                            </div>
                            ${inspection.purpose ? `
                                <div style="margin-top: 1rem;">
                                    <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.5px;">Purpose of Assessment</label>
                                    <p style="margin: 0; font-size: 1rem; color: #1a1a1a; font-weight: 500; line-height: 1.5; background: #f8f9fa; padding: 0.75rem; border-radius: 4px; border-left: 3px solid #6c757d;">${inspection.purpose}</p>
                                </div>
                            ` : ''}
                        </div>

                        ${inspection.notes && inspection.notes !== 'No notes available' ? `
                            <!-- Additional Notes -->
                            <div style="padding: 1.5rem 2rem;">
                                <h3 style="margin: 0 0 1rem 0; color: #333; font-size: 1.1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-left: 3px solid #dc3545; padding-left: 0.75rem;">
                                    Additional Notes
                                </h3>
                                <div style="background: #fff5f5; border: 1px solid #fed7d7; border-radius: 4px; padding: 1rem;">
                                    <p style="margin: 0; font-size: 1rem; color: #742a2a; line-height: 1.5; white-space: pre-wrap;">${inspection.notes}</p>
                                </div>
                            </div>
                        ` : ''}
                    `}
                </div>

                <!-- Footer -->
                <div style="
                    padding: 1rem 2rem;
                    border-top: 2px solid #f1f3f4;
                    background: #fafbfc;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <div style="font-size: 0.85rem; color: #666;">
                        <strong>Submitted:</strong> ${new Date(inspection.created_at).toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}
                    </div>
                    <button class="btn close-btn" style="
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 0.5rem 1.5rem;
                        border-radius: 4px;
                        font-size: 0.9rem;
                        font-weight: 500;
                        cursor: pointer;
                        transition: background-color 0.2s ease;
                    " onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                        Close
                    </button>
                </div>
            </div>

            <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
            </style>
        `;

        document.body.appendChild(modal);

        // Close modal functionality
        modal.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                modal.remove();
            });
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    showError(message) {
        const tableBody = document.getElementById('inspection-history-table-body');
        tableBody.innerHTML = `
            <tr>
                <td colspan="7" style="padding: 2rem; text-align: center; color: #d32f2f;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                    <br>${message}
                </td>
            </tr>
        `;
    }
}

// Initialize inspection history manager
let inspectionHistoryManager;

// Add to StaffApp class by extending the existing object
if (typeof staffApp !== 'undefined') {
    staffApp.loadInspectionHistory = function() {
        if (!inspectionHistoryManager) {
            inspectionHistoryManager = new InspectionHistoryManager();
        }
        inspectionHistoryManager.loadInspectionHistory();
    };
} else {
    // Initialize when staffApp is created
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            if (typeof staffApp !== 'undefined') {
                staffApp.loadInspectionHistory = function() {
                    if (!inspectionHistoryManager) {
                        inspectionHistoryManager = new InspectionHistoryManager();
                    }
                    inspectionHistoryManager.loadInspectionHistory();
                };
            }
        }, 1000);
    });
}

   </script>
</body>
</html>