<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssessPro - Head Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Head Dashboard Styles */

/* Variable Definitions */
:root {
    --primary-green: #2d8659;
    --primary-color: #2d8659;  /* Added for consistency */
    --accent-green: #4ade80;
    --light-green: #f0f9f4;
    --dark-green: #1e5a3a;
    --text-dark: #1f2937;
    --text-primary: #1f2937;  /* Added for consistency */
    --text-light: #6b7280;
    --text-muted: #9ca3af;
    --white: #ffffff;
    --border-light: #e5e7eb;
    --border-medium: #d1d5db;
    --sidebar-width: 280px;
    --header-height: 70px;
    --bg-light: #f8fafc;
    --bg-lighter: #fafbfc;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    --card-bg: #ffffff;
    --card-border-radius: 12px;
    --gradient-primary: linear-gradient(135deg, #2d8659 0%, #34a169 100%);
    --gradient-light: linear-gradient(135deg, #f0f9f4 0%, #e6f7e1 100%);
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --info-color: #3b82f6;
    --error-color: #ef4444;
}

/* Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg-light);
    color: var(--text-dark);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    /* Prevent text size adjustment on mobile */
    -webkit-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%;
}

/* Layout */
.head-layout {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    width: 280px;
    background: #ffffff; /* Match admin/staff: white sidebar */
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    position: fixed;
    height: 100vh;
    left: 0;
    top: 0;
    z-index: 1000;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
}

.sidebar-header {
    background: #2d8659;
    padding: 3rem 0 2rem 0;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 140px;
}

.sidebar-logo {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.sidebar-logo img {
    width: 130px;
    height: 130px;
    object-fit: cover;
    border-radius: 50%;
    border: none;
    background: transparent;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.sidebar-nav {
    padding: 1rem 0;
}

.nav-section {
    margin-bottom: 2rem;
}

.nav-section-title {
    padding: 0 1.5rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #6b7280;
}

.nav-item {
    margin-bottom: 0.25rem;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 0.875rem 1.5rem;
    color: #1f2937;
    text-decoration: none;
    transition: all 0.2s ease;
    position: relative;
    min-height: 48px; /* Touch-friendly minimum height */
    -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
}

.nav-link:hover {
    background: #f0f9f4;
    color: #2d8659;
}

.nav-link.active {
    background: #f0f9f4;
    color: #2d8659;
    border-right: 3px solid #2d8659;
}

.nav-link i {
    width: 20px;
    margin-right: 0.875rem;
    font-size: 1.125rem;
}

/* Main Content */
.main-content {
    flex-grow: 1;
    margin-left: var(--sidebar-width);
    transition: margin-left 0.3s ease-in-out;
}

/* Header */
.header {
    background: #fff;
    height: 70px;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 2rem;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sidebar-toggle {
    display: none;
    background: none;
    border: none;
    font-size: 1.25rem;
    color: #1f2937;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.2s ease;
    min-height: 44px; /* Touch-friendly minimum size */
    min-width: 44px;
    align-items: center;
    justify-content: center;
}

.sidebar-toggle:hover,
.sidebar-toggle:focus {
    background: var(--light-green);
    outline: none;
}

.page-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.search-box {
    position: relative;
}

.search-box input {
    padding: 0.5rem 1rem 0.5rem 2.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 20px;
    width: 300px;
    background: #f8fafc;
    transition: all 0.2s ease;
}

.search-box i {
    position: absolute;
    left: 0.875rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.notification-btn {
    position: relative;
    background: none;
    border: none;
    font-size: 1.25rem;
    color: #6b7280;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.2s ease;
    min-height: 44px; /* Touch-friendly minimum size */
    min-width: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
}



.user-menu {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1rem;
    background: var(--white);
    border: 1px solid var(--border-light);
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.user-menu:hover {
    border-color: var(--border-light);
}

.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-green);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-weight: 600;
}

.user-info {
    display: flex;
    flex-direction: column;
}

.user-name {
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1;
}

.user-role {
    font-size: 0.75rem;
    color: var(--text-light);
    line-height: 1;
}

/* Content */
.content {
    padding: 2rem;
    background: var(--bg-light);
    min-height: calc(100vh - var(--header-height));
}

.content-section {
    display: none;
    animation: fadeIn 0.5s;
}

.content-section.active {
    display: block;
}

/* Welcome Banner */
.welcome-banner {
    background: var(--gradient-primary);
    border-radius: 16px;
    padding: 2.5rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: var(--white);
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
}

.welcome-banner::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
    pointer-events: none;
}

.welcome-content {
    flex: 1;
    z-index: 1;
}

.welcome-title {
    font-size: 2.25rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    line-height: 1.2;
}

.welcome-subtitle {
    font-size: 1.125rem;
    opacity: 0.9;
    margin-bottom: 1rem;
    font-weight: 400;
}

.welcome-date {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
    opacity: 0.8;
}

.welcome-graphic {
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
}

.dashboard-icon {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    backdrop-filter: blur(10px);
}

/* Section Headers */
.metrics-section,
.quick-actions-section {
    margin-bottom: 2rem;
}

.section-header {
    margin-bottom: 1.5rem;
}

.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
}

.section-subtitle {
    font-size: 0.95rem;
    color: var(--text-light);
}

/* Cards */
.card {
    background: var(--card-bg);
    border-radius: var(--card-border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    margin-bottom: 1.5rem;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-light);
    padding-bottom: 1rem;
}

.card-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary-green);
}

/* Enhanced Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--card-bg);
    border-radius: var(--card-border-radius);
    padding: 1.75rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-light);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: var(--primary-green);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-green);
}

.stat-card.primary::before { background: var(--primary-green); }
.stat-card.success::before { background: var(--success-color); }
.stat-card.warning::before { background: var(--warning-color); }
.stat-card.info::before { background: var(--info-color); }

.stat-card {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.stat-card.primary .stat-icon {
    background: rgba(45, 134, 89, 0.1);
    color: var(--primary-green);
}

.stat-card.success .stat-icon {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-color);
}

.stat-card.warning .stat-icon {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
}

.stat-card.info .stat-icon {
    background: rgba(59, 130, 246, 0.1);
    color: var(--info-color);
}

.stat-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.stat-card .value {
    font-size: 2.25rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
    line-height: 1;
}

.stat-card .label {
    font-size: 0.95rem;
    color: var(--text-light);
    font-weight: 500;
    margin-bottom: 0.75rem;
}

.trend {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8rem;
    font-weight: 500;
}

.trend.positive {
    color: var(--success-color);
}

.trend.negative {
    color: var(--error-color);
}

.trend.neutral {
    color: var(--text-muted);
}

.trend i {
    font-size: 0.7rem;
}

/* Enhanced Charts Grid */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.chart-card {
    background: var(--card-bg);
    border-radius: var(--card-border-radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border-light);
    overflow: hidden;
    transition: all 0.3s ease;
}

.chart-card:hover {
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-green);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1.5rem 1.5rem 1rem;
    border-bottom: 1px solid var(--border-light);
    background: var(--bg-lighter);
}

.chart-title-section {
    flex: 1;
}

.chart-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
}

.chart-subtitle {
    font-size: 0.875rem;
    color: var(--text-light);
}

.chart-actions {
    display: flex;
    gap: 0.5rem;
}

.chart-action-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--bg-light);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text-light);
    transition: all 0.2s ease;
    position: relative;
}

.chart-action-btn:hover {
    background: var(--primary-green);
    color: var(--white);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(45, 134, 89, 0.3);
}

.chart-action-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 4px rgba(45, 134, 89, 0.2);
}

.chart-action-btn.downloading {
    background: var(--warning-color);
    color: var(--white);
    pointer-events: none;
}

.chart-action-btn.downloading::after {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    border: 2px solid transparent;
    border-top: 2px solid var(--white);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.chart-action-btn.success {
    background: var(--success-color);
    color: var(--white);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.chart-content {
    padding: 1.5rem;
    min-height: 250px;
}

.chart-content canvas {
    max-width: 100%;
    height: auto;
}

/* Chart Interpretation Styles */
.chart-interpretation {
    padding: 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-top: 1px solid #e2e8f0;
    margin-top: 0.5rem;
    border-radius: 0 0 12px 12px;
}

.interpretation-content {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.interpretation-icon {
    color: var(--primary-green);
    font-size: 1.1rem;
    margin-top: 0.1rem;
    flex-shrink: 0;
}

.interpretation-text {
    color: #374151;
    font-size: 0.9rem;
    line-height: 1.5;
    margin: 0;
    font-weight: 500;
}

.interpretation-text.positive {
    color: #065f46;
}

.interpretation-text.warning {
    color: #92400e;
}

.interpretation-text.negative {
    color: #991b1b;
}

/* Quick Actions */
.quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.action-card {
    background: var(--card-bg);
    border-radius: var(--card-border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.action-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-green);
}

.action-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: var(--gradient-light);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-green);
    font-size: 1.25rem;
    flex-shrink: 0;
}

.action-content {
    flex: 1;
}

.action-content h4 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
}

.action-content p {
    font-size: 0.875rem;
    color: var(--text-light);
    line-height: 1.4;
}

.action-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--primary-green);
    color: var(--white);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.action-btn:hover {
    background: var(--dark-green);
    transform: scale(1.05);
}

/* Professional Announcements Styling */
.announcements-header {
    margin-bottom: 2rem;
}

.page-header {
    background: var(--card-bg);
    border-radius: var(--card-border-radius);
    padding: 2rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-light);
    text-align: center;
}

.page-main-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
}

.page-description {
    font-size: 1.125rem;
    color: var(--text-light);
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
}

/* Announcement Composer */
.announcement-composer-card {
    background: var(--card-bg);
    border-radius: var(--card-border-radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border-light);
    margin-bottom: 2rem;
    overflow: hidden;
}

.composer-header {
    background: var(--bg-lighter);
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.composer-title-section {
    flex: 1;
}

.composer-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.composer-title i {
    color: var(--primary-green);
}

.composer-subtitle {
    font-size: 0.875rem;
    color: var(--text-light);
}

.composer-status {
    display: flex;
    align-items: center;
}

.status-badge {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-badge.active {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-color);
}

.status-badge.active i {
    animation: pulse 2s infinite;
}

/* Professional Form Styling */
.professional-form {
    padding: 2rem;
}

.form-row {
    margin-bottom: 1.5rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-label i {
    color: var(--primary-green);
    font-size: 0.9rem;
}

.form-input,
.form-textarea {
    padding: 0.875rem 1rem;
    border: 2px solid var(--border-light);
    border-radius: 8px;
    font-family: 'Poppins', sans-serif;
    font-size: 0.95rem;
    color: var(--text-dark);
    background: var(--white);
    transition: all 0.2s ease;
}

.form-input:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(45, 134, 89, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 120px;
}

.form-help {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    font-size: 0.8rem;
}

.character-count {
    color: var(--text-muted);
}

.form-tip {
    color: var(--text-light);
    font-style: italic;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding-top: 1rem;
    border-top: 1px solid var(--border-light);
}

.btn-secondary {
    background: var(--bg-light);
    color: var(--text-dark);
    border: 1px solid var(--border-medium);
    padding: 0.875rem 1.5rem;
    font-weight: 500;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-secondary:hover {
    background: var(--border-light);
    border-color: var(--text-light);
}

.btn-primary {
    background: var(--gradient-primary);
    color: var(--white);
    border: none;
    padding: 0.875rem 1.5rem;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    position: relative;
    overflow: hidden;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-lg);
}

.btn-primary.enhanced {
    position: relative;
    overflow: hidden;
}

.btn-shine {
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn-primary.enhanced:hover .btn-shine {
    left: 100%;
}

/* Announcements History */
.announcements-history-card {
    background: var(--card-bg);
    border-radius: var(--card-border-radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border-light);
    overflow: hidden;
}

.history-header {
    background: linear-gradient(135deg, var(--bg-lighter) 0%, var(--white) 100%);
    padding: 2rem 1.5rem 1.5rem;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    position: relative;
}

.history-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-primary);
}

.history-title-section {
    flex: 1;
}

.history-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.history-title i {
    color: var(--primary-green);
}

.history-subtitle {
    font-size: 0.875rem;
    color: var(--text-light);
}

.history-actions {
    display: flex;
    gap: 0.75rem;
}

.filter-btn,
.export-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-medium);
    background: var(--white);
    color: var(--text-dark);
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.filter-btn:hover,
.export-btn:hover {
    border-color: var(--primary-green);
    color: var(--primary-green);
}

/* Enhanced Announcements Timeline */
.announcements-timeline {
    padding: 2rem;
    min-height: 200px;
}

.announcement-item {
    background: var(--white);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    position: relative;
    border-left: 4px solid var(--primary-green);
}

.announcement-item:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-1px);
}

.announcement-item h4 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.announcement-item p {
    font-size: 0.95rem;
    color: var(--text-dark);
    line-height: 1.6;
    margin-bottom: 1rem;
}

.announcement-item small {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-muted);
    font-size: 0.8rem;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-light);
}

/* Enhanced Form Styling */
.form-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.form-group.flex-1 {
    flex: 1;
}

.form-group.flex-2 {
    flex: 2;
}

.form-select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    color: var(--text-dark);
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.form-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(45, 134, 89, 0.1);
}

.form-textarea.enhanced {
    min-height: 200px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    resize: vertical;
}

.form-help {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
}

.help-left {
    display: flex;
    gap: 1rem;
}

.character-count, .word-count {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.character-count.warning {
    color: #f59e0b;
}

.character-count.danger {
    color: #ef4444;
}

/* Advanced Options */
.advanced-options {
    background: #f8f9fa;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.checkbox-group {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
}

.checkbox-item {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-dark);
}

.checkbox-item input[type="checkbox"] {
    display: none;
}

.checkmark {
    width: 18px;
    height: 18px;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    margin-right: 0.75rem;
    position: relative;
    transition: all 0.2s ease;
}

.checkbox-item input:checked + .checkmark {
    background: var(--primary-color);
    border-color: var(--primary-color);
}

.checkbox-item input:checked + .checkmark:after {
    content: "âœ“";
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
}

/* Enhanced Button Styling */
.btn-ghost {
    background: transparent;
    color: var(--text-muted);
    border: 1px solid #e5e7eb;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-ghost:hover {
    background: #f9fafb;
    border-color: #d1d5db;
    color: var(--text-dark);
}

.btn-ghost.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

/* History Controls */
.history-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 1rem 1.5rem;
    background: var(--white);
    border-bottom: 1px solid var(--border-light);
}

.search-box {
    position: relative;
    flex: 1;
    max-width: 320px;
}

.search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 0.9rem;
    z-index: 1;
}

.search-input {
    width: 100%;
    padding: 0.625rem 1rem 0.625rem 2.75rem;
    border: 1px solid var(--border-light);
    border-radius: 8px;
    font-size: 0.9rem;
    background: var(--white);
    transition: all 0.2s ease;
    color: var(--text-dark);
}

.search-input:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(45, 134, 89, 0.1);
}

.search-input::placeholder {
    color: var(--text-muted);
}

.filter-controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-left: auto;
}

.filter-select {
    padding: 0.625rem 0.875rem;
    border: 1px solid var(--border-light);
    border-radius: 8px;
    font-size: 0.9rem;
    background: var(--white);
    color: var(--text-dark);
    min-width: 140px;
    transition: all 0.2s ease;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(45, 134, 89, 0.1);
}

.history-actions {
    display: flex;
    gap: 0.75rem;
}

.action-btn {
    width: 42px;
    height: 42px;
    border: 1px solid var(--border-light);
    border-radius: 8px;
    background: var(--white);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.action-btn:hover {
    background: var(--bg-lighter);
    color: var(--primary-green);
    border-color: var(--primary-green);
    transform: translateY(-1px);
}

/* Announcement Stats */
.announcement-stats {
    display: flex;
    gap: 2rem;
    padding: 1.5rem;
    background: var(--bg-lighter);
    border-bottom: 1px solid var(--border-light);
    justify-content: center;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.stat-item.urgent .stat-value {
    color: #ef4444;
}

.stat-label {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-dark);
}

/* Priority Badges */
.priority-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.priority-badge.normal {
    background: #e5e7eb;
    color: #4b5563;
}

.priority-badge.high {
    background: #fef3c7;
    color: #d97706;
}

.priority-badge.urgent {
    background: #fee2e2;
    color: #dc2626;
}

.category-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 500;
    background: #f3f4f6;
    color: #6b7280;
    margin-left: 0.5rem;
}

/* Enhanced Announcement Item Styling */
.announcement-item {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.2s ease;
    position: relative;
}

.announcement-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: #d1d5db;
}

.announcement-header {
    margin-bottom: 1rem;
}

.announcement-title-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
}

.announcement-item h4 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-dark);
    line-height: 1.4;
    flex: 1;
}

.announcement-badges {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-shrink: 0;
}

.announcement-content {
    margin-bottom: 1rem;
}

.announcement-message {
    font-size: 0.95rem;
    line-height: 1.6;
    color: var(--text-dark);
    word-wrap: break-word;
}

.announcement-message strong {
    font-weight: 600;
    color: #1f2937;
}

.announcement-message em {
    font-style: italic;
    color: #4b5563;
}

.announcement-expiry {
    margin-top: 0.75rem;
    padding: 0.5rem;
    background: #fef3c7;
    border-left: 3px solid #f59e0b;
    border-radius: 4px;
    font-size: 0.85rem;
    color: #92400e;
}

.announcement-expiry i {
    margin-right: 0.5rem;
}

.announcement-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #f3f4f6;
}

.announcement-footer small {
    color: var(--text-muted);
    font-size: 0.8rem;
}

.announcement-footer small i {
    margin-right: 0.25rem;
    color: #9ca3af;
}

.announcement-actions {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.announcement-item:hover .announcement-actions {
    opacity: 1;
}

.announcement-actions .action-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: white;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
}

.announcement-actions .action-btn:hover {
    background: #f9fafb;
    color: var(--text-dark);
    border-color: #d1d5db;
}

/* Modal Styling */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    position: relative;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.close {
    position: absolute;
    right: 1rem;
    top: 1rem;
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.close:hover {
    color: #000;
    background: #f3f4f6;
}

/* Responsive Design */
@media (max-width: 768px) {
    .form-row {
        flex-direction: column;
        gap: 0;
    }
    
    .form-group.flex-1,
    .form-group.flex-2 {
        flex: 1;
    }
    
    .history-controls {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
    }
    
    .search-box {
        max-width: 100%;
    }
    
    .filter-controls {
        margin-left: 0;
        justify-content: stretch;
        width: 100%;
    }
    
    .filter-select {
        flex: 1;
        min-width: 0;
    }
    
    .filter-controls {
        width: 100%;
        justify-content: space-between;
    }
    
    .announcement-stats {
        gap: 1rem;
        padding: 1rem;
        flex-wrap: wrap;
        justify-content: space-around;
    }
    
    .stat-item {
        min-width: 80px;
    }
    
    .announcement-title-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    
    .checkbox-group {
        flex-direction: column;
        gap: 1rem;
    }
}

.empty-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--bg-light);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 1.5rem;
    color: var(--text-muted);
}

.empty-state h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
}

.empty-state p {
    font-size: 0.95rem;
    color: var(--text-light);
    max-width: 400px;
    margin: 0 auto;
    line-height: 1.5;
}

/* Overlay and Toast */
.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.4);
    z-index: 900;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                visibility 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    -webkit-tap-highlight-color: transparent;
}

.sidebar-overlay.active {
    opacity: 1;
    visibility: visible;
}

#toast-container {
    position: fixed;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2000;
    display: flex;
    flex-direction: column-reverse;
    gap: 0.75rem;
}

.toast {
    background-color: var(--primary-green);
    color: var(--white);
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 250px;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}

.toast .icon {
    font-size: 1.5rem;
    color: var(--accent-green);
}

.toast .message {
    font-size: 1rem;
    font-weight: 500;
}


/* Animations */
@keyframes fadeIn {
    from { 
        opacity: 0; 
        transform: translateY(10px);
    }
    to { 
        opacity: 1; 
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes float {
    0%, 100% {
        transform: translateY(0px);
    }
    50% {
        transform: translateY(-5px);
    }
}

.dashboard-icon {
    animation: float 3s ease-in-out infinite;
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.2s; }
.stat-card:nth-child(3) { animation-delay: 0.3s; }
.stat-card:nth-child(4) { animation-delay: 0.4s; }

.chart-card:nth-child(1) { animation-delay: 0.5s; }
.chart-card:nth-child(2) { animation-delay: 0.6s; }

.action-card:nth-child(1) { animation-delay: 0.7s; }
.action-card:nth-child(2) { animation-delay: 0.8s; }
.action-card:nth-child(3) { animation-delay: 0.9s; }

/* Mobile Responsive */
@media (max-width: 1024px) {
    .head-layout {
        flex-direction: column;
    }
    .sidebar {
        width: 100%;
        height: auto;
        position: relative;
    }
    .main-content {
        margin-left: 0;
    }
}

@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        width: 280px;
        position: fixed;
        height: 100vh;
        z-index: 1001;
    }
    .sidebar.mobile-open {
        transform: translateX(0);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    }
    .main-content {
        margin-left: 0;
    }
    .sidebar-toggle {
        display: flex;
    }
    .search-box input {
        width: 200px;
    }
    .header {
        padding: 0 1rem;
    }
    .user-info {
        display: flex;
        flex-direction: column;
    }
    .user-name {
        font-size: 0.75rem;
    }
    .user-role {
        font-size: 0.7rem;
        color: var(--text-light);
    }
    .user-avatar {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        justify-items: center;
        align-items: center;
    }
    
    .stat-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        width: 100%;
        max-width: 250px;
    }
    
    .stat-icon {
        align-self: center;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
    }
    
    .stat-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 100%;
    }
    
    .stat-card .value,
    .stat-card .label,
    .trend {
        text-align: center;
        width: 100%;
    }
    
    .trend {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.25rem;
        flex-wrap: wrap;
    }
    .content {
        padding: 1rem;
    }
    .card, .announcement-composer-card, .announcements-history-card {
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .page-title {
        font-size: 1.25rem;
    }
    
    /* Mobile optimizations for new elements */
    .welcome-banner {
        flex-direction: column;
        text-align: center;
        padding: 2rem 1.5rem;
    }
    
    .welcome-title {
        font-size: 1.75rem;
    }
    
    .welcome-graphic {
        margin-top: 1rem;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .quick-actions-grid {
        grid-template-columns: 1fr;
    }
    
    .composer-header,
    .history-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .composer-status,
    .history-actions {
        justify-content: center;
    }
    
    .form-actions {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .form-actions .btn-primary,
    .form-actions .btn-secondary {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .header {
        padding: 0 0.5rem;
    }
    .search-box {
        display: none;
    }
    .header-actions {
        gap: 0.5rem;
    }
    .user-menu {
        padding: 0.25rem 0.5rem;
    }
    .user-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.75rem;
    }
    .user-info .user-role {
        font-size: 0.65rem;
    }
    .content {
        padding: 0.5rem;
    }
    .card, .announcement-composer-card, .announcements-history-card {
        padding: 0.75rem;
    }
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        justify-items: center;
        align-items: center;
    }
    .stat-card {
        padding: 1rem;
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 200px;
    }
    .stat-icon {
        align-self: center;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .stat-content {
        align-items: center;
        display: flex;
        flex-direction: column;
        text-align: center;
        width: 100%;
    }
    .stat-card .value {
        font-size: 1.5rem;
        text-align: center;
        width: 100%;
    }
    .stat-card .label {
        font-size: 0.8rem;
        text-align: center;
        width: 100%;
    }
    .trend {
        font-size: 0.7rem;
        justify-content: center;
        text-align: center;
        width: 100%;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    .chart-content {
        padding: 1rem;
        min-height: 250px;
    }
    .form-input,
    .form-textarea {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 1rem;
    }
    .btn-primary, .btn-secondary {
        padding: 1rem 1.5rem;
        font-size: 0.95rem;
    }
    .sidebar-toggle {
        padding: 0.75rem;
        font-size: 1.1rem;
    }
    .notification-btn {
        padding: 0.75rem;
        font-size: 1.1rem;
    }
    
    /* Very small screen optimizations */
    .welcome-banner {
        padding: 1.5rem 1rem;
    }
    
    .welcome-title {
        font-size: 1.5rem;
    }
    
    .page-main-title {
        font-size: 1.5rem;
    }
    
    .section-title {
        font-size: 1.25rem;
    }
    
    .dashboard-icon {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
    }
    
    .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
    
    .action-card {
        padding: 1rem;
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
    }
    
    .action-btn {
        align-self: center;
    }
    
    .professional-form {
        padding: 1rem;
    }
    
    .announcements-timeline {
        padding: 1rem;
    }
    
    .empty-state {
        padding: 2rem 1rem;
    }
    
    .empty-icon {
        width: 48px;
        height: 48px;
        font-size: 1.25rem;
    }
}

/* Analytics Dashboard Styles */
.date-filter {
    margin-left: auto;
}

.date-filter select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    background: var(--white);
    color: var(--text-dark);
    font-size: 0.875rem;
    cursor: pointer;
}

.date-filter select:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(45, 134, 89, 0.1);
}

/* Insights Section */
.insights-section {
    margin-top: 2rem;
}

.insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.insight-card {
    background: var(--card-bg);
    border-radius: var(--card-border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-light);
    transition: all 0.3s ease;
}

.insight-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.insight-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-light);
}

.insight-header i {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 1rem;
}

.insight-card.trends .insight-header i {
    background: rgba(59, 130, 246, 0.1);
    color: var(--info-color);
}

.insight-card.peak-periods .insight-header i {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
}

.insight-card.recommendations .insight-header i {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-color);
}

.insight-card.performance .insight-header i {
    background: rgba(139, 92, 246, 0.1);
    color: #8b5cf6;
}

.insight-header h3 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-dark);
}

.insight-content {
    color: var(--text-light);
    font-size: 0.875rem;
    line-height: 1.6;
}

.loading {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-muted);
    font-style: italic;
}

.insight-item {
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    background: var(--bg-lighter);
    border-radius: 6px;
    border-left: 3px solid var(--primary-green);
}

.insight-item:last-child {
    margin-bottom: 0;
}

.insight-item .label {
    font-weight: 600;
    color: var(--text-dark);
    display: block;
    margin-bottom: 0.25rem;
}

.insight-item .value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-green);
}

.insight-item .description {
    color: var(--text-light);
    font-size: 0.8125rem;
    margin-top: 0.25rem;
}

.recommendation-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: var(--bg-lighter);
    border-radius: 6px;
}

.recommendation-item:last-child {
    margin-bottom: 0;
}

.recommendation-item .icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-green);
    color: var(--white);
    border-radius: 50%;
    font-size: 0.75rem;
    flex-shrink: 0;
    margin-top: 0.125rem;
}

.recommendation-item .content {
    flex: 1;
}

.recommendation-item .title {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
}

.recommendation-item .description {
    color: var(--text-light);
    font-size: 0.8125rem;
}

.priority-high {
    border-left-color: var(--error-color);
}

.priority-medium {
    border-left-color: var(--warning-color);
}

.priority-low {
    border-left-color: var(--info-color);
}

/* Chart Loading State */
.chart-content .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: var(--text-muted);
}

/* Medium screens - tablet layout */
@media (max-width: 1024px) {
    .charts-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .chart-content {
        padding: 1rem;
        min-height: 220px;
    }
}

/* Enhanced Mobile Responsiveness for Analytics */
@media (max-width: 768px) {
    .insights-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .insight-card {
        padding: 1rem;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .date-filter {
        margin-left: 0;
        margin-top: 1rem;
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
}

/* Metric Cards Enhancements */
.metric-value {
    font-size: 2.25rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
    line-height: 1;
}

.metric-trend {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8rem;
    font-weight: 500;
}

.metric-trend.trend-up {
    color: var(--success-color);
}

.metric-trend.trend-down {
    color: var(--error-color);
}

.metric-trend.trend-neutral {
    color: var(--text-muted);
}

.metric-subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.metric-trend i {
    font-size: 0.7rem;
}

/* Recommendations Styling */
.recommendations-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.recommendation-item {
    padding: 1rem;
    border-radius: 0.5rem;
    border-left: 4px solid var(--primary-color);
    background: #f8fafc;
}

.recommendation-item.priority-high {
    border-left-color: #ef4444;
    background: #fef2f2;
}

.recommendation-item.priority-medium {
    border-left-color: #f59e0b;
    background: #fffbeb;
}

.recommendation-item.priority-low {
    border-left-color: #10b981;
    background: #f0fdf4;
}

.recommendation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.recommendation-title {
    font-weight: 600;
    color: var(--text-color);
    flex-grow: 1;
}

.recommendation-priority {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 1rem;
    font-weight: 600;
    text-transform: uppercase;
}

.recommendation-priority.high {
    background: #fee2e2;
    color: #dc2626;
}

.recommendation-priority.medium {
    background: #fef3c7;
    color: #d97706;
}

.recommendation-priority.low {
    background: #dcfce7;
    color: #16a34a;
}

.recommendation-description {
    font-size: 0.9rem;
    color: var(--text-muted);
    line-height: 1.4;
    margin: 0;
}

.no-recommendations {
    text-align: center;
    color: var(--text-muted);
    font-style: italic;
    margin: 0;
}

/* Refresh Button */
.date-filter {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.refresh-analytics {
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 0.5rem;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.refresh-analytics:hover {
    background: #2563eb;
    transform: scale(1.05);
}

.refresh-analytics i {
    font-size: 0.9rem;
}

/* Loading States */
.analytics-loading {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.9);
    padding: 2rem;
    border-radius: 0.75rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    display: none;
}

.analytics-loading i {
    font-size: 2rem;
    color: var(--primary-color);
    margin-bottom: 1rem;
}

/* DSS Analytics Enhancements */
.insight-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
}

.insight-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-1px);
}

.insight-item:last-child {
    margin-bottom: 0;
}

.insight-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    flex-shrink: 0;
    font-size: 0.875rem;
}

.insight-icon.positive {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
}

.insight-icon.warning {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
}

.insight-icon.negative {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.insight-icon.neutral {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
}

.insight-text {
    flex: 1;
    min-width: 0;
}

.insight-label {
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 0.25rem 0;
    font-size: 0.875rem;
}

.insight-description {
    color: var(--text-muted);
    margin: 0;
    font-size: 0.8rem;
    line-height: 1.4;
}

.insight-metric {
    color: var(--primary-color);
    font-weight: 500;
    font-size: 0.75rem;
    margin: 0.25rem 0 0 0;
}

/* Recommendation Items */
.recommendation-item {
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
}

.recommendation-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.recommendation-item.priority-high {
    border-left: 4px solid #ef4444;
    background: rgba(239, 68, 68, 0.03);
}

.recommendation-item.priority-medium {
    border-left: 4px solid #f59e0b;
    background: rgba(245, 158, 11, 0.03);
}

.recommendation-item.priority-low {
    border-left: 4px solid #22c55e;
    background: rgba(34, 197, 94, 0.03);
}

.recommendation-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.recommendation-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    background: rgba(59, 130, 246, 0.1);
    color: var(--primary-color);
    flex-shrink: 0;
}

.recommendation-meta {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.recommendation-title {
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    font-size: 0.9rem;
}

.recommendation-priority {
    padding: 0.25rem 0.5rem;
    border-radius: 1rem;
    font-weight: 600;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.recommendation-priority.high {
    background: #fee2e2;
    color: #dc2626;
}

.recommendation-priority.medium {
    background: #fef3c7;
    color: #d97706;
}

.recommendation-priority.low {
    background: #dcfce7;
    color: #16a34a;
}

.recommendation-description {
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.5;
    margin: 0;
}

/* Performance Grade Styling */
.insight-item .insight-icon.positive {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.insight-item .insight-icon.warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.insight-item .insight-icon.negative {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

/* Loading States for DSS */
.insight-content .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    color: var(--text-muted);
}

.insight-content .loading i {
    margin-right: 0.5rem;
    animation: pulse 1.5s ease-in-out infinite alternate;
}


    </style>
</head>
<body>
    <div class="head-layout">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header" style="background: #2d8659; padding: 3rem 0 2rem 0; display: flex; align-items: center; justify-content: center; min-height: 140px;">
                <div class="sidebar-logo" style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <img src="../images/logo.png" alt="Logo" style="width: 130px; height: 130px; object-fit: cover; border-radius: 50%; border: none; background: transparent; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <div class="nav-item">
                        <a href="#" class="nav-link active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Administration</div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-section="announcements">
                            <i class="fas fa-bullhorn"></i>
                            <span>Announcements</span>
                        </a>
                    </div>
                </div>
                <div class="nav-section logout-section" style="margin-top:auto;">
                    <div class="nav-item">
                        <a href="#" class="nav-link" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </nav>
        </aside>
        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <header class="header"> 
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">AssessPro</h1>
                </div>
                <div class="header-right">
                    <div class="header-actions">
                        <div class="user-menu">
                            <div class="user-avatar">H</div>
                            <div class="user-info">
                                <div class="user-name"></div>
                                <div class="user-role">Assessor</div>
                            </div>
                        </div>
                    </div>  
                </div>  
            </header>

            <div class="content">
                <!-- Dashboard Section (Default) -->
                <section class="content-section active" id="dashboard">
                    <!-- Welcome Banner -->
                    <div class="welcome-banner">
                        <div class="welcome-content">
                            <h1 class="welcome-title">Welcome back, Department Head</h1>
                            <p class="welcome-subtitle">Here's what's happening with your assessment system today</p>
                            <div class="welcome-date">
                                <i class="fas fa-calendar-alt"></i>
                                <span id="currentDate"></span>
                            </div>
                        </div>
                        <div class="welcome-graphic">
                            <div class="dashboard-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Key Metrics Overview -->
                    <div class="metrics-section">
                        <div class="section-header">
                            <h2 class="section-title">Assessment Analytics Dashboard</h2>
                            <div class="section-subtitle">Real-time inspection metrics and insights</div>
                            <div class="date-filter">
                                <select id="periodSelect">
                                    <option value="week">Last Week</option>
                                    <option value="month" selected>Last Month</option>
                                    <option value="year">Last Year</option>
                                </select>
                                <button class="refresh-analytics" title="Refresh Analytics">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <div id="lastUpdated" style="font-size: 0.75rem; color: var(--text-muted); margin-left: 1rem;">
                                    <i class="fas fa-clock"></i> Loading...
                                </div>
                            </div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card primary" data-metric="total-requests">
                                <div class="stat-icon">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="value metric-value" id="totalInspections">0</span>
                                    <span class="label">Total Requests</span>
                                    <span class="trend metric-trend" id="totalTrend">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span>Loading...</span>
                                    </span>
                                </div>
                            </div>
                            <div class="stat-card warning" data-metric="pending-requests">
                                <div class="stat-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="value metric-value" id="pendingInspections">0</span>
                                    <span class="label">Scheduled Inspections</span>
                                    <span class="trend metric-trend" id="pendingTrend">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span>Loading...</span>
                                    </span>
                                </div>
                            </div>
                            <div class="stat-card success" data-metric="completed-requests">
                                <div class="stat-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="value metric-value" id="completedInspections">0</span>
                                    <span class="label">Completed</span>
                                    <span class="trend metric-trend" id="completedTrend">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span>Loading...</span>
                                    </span>
                                </div>
                            </div>
                            <div class="stat-card info" data-metric="top-barangay">
                                <div class="stat-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="value metric-value" id="topBarangay">--</span>
                                    <span class="label">Top Barangay</span>
                                    <span class="trend metric-subtitle" id="barangayTrend">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span>Loading...</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Charts -->
                    <div class="charts-grid">
                        <!-- Dynamic Inspection Trends -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title" id="trendsChartTitle">Inspection Trends</h3>
                                    <p class="chart-subtitle" id="trendsChartSubtitle">Inspection requests over time</p>
                                </div>
                                <div class="chart-actions">
                                    <button class="chart-action-btn" onclick="exportChart('monthlyTrends')" title="Export chart data as CSV">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="assessmentTrendsChart"></canvas>
                            </div>
                            <div class="chart-interpretation" id="monthly-trends-interpretation">
                                <div class="interpretation-content">
                                    <i class="fas fa-chart-line interpretation-icon"></i>
                                    <p class="interpretation-text">Analyzing monthly trends...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Barangay Distribution -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title">Barangay Distribution</h3>
                                    <p class="chart-subtitle">Inspection requests by barangay</p>
                                </div>
                                <div class="chart-actions">
                                    <button class="chart-action-btn" onclick="exportChart('barangayDistribution')" title="Export chart data as CSV">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="barangayChart"></canvas>
                            </div>
                            <div class="chart-interpretation" id="barangay-distribution-interpretation">
                                <div class="interpretation-content">
                                    <i class="fas fa-map-marker-alt interpretation-icon"></i>
                                    <p class="interpretation-text">Analyzing barangay distribution...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Property Classification (Only Land Property Inspections) -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title">Land Property Classification</h3>
                                    <p class="chart-subtitle">Property types for land property assessments only</p>
                                </div>
                                <div class="chart-actions">
                                    <button class="chart-action-btn" onclick="exportChart('propertyClassification')" title="Export chart data as CSV">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="propertyChart"></canvas>
                            </div>
                            <div class="chart-interpretation" id="property-classification-interpretation">
                                <div class="interpretation-content">
                                    <i class="fas fa-building interpretation-icon"></i>
                                    <p class="interpretation-text">Analyzing property classification...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Inspection Type Distribution -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title">Inspection Type Distribution</h3>
                                    <p class="chart-subtitle">Distribution by inspection category</p>
                                </div>
                                <div class="chart-actions">
                                    <button class="chart-action-btn" onclick="exportChart('inspectionTypeDistribution')" title="Export chart data as CSV">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="inspectionTypeChart"></canvas>
                            </div>
                            <div class="chart-interpretation" id="inspection-type-interpretation">
                                <div class="interpretation-content">
                                    <i class="fas fa-clipboard-check interpretation-icon"></i>
                                    <p class="interpretation-text">Analyzing inspection types...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Inspection Status -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title">Inspection Status Overview</h3>
                                    <p class="chart-subtitle">Current status distribution</p>
                                </div>
                                <div class="chart-actions">
                                    <button class="chart-action-btn" onclick="exportChart('statusOverview')" title="Export chart data as CSV">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="completionStatusChart"></canvas>
                            </div>
                            <div class="chart-interpretation" id="completion-status-interpretation">
                                <div class="interpretation-content">
                                    <i class="fas fa-tasks interpretation-icon"></i>
                                    <p class="interpretation-text">Analyzing inspection status...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Insights -->
                    <div class="insights-section">
                        <div class="section-header">
                            <h2 class="section-title">Analytics Insights & Recommendations</h2>
                            <div class="section-subtitle">Data-driven insights to optimize inspection processes</div>
                        </div>
                        <div class="insights-grid">
                            <div class="insight-card trends">
                                <div class="insight-header">
                                    <i class="fas fa-chart-line"></i>
                                    <h3>Trend Analysis</h3>
                                </div>
                                <div class="insight-content" id="trendInsights">
                                    <p class="insight-trend">Analyzing trends...</p>
                                </div>
                            </div>
                            
                            <div class="insight-card peak-periods">
                                <div class="insight-header">
                                    <i class="fas fa-clock"></i>
                                    <h3>Peak & Low Periods</h3>
                                </div>
                                <div class="insight-content" id="periodInsights">
                                    <p class="insight-peak">Identifying peak periods...</p>
                                    <p class="insight-low">Identifying low periods...</p>
                                </div>
                            </div>
                            
                            <div class="insight-card recommendations">
                                <div class="insight-header">
                                    <i class="fas fa-lightbulb"></i>
                                    <h3>Recommendations</h3>
                                </div>
                                <div class="insight-content" id="recommendations">
                                    <div class="recommendations-list">
                                        <p class="no-recommendations">Generating recommendations...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="insight-card performance">
                                <div class="insight-header">
                                    <i class="fas fa-trophy"></i>
                                    <h3>Performance Summary</h3>
                                </div>
                                <div class="insight-content" id="performanceSummary">
                                    <p class="insight-performance">Calculating performance...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Announcements Section -->
                <section class="content-section" id="announcements">
                    <div class="announcements-header">
                        <div class="page-header">
                            <h1 class="page-main-title">System Announcements</h1>
                            <p class="page-description">Communicate important updates and information to all system users</p>
                        </div>
                    </div>

                    <div class="announcement-composer-card">
                        <div class="composer-header">
                            <div class="composer-title-section">
                                <h2 class="composer-title">
                                    <i class="fas fa-bullhorn"></i>
                                    Create New Announcement
                                </h2>
                                <p class="composer-subtitle">Broadcast important information to all users</p>
                            </div>
                            <div class="composer-status">
                                <span class="status-badge active">
                                    <i class="fas fa-circle"></i>
                                    System Active
                                </span>
                            </div>
                        </div>
                        <form id="announcementForm" class="professional-form">
                            <div class="form-row">
                                <div class="form-group flex-2">
                                    <label for="announcementSubject" class="form-label">
                                        <i class="fas fa-tag"></i>
                                        Subject Line
                                    </label>
                                    <input type="text" 
                                           id="announcementSubject" 
                                           class="form-input" 
                                           placeholder="Enter announcement subject..."
                                           maxlength="100"
                                           required>
                                </div>
                                <div class="form-group flex-1">
                                    <label for="announcementPriority" class="form-label">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Priority Level
                                    </label>
                                    <select id="announcementPriority" class="form-select" required>
                                        <option value="normal" selected>Normal</option>
                                        <option value="high">High Priority</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="announcementCategory" class="form-label">
                                        <i class="fas fa-folder"></i>
                                        Category
                                    </label>
                                    <select id="announcementCategory" class="form-select" required>
                                        <option value="general">General Information</option>
                                        <option value="system">System Updates</option>
                                        <option value="maintenance">Maintenance Notice</option>
                                        <option value="policy">Policy Changes</option>
                                        <option value="emergency">Emergency Alert</option>
                                        <option value="training">Training/Workshop</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="announcementMessage" class="form-label">
                                        <i class="fas fa-edit"></i>
                                        Message Content
                                    </label>
                                    <textarea id="announcementMessage" 
                                              class="form-textarea enhanced" 
                                              rows="8" 
                                              placeholder="Compose your announcement message here... 

Use bullet points for better readability:
â€¢ Point 1
â€¢ Point 2
â€¢ Point 3

You can also use **bold text** or *italic text* for emphasis."
                                              maxlength="2000"
                                              required></textarea>
                                    <div class="form-help">
                                        <div class="help-left">
                                            <span class="character-count">0 / 2000 characters</span>
                                            <span class="word-count">0 words</span>
                                        </div>
                                        <div class="help-right">
                                            <span class="form-tip">Use clear, professional language for maximum impact</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-users"></i>
                                        Target Recipients
                                    </label>
                                    <div class="checkbox-group">
                                        <label class="checkbox-item">
                                            <input type="checkbox" id="targetAll" checked>
                                            <div class="checkmark"></div>
                                            All Users
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" id="targetStaff">
                                            <div class="checkmark"></div>
                                            Staff Only
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" id="targetAdmins">
                                            <div class="checkmark"></div>
                                            Administrators Only
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn-secondary" id="previewAnnouncement">
                                    <i class="fas fa-eye"></i>
                                    Preview
                                </button>
                                <button type="submit" class="btn-primary enhanced">
                                    <i class="fas fa-paper-plane"></i>
                                    <span class="btn-text">Send Announcement</span>
                                    <span class="btn-shine"></span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="announcements-history-card">
                        <div class="history-header">
                            <div class="history-title-section">
                                <h2 class="history-title">
                                    <i class="fas fa-history"></i>
                                    Announcement History
                                </h2>
                                <p class="history-subtitle">Track all system announcements and their engagement</p>
                            </div>
                            <div class="history-actions">
                                <button class="action-btn" id="refreshAnnouncements" title="Refresh">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="action-btn" id="exportAnnouncements" title="Export">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="history-controls">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="announcementSearch" placeholder="Search announcements..." class="search-input">
                            </div>
                            <div class="filter-controls">
                                <select id="priorityFilter" class="filter-select">
                                    <option value="all">All Priorities</option>
                                    <option value="urgent">Urgent</option>
                                    <option value="high">High Priority</option>
                                    <option value="normal">Normal</option>
                                </select>
                                <select id="categoryFilter" class="filter-select">
                                    <option value="all">All Categories</option>
                                    <option value="general">General</option>
                                    <option value="system">System</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="policy">Policy</option>
                                    <option value="emergency">Emergency</option>
                                    <option value="training">Training</option>
                                </select>
                            </div>
                        </div>
                        <div class="announcement-stats">
                            <div class="stat-item">
                                <span class="stat-label">Total</span>
                                <span class="stat-value" id="totalAnnouncements">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">This Month</span>
                                <span class="stat-value" id="monthlyAnnouncements">0</span>
                            </div>
                            <div class="stat-item urgent">
                                <span class="stat-label">Urgent</span>
                                <span class="stat-value" id="urgentAnnouncements">0</span>
                            </div>
                        </div>
                        <div id="announcementsList" class="announcements-timeline">
                            <!-- Announcements will be dynamically added here -->
                            <div class="empty-state" id="no-announcements-message">
                                <div class="empty-icon">
                                    <i class="fas fa-bullhorn"></i>
                                </div>
                                <h3>No announcements yet</h3>
                                <p>Create your first announcement to communicate with system users</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Chart.js CDN for analytics charts -->
        
    <script>
        // SESSION SECURITY VALIDATION
class SessionValidator {
    constructor() {
        this.checkInterval = 5 * 60 * 1000; // Check every 5 minutes
        this.tabCheckInterval = 10 * 1000; // Check tabs every 10 seconds
        this.warningTime = 25 * 60 * 1000; // Warn at 25 minutes
        this.tabToken = this.generateTabToken();
        this.init();
    }
    
    generateTabToken() {
        return 'tab_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    }
    
    init() {
        this.validateSession();
        this.validateTab();
        setInterval(() => this.validateSession(), this.checkInterval);
        setInterval(() => this.validateTab(), this.tabCheckInterval);
        this.setupActivityTracking();
        this.validatePageAccess();
        
        // Handle tab/window close
        window.addEventListener('beforeunload', () => {
            this.cleanupTab();
        });
        
        // Handle page visibility change (tab switching)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Tab became active, validate immediately
                this.validateTab();
            }
        });
    }
    
    async validateTab() {
        try {
            const response = await fetch('../backend/security/validate_tab.php', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tab_token: this.tabToken,
                    page_url: window.location.href
                })
            });
            
            const result = await response.json();
            
            if (!result.success) {
                this.redirectToLogin(result.message || 'Multiple tabs detected');
                return;
            }
            
        } catch (error) {
            console.error('Tab validation error:', error);
            // Don't redirect on network errors for tab validation
        }
    }
    
    async cleanupTab() {
        try {
            // Send cleanup request when tab is closing
            fetch('../backend/security/cleanup_tab.php', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tab_token: this.tabToken
                })
            });
        } catch (error) {
            // Ignore cleanup errors
        }
    }
    
    async validateSession() {
        try {
            const response = await fetch('../backend/security/session_check.php', {
                method: 'POST',
                credentials: 'same-origin'
            });
            const result = await response.json();
            
            if (!result.success) {
                this.redirectToLogin(result.message);
            }
        } catch (error) {
            console.error('Session validation error:', error);
        }
    }
    
    async validatePageAccess() {
        try {
            const response = await fetch('../backend/security/validate_access.php', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    required_role: 'head',
                    page: 'head-dashboard'
                })
            });
            const result = await response.json();
            
            if (!result.success) {
                this.redirectToLogin(result.message);
            }
        } catch (error) {
            this.redirectToLogin('Access validation failed');
        }
    }
    
    setupActivityTracking() {
        const events = ['mousedown', 'keydown', 'scroll', 'click'];
        let lastActivity = Date.now();
        
        const updateActivity = () => {
            const now = Date.now();
            if (now - lastActivity > 60000) {
                fetch('../backend/security/update_activity.php', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                lastActivity = now;
            }
        };
        
        events.forEach(event => {
            document.addEventListener(event, updateActivity, true);
        });
    }
    
    redirectToLogin(message = 'Session expired') {
        console.log('Redirecting to login:', message);
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = '../index.html';
    }
}

// Initialize session validator
const sessionValidator = new SessionValidator();

        // Global variables for MySQL API configuration
const apiBaseUrl = '../backend/';

// Analytics Variables
let monthlyChart = null;
let barangayChart = null;
let propertyChart = null;
let inspectionTypeChart = null;

// DOM Elements
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebarOverlay = document.getElementById('sidebarOverlay');
const mainContent = document.getElementById('mainContent');
const navLinks = document.querySelectorAll('.nav-link');
const pageTitle = document.getElementById('pageTitle');
const contentSections = document.querySelectorAll('.content-section');
const userIdDisplay = document.querySelector('.user-name');

// --- Utility Class for UI elements and Helpers ---
class Utils {
    static showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.classList.add('toast', type);
        toast.innerHTML = `<i class="fa-solid fa-info-circle icon"></i> <span class="message">${message}</span>`;
        toastContainer.appendChild(toast);

        // Show toast with a slight delay for CSS animation
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        // Hide and remove toast after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300); // Wait for fade-out animation
        }, 3000);
    }
}

// --- MySQL API Manager Class ---
class AnnouncementManager {
    constructor() {
        this.apiUrl = '../backend/announcements.php';
        this.isReady = true;
        this.userId = 'head-assessor';
        console.log('MySQL Announcement Manager initialized');
        
        // Set user display
        if (userIdDisplay) {
            userIdDisplay.textContent = 'Head';
        }
    }

    async addAnnouncement(subject, message) {
        // Backward compatibility - convert to enhanced format
        return this.addEnhancedAnnouncement({
            subject: subject,
            message: message,
            priority: 'normal',
            category: 'general',
            expiry: null,
            targetAll: true,
            targetStaff: false,
            targetAdmins: false
        });
    }

    async addEnhancedAnnouncement(announcementData) {
        if (!this.isReady) {
            Utils.showToast("Database not ready. Please wait.", "error");
            throw new Error("Database not ready");
        }

        try {
            const response = await fetch(this.apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    subject: announcementData.subject,
                    message: announcementData.message,
                    priority: announcementData.priority,
                    category: announcementData.category,
                    expiry: announcementData.expiry || null,
                    targetAll: announcementData.targetAll,
                    targetStaff: announcementData.targetStaff,
                    targetAdmins: announcementData.targetAdmins,
                    authorId: this.userId,
                    authorName: 'Head Assessor'
                })
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
                console.log("Enhanced announcement added to MySQL with ID:", result.id);
                console.log("Response:", result);
                return true;
            } else {
                throw new Error(result.error || 'Failed to save announcement');
            }
        } catch (error) {
            console.error("Error adding enhanced announcement:", error);
            throw error;
        }
    }

    async getAllAnnouncements() {
        try {
            const response = await fetch(this.apiUrl);
            const result = await response.json();
            
            if (response.ok && result.success) {
                return result.data;
            } else {
                throw new Error(result.error || 'Failed to fetch announcements');
            }
        } catch (error) {
            console.error("Error fetching announcements:", error);
            throw error;
        }
    }

    async getAnnouncementStats() {
        try {
            const response = await fetch(this.apiUrl + '?path=stats');
            const result = await response.json();
            
            if (response.ok && result.success) {
                return result.data;
            } else {
                throw new Error(result.error || 'Failed to fetch stats');
            }
        } catch (error) {
            console.error("Error fetching announcement stats:", error);
            throw error;
        }
    }

    async updateAnnouncement(id, announcementData) {
        try {
            const response = await fetch(this.apiUrl + '?path=' + id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(announcementData)
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
                return true;
            } else {
                throw new Error(result.error || 'Failed to update announcement');
            }
        } catch (error) {
            console.error("Error updating announcement:", error);
            throw error;
        }
    }

    async deleteAnnouncement(id) {
        try {
            const response = await fetch(this.apiUrl + '?path=' + id, {
                method: 'DELETE'
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
                return true;
            } else {
                throw new Error(result.error || 'Failed to delete announcement');
            }
        } catch (error) {
            console.error("Error deleting announcement:", error);
            throw error;
        }
    }

    // Simulate real-time updates with periodic polling
    startPolling(callback, interval = 5000) {
        const poll = async () => {
            try {
                const announcements = await this.getAllAnnouncements();
                callback(announcements);
            } catch (error) {
                console.error("Polling error:", error);
            }
        };
        
        // Initial fetch
        poll();
        
        // Set up polling interval
        return setInterval(poll, interval);
    }

    stopPolling(intervalId) {
        if (intervalId) {
            clearInterval(intervalId);
        }
    }
}


// --- Main Application Logic ---
class HeadApp {
    constructor() {
        this.announcementManager = new AnnouncementManager();
        this.chartInstances = {};
        this.pollingInterval = null;
        this.init();
    }

    init() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.initializeModules());
        } else {
            this.initializeModules();
        }
    }

    initializeModules() {
        console.log('Initializing Head Dashboard...');
        this.bindEvents();
        this.handleResize();
        this.loadInitialData();
        this.setupRealtimeListeners();
        this.startAutoRefresh(); // Add auto-refresh functionality
    }

    bindEvents() {
        // Sidebar toggle for mobile
        sidebarToggle.addEventListener('click', () => {
            this.toggleSidebar();
        });

        // Close sidebar when clicking overlay
        sidebarOverlay.addEventListener('click', () => {
            this.closeSidebar();
        });

        // Add touch support for swipe-to-close
        this.setupTouchGestures();

        // Handle navigation clicks
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                this.handleNavClick(link);
            });
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            this.handleResize();
        });

        // Handle keyboard navigation for mobile drawer
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sidebar.classList.contains('mobile-open')) {
                this.closeSidebar();
            }
        });

        // Cleanup auto-refresh when page is about to unload
        window.addEventListener('beforeunload', () => {
            this.stopAutoRefresh();
            if (this.pollingInterval) {
                this.announcementManager.stopPolling(this.pollingInterval);
            }
        });

        // Handle announcement form submission
        const announcementForm = document.getElementById('announcementForm');
        if (announcementForm) {
            announcementForm.addEventListener('submit', (e) => {
                e.preventDefault();
                console.log('Form submitted, processing announcement...');
                this.handleAnnouncementSubmit();
            });
        } else {
            console.error('Announcement form not found!');
        }

        // Handle analytics refresh button
        const refreshAnalyticsBtn = document.querySelector('.refresh-analytics');
        if (refreshAnalyticsBtn) {
            refreshAnalyticsBtn.addEventListener('click', () => {
                this.loadRealAnalytics();
                Utils.showToast('Analytics refreshed manually', 'success');
                
                // Add visual feedback
                const icon = refreshAnalyticsBtn.querySelector('i');
                icon.classList.add('fa-spin');
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                }, 1000);
            });
        }

        // Handle period selector change
        const periodSelect = document.getElementById('periodSelect');
        if (periodSelect) {
            periodSelect.addEventListener('change', async (e) => {
                const selectedPeriod = e.target.value;
                console.log('Period filter changed to:', selectedPeriod);
                await this.loadRealAnalytics(selectedPeriod);
            });
        }

        // Logout button
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                await handleLogout();
            });
        }
    }

    toggleSidebar() {
        const isOpening = !sidebar.classList.contains('mobile-open');
        sidebar.classList.toggle('mobile-open');
        sidebarOverlay.classList.toggle('active');
        
        // Focus management for accessibility
        if (isOpening) {
            // Focus first nav link when opening
            const firstNavLink = sidebar.querySelector('.nav-link');
            if (firstNavLink) {
                setTimeout(() => firstNavLink.focus(), 300);
            }
        } else {
            // Return focus to toggle button when closing
            setTimeout(() => sidebarToggle.focus(), 300);
        }
    }

    closeSidebar() {
        sidebar.classList.remove('mobile-open');
        sidebarOverlay.classList.remove('active');
    }

    setupTouchGestures() {
        let startX = 0;
        let currentX = 0;
        let isDragging = false;

        sidebar.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isDragging = true;
        }, { passive: true });

        sidebar.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            currentX = e.touches[0].clientX;
            const deltaX = currentX - startX;
            
            // Only allow swipe left to close
            if (deltaX < 0) {
                const opacity = Math.max(0, 1 + deltaX / 280);
                sidebar.style.transform = `translateX(${Math.min(0, deltaX)}px)`;
                sidebarOverlay.style.opacity = opacity;
            }
        }, { passive: true });

        sidebar.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;
            
            const deltaX = currentX - startX;
            
            // Close if swiped more than 30% of sidebar width
            if (deltaX < -84) { // 30% of 280px
                this.closeSidebar();
            }
            
            // Reset transform and opacity
            sidebar.style.transform = '';
            sidebarOverlay.style.opacity = '';
        }, { passive: true });
    }

    handleResize() {
        if (window.innerWidth > 1024) {
            this.closeSidebar();
        }
        // Resize charts on window resize
        for (const chartId in this.chartInstances) {
            if (this.chartInstances[chartId]) {
                this.chartInstances[chartId].resize();
            }
        }
    }

    handleNavClick(link) {
        const sectionId = link.getAttribute('data-section');
        const section = document.getElementById(sectionId);

        // Deactivate all links and content sections
        navLinks.forEach(l => l.classList.remove('active'));
        contentSections.forEach(s => s.classList.remove('active'));

        // Activate the clicked link and its corresponding section
        link.classList.add('active');
        section.classList.add('active');

        // Update page title
        pageTitle.textContent = 'AssessPro';

        // Close sidebar/drawer when menu item is clicked (for mobile)
        this.closeSidebar();
    }

    loadInitialData() {
        // Set current date
        this.updateCurrentDate();
        
        // Load real analytics data
        this.loadRealAnalytics();
        
        // Add character count functionality
        this.setupCharacterCount();
    }

    async loadRealAnalytics(selectedPeriod = null) {
        try {
            // Show loading state
            this.showAnalyticsLoading();
            
            // Get selected period - use parameter if provided, otherwise read from DOM
            let period;
            let periodType;
            if (selectedPeriod !== null) {
                periodType = selectedPeriod;
                console.log('Using selected period:', periodType);
            } else {
                const periodSelect = document.getElementById('periodSelect');
                periodType = periodSelect ? periodSelect.value : 'month';
                console.log('Reading period from DOM:', periodType);
            }
            
            // Convert period type to backend-compatible values (kept for backward compatibility)
            switch (periodType) {
                case 'week':
                    period = 7; // 7 days
                    break;
                case 'month':
                    period = 1;
                    break;
                case 'year':
                    period = 12;
                    break;
                default:
                    period = 1;
                    break;
            }
            
            console.log('Loading analytics for period:', periodType, '(', period, 'months equivalent)');
            
            const response = await fetch('../backend/api/head.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'get_analytics',
                    period: period,
                    period_type: periodType
                })
            });

            if (!response.ok) {
                throw new Error('Failed to fetch analytics data');
            }

            const result = await response.json();
            console.log('Analytics response for', periodType + ':', result);
            
            if (result.success) {
                console.log('Updating dashboard with', periodType, 'data');
                console.log('Received data:', result.data);
                console.log('Trends data:', result.data.monthly_trends);
                
                this.updateChartTitles(periodType);
                this.updateDashboardMetrics(result.data);
                this.renderRealCharts(result.data);
                this.updateLastUpdatedTime();
                console.log('Dashboard updated successfully for', periodType);
                
                // Check if we have actual data
                if (result.data.monthly_trends && result.data.monthly_trends.length === 0) {
                    console.warn('No trend data available for', periodType);
                    this.showNoDataMessage(periodType);
                }
            } else {
                console.error('Analytics API error:', result.message);
                this.loadFallbackData();
            }
        } catch (error) {
            console.error('Analytics Error:', error);
            this.loadFallbackData();
        } finally {
            this.hideAnalyticsLoading();
        }
    }

    updateChartTitles(periodType) {
        const titleElement = document.getElementById('trendsChartTitle');
        const subtitleElement = document.getElementById('trendsChartSubtitle');
        
        if (titleElement && subtitleElement) {
            switch (periodType) {
                case 'week':
                    titleElement.textContent = 'Weekly Inspection Trends';
                    subtitleElement.textContent = 'Inspection requests over the past week';
                    break;
                case 'month':
                    titleElement.textContent = 'Monthly Inspection Trends';
                    subtitleElement.textContent = 'Inspection requests over the past month';
                    break;
                case 'year':
                    titleElement.textContent = 'Yearly Inspection Trends';
                    subtitleElement.textContent = 'Inspection requests over the past year';
                    break;
                default:
                    titleElement.textContent = 'Inspection Trends';
                    subtitleElement.textContent = 'Inspection requests over time';
                    break;
            }
        }
    }

    showNoDataMessage(periodType) {
        const chartCanvas = document.getElementById('assessmentTrendsChart');
        if (chartCanvas) {
            const ctx = chartCanvas.getContext('2d');
            ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
            ctx.font = '16px Arial';
            ctx.fillStyle = '#6b7280';
            ctx.textAlign = 'center';
            ctx.fillText(`No inspection data available for the past ${periodType}`, 
                        chartCanvas.width / 2, chartCanvas.height / 2);
        }
    }

    updateLastUpdatedTime() {
        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (lastUpdatedElement) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            lastUpdatedElement.innerHTML = `<i class="fas fa-clock"></i> Updated: ${timeString}`;
        }
    }

    // Helper function to calculate absolute change from trend data
    calculateAbsoluteChange(currentValue, trend) {
        if (!trend) return null;
        
        // Try to extract from description first (format: "previous â†’ current")
        if (trend.description && trend.description.includes('â†’')) {
            const match = trend.description.match(/(\d+)\s*â†’\s*(\d+)/);
            if (match) {
                const previous = parseInt(match[1]);
                const current = parseInt(match[2]);
                return current - previous;
            }
        }
        
        // If trend already has absolute display (like "+5" or "-3")
        if (trend.display && (trend.display.startsWith('+') || trend.display.startsWith('-')) && !trend.display.includes('%')) {
            const numMatch = trend.display.match(/([+-]?\d+)/);
            if (numMatch) {
                return parseInt(numMatch[1]);
            }
        }
        
        // Calculate from percentage if available
        if (trend.percentage && currentValue !== null && currentValue !== undefined) {
            if (trend.direction === 'up') {
                const previousValue = Math.round(currentValue / (1 + (trend.percentage / 100)));
                return currentValue - previousValue;
            } else if (trend.direction === 'down') {
                const previousValue = Math.round(currentValue / (1 - (trend.percentage / 100)));
                return currentValue - previousValue;
            }
        }
        
        return null;
    }

    updateDashboardMetrics(data) {
        console.log('Updating dashboard metrics with data:', data);
        
        // Update total inspections
        const totalElement = document.getElementById('totalInspections');
        const totalTrendElement = document.getElementById('totalTrend');
        if (totalElement && data.metrics.total) {
            console.log('Updating total:', data.metrics.total.value);
            totalElement.textContent = data.metrics.total.value || 0;
            this.updateTrendElementAbsolute(totalTrendElement, data.metrics.total.trend, data.metrics.total.value);
        }

        // Update pending inspections
        const pendingElement = document.getElementById('pendingInspections');
        const pendingTrendElement = document.getElementById('pendingTrend');
        if (pendingElement && data.metrics.pending) {
            console.log('Updating pending:', data.metrics.pending.value);
            pendingElement.textContent = data.metrics.pending.value || 0;
            this.updateTrendElementAbsolute(pendingTrendElement, data.metrics.pending.trend, data.metrics.pending.value);
        }

        // Update completed inspections
        const completedElement = document.getElementById('completedInspections');
        const completedTrendElement = document.getElementById('completedTrend');
        if (completedElement && data.metrics.completed) {
            console.log('Updating completed:', data.metrics.completed.value);
            completedElement.textContent = data.metrics.completed.value || 0;
            this.updateTrendElementAbsolute(completedTrendElement, data.metrics.completed.trend, data.metrics.completed.value);
        }

        // Update top barangay
        const topBarangayElement = document.getElementById('topBarangay');
        const barangayTrendElement = document.getElementById('barangayTrend');
        if (topBarangayElement && data.metrics.top_barangay) {
            console.log('Updating top barangay:', data.metrics.top_barangay.value);
            topBarangayElement.textContent = data.metrics.top_barangay.value || 'N/A';
            if (barangayTrendElement) {
                barangayTrendElement.innerHTML = `<span>${data.metrics.top_barangay.count || 0} requests</span>`;
            }
        }
    }

    updateTrendElement(element, trend) {
        if (!element || !trend) return;
        
        console.log('Updating trend element with data:', trend);
        
        // Handle special cases
        if (trend.display === 'â€”' || trend.percentage === null) {
            element.className = 'trend metric-trend trend-neutral';
            element.innerHTML = '<span class="no-trend" title="' + (trend.description || 'No comparison data available') + '">â€”</span>';
            return;
        }
        
        // Handle "New" activity case
        if (trend.display === 'New') {
            element.className = 'trend metric-trend trend-up';
            element.innerHTML = `
                <i class="fas fa-plus-circle"></i>
                <span title="${trend.description}">New</span>
            `;
            return;
        }
        
        // Handle major changes that were capped
        if (trend.display === 'Major â†‘' || trend.display === 'Major â†“') {
            element.className = `trend metric-trend trend-${trend.direction}`;
            const icon = trend.direction === 'up' ? 'arrow-up' : 'arrow-down';
            element.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span title="${trend.description}">${trend.display}</span>
            `;
            return;
        }
        
        // Handle absolute change displays (for small datasets)
        if (trend.display && (trend.display.startsWith('+') || trend.display.startsWith('-')) && !trend.display.includes('%')) {
            element.className = `trend metric-trend trend-${trend.direction}`;
            const icon = trend.direction === 'up' ? 'arrow-up' : 
                        trend.direction === 'down' ? 'arrow-down' : 'minus';
            element.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span title="${trend.description}">${trend.display}</span>
            `;
            return;
        }
        
        // Regular trend display
        element.className = `trend metric-trend trend-${trend.direction}`;
        let icon;
        switch (trend.direction) {
            case 'up':
                icon = 'arrow-up';
                break;
            case 'down':
                icon = 'arrow-down';
                break;
            default:
                icon = 'minus';
                break;
        }
        
        element.innerHTML = `
            <i class="fas fa-${icon}"></i>
            <span title="${trend.description || trend.display}">${trend.display}</span>
        `;
        
        console.log('Trend element updated:', element.className, trend.display);
    }

    updateTrendElementAbsolute(element, trend, currentValue) {
        if (!element || !trend) {
            if (element) {
                element.className = 'trend metric-trend trend-neutral';
                element.innerHTML = '<span class="no-trend">â€”</span>';
            }
            return;
        }
        
        console.log('Updating trend with absolute change:', {trend, currentValue});
        
        // Handle special cases
        if (trend.display === 'â€”' || trend.percentage === null) {
            element.className = 'trend metric-trend trend-neutral';
            element.innerHTML = '<span class="no-trend">â€”</span>';
            return;
        }
        
        // Handle "New" activity case
        if (trend.display === 'New') {
            element.className = 'trend metric-trend trend-up';
            element.innerHTML = `
                <i class="fas fa-plus-circle"></i>
                <span>+${currentValue || 0}</span>
            `;
            return;
        }
        
        // Calculate absolute change
        let absoluteChange = this.calculateAbsoluteChange(currentValue, trend);
        
        // If we can't calculate, show fallback based on direction
        if (absoluteChange === null) {
            if (trend.direction === 'up') {
                absoluteChange = 1; // At least +1
            } else if (trend.direction === 'down') {
                absoluteChange = -1; // At least -1
            } else {
                absoluteChange = 0; // No change
            }
        }
        
        // Format display
        let displayText;
        let direction;
        if (absoluteChange > 0) {
            displayText = '+' + absoluteChange;
            direction = 'up';
        } else if (absoluteChange < 0) {
            displayText = absoluteChange.toString();
            direction = 'down';
        } else {
            displayText = 'Â±0';
            direction = 'neutral';
        }
        
        // Set class and icon
        element.className = `trend metric-trend trend-${direction}`;
        
        let icon;
        switch (direction) {
            case 'up':
                icon = 'arrow-up';
                break;
            case 'down':
                icon = 'arrow-down';
                break;
            default:
                icon = 'equals';
                break;
        }
        
        // Create tooltip
        const changeAmount = Math.abs(absoluteChange);
        const changeText = absoluteChange > 0 ? 'increase' : absoluteChange < 0 ? 'decrease' : 'no change';
        const tooltip = `${changeText} of ${changeAmount} ${changeAmount === 1 ? 'request' : 'requests'} compared to previous period`;
        
        element.innerHTML = `
            <i class="fas fa-${icon}"></i>
            <span title="${tooltip}">${displayText}</span>
        `;
        
        console.log('Absolute trend updated:', {displayText, direction, absoluteChange});
    }

    renderRealCharts(data) {
        // Render Monthly Trends Chart
        this.renderMonthlyTrendsChart(data.monthly_trends);
        
        // Render completion status chart
        this.renderCompletionChart(data.metrics);
        
        // Render barangay distribution chart
        this.renderBarangayChart(data.barangay_distribution);
        
        // Render property classification chart (only Land Property inspections)
        this.renderPropertyChart(data.property_classification);
        
        // Render inspection type distribution chart
        this.renderInspectionTypeChart(data.inspection_type_distribution);
        
        // Generate DSS Analytics & Recommendations
        this.generateDSSInsights(data);
    }

    renderMonthlyTrendsChart(monthlyData) {
        const trendsCtx = document.getElementById('assessmentTrendsChart');
        if (!trendsCtx) return;

        // Destroy existing chart
        if (this.chartInstances.assessmentTrendsChart) {
            this.chartInstances.assessmentTrendsChart.destroy();
        }

        const ctx = trendsCtx.getContext('2d');
        this.chartInstances.assessmentTrendsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlyData ? monthlyData.map(item => item.label) : [],
                datasets: [{
                    label: 'Monthly Requests',
                    data: monthlyData ? monthlyData.map(item => item.total) : [],
                    backgroundColor: 'rgba(45, 134, 89, 0.1)',
                    borderColor: 'rgba(45, 134, 89, 1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        // Generate dynamic interpretation for Monthly Trends
        this.generateMonthlyTrendsInterpretation(monthlyData);
    }
    
    generateMonthlyTrendsInterpretation(monthlyData) {
        const interpretationEl = document.getElementById('monthly-trends-interpretation');
        if (!interpretationEl || !monthlyData || monthlyData.length === 0) {
            if (interpretationEl) {
                interpretationEl.innerHTML = `
                    <div class="interpretation-item warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <h5>No Data Available</h5>
                            <p>Insufficient data to generate trend analysis. Data collection may be in progress.</p>
                        </div>
                    </div>
                `;
            }
            return;
        }
        
        const values = monthlyData.map(item => item.total);
        const labels = monthlyData.map(item => item.label);
        const total = values.reduce((sum, val) => sum + val, 0);
        const average = total / values.length;
        
        // Calculate trend
        let trendDirection = 'stable';
        let trendPercentage = 0;
        if (values.length >= 2) {
            const recent = values.slice(-3); // Last 3 months
            const earlier = values.slice(0, -3);
            if (earlier.length > 0) {
                const recentAvg = recent.reduce((sum, val) => sum + val, 0) / recent.length;
                const earlierAvg = earlier.reduce((sum, val) => sum + val, 0) / earlier.length;
                trendPercentage = earlierAvg > 0 ? ((recentAvg - earlierAvg) / earlierAvg * 100) : 0;
                
                if (Math.abs(trendPercentage) > 5) {
                    trendDirection = trendPercentage > 0 ? 'increasing' : 'decreasing';
                }
            }
        }
        
        // Find peak and low months
        const maxValue = Math.max(...values);
        const minValue = Math.min(...values);
        const maxIndex = values.indexOf(maxValue);
        const minIndex = values.indexOf(minValue);
        const peakMonth = labels[maxIndex];
        const lowMonth = labels[minIndex];
        
        // Generate interpretations
        let interpretations = [];
        
        // Trend interpretation
        if (trendDirection === 'increasing') {
            interpretations.push({
                type: 'positive',
                icon: 'fa-trending-up',
                title: 'Growing Demand',
                text: `Assessment requests are trending upward with a ${Math.abs(trendPercentage).toFixed(1)}% increase. This indicates growing citizen engagement and property development activity.`
            });
        } else if (trendDirection === 'decreasing') {
            interpretations.push({
                type: 'warning',
                icon: 'fa-trending-down',
                title: 'Declining Activity',
                text: `Assessment requests have decreased by ${Math.abs(trendPercentage).toFixed(1)}%. Consider investigating potential barriers or seasonal factors affecting citizen engagement.`
            });
        } else {
            interpretations.push({
                type: 'neutral',
                icon: 'fa-equals',
                title: 'Stable Demand',
                text: `Assessment requests remain relatively stable with consistent monthly volumes. This indicates predictable service demand patterns.`
            });
        }
        
        // Peak analysis
        if (maxValue > average * 1.5) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-chart-line',
                title: 'Peak Performance',
                text: `${peakMonth} showed exceptional activity with ${maxValue} requests (${((maxValue / average - 1) * 100).toFixed(0)}% above average). Analyze successful factors for replication.`
            });
        }
        
        // Workload analysis
        if (average > 50) {
            interpretations.push({
                type: 'warning',
                icon: 'fa-exclamation-circle',
                title: 'High Volume Alert',
                text: `Monthly average of ${average.toFixed(0)} requests indicates high service demand. Consider resource allocation and process optimization.`
            });
        } else if (average < 10) {
            interpretations.push({
                type: 'neutral',
                icon: 'fa-info-circle',
                title: 'Low Volume Period',
                text: `Relatively low request volume (${average.toFixed(0)}/month average) may indicate seasonal patterns or outreach opportunities.`
            });
        }
        
        // Render interpretations
        interpretationEl.innerHTML = interpretations.map(item => `
            <div class="interpretation-item ${item.type}">
                <i class="fas ${item.icon}"></i>
                <div>
                    <h5>${item.title}</h5>
                    <p>${item.text}</p>
                </div>
            </div>
        `).join('');
    }

    renderCompletionChart(metrics) {
        const completionCtx = document.getElementById('completionStatusChart');
        if (!completionCtx) return;

        // Destroy existing chart
        if (this.chartInstances.completionStatusChart) {
            this.chartInstances.completionStatusChart.destroy();
        }

        const completed = metrics.completed ? metrics.completed.value : 0;
        const pending = metrics.pending ? metrics.pending.value : 0;

        const ctx = completionCtx.getContext('2d');
        this.chartInstances.completionStatusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'Pending'],
                datasets: [{
                    data: [completed, pending],
                    backgroundColor: ['#4ade80', '#f59e0b'],
                    borderColor: '#ffffff',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = completed + pending;
                                const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // Generate dynamic interpretation for Completion Status
        this.generateCompletionInterpretation(metrics);
    }
    
    generateCompletionInterpretation(metrics) {
        const interpretationEl = document.getElementById('completion-status-interpretation');
        if (!interpretationEl) return;
        
        const completed = metrics.completed ? metrics.completed.value : 0;
        const pending = metrics.pending ? metrics.pending.value : 0;
        const total = completed + pending;
        
        if (total === 0) {
            interpretationEl.innerHTML = `
                <div class="interpretation-item warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <h5>No Active Cases</h5>
                        <p>No assessment cases currently in the system. This may indicate a new reporting period or system initialization.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        const completionRate = (completed / total) * 100;
        const pendingRate = (pending / total) * 100;
        
        let interpretations = [];
        
        // Completion rate analysis
        if (completionRate >= 90) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-check-circle',
                title: 'Excellent Performance',
                text: `Outstanding completion rate of ${completionRate.toFixed(1)}%. The assessment process is highly efficient with minimal backlog.`
            });
        } else if (completionRate >= 75) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-thumbs-up',
                title: 'Good Progress',
                text: `Solid completion rate of ${completionRate.toFixed(1)}%. Performance is above average with manageable pending cases.`
            });
        } else if (completionRate >= 50) {
            interpretations.push({
                type: 'warning',
                icon: 'fa-clock',
                title: 'Moderate Efficiency',
                text: `Completion rate of ${completionRate.toFixed(1)}% indicates room for improvement. Consider process optimization and resource allocation.`
            });
        } else {
            interpretations.push({
                type: 'negative',
                icon: 'fa-exclamation-triangle',
                title: 'Performance Concern',
                text: `Low completion rate of ${completionRate.toFixed(1)}% requires immediate attention. Significant backlog may affect service quality.`
            });
        }
        
        // Pending cases analysis
        if (pending > 0) {
            if (pending > completed) {
                interpretations.push({
                    type: 'negative',
                    icon: 'fa-hourglass-half',
                    title: 'Backlog Alert',
                    text: `${pending} pending cases exceed completed ones. Urgent action needed to address processing delays and prevent service deterioration.`
                });
            } else if (pending > total * 0.3) {
                interpretations.push({
                    type: 'warning',
                    icon: 'fa-tasks',
                    title: 'Pending Volume',
                    text: `${pending} cases pending (${pendingRate.toFixed(1)}% of total). Monitor workflow to prevent accumulation and maintain service standards.`
                });
            } else {
                interpretations.push({
                    type: 'neutral',
                    icon: 'fa-clipboard-list',
                    title: 'Normal Queue',
                    text: `${pending} cases pending (${pendingRate.toFixed(1)}% of total). Current pending volume is within normal operational range.`
                });
            }
        }
        
        // Productivity insights
        if (completed > 100) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-rocket',
                title: 'High Productivity',
                text: `${completed} completed assessments demonstrate strong team productivity and efficient workflow management.`
            });
        }
        
        // Render interpretations
        interpretationEl.innerHTML = interpretations.map(item => `
            <div class="interpretation-item ${item.type}">
                <i class="fas ${item.icon}"></i>
                <div>
                    <h5>${item.title}</h5>
                    <p>${item.text}</p>
                </div>
            </div>
        `).join('');
    }

    renderBarangayChart(barangayData) {
        const barangayCtx = document.getElementById('barangayChart');
        if (!barangayCtx) return;

        // Destroy existing chart
        if (this.chartInstances.barangayChart) {
            this.chartInstances.barangayChart.destroy();
        }

        const ctx = barangayCtx.getContext('2d');
        this.chartInstances.barangayChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: barangayData ? barangayData.map(item => item.label) : [],
                datasets: [{
                    label: 'Requests',
                    data: barangayData ? barangayData.map(item => item.value) : [],
                    backgroundColor: [
                        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                        '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#14b8a6'
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 2,
                    borderRadius: 6,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed.y} requests`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            stepSize: 1
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        // Generate dynamic interpretation for Barangay Distribution
        this.generateBarangayInterpretation(barangayData);
    }
    
    generateBarangayInterpretation(barangayData) {
        const interpretationEl = document.getElementById('barangay-distribution-interpretation');
        if (!interpretationEl || !barangayData || barangayData.length === 0) {
            if (interpretationEl) {
                interpretationEl.innerHTML = `
                    <div class="interpretation-item warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <h5>No Geographic Data</h5>
                            <p>No barangay distribution data available. Geographic analysis requires location-based assessment records.</p>
                        </div>
                    </div>
                `;
            }
            return;
        }
        
        const values = barangayData.map(item => item.value);
        const labels = barangayData.map(item => item.label);
        const total = values.reduce((sum, val) => sum + val, 0);
        const average = total / values.length;
        
        // Find highest and lowest activity barangays
        const maxValue = Math.max(...values);
        const minValue = Math.min(...values);
        const maxIndex = values.indexOf(maxValue);
        const minIndex = values.indexOf(minValue);
        const topBarangay = labels[maxIndex];
        const lowBarangay = labels[minIndex];
        
        // Calculate distribution metrics
        const highActivity = values.filter(val => val > average * 1.5).length;
        const lowActivity = values.filter(val => val < average * 0.5).length;
        const sortedValues = [...values].sort((a, b) => b - a);
        const topThreeTotal = sortedValues.slice(0, 3).reduce((sum, val) => sum + val, 0);
        const topThreePercentage = (topThreeTotal / total) * 100;
        
        let interpretations = [];
        
        // Leading barangay analysis
        if (maxValue > average * 2) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-trophy',
                title: 'High-Demand Area',
                text: `${topBarangay} leads with ${maxValue} requests (${((maxValue / total) * 100).toFixed(1)}% of total). Strong community engagement indicates active development or property concerns.`
            });
        } else {
            interpretations.push({
                type: 'neutral',
                icon: 'fa-chart-bar',
                title: 'Balanced Distribution',
                text: `${topBarangay} has the highest activity with ${maxValue} requests. Distribution appears relatively balanced across barangays.`
            });
        }
        
        // Coverage analysis
        if (lowActivity > values.length * 0.3) {
            interpretations.push({
                type: 'warning',
                icon: 'fa-map-marked-alt',
                title: 'Underserved Areas',
                text: `${lowActivity} barangays show low activity (below ${(average * 0.5).toFixed(1)} requests). Consider outreach programs or service accessibility improvements.`
            });
        }
        
        // Resource allocation insights
        if (maxValue > minValue * 5) {
            interpretations.push({
                type: 'negative',
                icon: 'fa-unlink',
                title: 'Service Gap Alert',
                text: `Significant disparity between ${topBarangay} (${maxValue}) and ${lowBarangay} (${minValue}). Review service delivery equity and accessibility barriers.`
            });
        }
        
        // Opportunity analysis
        const zeroActivity = values.filter(val => val === 0).length;
        if (zeroActivity > 0) {
            interpretations.push({
                type: 'warning',
                icon: 'fa-exclamation-circle',
                title: 'Zero Activity Areas',
                text: `${zeroActivity} barangay(s) with no requests. Investigate service awareness, accessibility, or community engagement opportunities.`
            });
        }
        
        // Render interpretations
        interpretationEl.innerHTML = interpretations.map(item => `
            <div class="interpretation-item ${item.type}">
                <i class="fas ${item.icon}"></i>
                <div>
                    <h5>${item.title}</h5>
                    <p>${item.text}</p>
                </div>
            </div>
        `).join('');
    }

    renderPropertyChart(propertyData) {
        const propertyCtx = document.getElementById('propertyChart');
        if (!propertyCtx) return;

        // Destroy existing chart
        if (this.chartInstances.propertyChart) {
            this.chartInstances.propertyChart.destroy();
        }

        const ctx = propertyCtx.getContext('2d');
        this.chartInstances.propertyChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: propertyData ? propertyData.map(item => item.label) : [],
                datasets: [{
                    data: propertyData ? propertyData.map(item => item.value) : [],
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                    borderColor: '#ffffff',
                    borderWidth: 3,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // Generate dynamic interpretation for Property Classification
        this.generatePropertyInterpretation(propertyData);
    }

    renderInspectionTypeChart(distributionData) {
        const typeCtx = document.getElementById('inspectionTypeChart');
        if (!typeCtx) return;

        // Destroy existing chart
        if (this.chartInstances.inspectionTypeChart) {
            this.chartInstances.inspectionTypeChart.destroy();
        }

        const ctx = typeCtx.getContext('2d');
        this.chartInstances.inspectionTypeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: distributionData ? distributionData.map(item => item.label) : [],
                datasets: [{
                    data: distributionData ? distributionData.map(item => item.value) : [],
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'],
                    borderColor: '#ffffff',
                    borderWidth: 3,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Generate dynamic interpretation for Inspection Type Distribution
        this.generateInspectionTypeInterpretation(distributionData);
    }
    
    generateInspectionTypeInterpretation(distributionData) {
        const interpretationEl = document.getElementById('inspection-type-interpretation');
        if (!interpretationEl || !distributionData || distributionData.length === 0) {
            if (interpretationEl) {
                interpretationEl.innerHTML = `
                    <div class="interpretation-item warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <h5>No Inspection Data</h5>
                            <p>No inspection type data available. Inspection analysis requires categorized inspection records.</p>
                        </div>
                    </div>
                `;
            }
            return;
        }
        
        const values = distributionData.map(item => item.value);
        const labels = distributionData.map(item => item.label);
        const total = values.reduce((sum, val) => sum + val, 0);
        
        // Calculate percentages and find dominant types
        const percentages = values.map(val => (val / total) * 100);
        const maxValue = Math.max(...values);
        const maxIndex = values.indexOf(maxValue);
        const dominantType = labels[maxIndex];
        const dominantPercentage = percentages[maxIndex];
        
        // Sort data for analysis
        const sortedData = distributionData.map((item, index) => ({
            label: item.label,
            value: item.value,
            percentage: percentages[index]
        })).sort((a, b) => b.value - a.value);
        
        let interpretations = [];
        
        // Service Mix Analysis
        if (dominantPercentage > 70) {
            interpretations.push({
                type: 'warning',
                icon: 'fa-exclamation-circle',
                title: 'Single Service Dominance',
                text: `${dominantType} represents ${dominantPercentage.toFixed(1)}% of all inspections. Consider diversifying service portfolio or investigating market demand for other inspection types.`
            });
        } else if (dominantPercentage > 50) {
            interpretations.push({
                type: 'neutral',
                icon: 'fa-chart-pie',
                title: 'Primary Service Focus',
                text: `${dominantType} is the primary service (${dominantPercentage.toFixed(1)}%). This indicates specialization while maintaining service diversity.`
            });
        } else {
            interpretations.push({
                type: 'positive',
                icon: 'fa-balance-scale',
                title: 'Balanced Service Portfolio',
                text: `Well-balanced inspection mix with ${dominantType} leading at ${dominantPercentage.toFixed(1)}%. Indicates diverse client needs and comprehensive service capability.`
            });
        }
        
        // Specific service type insights
        const propertyIndex = labels.findIndex(label => label.toLowerCase().includes('property'));
        const buildingIndex = labels.findIndex(label => label.toLowerCase().includes('building'));
        const machineryIndex = labels.findIndex(label => label.toLowerCase().includes('machinery'));
        
        if (propertyIndex !== -1 && percentages[propertyIndex] > 60) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-home',
                title: 'Property Assessment Focus',
                text: `Property assessments dominate (${percentages[propertyIndex].toFixed(1)}%), indicating strong real estate market activity and property valuation demands.`
            });
        }
        
        if (buildingIndex !== -1 && percentages[buildingIndex] > 30) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-building',
                title: 'Construction Activity',
                text: `Significant building inspections (${percentages[buildingIndex].toFixed(1)}%) suggest active construction, renovation, or compliance verification in the area.`
            });
        }
        
        if (machineryIndex !== -1 && percentages[machineryIndex] > 20) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-cogs',
                title: 'Industrial Operations',
                text: `Notable machinery inspections (${percentages[machineryIndex].toFixed(1)}%) indicate industrial activity and equipment compliance requirements.`
            });
        }
        
        // Service capacity analysis
        if (total > 500) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-rocket',
                title: 'High Service Volume',
                text: `${total} total inspections demonstrate strong service utilization and market demand across ${distributionData.length} inspection categories.`
            });
        } else if (total < 50) {
            interpretations.push({
                type: 'warning',
                icon: 'fa-chart-line',
                title: 'Low Service Volume',
                text: `${total} total inspections may indicate opportunity for service promotion or market expansion across inspection categories.`
            });
        }
        
        // Market diversity insights
        const evenDistribution = percentages.every(p => p >= 20 && p <= 40);
        if (evenDistribution) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-chart-bar',
                title: 'Optimal Service Mix',
                text: `Evenly distributed inspection types indicate comprehensive market coverage and balanced resource allocation across all service categories.`
            });
        }
        
        // Render interpretations
        interpretationEl.innerHTML = interpretations.map(item => `
            <div class="interpretation-item ${item.type}">
                <i class="fas ${item.icon}"></i>
                <div>
                    <h5>${item.title}</h5>
                    <p>${item.text}</p>
                </div>
            </div>
        `).join('');
    }
    
    generatePropertyInterpretation(propertyData) {
        const interpretationEl = document.getElementById('property-classification-interpretation');
        if (!interpretationEl || !propertyData || propertyData.length === 0) {
            if (interpretationEl) {
                interpretationEl.innerHTML = `
                    <div class="interpretation-item warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <h5>No Classification Data</h5>
                            <p>No property classification data available. Classification analysis requires categorized property records.</p>
                        </div>
                    </div>
                `;
            }
            return;
        }
        
        const values = propertyData.map(item => item.value);
        const labels = propertyData.map(item => item.label);
        const total = values.reduce((sum, val) => sum + val, 0);
        
        // Calculate percentages and find dominant categories
        const percentages = values.map(val => (val / total) * 100);
        const maxValue = Math.max(...values);
        const maxIndex = values.indexOf(maxValue);
        const dominantCategory = labels[maxIndex];
        const dominantPercentage = percentages[maxIndex];
        
        // Find second highest
        const sortedData = propertyData.map((item, index) => ({
            label: item.label,
            value: item.value,
            percentage: percentages[index]
        })).sort((a, b) => b.value - a.value);
        
        let interpretations = [];
        
        // Dominant category analysis
        if (dominantPercentage > 50) {
            interpretations.push({
                type: 'warning',
                icon: 'fa-exclamation-circle',
                title: 'Single Category Dominance',
                text: `${dominantCategory} represents ${dominantPercentage.toFixed(1)}% of all assessments. High concentration may indicate market specialization or limited property diversity.`
            });
        } else if (dominantPercentage > 35) {
            interpretations.push({
                type: 'neutral',
                icon: 'fa-chart-pie',
                title: 'Leading Category',
                text: `${dominantCategory} is the primary property type (${dominantPercentage.toFixed(1)}%). This indicates the main focus area for assessment services.`
            });
        } else {
            interpretations.push({
                type: 'positive',
                icon: 'fa-balance-scale',
                title: 'Diverse Portfolio',
                text: `Well-balanced property mix with ${dominantCategory} leading at ${dominantPercentage.toFixed(1)}%. Indicates diverse economic activity and property development.`
            });
        }
        
        // Market balance analysis
        const topTwoTotal = sortedData.slice(0, 2).reduce((sum, item) => sum + item.percentage, 0);
        if (topTwoTotal > 80) {
            interpretations.push({
                type: 'warning',
                icon: 'fa-compress-alt',
                title: 'Limited Diversity',
                text: `Top 2 categories account for ${topTwoTotal.toFixed(1)}% of assessments. Consider market diversification opportunities and emerging property types.`
            });
        }
        
        // Specific category insights
        const residentialIndex = labels.findIndex(label => label.toLowerCase().includes('residential'));
        const commercialIndex = labels.findIndex(label => label.toLowerCase().includes('commercial'));
        const industrialIndex = labels.findIndex(label => label.toLowerCase().includes('industrial'));
        const agriculturalIndex = labels.findIndex(label => label.toLowerCase().includes('agricultural'));
        const unspecifiedIndex = labels.findIndex(label => label.toLowerCase().includes('not specified'));
        
        if (residentialIndex !== -1 && percentages[residentialIndex] > 60) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-home',
                title: 'Residential Focus',
                text: `Strong residential market (${percentages[residentialIndex].toFixed(1)}%) indicates healthy community growth and housing development activity.`
            });
        }
        
        if (commercialIndex !== -1 && percentages[commercialIndex] > 25) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-store',
                title: 'Commercial Activity',
                text: `Significant commercial presence (${percentages[commercialIndex].toFixed(1)}%) suggests robust business development and economic growth opportunities.`
            });
        }
        
        if (industrialIndex !== -1 && percentages[industrialIndex] > 15) {
            interpretations.push({
                type: 'positive',
                icon: 'fa-industry',
                title: 'Industrial Development',
                text: `Industrial properties represent ${percentages[industrialIndex].toFixed(1)}% of assessments, indicating manufacturing and industrial growth in the area.`
            });
        }
        
        if (agriculturalIndex !== -1 && percentages[agriculturalIndex] > 20) {
            interpretations.push({
                type: 'neutral',
                icon: 'fa-leaf',
                title: 'Agricultural Base',
                text: `Agricultural land comprises ${percentages[agriculturalIndex].toFixed(1)}% of properties, showing the area maintains its agricultural heritage and food production capacity.`
            });
        }
        
        // Check for unspecified data and provide recommendation
        if (unspecifiedIndex !== -1 && percentages[unspecifiedIndex] > 10) {
            interpretations.push({
                type: 'warning',
                icon: 'fa-question-circle',
                title: 'Classification Improvement Needed',
                text: `${percentages[unspecifiedIndex].toFixed(1)}% of properties lack proper classification. Recommend updating property records to include specific property types for better analysis.`
            });
        }
        
        // Small category analysis
        const smallCategories = sortedData.filter(item => item.percentage < 5).length;
        if (smallCategories > 0) {
            interpretations.push({
                type: 'neutral',
                icon: 'fa-search',
                title: 'Emerging Categories',
                text: `${smallCategories} category(ies) with minimal activity (<5% each). Monitor for growth potential or consider consolidation for reporting efficiency.`
            });
        }
        
        // Render interpretations
        interpretationEl.innerHTML = interpretations.map(item => `
            <div class="interpretation-item ${item.type}">
                <i class="fas ${item.icon}"></i>
                <div>
                    <h5>${item.title}</h5>
                    <p>${item.text}</p>
                </div>
            </div>
        `).join('');
    }

    // === DECISION SUPPORT SYSTEM (DSS) ANALYTICS ===
    generateDSSInsights(data) {
        console.log('Generating DSS Analytics & Recommendations...');
        
        // Generate all 4 DSS components
        this.generateTrendAnalysis(data);
        this.generatePeakLowPeriods(data);
        this.generateRecommendations(data);
        this.generatePerformanceSummary(data);
    }

    generateTrendAnalysis(data) {
        const trendElement = document.getElementById('trendInsights');
        if (!trendElement) return;

        const monthlyData = data.monthly_trends || [];
        const metrics = data.metrics || {};
        
        if (monthlyData.length === 0) {
            trendElement.innerHTML = `
                <div class="insight-item">
                    <div class="insight-icon warning">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="insight-text">
                        <p class="insight-label">Insufficient Data</p>
                        <p class="insight-description">Not enough historical data for trend analysis</p>
                    </div>
                </div>
            `;
            return;
        }

        const values = monthlyData.map(item => item.total);
        const total = values.reduce((sum, val) => sum + val, 0);
        const average = total / values.length;
        
        // Calculate trend direction and velocity
        const recentPeriod = values.slice(-3); // Last 3 months
        const earlierPeriod = values.slice(0, -3);
        
        let trendDirection = 'stable';
        let trendVelocity = 0;
        let trendStrength = 'weak';
        
        if (earlierPeriod.length > 0) {
            const recentAvg = recentPeriod.reduce((sum, val) => sum + val, 0) / recentPeriod.length;
            const earlierAvg = earlierPeriod.reduce((sum, val) => sum + val, 0) / earlierPeriod.length;
            
            if (earlierAvg > 0) {
                trendVelocity = ((recentAvg - earlierAvg) / earlierAvg) * 100;
                
                if (Math.abs(trendVelocity) > 15) {
                    trendStrength = 'strong';
                } else if (Math.abs(trendVelocity) > 5) {
                    trendStrength = 'moderate';
                }
                
                if (trendVelocity > 5) {
                    trendDirection = 'increasing';
                } else if (trendVelocity < -5) {
                    trendDirection = 'decreasing';
                }
            }
        }

        // Calculate volatility (standard deviation)
        const mean = average;
        const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
        const volatility = Math.sqrt(variance);
        const volatilityRatio = volatility / mean;

        // Generate trend insights
        let insights = [];

        // Primary trend insight
        if (trendDirection === 'increasing') {
            insights.push({
                type: 'positive',
                icon: 'fa-trending-up',
                label: `${trendStrength.charAt(0).toUpperCase() + trendStrength.slice(1)} Growth Trajectory`,
                description: `Assessment demand has increased by ${Math.abs(trendVelocity).toFixed(1)}% over recent months, indicating ${trendStrength} upward momentum. ${trendStrength === 'strong' ? 'This substantial growth may require strategic capacity planning.' : 'Positive development supporting municipal service expansion.'}`
            });
        } else if (trendDirection === 'decreasing') {
            insights.push({
                type: 'warning',
                icon: 'fa-trending-down',
                label: `${trendStrength.charAt(0).toUpperCase() + trendStrength.slice(1)} Demand Decline`,
                description: `Assessment requests have decreased by ${Math.abs(trendVelocity).toFixed(1)}% over the analysis period. ${trendStrength === 'strong' ? 'This significant decline warrants immediate strategic review.' : 'Trend monitoring recommended to identify contributing factors.'}`
            });
        } else {
            insights.push({
                type: 'neutral',
                icon: 'fa-equals',
                label: 'Stable Demand Pattern',
                description: `Assessment demand remains consistent with minimal variance (Â±${Math.abs(trendVelocity).toFixed(1)}%). This stability enables predictable resource allocation and service planning.`
            });
        }

        // Volatility insight
        if (volatilityRatio > 0.4) {
            insights.push({
                type: 'warning',
                icon: 'fa-chart-line',
                label: 'High Demand Variability',
                description: `Assessment requests show significant fluctuation patterns (variance: ${volatility.toFixed(1)}). Strategic capacity management and flexible resource allocation are recommended to handle peak demand periods effectively.`
            });
        } else if (volatilityRatio < 0.15) {
            insights.push({
                type: 'positive',
                icon: 'fa-check-circle',
                label: 'Consistent Service Demand',
                description: `Assessment requests demonstrate low variability (variance: ${volatility.toFixed(1)}), enabling accurate forecasting and efficient resource planning across operational periods.`
            });
        }

        // Strategic forecast insight
        const projectedNext = values[values.length - 1] + (trendVelocity / 100 * values[values.length - 1]);
        insights.push({
            type: 'neutral',
            icon: 'fa-chart-bar',
            label: 'Strategic Forecast',
            description: `Predictive analysis indicates approximately ${Math.round(projectedNext)} assessment requests for the upcoming period, representing a ${trendVelocity > 0 ? '+' : ''}${trendVelocity.toFixed(1)}% projected change. This forecast supports proactive operational planning.`
        });

        trendElement.innerHTML = insights.map(insight => `
            <div class="insight-item">
                <div class="insight-icon ${insight.type}">
                    <i class="fas ${insight.icon}"></i>
                </div>
                <div class="insight-text">
                    <p class="insight-label">${insight.label}</p>
                    <p class="insight-description">${insight.description}</p>
                </div>
            </div>
        `).join('');
    }

    generatePeakLowPeriods(data) {
        const periodElement = document.getElementById('periodInsights');
        if (!periodElement) return;

        const monthlyData = data.monthly_trends || [];
        
        if (monthlyData.length === 0) {
            periodElement.innerHTML = `
                <div class="insight-item">
                    <div class="insight-icon warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="insight-text">
                        <p class="insight-label">No Temporal Data</p>
                        <p class="insight-description">Insufficient data for period analysis</p>
                    </div>
                </div>
            `;
            return;
        }

        const values = monthlyData.map(item => item.total);
        const labels = monthlyData.map(item => item.label);
        const average = values.reduce((sum, val) => sum + val, 0) / values.length;

        // Find peaks and valleys
        const maxValue = Math.max(...values);
        const minValue = Math.min(...values);
        const maxIndex = values.indexOf(maxValue);
        const minIndex = values.indexOf(minValue);
        const peakMonth = labels[maxIndex];
        const lowMonth = labels[minIndex];

        // Identify seasonal patterns
        const months = labels.map(label => {
            const monthMatch = label.match(/\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i);
            return monthMatch ? monthMatch[0] : label;
        });

        // Calculate period classifications
        const highPeriods = [];
        const lowPeriods = [];
        const normalPeriods = [];

        values.forEach((value, index) => {
            if (value > average * 1.3) {
                highPeriods.push({ month: labels[index], value, performance: 'high' });
            } else if (value < average * 0.7) {
                lowPeriods.push({ month: labels[index], value, performance: 'low' });
            } else {
                normalPeriods.push({ month: labels[index], value, performance: 'normal' });
            }
        });

        let insights = [];

        // Peak period analysis
        insights.push({
            type: 'positive',
            icon: 'fa-chart-line',
            label: 'Peak Demand Period Analysis',
            description: `${peakMonth} demonstrates highest service demand with ${maxValue} assessment requests (${((maxValue / average - 1) * 100).toFixed(0)}% above baseline). ${highPeriods.length} high-activity period(s) identified for strategic planning.`
        });

        // Low period analysis
        insights.push({
            type: 'neutral',
            icon: 'fa-chart-line',
            label: 'Optimal Resource Period',
            description: `${lowMonth} represents minimal demand period with ${minValue} requests (${((1 - minValue / average) * 100).toFixed(0)}% below baseline). ${lowPeriods.length} low-activity period(s) provide opportunity for maintenance and training activities.`
        });

        // Seasonal insight
        if (highPeriods.length > 0 && lowPeriods.length > 0) {
            const seasonalVariation = ((maxValue - minValue) / average) * 100;
            insights.push({
                type: seasonalVariation > 50 ? 'warning' : 'neutral',
                icon: 'fa-calendar-alt',
                label: 'Seasonal Demand Patterns',
                description: `Assessment demand exhibits ${seasonalVariation.toFixed(0)}% seasonal variation. ${seasonalVariation > 50 ? 'Significant cyclical patterns require strategic workforce planning and flexible resource allocation.' : 'Moderate seasonal fluctuations support predictable capacity management strategies.'}`
            });
        }

        // Workload distribution insight
        const peakToAverageRatio = maxValue / average;
        if (peakToAverageRatio > 2) {
            insights.push({
                type: 'warning',
                icon: 'fa-exclamation-triangle',
                label: 'Peak Capacity Analysis',
                description: `Maximum demand (${maxValue} requests) exceeds baseline by ${peakToAverageRatio.toFixed(1)}x, indicating potential service bottlenecks. Recommend implementing scalable resource strategies for high-demand periods.`
            });
        }

        periodElement.innerHTML = insights.map(insight => `
            <div class="insight-item">
                <div class="insight-icon ${insight.type}">
                    <i class="fas ${insight.icon}"></i>
                </div>
                <div class="insight-text">
                    <p class="insight-label">${insight.label}</p>
                    <p class="insight-description">${insight.description}</p>
                </div>
            </div>
        `).join('');
    }

    generateRecommendations(data) {
        const recommendationElement = document.getElementById('recommendations');
        if (!recommendationElement) return;

        const metrics = data.metrics || {};
        const monthlyData = data.monthly_trends || [];
        const barangayData = data.barangay_distribution || [];
        const propertyData = data.property_classification || [];

        let recommendations = [];

        // Performance-based recommendations
        const completed = metrics.completed ? metrics.completed.value : 0;
        const pending = metrics.pending ? metrics.pending.value : 0;
        const total = metrics.total ? metrics.total.value : 0;
        const completionRate = total > 0 ? (completed / total) * 100 : 0;

        if (completionRate < 75) {
            recommendations.push({
                priority: 'high',
                icon: 'fa-exclamation-circle',
                title: 'Optimize Service Delivery',
                description: `${completionRate.toFixed(1)}% completion rate below standards. Improve workflow efficiency.`
            });
        }

        if (pending > completed * 0.5 && pending > 10) {
            recommendations.push({
                priority: 'high',
                icon: 'fa-hourglass-half',
                title: 'Address Backlog',
                description: `${pending} pending cases create bottleneck. Deploy additional resources.`
            });
        }

        // Trend-based recommendations
        if (monthlyData.length >= 3) {
            const values = monthlyData.map(item => item.total);
            const recent = values.slice(-2);
            const earlier = values.slice(-4, -2);
            
            if (recent.length === 2 && earlier.length === 2) {
                const recentAvg = recent.reduce((sum, val) => sum + val, 0) / recent.length;
                const earlierAvg = earlier.reduce((sum, val) => sum + val, 0) / earlier.length;
                const growthRate = earlierAvg > 0 ? ((recentAvg - earlierAvg) / earlierAvg) * 100 : 0;

                if (growthRate > 20) {
                    recommendations.push({
                        priority: 'medium',
                        icon: 'fa-trending-up',
                        title: 'Scale Resources',
                        description: `${growthRate.toFixed(1)}% demand growth. Prepare capacity expansion.`
                    });
                } else if (growthRate < -20) {
                    recommendations.push({
                        priority: 'low',
                        icon: 'fa-search',
                        title: 'Analyze Decline',
                        description: `${Math.abs(growthRate).toFixed(1)}% demand drop. Review service accessibility.`
                    });
                }
            }
        }

        // Geographic recommendations
        if (barangayData.length > 0) {
            const values = barangayData.map(item => item.value);
            const total = values.reduce((sum, val) => sum + val, 0);
            const average = total / values.length;
            const zeroActivity = values.filter(val => val === 0).length;
            const lowActivity = values.filter(val => val < average * 0.3).length;

            if (zeroActivity > 0) {
                recommendations.push({
                    priority: 'medium',
                    icon: 'fa-map-marked-alt',
                    title: 'Expand Coverage',
                    description: `${zeroActivity} barangay(s) need service. Deploy mobile units.`
                });
            }

            if (lowActivity > values.length * 0.4) {
                recommendations.push({
                    priority: 'medium',
                    icon: 'fa-bullhorn',
                    title: 'Boost Engagement',
                    description: `${lowActivity} areas show low usage. Increase outreach efforts.`
                });
            }
        }

        // Property type recommendations
        if (propertyData.length > 0) {
            const values = propertyData.map(item => item.value);
            const labels = propertyData.map(item => item.label);
            const total = values.reduce((sum, val) => sum + val, 0);
            const maxValue = Math.max(...values);
            const maxIndex = values.indexOf(maxValue);
            const dominantType = labels[maxIndex];
            const dominantPercentage = (maxValue / total) * 100;

            if (dominantPercentage > 70) {
                recommendations.push({
                    priority: 'low',
                    icon: 'fa-balance-scale',
                    title: 'Diversify Services',
                    description: `${dominantType} dominates ${dominantPercentage.toFixed(0)}%. Balance property types.`
                });
            }
        }

        // Operational excellence recommendations
        if (total > 50) {
            recommendations.push({
                priority: 'medium',
                icon: 'fa-cogs',
                title: 'Implement Automation',
                description: `High volume (${total} requests) ready for digital workflows.`
            });
        }

        // If no specific recommendations, provide general ones
        if (recommendations.length === 0) {
            recommendations.push({
                priority: 'low',
                icon: 'fa-chart-bar',
                title: 'Maintain Standards',
                description: 'Performance within targets. Continue monitoring.'
            });
            
            recommendations.push({
                priority: 'low',
                icon: 'fa-lightbulb',
                title: 'Seek Improvements',
                description: 'Review processes for optimization opportunities.'
            });
        }

        // Sort by priority
        const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
        recommendations.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);

        recommendationElement.innerHTML = `
            <div class="recommendations-list">
                ${recommendations.map(rec => `
                    <div class="recommendation-item priority-${rec.priority}">
                        <div class="recommendation-header">
                            <div class="recommendation-icon">
                                <i class="fas ${rec.icon}"></i>
                            </div>
                            <div class="recommendation-meta">
                                <h4 class="recommendation-title">${rec.title}</h4>
                                <span class="recommendation-priority ${rec.priority}">${rec.priority.toUpperCase()}</span>
                            </div>
                        </div>
                        <p class="recommendation-description">${rec.description}</p>
                    </div>
                `).join('')}
            </div>
        `;
    }

    generatePerformanceSummary(data) {
        const performanceElement = document.getElementById('performanceSummary');
        if (!performanceElement) return;

        const metrics = data.metrics || {};
        const monthlyData = data.monthly_trends || [];

        // Calculate KPIs
        const completed = metrics.completed ? metrics.completed.value : 0;
        const pending = metrics.pending ? metrics.pending.value : 0;
        const total = metrics.total ? metrics.total.value : 0;
        const completionRate = total > 0 ? (completed / total) * 100 : 0;

        // Calculate monthly performance
        let monthlyAverage = 0;
        let performanceTrend = 'stable';
        if (monthlyData.length > 0) {
            const values = monthlyData.map(item => item.total);
            monthlyAverage = values.reduce((sum, val) => sum + val, 0) / values.length;
            
            if (values.length >= 2) {
                const recent = values[values.length - 1];
                const previous = values[values.length - 2];
                const changePercent = previous > 0 ? ((recent - previous) / previous) * 100 : 0;
                
                if (changePercent > 10) performanceTrend = 'improving';
                else if (changePercent < -10) performanceTrend = 'declining';
            }
        }

        // Determine overall performance grade
        let overallGrade = 'C';
        let gradeColor = 'warning';
        let gradeDescription = 'Standard Operational Level';

        if (completionRate >= 90 && performanceTrend !== 'declining') {
            overallGrade = 'A';
            gradeColor = 'positive';
            gradeDescription = 'Exceptional Service Excellence';
        } else if (completionRate >= 75 && performanceTrend !== 'declining') {
            overallGrade = 'B';
            gradeColor = 'positive';
            gradeDescription = 'Strong Operational Performance';
        } else if (completionRate >= 60) {
            overallGrade = 'C';
            gradeColor = 'neutral';
            gradeDescription = 'Standard Operational Level';
        } else {
            overallGrade = 'D';
            gradeColor = 'negative';
            gradeDescription = 'Performance Enhancement Required';
        }

        // Calculate efficiency metrics
        const dailyAverage = monthlyAverage / 30;
        const efficiency = completionRate;

        // Generate performance insights
        let insights = [];

        // Overall performance
        insights.push({
            type: gradeColor,
            icon: 'fa-trophy',
            label: `Service Excellence Rating: ${overallGrade}`,
            description: gradeDescription,
            metric: `${completionRate.toFixed(1)}% operational efficiency`
        });

        // Throughput analysis
        insights.push({
            type: 'neutral',
            icon: 'fa-tachometer-alt',
            label: 'Service Delivery Capacity',
            description: `Processing ${dailyAverage.toFixed(1)} assessments daily`,
            metric: `${monthlyAverage.toFixed(0)} monthly throughput`
        });

        // Trend performance
        const trendIcon = performanceTrend === 'improving' ? 'fa-arrow-up' : 
                         performanceTrend === 'declining' ? 'fa-arrow-down' : 'fa-arrows-alt-h';
        const trendType = performanceTrend === 'improving' ? 'positive' : 
                         performanceTrend === 'declining' ? 'warning' : 'neutral';

        insights.push({
            type: trendType,
            icon: trendIcon,
            label: 'Operational Trajectory',
            description: `${performanceTrend === 'improving' ? 'Positive growth momentum' : performanceTrend === 'declining' ? 'Performance decline detected' : 'Stable operational baseline'}`,
            metric: `Trend analysis: ${performanceTrend}`
        });

        // Workload status
        if (pending > 0 && total > 0) {
            const backlogRatio = pending / total;
            insights.push({
                type: backlogRatio > 0.2 ? 'warning' : 'neutral',
                icon: 'fa-tasks',
                label: 'Active Case Management',
                description: `${pending} assessments in progress`,
                metric: `${(backlogRatio * 100).toFixed(0)}% of total requests`
            });
        }

        performanceElement.innerHTML = insights.map(insight => `
            <div class="insight-item">
                <div class="insight-icon ${insight.type}">
                    <i class="fas ${insight.icon}"></i>
                </div>
                <div class="insight-text">
                    <p class="insight-label">${insight.label}</p>
                    <p class="insight-description">${insight.description}</p>
                    ${insight.metric ? `<p class="insight-metric">${insight.metric}</p>` : ''}
                </div>
            </div>
        `).join('');
    }

    showAnalyticsLoading() {
        // Show loading spinners in metric cards
        const loadingElements = [
            'totalTrend', 'pendingTrend', 'completedTrend', 'barangayTrend'
        ];
        
        loadingElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Loading...</span>';
            }
        });
    }

    hideAnalyticsLoading() {
        // Loading state will be replaced by actual data
    }

    loadFallbackData() {
        // Fallback to basic data if API fails
        const fallbackData = {
            totalAssessments: 0,
            pendingAssessments: 0,
            completedAssessments: 0,
            topBarangay: 'N/A'
        };

        document.getElementById('totalInspections').textContent = fallbackData.totalAssessments;
        document.getElementById('pendingInspections').textContent = fallbackData.pendingAssessments;
        document.getElementById('completedInspections').textContent = fallbackData.completedAssessments;
        document.getElementById('topBarangay').textContent = fallbackData.topBarangay;
        
        // Update trend elements to show no data
        ['totalTrend', 'pendingTrend', 'completedTrend', 'barangayTrend'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = '<span>No data</span>';
            }
        });
        
        Utils.showToast('Unable to load analytics data. Please check your connection.', 'warning');
    }

    startAutoRefresh() {
        // Refresh analytics every 10 seconds (faster for testing)
        // In production, you might want to increase this to 30-60 seconds
        const refreshIntervalMs = 10000; // 10 seconds
        
        this.refreshInterval = setInterval(() => {
            console.log('Auto-refreshing analytics...');
            this.loadRealAnalytics();
        }, refreshIntervalMs);

        // Also refresh when the page becomes visible again (user switches back to tab)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('Page visible again, refreshing analytics...');
                this.loadRealAnalytics();
            }
        });

        console.log(`Auto-refresh started: Analytics will update every ${refreshIntervalMs/1000} seconds`);
    }

    stopAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
            console.log('Auto-refresh stopped');
        }
    }

    updateCurrentDate() {
        const currentDateElement = document.getElementById('currentDate');
        if (currentDateElement) {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            currentDateElement.textContent = now.toLocaleDateString('en-US', options);
        }
    }

    setupCharacterCount() {
        const messageTextarea = document.getElementById('announcementMessage');
        const characterCount = document.querySelector('.character-count');
        const wordCount = document.querySelector('.word-count');
        
        if (messageTextarea && characterCount) {
            messageTextarea.addEventListener('input', (e) => {
                const text = e.target.value;
                const length = text.length;
                const words = text.trim() ? text.trim().split(/\s+/).length : 0;
                
                // Update counters
                characterCount.textContent = `${length} / 2000 characters`;
                if (wordCount) wordCount.textContent = `${words} words`;
                
                // Add visual feedback for length
                characterCount.className = 'character-count';
                if (length > 1800) {
                    characterCount.classList.add('danger');
                } else if (length > 1500) {
                    characterCount.classList.add('warning');
                }
            });
        }
        
        // Setup advanced options toggle
        const toggleBtn = document.getElementById('toggleAdvancedOptions');
        const advancedOptions = document.querySelector('.advanced-options');
        
        if (toggleBtn && advancedOptions) {
            toggleBtn.addEventListener('click', () => {
                const isVisible = advancedOptions.style.display !== 'none';
                advancedOptions.style.display = isVisible ? 'none' : 'block';
                toggleBtn.classList.toggle('active', !isVisible);
                
                const icon = toggleBtn.querySelector('i');
                icon.className = isVisible ? 'fas fa-cog' : 'fas fa-times';
            });
        }
        
        // Setup preview functionality
        const previewBtn = document.getElementById('previewAnnouncement');
        if (previewBtn) {
            previewBtn.addEventListener('click', () => {
                this.showAnnouncementPreview();
            });
        }
        
        // Setup minimum date for expiry
        const expiryInput = document.getElementById('announcementExpiry');
        if (expiryInput) {
            const today = new Date().toISOString().split('T')[0];
            expiryInput.setAttribute('min', today);
        }
        
        // Setup filtering and search
        this.setupAnnouncementFiltering();
        
        // Setup target recipient logic
        this.setupTargetingLogic();
    }
    
    setupTargetingLogic() {
        const targetAll = document.getElementById('targetAll');
        const targetStaff = document.getElementById('targetStaff');
        const targetAdmins = document.getElementById('targetAdmins');
        
        if (!targetAll || !targetStaff || !targetAdmins) return;
        
        // Handle "Staff Only" selection
        targetStaff.addEventListener('change', () => {
            if (targetStaff.checked) {
                targetAll.checked = false;  // Uncheck "All Users"
                // Allow both staff and admins to be selected together
            }
        });
        
        // Handle "Administrators Only" selection
        targetAdmins.addEventListener('change', () => {
            if (targetAdmins.checked) {
                targetAll.checked = false;  // Uncheck "All Users"
                // Allow both staff and admins to be selected together
            }
        });
        
        // Handle "All Users" selection
        targetAll.addEventListener('change', () => {
            if (targetAll.checked) {
                targetStaff.checked = false;   // Uncheck specific targeting
                targetAdmins.checked = false;  // Uncheck specific targeting
            }
        });
    }
    
    renderCharts(data) {
        // Destroy existing chart instances before re-rendering
        if (this.chartInstances.assessmentTrendsChart) {
            this.chartInstances.assessmentTrendsChart.destroy();
        }
        if (this.chartInstances.completionStatusChart) {
            this.chartInstances.completionStatusChart.destroy();
        }

        // Assessment Trends Chart
        const trendsCtx = document.getElementById('assessmentTrendsChart').getContext('2d');
        this.chartInstances.assessmentTrendsChart = new Chart(trendsCtx, {
            type: 'bar',
            data: {
                labels: data.monthlyData.labels,
                datasets: [{
                    label: 'Assessments',
                    data: data.monthlyData.assessments,
                    backgroundColor: 'rgba(45, 134, 89, 0.8)',
                    borderColor: 'rgba(45, 134, 89, 1)',
                    borderWidth: 1,
                    borderRadius: 5,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Completion Status Chart (Doughnut)
        const completionCtx = document.getElementById('completionStatusChart').getContext('2d');
        this.chartInstances.completionStatusChart = new Chart(completionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'Pending'],
                datasets: [{
                    label: 'Assessment Status',
                    data: [data.completedAssessments, data.pendingAssessments],
                    backgroundColor: ['#4ade80', '#e5e7eb'],
                    borderColor: '#ffffff',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                return `${tooltipItem.label}: ${tooltipItem.raw}`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    setupRealtimeListeners() {
        console.log('Setting up polling for announcements...');
        this.pollingInterval = this.announcementManager.startPolling((announcements) => {
            console.log('Received announcements update:', announcements.length, 'items');
            this.renderAnnouncements(announcements);
        });
        
        // Also load stats
        this.loadAnnouncementStats();
    }

    async loadAnnouncementStats() {
        try {
            const stats = await this.announcementManager.getAnnouncementStats();
            this.updateAnnouncementStatsDisplay(stats);
        } catch (error) {
            console.error('Error loading announcement stats:', error);
        }
    }
    
    renderAnnouncements(announcements) {
        console.log('Rendering announcements:', announcements);
        const announcementsList = document.getElementById('announcementsList');
        const noAnnouncementsMessage = document.getElementById('no-announcements-message');
        
        // Update statistics
        this.updateAnnouncementStats(announcements);
        
        // Clear current list
        announcementsList.innerHTML = '';
        
        if (announcements.length === 0) {
            announcementsList.appendChild(noAnnouncementsMessage.cloneNode(true));
        } else {
            // Filter announcements based on current filters
            const filteredAnnouncements = this.filterAnnouncements(announcements);
            
            if (filteredAnnouncements.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'empty-state';
                noResults.innerHTML = `
                    <div class="empty-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>No matching announcements</h3>
                    <p>Try adjusting your search or filter criteria</p>
                `;
                announcementsList.appendChild(noResults);
                return;
            }
            
            filteredAnnouncements.forEach(announcement => {
                const announcementItem = this.createAnnouncementElement(announcement);
                announcementsList.appendChild(announcementItem);
            });
        }
        
        // Store original data for filtering
        this.allAnnouncements = announcements;
    }

    createAnnouncementElement(announcement) {
        const item = document.createElement('div');
        item.classList.add('announcement-item');
        item.setAttribute('data-id', announcement.id);
        
        const date = new Date(announcement.timestamp).toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });
        
        const priority = announcement.priority || 'normal';
        const category = announcement.category || 'general';
        const authorName = announcement.authorName || 'Head Assessor';
        
        // Check if announcement is expired
        const isExpired = announcement.expiry && new Date(announcement.expiry) < new Date();
        
        // Format message with basic markdown support
        const formattedMessage = this.formatAnnouncementText(announcement.message);
        
        item.innerHTML = `
            <div class="announcement-header">
                <div class="announcement-title-row">
                    <h4>${announcement.subject}</h4>
                    <div class="announcement-badges">
                        <span class="priority-badge ${priority}">
                            <i class="fas ${this.getPriorityIcon(priority)}"></i>
                            ${priority}
                        </span>
                        <span class="category-badge">
                            <i class="fas ${this.getCategoryIcon(category)}"></i>
                            ${this.getCategoryLabel(category)}
                        </span>
                        ${this.getTargetingBadge(announcement.targetRecipients)}
                        ${isExpired ? '<span class="priority-badge" style="background: #f3f4f6; color: #9ca3af;">Expired</span>' : ''}
                    </div>
                </div>
            </div>
            <div class="announcement-content">
                <div class="announcement-message">${formattedMessage}</div>
                ${announcement.expiry ? `<div class="announcement-expiry">
                    <i class="fas fa-calendar-times"></i>
                    Expires: ${new Date(announcement.expiry).toLocaleDateString()}
                </div>` : ''}
            </div>
            <div class="announcement-footer">
                <small>
                    <i class="fas fa-user"></i>
                    Posted by: ${authorName} | 
                    <i class="fas fa-clock"></i>
                    ${date}
                    ${announcement.viewCount ? `| <i class="fas fa-eye"></i> ${announcement.viewCount} views` : ''}
                </small>
                <div class="announcement-actions">
                    <button class="action-btn" onclick="headApp.editAnnouncement('${announcement.id}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn" onclick="headApp.duplicateAnnouncement('${announcement.id}')" title="Duplicate">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="action-btn" onclick="headApp.deleteAnnouncement('${announcement.id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        return item;
    }

    handleAnnouncementSubmit() {
        console.log('handleAnnouncementSubmit called');
        const form = document.getElementById('announcementForm');
        const formData = new FormData(form);
        
        const announcementData = {
            subject: document.getElementById('announcementSubject').value.trim(),
            message: document.getElementById('announcementMessage').value.trim(),
            priority: document.getElementById('announcementPriority').value,
            category: document.getElementById('announcementCategory').value,
            expiry: null, // Removed expiry field
            targetAll: document.getElementById('targetAll').checked,
            targetStaff: document.getElementById('targetStaff').checked,
            targetAdmins: document.getElementById('targetAdmins').checked
        };
        
        // Validation
        if (!announcementData.subject || !announcementData.message) {
            Utils.showToast("Please enter both a subject and a message.", "warning");
            return;
        }
        
        if (announcementData.message.length > 2000) {
            Utils.showToast("Message exceeds maximum length of 2000 characters.", "warning");
            return;
        }
        
        // Enhanced target recipients logic
        if (!announcementData.targetAll && !announcementData.targetStaff && !announcementData.targetAdmins) {
            announcementData.targetAll = true;
        }
        
        // If "Staff Only" is selected, ensure exclusive targeting
        if (announcementData.targetStaff && !announcementData.targetAdmins) {
            announcementData.targetAll = false;  // Disable "All Users"
        }
        
        // If "Administrators Only" is selected, ensure exclusive targeting
        if (announcementData.targetAdmins && !announcementData.targetStaff) {
            announcementData.targetAll = false;  // Disable "All Users"
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.querySelector('.btn-text').textContent;
        submitBtn.querySelector('.btn-text').textContent = 'Sending...';
        submitBtn.disabled = true;
        
        console.log('MySQL API ready status:', this.announcementManager.isReady);
        console.log('Announcement data to save:', announcementData);
        
        // Send announcement
        this.announcementManager.addEnhancedAnnouncement(announcementData)
            .then(() => {
                // Reset form
                form.reset();
                document.getElementById('announcementPriority').value = 'normal';
                document.getElementById('announcementCategory').value = 'general';
                document.getElementById('targetAll').checked = true;
                document.getElementById('targetStaff').checked = false;
                document.getElementById('targetAdmins').checked = false;
                
                // Update character count
                const characterCount = document.querySelector('.character-count');
                const wordCount = document.querySelector('.word-count');
                if (characterCount) characterCount.textContent = '0 / 2000 characters';
                if (wordCount) wordCount.textContent = '0 words';
                
                Utils.showToast("Announcement sent successfully!", "success");
            })
            .catch((error) => {
                console.error('Announcement submission error:', error);
                Utils.showToast("Failed to send announcement. Please try again.", "error");
            })
            .finally(() => {
                // Restore button state
                submitBtn.querySelector('.btn-text').textContent = originalText;
                submitBtn.disabled = false;
            });
    }
    // Supporting functions for enhanced announcements
    formatAnnouncementText(text) {
        return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **bold**
            .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *italic*
            .replace(/\n/g, '<br>')                            // Line breaks
            .replace(/â€¢ /g, '<br>â€¢ ');                         // Bullet points
    }

    getPriorityIcon(priority) {
        const icons = {
            normal: 'fa-info-circle',
            high: 'fa-exclamation-circle',
            urgent: 'fa-exclamation-triangle'
        };
        return icons[priority] || icons.normal;
    }

    getCategoryIcon(category) {
        const icons = {
            general: 'fa-info-circle',
            system: 'fa-cogs',
            maintenance: 'fa-tools',
            policy: 'fa-gavel',
            emergency: 'fa-exclamation-triangle',
            training: 'fa-graduation-cap'
        };
        return icons[category] || icons.general;
    }

    getCategoryLabel(category) {
        const labels = {
            general: 'General',
            system: 'System',
            maintenance: 'Maintenance',
            policy: 'Policy',
            emergency: 'Emergency',
            training: 'Training'
        };
        return labels[category] || 'General';
    }

    getTargetingBadge(targetRecipients) {
        if (!targetRecipients) return '';
        
        // Determine targeting based on recipient settings
        if (targetRecipients.all) {
            return '<span class="category-badge" style="background: #e0f2fe; color: #0277bd;"><i class="fas fa-users"></i> All Users</span>';
        }
        
        const targets = [];
        if (targetRecipients.staff) targets.push('Staff');
        if (targetRecipients.admins) targets.push('Admins');
        
        if (targets.length === 0) {
            return '<span class="category-badge" style="background: #e0f2fe; color: #0277bd;"><i class="fas fa-users"></i> All Users</span>';
        }
        
        // Staff-only announcement (highlighted)
        if (targets.length === 1 && targets.includes('Staff')) {
            return '<span class="category-badge" style="background: #e8f5e8; color: #2e7d32; border: 1px solid #4caf50;"><i class="fas fa-user-tie"></i> Staff Only</span>';
        }
        
        // Admin-only announcement
        if (targets.length === 1 && targets.includes('Admins')) {
            return '<span class="category-badge" style="background: #fff3e0; color: #e65100; border: 1px solid #ff9800;"><i class="fas fa-user-shield"></i> Admins Only</span>';
        }
        
        // Multiple specific targets
        return `<span class="category-badge" style="background: #f3e5f5; color: #7b1fa2;"><i class="fas fa-user-friends"></i> ${targets.join(' + ')}</span>`;
    }

    updateAnnouncementStatsDisplay(stats) {
        const totalElement = document.getElementById('totalAnnouncements');
        const monthlyElement = document.getElementById('monthlyAnnouncements');
        const urgentElement = document.getElementById('urgentAnnouncements');
        
        if (totalElement) totalElement.textContent = stats.total;
        if (monthlyElement) monthlyElement.textContent = stats.monthly;
        if (urgentElement) urgentElement.textContent = stats.urgent;
    }

    updateAnnouncementStats(announcements) {
        const totalCount = announcements.length;
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        
        const monthlyCount = announcements.filter(a => {
            const date = new Date(a.timestamp);
            return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
        }).length;
        
        const urgentCount = announcements.filter(a => 
            (a.priority === 'urgent' || a.priority === 'high') && 
            (!a.expiry || new Date(a.expiry) >= new Date())
        ).length;
        
        // Update stats display
        const totalEl = document.getElementById('totalAnnouncements');
        const monthlyEl = document.getElementById('monthlyAnnouncements');
        const urgentEl = document.getElementById('urgentAnnouncements');
        
        if (totalEl) totalEl.textContent = totalCount;
        if (monthlyEl) monthlyEl.textContent = monthlyCount;
        if (urgentEl) urgentEl.textContent = urgentCount;
    }

    filterAnnouncements(announcements) {
        if (!announcements) return [];
        
        const searchTerm = document.getElementById('announcementSearch')?.value.toLowerCase() || '';
        const priorityFilter = document.getElementById('priorityFilter')?.value || 'all';
        const categoryFilter = document.getElementById('categoryFilter')?.value || 'all';
        
        return announcements.filter(announcement => {
            // Search filter
            const matchesSearch = !searchTerm || 
                announcement.subject.toLowerCase().includes(searchTerm) ||
                announcement.message.toLowerCase().includes(searchTerm);
            
            // Priority filter
            const matchesPriority = priorityFilter === 'all' || 
                announcement.priority === priorityFilter;
            
            // Category filter
            const matchesCategory = categoryFilter === 'all' || 
                announcement.category === categoryFilter;
            
            // Hide expired announcements unless specifically searching for them
            const isExpired = announcement.expiry && new Date(announcement.expiry) < new Date();
            const showExpired = searchTerm.includes('expired') || searchTerm.includes('old');
            
            return matchesSearch && matchesPriority && matchesCategory && (!isExpired || showExpired);
        });
    }

    setupAnnouncementFiltering() {
        const searchInput = document.getElementById('announcementSearch');
        const priorityFilter = document.getElementById('priorityFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const refreshBtn = document.getElementById('refreshAnnouncements');
        
        // Setup search with debounce
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    this.renderAnnouncements(this.allAnnouncements || []);
                }, 300);
            });
        }
        
        // Setup filter changes
        [priorityFilter, categoryFilter].forEach(filter => {
            if (filter) {
                filter.addEventListener('change', () => {
                    this.renderAnnouncements(this.allAnnouncements || []);
                });
            }
        });
        
        // Setup refresh button
        if (refreshBtn) {
            refreshBtn.addEventListener('click', async () => {
                const icon = refreshBtn.querySelector('i');
                icon.classList.add('fa-spin');
                
                try {
                    // Manually refresh announcements
                    const announcements = await this.announcementManager.getAllAnnouncements();
                    this.renderAnnouncements(announcements);
                    
                    // Refresh stats
                    await this.loadAnnouncementStats();
                    
                    Utils.showToast('Announcements refreshed', 'success');
                } catch (error) {
                    console.error('Error refreshing announcements:', error);
                    Utils.showToast('Failed to refresh announcements', 'error');
                } finally {
                    icon.classList.remove('fa-spin');
                }
            });
        }
        
        // Setup export button
        const exportBtn = document.getElementById('exportAnnouncements');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                this.exportAnnouncements();
            });
        }
    }

    showAnnouncementPreview() {
        const subject = document.getElementById('announcementSubject').value.trim();
        const message = document.getElementById('announcementMessage').value.trim();
        const priority = document.getElementById('announcementPriority').value;
        const category = document.getElementById('announcementCategory').value;
        
        if (!subject || !message) {
            Utils.showToast('Please enter both subject and message to preview', 'warning');
            return;
        }
        
        const previewData = {
            id: 'preview',
            subject: subject,
            message: message,
            priority: priority,
            category: category,
            timestamp: new Date().toISOString(),
            authorName: 'Head Assessor'
        };
        
        const previewElement = this.createAnnouncementElement(previewData);
        previewElement.style.border = '2px dashed var(--primary-color)';
        previewElement.style.background = '#f8fffe';
        
        // Create modal for preview
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2 style="margin-bottom: 1rem;">
                    <i class="fas fa-eye"></i>
                    Announcement Preview
                </h2>
                <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i>
                        This is how your announcement will appear to users
                    </p>
                </div>
                <div id="previewContainer"></div>
                <div style="text-align: right; margin-top: 2rem;">
                    <button class="btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">
                        Close Preview
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('previewContainer').appendChild(previewElement);
    }

    editAnnouncement(announcementId) {
        Utils.showToast('Edit functionality will be implemented in the next update', 'info');
    }

    duplicateAnnouncement(announcementId) {
        const announcement = this.allAnnouncements?.find(a => a.id === announcementId);
        if (announcement) {
            document.getElementById('announcementSubject').value = `Copy of ${announcement.subject}`;
            document.getElementById('announcementMessage').value = announcement.message;
            document.getElementById('announcementPriority').value = announcement.priority || 'normal';
            document.getElementById('announcementCategory').value = announcement.category || 'general';
            
            Utils.showToast('Announcement duplicated to form', 'success');
            
            // Scroll to form
            document.getElementById('announcementForm').scrollIntoView({ behavior: 'smooth' });
        }
    }

    deleteAnnouncement(announcementId) {
        if (confirm('Are you sure you want to delete this announcement? This action cannot be undone.')) {
            Utils.showToast('Delete functionality will be implemented in the next update', 'info');
        }
    }

    exportAnnouncements() {
        try {
            const exportBtn = document.getElementById('exportAnnouncements');
            const icon = exportBtn?.querySelector('i');
            
            // Show loading state
            if (exportBtn) {
                exportBtn.disabled = true;
                if (icon) {
                    icon.className = 'fas fa-spinner fa-spin';
                }
            }
            
            // Get current announcements data (filtered if search/filters are active)
            const announcements = this.allAnnouncements || [];
            
            // Debug: Log the first announcement to see the data structure
            if (announcements.length > 0) {
                console.log('First announcement data structure:', announcements[0]);
            }
            
            if (announcements.length === 0) {
                Utils.showToast('No announcements to export', 'warning');
                this.resetExportButton(exportBtn, icon);
                return;
            }

            // Prepare CSV data
            const csvData = [];
            
            // Header row
            csvData.push([
                'ID',
                'Subject',
                'Message',
                'Priority',
                'Category',
                'Created Date',
                'Expiry Date',
                'Status',
                'Created By'
            ]);
            
            // Data rows
            announcements.forEach(announcement => {
                // The backend returns createdAt, timestamp (both contain created_at), and expiry (contains expiry_date)
                const createdAtField = announcement.createdAt || announcement.timestamp || announcement.created_at;
                const createdDate = createdAtField ? new Date(createdAtField).toLocaleString() : 'N/A';
                const expiryDate = announcement.expiry || announcement.expiry_date ? 
                    new Date(announcement.expiry || announcement.expiry_date).toLocaleDateString() : 'No expiry';
                const expiryField = announcement.expiry || announcement.expiry_date;
                const status = expiryField && new Date(expiryField) < new Date() ? 'Expired' : 'Active';
                
                csvData.push([
                    announcement.id || 'N/A',
                    announcement.subject || 'N/A',
                    announcement.message ? announcement.message.replace(/\n/g, ' ').replace(/"/g, '""') : 'N/A',
                    announcement.priority || 'normal',
                    announcement.category || 'general',
                    createdDate,
                    expiryDate,
                    status,
                    announcement.authorName || announcement.author_name || announcement.created_by || 'Head Assessor'
                ]);
            });
            
            // Add metadata
            csvData.push([]);
            csvData.push(['Export Details:']);
            csvData.push(['Generated on:', new Date().toLocaleString()]);
            csvData.push(['Generated by:', 'Head Assessor Dashboard']);
            csvData.push(['Total announcements:', announcements.length]);
            
            // Convert to CSV and download
            this.downloadAnnouncementCSV(csvData);
            
            // Show success state
            if (exportBtn) {
                exportBtn.disabled = false;
                if (icon) {
                    icon.className = 'fas fa-check';
                }
                
                // Reset after delay
                setTimeout(() => {
                    this.resetExportButton(exportBtn, icon);
                }, 2000);
            }
            
            Utils.showToast(`${announcements.length} announcements exported successfully`, 'success');
            
        } catch (error) {
            console.error('Export error:', error);
            const exportBtn = document.getElementById('exportAnnouncements');
            const icon = exportBtn?.querySelector('i');
            this.resetExportButton(exportBtn, icon);
            Utils.showToast('Failed to export announcements', 'error');
        }
    }
    
    resetExportButton(button, icon) {
        if (button) {
            button.disabled = false;
        }
        if (icon) {
            icon.className = 'fas fa-download';
        }
    }
    
    downloadAnnouncementCSV(data) {
        try {
            // Convert data to CSV string with UTF-8 BOM for Excel compatibility
            const csvContent = '\uFEFF' + data.map(row => 
                row.map(field => {
                    // Handle fields that might contain commas or quotes
                    const fieldStr = String(field || '');
                    if (fieldStr.includes(',') || fieldStr.includes('"') || fieldStr.includes('\n')) {
                        return `"${fieldStr.replace(/"/g, '""')}"`;
                    }
                    return fieldStr;
                }).join(',')
            ).join('\n');
            
            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
            const filename = `announcements-export-${timestamp}.csv`;
            
            if (navigator.msSaveBlob) {
                // IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                // Other browsers
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            }
            
        } catch (error) {
            console.error('CSV download error:', error);
            throw new Error('Failed to generate CSV file');
        }
    }

    // Chart Export Functionality
    exportChart(chartType) {
        if (!this.chartInstances || !chartType) {
            Utils.showToast('Chart data not available for export', 'error');
            return;
        }

        // Find the button that triggered this export for visual feedback
        const buttons = document.querySelectorAll('.chart-action-btn');
        let targetButton = null;
        
        // Find button by chart type context
        buttons.forEach(btn => {
            const chartCard = btn.closest('.chart-card');
            if (chartCard) {
                const canvas = chartCard.querySelector('canvas');
                if (canvas) {
                    const canvasId = canvas.id;
                    if ((chartType === 'monthlyTrends' && canvasId === 'assessmentTrendsChart') ||
                        (chartType === 'barangayDistribution' && canvasId === 'barangayChart') ||
                        (chartType === 'propertyClassification' && canvasId === 'propertyChart') ||
                        (chartType === 'statusOverview' && canvasId === 'completionStatusChart')) {
                        targetButton = btn;
                    }
                }
            }
        });

        // Show loading state
        if (targetButton) {
            targetButton.classList.add('downloading');
            const icon = targetButton.querySelector('i');
            if (icon) icon.style.display = 'none';
        }

        let chartInstance;
        let filename;
        let data;

        switch (chartType) {
            case 'monthlyTrends':
                chartInstance = this.chartInstances.assessmentTrendsChart;
                filename = 'monthly-inspection-trends';
                break;
            case 'barangayDistribution':
                chartInstance = this.chartInstances.barangayChart;
                filename = 'barangay-distribution';
                break;
            case 'propertyClassification':
                chartInstance = this.chartInstances.propertyChart;
                filename = 'property-classification';
                break;
            case 'inspectionTypeDistribution':
                chartInstance = this.chartInstances.inspectionTypeChart;
                filename = 'inspection-type-distribution';
                break;
            case 'statusOverview':
                chartInstance = this.chartInstances.completionStatusChart;
                filename = 'inspection-status-overview';
                break;
            default:
                this.resetButtonState(targetButton);
                Utils.showToast('Unknown chart type', 'error');
                return;
        }

        if (!chartInstance) {
            this.resetButtonState(targetButton);
            Utils.showToast('Chart not initialized yet. Please wait for data to load.', 'warning');
            return;
        }

        try {
            // Extract chart data
            data = this.extractChartData(chartInstance, chartType);
            
            if (!data || data.length === 0) {
                this.resetButtonState(targetButton);
                Utils.showToast('No data available to export', 'warning');
                return;
            }

            // Convert to CSV and download
            this.downloadCSV(data, filename);
            
            // Show success state
            if (targetButton) {
                targetButton.classList.remove('downloading');
                targetButton.classList.add('success');
                const icon = targetButton.querySelector('i');
                if (icon) {
                    icon.style.display = '';
                    icon.className = 'fas fa-check';
                }
                
                // Reset after delay
                setTimeout(() => {
                    this.resetButtonState(targetButton);
                }, 2000);
            }
            
            Utils.showToast(`Chart data exported as ${filename}.csv`, 'success');

        } catch (error) {
            console.error('Export error:', error);
            this.resetButtonState(targetButton);
            Utils.showToast('Failed to export chart data', 'error');
        }
    }

    resetButtonState(button) {
        if (button) {
            button.classList.remove('downloading', 'success');
            const icon = button.querySelector('i');
            if (icon) {
                icon.style.display = '';
                icon.className = 'fas fa-download';
            }
        }
    }

    extractChartData(chartInstance, chartType) {
        const chartData = chartInstance.data;
        const csvData = [];

        try {
            // Validate chart data structure
            if (!chartData || !chartData.labels || !chartData.datasets || chartData.datasets.length === 0) {
                console.warn('Invalid chart data structure:', chartData);
                return [];
            }

            switch (chartType) {
                case 'monthlyTrends':
                    // Header row
                    csvData.push(['Month', 'Inspection Requests']);
                    
                    // Data rows
                    chartData.labels.forEach((label, index) => {
                        const value = chartData.datasets[0]?.data[index] || 0;
                        csvData.push([label, value]);
                    });
                    break;

                case 'barangayDistribution':
                    // Header row
                    csvData.push(['Barangay', 'Number of Inspections']);
                    
                    // Data rows
                    chartData.labels.forEach((label, index) => {
                        const value = chartData.datasets[0]?.data[index] || 0;
                        csvData.push([label, value]);
                    });
                    break;

                case 'propertyClassification':
                    // Header row
                    csvData.push(['Property Type', 'Count', 'Percentage']);
                    
                    // Calculate total for percentage
                    const total = chartData.datasets[0]?.data.reduce((sum, val) => sum + (val || 0), 0) || 1;
                    
                    // Data rows
                    chartData.labels.forEach((label, index) => {
                        const value = chartData.datasets[0]?.data[index] || 0;
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                        csvData.push([label, value, percentage]);
                    });
                    break;

                case 'inspectionTypeDistribution':
                    // Header row
                    csvData.push(['Inspection Type', 'Count']);

                    // Data rows
                    chartData.labels.forEach((label, index) => {
                        const value = chartData.datasets[0]?.data[index] || 0;
                        csvData.push([label, value]);
                    });
                    break;

                case 'statusOverview':
                    // Header row
                    csvData.push(['Status', 'Count', 'Percentage']);
                    
                    // Calculate total for percentage
                    const statusTotal = chartData.datasets[0]?.data.reduce((sum, val) => sum + (val || 0), 0) || 1;
                    
                    // Data rows
                    chartData.labels.forEach((label, index) => {
                        const value = chartData.datasets[0]?.data[index] || 0;
                        const percentage = statusTotal > 0 ? ((value / statusTotal) * 100).toFixed(1) + '%' : '0%';
                        csvData.push([label, value, percentage]);
                    });
                    break;

                default:
                    console.warn('Unknown chart type for data extraction:', chartType);
                    return [];
            }

            // Validate we have data beyond headers
            if (csvData.length <= 1) {
                console.warn('No data rows found for chart:', chartType);
                return [];
            }

            // Add metadata rows
            csvData.push([]);
            csvData.push(['Generated on:', new Date().toLocaleString()]);
            csvData.push(['Generated by:', 'Head Assessor Dashboard']);
            csvData.push(['Chart type:', chartType]);

            return csvData;

        } catch (error) {
            console.error('Data extraction error:', error);
            return [];
        }
    }

    downloadCSV(data, filename) {
        try {
            // Convert data to CSV string with UTF-8 BOM for Excel compatibility
            const csvContent = '\uFEFF' + data.map(row => 
                row.map(field => {
                    // Handle null/undefined values
                    if (field == null) return '';
                    
                    // Convert to string
                    const fieldStr = String(field);
                    
                    // Escape fields containing commas, quotes, or newlines
                    if (fieldStr.includes(',') || fieldStr.includes('"') || fieldStr.includes('\n')) {
                        return `"${fieldStr.replace(/"/g, '""')}"`;
                    }
                    return fieldStr;
                }).join(',')
            ).join('\n');

            // Create blob with proper MIME type
            const blob = new Blob([csvContent], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            // Generate timestamp for filename
            const timestamp = new Date().toISOString().split('T')[0];
            const fullFilename = `${filename}-${timestamp}.csv`;
            
            // Check if browser supports download
            if (!window.URL || !window.URL.createObjectURL) {
                throw new Error('Browser does not support file download');
            }
            
            // Create and trigger download
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.setAttribute('href', url);
            link.setAttribute('download', fullFilename);
            link.style.visibility = 'hidden';
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            
            // Cleanup
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log(`CSV exported successfully: ${fullFilename}`);
            
        } catch (error) {
            console.error('CSV download error:', error);
            throw new Error('Failed to download CSV file');
        }
    }
}

// Global function for quick actions
function switchToSection(sectionId) {
    const targetLink = document.querySelector(`[data-section="${sectionId}"]`);
    if (targetLink) {
        targetLink.click();
    }
}

// Global function for chart export
function exportChart(chartType) {
    if (window.headApp && typeof window.headApp.exportChart === 'function') {
        window.headApp.exportChart(chartType);
    } else {
        console.error('HeadApp not initialized or exportChart method not available');
        // Fallback toast notification
        if (window.Utils && typeof Utils.showToast === 'function') {
            Utils.showToast('Export functionality not ready. Please try again.', 'warning');
        }
    }
}

// Logout functionality
async function handleLogout() {
    try {
        const response = await fetch('../backend/api/auth.php?action=logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();
        
        if (data.success) {
            // Clear local storage
            sessionStorage.clear();
            localStorage.clear();
            
            // Redirect to homepage
            window.location.href = '../index.html';
        } else {
            console.error('Logout failed:', data.error);
            // Force logout even if server call fails
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = '../index.html';
        }
    } catch (error) {
        console.error('Logout error:', error);
        // Force logout even if server call fails
        sessionStorage.clear();
        localStorage.clear();
        window.location.href = '../index.html';
    }
}

// Initialize the application
const headApp = new HeadApp();
window.headApp = headApp; // Make globally accessible for chart exports

    </script>
</body>
</html>